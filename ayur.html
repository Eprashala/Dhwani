<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>श्री धन्वंतरी कृपा - वैद्यजी AI (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-emerald-800 hover:bg-emerald-600 shadow-lg
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-emerald-900 focus:ring-emerald-500
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-emerald-800 text-emerald-100
                   hover:bg-emerald-700
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-emerald-900 focus:ring-emerald-500
                   disabled:bg-emerald-900 disabled:text-emerald-300 disabled:cursor-not-allowed;
        }

        .custom-checkbox {
            @apply w-4 h-4 text-emerald-600 bg-emerald-900 border-emerald-700 rounded focus:ring-emerald-500 focus:ring-2 ring-offset-emerald-800;
        }
        
        .custom-input {
            @apply block w-3/4 mx-auto text-center border border-emerald-700 rounded-lg p-3 outline-none transition-all;
            background-color: #064e3b !important;
            color: #d1fae5 !important;
            caret-color: #34d399 !important;
        }
        .custom-input::placeholder { color: #6ee7b7 !important; opacity: 0.7 !important; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #022c22; }
        ::-webkit-scrollbar-thumb { background: #047857; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }

        /* --- HIGHLIGHTING STYLES --- */
        .word-span {
            border-radius: 3px;
            padding: 2px 4px;
            transition: all 0.1s ease-out;
            display: inline-block;
            margin: 0 1px;
        }
        
        .active-word {
            background-color: #d97706; /* Amber-600 */
            color: white;
            transform: scale(1.1);
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>

<body class="bg-[#022c22] text-emerald-50 flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-[#064e3b] rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto border-t-4 border-emerald-500 border-b-4 border-emerald-800">
        
        <div class="flex items-center justify-between mb-4 shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                <span class="text-emerald-400">श्री धन्वंतरी</span> <span class="text-emerald-200">आयुर्वेद</span> <span class="text-emerald-500">कक्ष</span>
            </h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-600 transition-colors" title="बंद आहे"></div>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-[#022c22] rounded-lg p-4 mb-4 border border-emerald-900 space-y-4 shadow-inner min-h-[200px] scroll-smooth relative">
            <div class="text-emerald-300/60 text-center mt-10">
                सुरू करण्यासाठी "वैद्यजी" म्हणा.<br>
                <span class="text-sm opacity-70 text-emerald-400">मी वैद्यजी आहे. मी आपल्या प्रकृतीनुसार उपचार सुचवेन.</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-emerald-900/30 p-2 rounded-xl">
            <button id="pause-resume-button" class="icon-btn bg-emerald-700 hover:bg-emerald-600" title="Pause" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            <button id="stop-speech-button" class="icon-btn bg-red-900/50 hover:bg-red-800" title="Stop & Listen" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>
            <button id="replay-button" class="icon-btn bg-blue-900/50 hover:bg-blue-800" title="Replay" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-8 h-8">
                    <path d="M8 5v14l11-7z" />
                </svg>
            </button>
        </div>

        <div class="flex flex-col gap-4 mb-4 shrink-0 w-full text-center">
            <div class="w-full">
                <label class="text-xs text-emerald-400 mb-1 block">रुग्णाचे नाव</label>
                <input type="text" id="manual-name" class="custom-input" placeholder="तुमचे नाव">
            </div>
            <div class="w-full">
                <label class="text-xs text-emerald-400 mb-1 block">वय (वर्षे)</label>
                <input type="number" id="manual-age" class="custom-input" placeholder="उदा. ३०">
            </div>
        </div>

        <div class="flex items-center justify-center gap-2 mb-2 shrink-0">
            <input type="checkbox" id="remember-me-checkbox" class="custom-checkbox">
            <label for="remember-me-checkbox" class="text-sm text-emerald-200 cursor-pointer select-none">माहिती लक्षात ठेवा</label>
        </div>

        <div id="advance-container" class="hidden"></div> 

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all duration-300 ease-in-out shrink-0
                       bg-emerald-600 text-white shadow-lg shadow-emerald-900/50
                       hover:bg-emerald-500 hover:shadow-emerald-500/50 hover:-translate-y-0.5
                       focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50
                       disabled:bg-gray-700 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0">
            सल्ला घ्या
        </button>

        <div class="mt-4 grid grid-cols-3 gap-3 shrink-0">
            <button id="restart-chat-button" class="utility-btn" disabled>पुन्हा सुरू करा</button>
            <button id="share-button" class="utility-btn bg-blue-900/50 hover:bg-blue-800">शेअर करा</button>
            <button id="end-chat-button" class="utility-btn text-red-200 hover:bg-red-900/40" disabled>थांबवा</button>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        
        let appState = 'IDLE'; // IDLE, LISTENING, BUSY, PAUSED
        let userName = '';
        let userAge = 30; 
        let chatHistory = [];
        let systemInstruction = '';
        
        // Audio Objects
        const synth = window.speechSynthesis;
        let recognition = null;
        let wakeLock = null;
        
        // State Flags
        let isGlobalPaused = false;
        let lastSpokenText = '';
        
        // Highlighting Globals
        window.currentUtterance = null; // Important: prevent GC
        let currentMessageDivId = null; 
        let currentSpansMap = [];

        // --- 2. INITIALIZATION ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        
        // Buttons
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData();
            initRecognition();
        };

        function initRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("तुमचा ब्राउझर स्पीच रेकग्निशनला सपोर्ट करत नाही. कृपया Chrome वापरा.");
                return;
            }
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'mr-IN';
            
            recognition.onresult = handleRecognitionResult;
            recognition.onend = handleRecognitionEnd;
            recognition.onerror = (e) => {
                console.log("Rec Error:", e.error);
                if (e.error === 'no-speech' && appState === 'LISTENING') {
                    // Just restart silently
                    try { recognition.start(); } catch(err){}
                } else if (e.error === 'not-allowed') {
                    alert("माईकची परवानगी नाकारली आहे.");
                    setState('IDLE');
                }
            };
        }

        // --- 3. EVENT LISTENERS ---
        talkButton.addEventListener('click', toggleSession);
        stopSpeechButton.addEventListener('click', forceStopAndListen);
        pauseResumeButton.addEventListener('click', togglePause);
        replayButton.addEventListener('click', () => { if(lastSpokenText) speakText(lastSpokenText, true); });
        
        document.getElementById('restart-chat-button').addEventListener('click', resetChat);
        document.getElementById('end-chat-button').addEventListener('click', endChat);
        document.getElementById('share-button').addEventListener('click', shareChat);

        // --- 4. CORE LOGIC FLOW ---
        
        async function toggleSession() {
            if (appState === 'IDLE') {
                // START
                const name = manualNameInput.value.trim();
                const age = manualAgeInput.value.trim();
                
                if (!name || !age) {
                    alert("कृपया नाव आणि वय टाका.");
                    return;
                }
                
                userName = name;
                userAge = age;
                saveUserData();
                buildSystemPrompt();
                
                await acquireWakeLock();
                
                // Welcome Logic
                if (chatHistory.length === 0) {
                     const welcome = `नमस्कार ${userName}, मी वैद्यजी आहे. सांगा, तुम्हाला काय त्रास होत आहे?`;
                     logMessage('वैद्यजी', welcome);
                     setState('BUSY');
                     await speakAndRender(welcome); // Speak first
                } else {
                     logMessage('सिस्टम', 'जुने संभाषण लोड करत आहे...');
                }
                
                // After speaking/loading, start listening
                setState('LISTENING');
                startRecognitionSafe();

            } else {
                // STOP (Back to Idle)
                endChat();
            }
        }

        // --- 5. RECOGNITION HANDLERS ---
        
        async function handleRecognitionResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            
            console.log("User said:", transcript);
            
            // 1. Stop Listening immediately
            recognition.stop();
            setState('BUSY'); // UI shows busy
            
            // 2. Log User Message
            logMessage('तुम्ही', transcript);
            chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
            
            // 3. Get AI Reply
            const aiText = await getAIResponse(chatHistory);
            
            // 4. Clean Text
            const cleanText = aiText.replace(/[\*\[\]\(\)<>`]/g, '').trim();
            chatHistory.push({ role: 'model', parts: [{ text: cleanText }] });
            
            // 5. Speak & Highlight (Await until finished)
            await speakAndRender(cleanText);
            
            // 6. Resume Listening ONLY after speaking is fully done
            if (!isGlobalPaused && appState !== 'IDLE') {
                setState('LISTENING');
                startRecognitionSafe();
            }
        }

        function handleRecognitionEnd() {
            // Check if we should restart listening
            if (appState === 'LISTENING' && !isGlobalPaused && !synth.speaking) {
                startRecognitionSafe();
            }
        }

        function startRecognitionSafe() {
            if (!recognition) return;
            try { recognition.start(); } catch(e) { /* ignore if already started */ }
        }

        // --- 6. TTS & HIGHLIGHTING (THE CORE FIX) ---

        async function speakAndRender(text) {
            // 1. Render HTML with Spans for Highlighting
            const divId = 'msg-' + Date.now();
            currentMessageDivId = divId; // Set global target
            
            const div = document.createElement('div');
            div.id = divId;
            div.className = "mb-4 p-3 bg-emerald-900/40 rounded-lg border border-emerald-800/50";
            
            // Create words array and map
            const words = text.split(' ');
            currentSpansMap = [];
            let charCount = 0;
            
            const htmlWords = words.map((word, i) => {
                const start = charCount;
                const end = charCount + word.length + 1; // + space
                const spanId = `w-${divId}-${i}`;
                
                currentSpansMap.push({ start, end, id: spanId });
                charCount = end;
                
                return `<span id="${spanId}" class="word-span">${word}</span>`;
            }).join(' ');

            div.innerHTML = `<strong class="text-emerald-400 block mb-1">वैद्यजी:</strong> <div class="text-emerald-50 text-lg leading-relaxed">${htmlWords}</div>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;

            // 2. Speak with Promise
            await speakText(text, true);
        }

        function speakText(text, useHighlighting) {
            return new Promise((resolve) => {
                if (synth.speaking) synth.cancel();
                if (recognition) try{ recognition.stop(); } catch(e){} // Ensure mic is off

                const utterance = new SpeechSynthesisUtterance(text);
                window.currentUtterance = utterance; // Anti-GC fix

                utterance.lang = 'mr-IN';
                utterance.rate = 0.9;
                
                // Voice selection
                let voices = synth.getVoices();
                let v = voices.find(x => x.lang === 'mr-IN') || voices.find(x => x.lang === 'hi-IN');
                if(v) utterance.voice = v;

                utterance.onboundary = (event) => {
                    if (useHighlighting && event.name === 'word' && currentMessageDivId) {
                        const idx = event.charIndex;
                        const match = currentSpansMap.find(s => idx >= s.start && idx < s.end);
                        
                        // Clear old
                        const old = document.querySelectorAll(`#${currentMessageDivId} .active-word`);
                        old.forEach(el => el.classList.remove('active-word'));
                        
                        // Set new
                        if (match) {
                            const el = document.getElementById(match.id);
                            if(el) {
                                el.classList.add('active-word');
                                el.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
                            }
                        }
                    }
                };

                utterance.onend = () => {
                    window.currentUtterance = null;
                    // Clear highlights
                    if(currentMessageDivId) {
                         const old = document.querySelectorAll(`#${currentMessageDivId} .active-word`);
                         old.forEach(el => el.classList.remove('active-word'));
                    }
                    resolve();
                };
                
                utterance.onerror = (e) => {
                    console.log("TTS Error", e);
                    window.currentUtterance = null;
                    resolve(); // Resolve anyway to unblock app
                };

                synth.speak(utterance);
            });
        }

        // --- 7. BUTTON ACTIONS ---

        function forceStopAndListen() {
            if (appState === 'IDLE') return;
            
            // 1. Stop Speaking
            if (synth.speaking) synth.cancel();
            
            // 2. Stop Listening (to reset)
            if (recognition) try{ recognition.stop(); } catch(e){}

            // 3. Force State
            logMessage('सिस्टम', 'थांबले. ऐकत आहे...');
            
            // Small delay to let browser events settle
            setTimeout(() => {
                setState('LISTENING');
                startRecognitionSafe();
            }, 200);
        }

        function togglePause() {
            if (isGlobalPaused) {
                // RESUME
                isGlobalPaused = false;
                pauseResumeButton.classList.remove('bg-yellow-600');
                pauseResumeButton.classList.add('bg-emerald-700');
                logMessage('सिस्टम', 'पुन्हा सुरू.');
                
                if (appState !== 'IDLE') {
                    setState('LISTENING');
                    startRecognitionSafe();
                }
            } else {
                // PAUSE
                isGlobalPaused = true;
                if (synth.speaking) synth.cancel();
                if (recognition) try{ recognition.stop(); } catch(e){}
                
                pauseResumeButton.classList.remove('bg-emerald-700');
                pauseResumeButton.classList.add('bg-yellow-600');
                logMessage('सिस्टम', 'पॉज केले.');
            }
        }

        function setState(newState) {
            appState = newState;
            statusIndicator.className = 'w-4 h-4 rounded-full transition-colors ' + 
                (newState === 'IDLE' ? 'bg-gray-600' : 
                 newState === 'LISTENING' ? 'bg-emerald-500 listening-pulse' : 
                 newState === 'BUSY' ? 'bg-yellow-500' : 'bg-red-500');
            
            // Button States
            talkButton.disabled = (newState !== 'IDLE');
            talkButton.textContent = (newState === 'IDLE') ? 'सल्ला घ्या' : (newState === 'BUSY' ? 'वैद्यजी विचार करत आहेत...' : 'ऐकत आहे...');
            
            const controlsDisabled = (newState === 'IDLE');
            stopSpeechButton.disabled = controlsDisabled;
            pauseResumeButton.disabled = controlsDisabled;
            replayButton.disabled = controlsDisabled;
            document.getElementById('end-chat-button').disabled = controlsDisabled;
            document.getElementById('restart-chat-button').disabled = controlsDisabled;
            
            manualNameInput.disabled = (newState !== 'IDLE');
            manualAgeInput.disabled = (newState !== 'IDLE');
        }

        // --- 8. HELPERS ---
        
        async function getAIResponse(history) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${DEFAULT_API_KEY}`;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: history,
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                return "संपर्क तुटला आहे. कृपया इंटरनेट तपासा.";
            }
        }

        function buildSystemPrompt() {
            systemInstruction = `
                Role: Vaidyaji (Ayurveda Expert). User: ${userName}, Age: ${userAge}.
                Lang: Marathi Only. No English.
                Ref: Charaka, Sushruta, Vagbhata.
                Format: Diagnosis -> Sanskrit Verse (Text) -> Marathi Meaning -> Remedy/Diet.
                Tone: Calm, Caring.
                IMPORTANT: Do NOT use markdown symbols like * or # or brackets []. Pure text.
            `;
        }

        function logMessage(sender, text) {
            const div = document.createElement('div');
            const color = sender === 'तुम्ही' ? 'text-blue-300' : (sender === 'सिस्टम' ? 'text-yellow-400' : 'text-emerald-400');
            div.innerHTML = `<strong class="${color}">${sender}:</strong> <span class="text-white/80">${text}</span>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function loadUserData() {
            if(localStorage.getItem('v_remember') === 'true') {
                document.getElementById('remember-me-checkbox').checked = true;
                manualNameInput.value = localStorage.getItem('v_name') || '';
                manualAgeInput.value = localStorage.getItem('v_age') || '';
            }
        }

        function saveUserData() {
            if(document.getElementById('remember-me-checkbox').checked) {
                localStorage.setItem('v_remember', 'true');
                localStorage.setItem('v_name', userName);
                localStorage.setItem('v_age', userAge);
            } else {
                localStorage.clear();
            }
        }
        
        async function acquireWakeLock() {
             if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
        }

        async function endChat() {
            setState('IDLE');
            if(synth.speaking) synth.cancel();
            if(recognition) try{ recognition.stop(); } catch(e){}
            logMessage('सिस्टम', 'सत्र समाप्त.');
            chatHistory = [];
        }

        function resetChat() { endChat(); setTimeout(toggleSession, 500); }
        async function shareChat() { /* Simple Copy */ try{await navigator.clipboard.writeText(conversationLog.innerText); alert('Copied');}catch(e){} }
    </script>
</body>
</html>