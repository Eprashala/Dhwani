<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>श्री धन्वंतरी कृपा - वैद्यजी AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-emerald-800 hover:bg-emerald-600 shadow-lg
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-emerald-900 focus:ring-emerald-500
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-emerald-800 text-emerald-100
                   hover:bg-emerald-700
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-emerald-900 focus:ring-emerald-500
                   disabled:bg-emerald-900 disabled:text-emerald-300 disabled:cursor-not-allowed;
        }

        .custom-checkbox {
            @apply w-4 h-4 text-emerald-600 bg-emerald-900 border-emerald-700 rounded focus:ring-emerald-500 focus:ring-2 ring-offset-emerald-800;
        }
        
        .custom-input {
            @apply block w-3/4 mx-auto text-center border border-emerald-700 rounded-lg p-3 outline-none transition-all;
            background-color: #064e3b !important;
            color: #d1fae5 !important;
            caret-color: #34d399 !important;
        }
        .custom-input::placeholder { color: #6ee7b7 !important; opacity: 0.7 !important; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #022c22; }
        ::-webkit-scrollbar-thumb { background: #047857; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }

        /* --- HIGHLIGHTING STYLES --- */
        .word-span {
            border-radius: 3px;
            padding: 2px 4px;
            transition: all 0.2s ease-out;
            display: inline-block;
            margin: 0 1px;
        }
        
        .active-word {
            background-color: #d97706; /* Amber-600 */
            color: white;
            transform: scale(1.15);
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
            position: relative;
        }
    </style>
</head>

<body class="bg-[#022c22] text-emerald-50 flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-[#064e3b] rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto border-t-4 border-emerald-500 border-b-4 border-emerald-800">
        
        <div class="flex items-center justify-between mb-4 shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                <span class="text-emerald-400">श्री धन्वंतरी</span> <span class="text-emerald-200">आयुर्वेद</span> <span class="text-emerald-500">कक्ष</span>
            </h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-600 transition-colors" title="बंद आहे"></div>
        </div>
        <div class="text-center mb-2">
             <span class="text-xs text-emerald-300 uppercase tracking-widest">|| सर्वे सन्तु निरामयाः ||</span>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-[#022c22] rounded-lg p-4 mb-4 border border-emerald-900 space-y-4 shadow-inner min-h-[200px] scroll-smooth relative">
            <div class="text-emerald-300/60 text-center mt-10">
                सुरू करण्यासाठी "वैद्यजी", "आचार्य" किंवा "गुरुजी" म्हणा.<br>
                <span class="text-sm opacity-70 text-emerald-400">मी वैद्यजी आहे. मी आपल्या प्रकृतीनुसार उपचार सुचवेन.</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-emerald-900/30 p-2 rounded-xl">
            <button id="pause-resume-button" class="icon-btn bg-emerald-700 hover:bg-emerald-600" title="संभाषण थांबवा / सुरू करा (Pause)" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn bg-red-900/50 hover:bg-red-800" title="बोलणे थांबवा आणि लगेच ऐका" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>

            <button id="replay-button" class="icon-btn bg-blue-900/50 hover:bg-blue-800" title="शेवटचे उत्तर पुन्हा ऐका" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-8 h-8">
                    <path d="M8 5v14l11-7z" />
                </svg>
            </button>
        </div>

        <div class="flex flex-col gap-4 mb-4 shrink-0 w-full text-center">
            <div class="w-full">
                <label class="text-xs text-emerald-400 mb-1 block">रुग्णाचे नाव</label>
                <input type="text" id="manual-name" class="custom-input" placeholder="तुमचे नाव">
            </div>
            <div class="w-full">
                <label class="text-xs text-emerald-400 mb-1 block">वय (वर्षे)</label>
                <input type="number" id="manual-age" class="custom-input" placeholder="उदा. ३०">
            </div>
        </div>

        <div class="flex items-center justify-center gap-2 mb-2 shrink-0">
            <input type="checkbox" id="remember-me-checkbox" class="custom-checkbox">
            <label for="remember-me-checkbox" class="text-sm text-emerald-200 cursor-pointer select-none">
                माहिती लक्षात ठेवा
            </label>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0">
            <button id="advance-toggle-btn" class="text-xs text-emerald-500 hover:text-emerald-400 underline mb-2 focus:outline-none">
                ▼ प्रगत सेटिंग्ज (API Key)
            </button>

            <div id="advance-container" class="hidden w-full bg-[#064e3b] border border-emerald-800 rounded-lg p-4 flex flex-col gap-3 transition-all">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="use-custom-key-checkbox" class="custom-checkbox">
                    <label for="use-custom-key-checkbox" class="text-sm text-emerald-200 cursor-pointer select-none">
                        तुमची स्वतःची API Key वापरा
                    </label>
                </div>
                <input type="text" id="custom-api-key-input" class="custom-input text-xs w-full !w-full" placeholder="API Key येथे पेस्ट करा" disabled>
                <button id="paste-key-btn" type="button" disabled class="w-full py-2 px-4 bg-emerald-900 hover:bg-emerald-800 text-white text-xs rounded transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    पेस्ट करा
                </button>
                <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-center w-full py-2 bg-[#022c22] hover:bg-[#065f46] text-xs text-emerald-400 rounded transition-colors border border-emerald-800">
                    मोफत Google Gemini API Key मिळवा ↗
                </a>
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all duration-300 ease-in-out shrink-0
                       bg-emerald-600 text-white shadow-lg shadow-emerald-900/50
                       hover:bg-emerald-500 hover:shadow-emerald-500/50 hover:-translate-y-0.5
                       focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50
                       disabled:bg-gray-700 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0">
            सल्ला घ्या
        </button>

        <div class="mt-4 grid grid-cols-3 gap-3 shrink-0">
            <button id="restart-chat-button" class="utility-btn" disabled>पुन्हा सुरू करा</button>
            <button id="share-button" class="utility-btn bg-blue-900/50 hover:bg-blue-800">शेअर करा</button>
            <button id="end-chat-button" class="utility-btn text-red-200 hover:bg-red-900/40" disabled>थांबवा</button>
        </div>

    </div>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());

        function enterFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen(); } 
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } 
            else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
        }

        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const shareButton = document.getElementById('share-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');
        
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        // IMPORTANT: If this default key is invalid, the app will fail.
        // Users should use their own key in the Advanced Settings if needed.
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 30; 
        let chatHistory = [];
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let ignoreNextRecognition = false;
        let isGlobalPaused = false;
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;
        
        // Tracking active message for highlighting
        let currentMessageDivId = null; 
        let currentSpansMap = []; // Array of {start, end, id}

        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData(); 
            loadVoices();   
        };

        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
        });

        useCustomKeyCheckbox.addEventListener('change', () => {
            const isChecked = useCustomKeyCheckbox.checked;
            customApiKeyInput.disabled = !isChecked;
            pasteKeyBtn.disabled = !isChecked;
            saveUserData(); 
            if (isChecked) customApiKeyInput.focus();
        });

        customApiKeyInput.addEventListener('input', saveUserData);

        pasteKeyBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    customApiKeyInput.value = text;
                    saveUserData();
                    const originalText = pasteKeyBtn.innerHTML;
                    pasteKeyBtn.textContent = "पेस्ट झाले!";
                    setTimeout(() => { pasteKeyBtn.innerHTML = originalText; }, 1000);
                }
            } catch (err) { alert('पेस्ट करता आले नाही. कृपया टाईप करा.'); }
        });

        function getEffectiveApiKey() {
            if (useCustomKeyCheckbox.checked && customApiKeyInput.value.trim().length > 10) {
                return customApiKeyInput.value.trim();
            }
            return DEFAULT_API_KEY;
        }

        function loadUserData() {
            try {
                const savedName = localStorage.getItem('vaidya_userName');
                const savedAge = localStorage.getItem('vaidya_userAge');
                const savedRemember = localStorage.getItem('vaidya_remember');

                if (savedRemember === 'true') {
                    rememberMeCheckbox.checked = true;
                    if (savedName) manualNameInput.value = savedName;
                    if (savedAge) manualAgeInput.value = savedAge;
                    if (savedName) talkButton.textContent = `${savedName}, सल्ला घ्या`;
                }
                const savedUseKey = localStorage.getItem('vaidya_useCustomKey');
                const savedKey = localStorage.getItem('vaidya_customKey');

                if (savedUseKey === 'true') {
                    useCustomKeyCheckbox.checked = true;
                    customApiKeyInput.disabled = false;
                    pasteKeyBtn.disabled = false;
                    if (savedKey) customApiKeyInput.value = savedKey;
                }
            } catch (e) { console.error(e); }
        }

        function saveUserData() {
            try {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('vaidya_remember', 'true');
                    localStorage.setItem('vaidya_userName', manualNameInput.value.trim());
                    localStorage.setItem('vaidya_userAge', manualAgeInput.value.trim());
                } else {
                    localStorage.removeItem('vaidya_remember');
                    localStorage.removeItem('vaidya_userName');
                    localStorage.removeItem('vaidya_userAge');
                }
                localStorage.setItem('vaidya_useCustomKey', useCustomKeyCheckbox.checked);
                if (customApiKeyInput.value) {
                    localStorage.setItem('vaidya_customKey', customApiKeyInput.value.trim());
                }
            } catch (e) { console.error(e); }
        }

        function loadChatContext(name) {
            const key = `vaidya_history_${name.toLowerCase()}`;
            const savedHistory = localStorage.getItem(key);
            try { return savedHistory ? JSON.parse(savedHistory) : []; } catch (e) { return []; }
        }

        function saveChatContext() {
            if (!userName) return;
            const key = `vaidya_history_${userName.toLowerCase()}`;
            const limitedHistory = chatHistory.slice(-20); 
            localStorage.setItem(key, JSON.stringify(limitedHistory));
        }

        manualNameInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });
        manualAgeInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            logMessage('त्रुटी', 'हा ब्राउझर सपोर्ट करत नाही. कृपया Google Chrome वापरा.');
            talkButton.disabled = true;
        } else {
            try {
                recognition = new SpeechRecognition();
                recognition.continuous = false; 
                recognition.interimResults = false;
                recognition.lang = 'mr-IN'; 

                recognition.onresult = handleSpeechResult;
                recognition.onend = handleSpeechEnd;
                
                recognition.onerror = (event) => {
                    if (event.error === 'no-speech' && appState !== 'IDLE' && appState !== 'BUSY' && !isGlobalPaused) {
                        startRecognitionSafe();
                    } else if (event.error === 'not-allowed') {
                        setState('IDLE');
                    }
                };
            } catch (e) { alert("माईक त्रुटी: " + e.message); }
        }

        function startRecognitionSafe() {
            if (!recognition || isGlobalPaused || synth.speaking) return;
            try { recognition.start(); } catch (e) {}
        }

        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopAndListenImmediately);
        replayButton.addEventListener('click', replaySpeech);
        shareButton.addEventListener('click', shareChat);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);
        
        document.addEventListener('visibilitychange', () => {
             if (document.hidden) {
                 if (appState !== 'IDLE') {
                     activateGlobalPause();
                 }
             }
        });

        function togglePauseResume() {
            if (!isGlobalPaused) {
                activateGlobalPause();
            } else {
                resumeGlobalSession();
            }
        }

        function activateGlobalPause() {
            isGlobalPaused = true;
            synth.cancel(); 
            if (recognition) try { recognition.stop(); } catch(e){}
            pauseResumeButton.classList.remove('bg-emerald-700', 'hover:bg-emerald-600');
            pauseResumeButton.classList.add('bg-yellow-600', 'hover:bg-yellow-500', 'ring-2', 'ring-yellow-400');
            statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-600'; 
            logMessage('सिस्टम', 'संभाषण थांबवले आहे (Paused).');
        }

        function resumeGlobalSession() {
            isGlobalPaused = false;
            pauseResumeButton.classList.add('bg-emerald-700', 'hover:bg-emerald-600');
            pauseResumeButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-500', 'ring-2', 'ring-yellow-400');
            if (systemInstruction) {
                setState('CONVERSATION'); 
                startRecognitionSafe();
                logMessage('सिस्टम', 'पुन्हा सुरू (Resumed).');
            } else {
                setState('IDLE');
            }
        }

        function stopAndListenImmediately() {
            if (appState === 'IDLE') return;
            if (synth.speaking) synth.cancel();
            ignoreNextRecognition = true;
            if (recognition) try { recognition.stop(); } catch(e){}
            setTimeout(() => {
                ignoreNextRecognition = false;
                setState('CONVERSATION'); 
                logMessage('सिस्टम', 'ऐकत आहे...');
                startRecognitionSafe();
            }, 200); 
        }

        async function toggleListening() {
            if (appState === 'IDLE') {
                try { enterFullScreen(); } catch(e) {}
            }
            try {
                if (appState === 'IDLE') {
                    talkButton.textContent = "धन्वंतरी आवाहन...";
                    talkButton.disabled = true;
                    await acquireWakeLock(); 
                    
                    const inputName = manualNameInput.value.trim();
                    const inputAge = manualAgeInput.value.trim();

                    if (inputName && inputAge) {
                        userName = inputName;
                        userAge = parseInt(inputAge);
                        saveUserData(); 
                        buildSystemPrompt(); 
                        toggleMediaButtons(false);
                        const previousHistory = loadChatContext(userName);
                        
                        if (previousHistory.length > 0) {
                            chatHistory = previousHistory;
                            logMessage('सिस्टम', 'वैद्यजी तुम्हाला ओळखत आहेत...');
                            setState('BUSY');
                            const welcomeBackPrompt = "जुना रुग्ण परत आला आहे. म्हणा 'नमस्कार वैद्यजी, मला पुन्हा त्रास होत आहे.'";
                            const tempHistory = [...chatHistory, { role: 'user', parts: [{ text: welcomeBackPrompt }] }];
                            const welcomeText = await getAIResponse(tempHistory);
                            await processAndSpeak(welcomeText);
                        } else {
                            if (chatHistory.length === 0) {
                                chatHistory.push({ role: 'user', parts: [{ text: "Start session." }] });
                                chatHistory.push({ role: 'model', parts: [{ text: `नमो धन्वन्तरये नमः ${userName}.` }] });
                            }
                            const welcomeText = `नमस्कार ${userName}, मी 'वैद्यजी' आहे. आयुर्वेदाच्या प्राचीन ग्रंथांनुसार मी तुमच्या समस्यांचे निवारण करीन. तुम्हाला काय त्रास होत आहे?`;
                            setState('BUSY'); 
                            await processAndSpeak(welcomeText);
                        }
                    } else {
                        setState('LISTENING_FOR_WAKEWORD');
                        startRecognitionSafe();
                        toggleMediaButtons(false);
                        if (conversationLog.childElementCount < 3) logMessage('माहिती', '"वैद्यजी", "आचार्य" किंवा "गुरुजी" म्हणा.');
                    }
                } else {
                    setState('IDLE');
                    recognition.stop();
                    if (synth.speaking) synth.cancel();
                    await releaseWakeLock();
                }
            } catch (error) { setState('IDLE'); }
        }

        function setState(newState) {
            appState = newState;
            switch (newState) {
                case 'IDLE':
                    talkButton.textContent = 'सल्ला घ्या';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-600 transition-colors';
                    endChatButton.disabled = true;
                    toggleMediaButtons(true);
                    talkButton.classList.remove('bg-emerald-700', 'hover:bg-emerald-600');
                    talkButton.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                    manualNameInput.disabled = false;
                    manualAgeInput.disabled = false;
                    break;
                case 'BUSY':
                    talkButton.textContent = 'निदान सुरू आहे...';
                    talkButton.disabled = true;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500 transition-colors';
                    endChatButton.disabled = false;
                    break;
                default:
                    talkButton.textContent = 'ऐकणे थांबवा';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-emerald-500 listening-pulse transition-colors';
                    endChatButton.disabled = false;
                    toggleMediaButtons(false);
                    talkButton.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
                    talkButton.classList.add('bg-emerald-700', 'hover:bg-emerald-600');
                    manualNameInput.disabled = true;
                    manualAgeInput.disabled = true;
                    break;
            }
        }

        function handleSpeechEnd() {
            if (appState !== 'IDLE' && appState !== 'BUSY' && !isGlobalPaused && !synth.speaking) {
                startRecognitionSafe();
            }
            else if (appState === 'IDLE') setState('IDLE'); 
        }
        
        async function handleSpeechResult(event) {
            if (ignoreNextRecognition) return;

            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            console.log(`Heard: ${transcript}`);
            
            const currentState = appState;
            recognition.stop();
            setState('BUSY');

            try {
                switch (currentState) {
                    case 'LISTENING_FOR_WAKEWORD':
                        const t = transcript.toLowerCase();
                        if (t.includes('acharya') || t.includes('vaidya') || t.includes('guruji') || t.includes('आचार्य') || t.includes('वैद्य') || t.includes('गुरुजी')) {
                            const greeting = "नमो धन्वन्तरये नमः, मी वैद्यजी आहे. कृपया तुमचे नाव सांगा.";
                            await processAndSpeak(greeting);
                            setState('LISTENING_FOR_NAME');
                        } else {
                            setState('LISTENING_FOR_WAKEWORD');
                            startRecognitionSafe();
                        }
                        break;

                    case 'LISTENING_FOR_NAME':
                        logMessage('तुम्ही', transcript);
                        userName = await extractNameFromTranscript(transcript);
                        manualNameInput.value = userName; 
                        
                        const agePrompt = `नमस्कार ${userName}, तुमचे वय काय आहे?`;
                        await processAndSpeak(agePrompt);
                        setState('LISTENING_FOR_AGE');
                        break;

                    case 'LISTENING_FOR_AGE':
                        logMessage('तुम्ही', transcript);
                        userAge = await extractAgeFromTranscript(transcript);
                        manualAgeInput.value = userAge; 
                        saveUserData();
                        buildSystemPrompt(); 
                        const history = loadChatContext(userName);
                        if(history.length > 0) chatHistory = history;
                        const startPrompt = `उत्तम. ${userAge} वर्षांच्या वयानुसार मी आयुर्वेदाच्या दृष्टीकोनातून मार्गदर्शन करीन. सांगा, तुम्हाला कोणता त्रास किंवा व्याधी आहे?`;
                        await processAndSpeak(startPrompt);
                        setState('CONVERSATION');
                        break;

                    case 'CONVERSATION':
                        logMessage(userName || 'तुम्ही', transcript);
                        chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                        saveChatContext();
                        
                        const aiResponseText = await generateTextResponseFromChat();
                        
                        // Error handling if API fails (returns empty or error string)
                        if (!aiResponseText || aiResponseText.includes("संपर्क तुटला")) {
                            logMessage('सिस्टम', 'API त्रुटी: कृपया API KEY तपासा.');
                            await speakText("संपर्क तुटला आहे. कृपया तुमची API Key तपासा.", 'mr-IN', false);
                            return;
                        }

                        const noBracketText = cleanBrackets(aiResponseText);
                        const cleanedResponseText = cleanTextForTTS(noBracketText);
                        
                        chatHistory.push({ role: 'model', parts: [{ text: cleanedResponseText }] });
                        saveChatContext();
                        
                        await processAndSpeak(cleanedResponseText);
                        setState('CONVERSATION');
                        break;
                }
            } catch (error) {
                console.error("Critical Error", error);
                if (systemInstruction) { setState('CONVERSATION'); startRecognitionSafe(); }
                else { setState('LISTENING_FOR_WAKEWORD'); startRecognitionSafe(); }
            }
        }

        function buildSystemPrompt() {
            systemInstruction = `
                You are "Vaidyaji" (वैद्यजी), an expert in Ayurveda. User: ${userName}, Age: ${userAge}. 
                REF: Brihat Trayi, Sharangadhara, Madhava Nidana.
                RULES: PURE MARATHI. NO English. NO Brackets/symbols. Gender-neutral.
                STRUCTURE: 1. Diagnosis. 2. Sanskrit Verse (Text only). 3. Book Name. 4. Marathi Translation. 5. Remedy/Diet.
                TONE: Calm, Healing, Expert.
            `;
            restartChatButton.disabled = false;
        }

        async function getAIResponse(historyData) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: historyData, systemInstruction: { parts: [{ text: systemInstruction }] } })
                });
                const result = await response.json();
                if (result.error) {
                    console.error("API Error:", result.error);
                    return "संपर्क तुटला आहे. कृपया तुमची API Key तपासा.";
                }
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) { 
                console.error("Fetch Error:", error);
                return "संपर्क तुटला आहे. कृपया इंटरनेट तपासा."; 
            }
        }

        async function generateTextResponseFromChat() { return await getAIResponse(chatHistory); }
        async function extractNameFromTranscript(t) { return "मित्र"; } 
        async function extractAgeFromTranscript(t) { return 30; }

        function cleanBrackets(text) {
             return text.replace(/[\*\[\]\(\)<>`]/g, '').replace(/\(.*?\)/g, '').replace(/\[.*?\]/g, '').replace(/<.*?>/g, '');
        }

        function cleanTextForTTS(text) { return text.replace(/[\*#`<>]/g, '').trim(); }

        function loadVoices() {
            voices = synth.getVoices();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        function replaySpeech() {
            if (lastSpokenText) { 
                if (recognition) recognition.stop();
                setState('BUSY'); 
                // Just speak, no complex highlighting redo for simplicity in replay
                speakText(lastSpokenText, 'mr-IN', false); 
            }
        }
        
        // --- NEW: Process Text into Spans BEFORE Speaking ---
        async function processAndSpeak(text) {
            // 1. Create Div
            const div = document.createElement('div');
            const divId = 'msg-' + Date.now();
            div.id = divId;
            div.className = "mb-2"; // spacing
            
            const senderClass = 'text-emerald-500 font-bold'; 
            
            // 2. Format content into spans
            // We split by spaces to create words
            const words = text.split(' ');
            let htmlContent = '';
            let charCount = 0;
            currentSpansMap = []; // Reset map

            words.forEach((word, index) => {
                const spanId = `word-${divId}-${index}`;
                // Store start/end relative to the whole string including spaces
                const start = charCount;
                const end = charCount + word.length + 1; // +1 for space
                currentSpansMap.push({ start, end, id: spanId });
                
                htmlContent += `<span id="${spanId}" class="word-span">${word}</span> `;
                charCount += word.length + 1;
            });

            div.innerHTML = `<strong class="${senderClass}">वैद्यजी:</strong> <div class="text-emerald-50 text-lg leading-loose mt-1">${htmlContent}</div>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
            
            // Set global ID for the speaker function to find
            currentMessageDivId = divId;

            // 3. Speak
            await speakText(text, 'mr-IN', true);
        }

        function logMessage(sender, message) {
            // Standard logger for non-TTS messages or errors
            const div = document.createElement('div');
            let senderClass = 'text-emerald-300 font-semibold';
            let messageClass = 'text-white';
            if (sender === 'सिस्टम') senderClass = 'text-yellow-400 font-bold';
            
            div.innerHTML = `<strong class="${senderClass}">${sender}:</strong> <span class="${messageClass}">${message}</span>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        async function speakText(text, lang = 'mr-IN', useHighlighting = false) {
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}

            lastSpokenText = text;
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                if (useHighlighting && currentMessageDivId) {
                    utterance.onboundary = (event) => {
                        if (event.name === 'word') {
                            const charIndex = event.charIndex;
                            // Find the span that contains this charIndex
                            const match = currentSpansMap.find(s => charIndex >= s.start && charIndex < s.end);
                            
                            // Clear previous active
                            const prevActive = document.querySelectorAll(`#${currentMessageDivId} .active-word`);
                            prevActive.forEach(el => el.classList.remove('active-word'));

                            if (match) {
                                const span = document.getElementById(match.id);
                                if (span) {
                                    span.classList.add('active-word');
                                    span.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                                }
                            }
                        }
                    };
                }

                utterance.onstart = () => { if (recognition) try { recognition.stop(); } catch(e){} };
                
                utterance.onend = () => {
                     // Clear highlights on end
                     if (currentMessageDivId) {
                        const prevActive = document.querySelectorAll(`#${currentMessageDivId} .active-word`);
                        prevActive.forEach(el => el.classList.remove('active-word'));
                    }
                    if (!isGlobalPaused && appState !== 'IDLE') startRecognitionSafe();
                    resolve();
                };

                utterance.onerror = (e) => { 
                    if (!isGlobalPaused && appState !== 'IDLE') startRecognitionSafe();
                    if (e.error === 'interrupted') resolve(); else reject(e.error); 
                };

                let vedicVoice = voices.find(voice => voice.lang === 'mr-IN') || voices.find(voice => voice.lang === 'hi-IN');
                if (vedicVoice) utterance.voice = vedicVoice;
                utterance.lang = 'mr-IN'; 
                utterance.rate = 0.85; 
                utterance.pitch = 0.8; 
                synth.speak(utterance);
            });
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }

        function getChatLogAsText() {
            const messages = [];
            conversationLog.querySelectorAll('div').forEach(div => { if (div.textContent) messages.push(div.textContent); });
            return messages.join('\n');
        }

        async function shareChat() {
            const chatText = getChatLogAsText();
            if (!chatText.trim()) return;
            try { await navigator.share({ title: 'वैद्यजी सल्ला', text: chatText }); } 
            catch (err) { try { await navigator.clipboard.writeText(chatText); alert('कॉपी केले'); } catch (e) {} }
        }

        async function acquireWakeLock() {
            if ('wakeLock' in navigator) { 
                try { 
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        if (appState !== 'IDLE' && document.visibilityState === 'visible') acquireWakeLock();
                    });
                } catch (e) {} 
            }
        }

        async function releaseWakeLock() {
            if (wakeLock) { try { await wakeLock.release(); wakeLock = null; } catch (e) {} }
        }

        async function endChat() {
            appState = 'IDLE'; setState('IDLE');
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch (e) {}
            await releaseWakeLock();
            userName = ''; userAge = 30; chatHistory = []; systemInstruction = '';
            conversationLog.innerHTML = '<div class="text-gray-400 text-center">सत्र समाप्त. सर्वे सन्तु निरामयाः.</div>';
            restartChatButton.disabled = true;
            isGlobalPaused = false;
        }

        async function restartChat() {
            if (!systemInstruction) return;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}
            appState = 'IDLE'; setState('IDLE');
            await releaseWakeLock();
            conversationLog.innerHTML = '';
            if(userName) {
                localStorage.removeItem(`vaidya_history_${userName.toLowerCase()}`);
                chatHistory = [];
            }
            isGlobalPaused = false;
        }
    </script>
</body>
</html>