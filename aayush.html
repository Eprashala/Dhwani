<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aayush Dhwani Marathi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200 bg-gray-700 hover:bg-gray-600 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-30 disabled:cursor-not-allowed;
        }
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors bg-gray-700 text-white hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-800 disabled:text-gray-600 disabled:cursor-not-allowed;
        }
        .cricket-accent { color: #60a5fa; }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto">
        
        <div class="flex items-center justify-between mb-4 shrink-0">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white">
                    ‡§®‡§Æ‡§∏‡•ç‡§§‡•á <span class="cricket-accent">‡§Ü‡§Ø‡•Å‡§∑</span> üèè
                </h1>
                <p class="text-xs text-gray-400">‡§á‡§Ø‡§§‡•ç‡§§‡§æ ‡•ß‡•¶ ‡§µ‡•Ä ‚Ä¢ ‡§Æ‡§∞‡§æ‡§†‡•Ä ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ</p>
            </div>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-500 transition-colors" title="Offline"></div>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-gray-900 rounded-lg p-4 mb-4 border border-gray-700 space-y-4 shadow-inner min-h-[200px]">
            <div class="text-gray-400 text-center mt-10">
                ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏‡§æ‡§∏‡§æ‡§†‡•Ä ‡§§‡§Ø‡§æ‡§∞ ‡§Ü‡§π‡§æ‡§§?<br>
                <span class="text-sm opacity-70">‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ñ‡§æ‡§≤‡•Ä‡§≤ ‡§¨‡§ü‡§£ ‡§¶‡§æ‡§¨‡§æ.</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-gray-800/50 p-2 rounded-xl">
            <button id="pause-resume-button" class="icon-btn bg-blue-900/30 hover:bg-blue-800" disabled title="Pause/Resume">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn bg-red-900/30 hover:bg-red-800" disabled title="Stop Speaking">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>
            </button>

            <button id="replay-button" class="icon-btn bg-green-900/30 hover:bg-green-800" disabled title="Repeat Last">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
            </button>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0">
             <div class="flex items-center justify-center gap-2 mb-2">
                <input type="checkbox" id="remember-history-checkbox" class="custom-checkbox" checked>
                <label for="remember-history-checkbox" class="text-sm text-gray-300 cursor-pointer select-none">‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§Ü‡§†‡§µ‡§£‡•Ä ‡§†‡•á‡§µ‡§æ (History)</label>
            </div>
            
            <button id="advance-toggle-btn" class="text-xs text-blue-400 hover:text-blue-300 underline mb-2 focus:outline-none">‚ñº API Key Settings</button>
            <div id="advance-container" class="hidden w-full bg-gray-800/80 border border-gray-700 rounded-lg p-4 flex flex-col gap-3 transition-all">
                <input type="text" id="custom-api-key-input" class="block w-full text-center border border-gray-500 rounded-lg p-2 bg-black text-white text-xs" placeholder="Paste API Key">
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-bold transition-all duration-300 ease-in-out shrink-0 bg-blue-600 text-white shadow-lg shadow-blue-900/50 hover:bg-blue-500 hover:shadow-blue-500/50 hover:-translate-y-0.5 disabled:bg-gray-600 disabled:cursor-not-allowed">
            ‡§∏‡•Å‡§∞‡•Å ‡§ï‡§∞‡§æ (Start) üèè
        </button>

        <div class="mt-4 grid grid-cols-2 gap-3 shrink-0">
            <button id="restart-chat-button" class="utility-btn" disabled>‡§®‡§µ‡•Ä‡§® ‡§µ‡§ø‡§∑‡§Ø (New Topic)</button>
            <button id="end-chat-button" class="utility-btn text-red-200 hover:bg-red-900/40" disabled>‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ (End Chat)</button>
        </div>
    </div>

    <script>
        const DEFAULT_API_KEY = "AIzaSyDrug6WnhILDj0t_weHOOpLf0dXy-IRU9Q"; 
        
        const talkBtn = document.getElementById('talk-button');
        const statusInd = document.getElementById('status-indicator');
        const chatLog = document.getElementById('conversation-log');
        const keyInput = document.getElementById('custom-api-key-input');
        const advanceBox = document.getElementById('advance-container');
        const historyCheck = document.getElementById('remember-history-checkbox');
        
        const pauseBtn = document.getElementById('pause-resume-button');
        const stopBtn = document.getElementById('stop-speech-button');
        const replayBtn = document.getElementById('replay-button');
        const newTopicBtn = document.getElementById('restart-chat-button');
        const endChatBtn = document.getElementById('end-chat-button');

        let appState = 'IDLE'; 
        let recognition;
        let chatHistory = [];
        let synth = window.speechSynthesis;
        let voices = [];
        let lastSpokenText = "";
        let isSpeaking = false;
        let wakeLock = null;

        window.onload = () => {
            voices = synth.getVoices();
            if(synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => voices = synth.getVoices();
            if(localStorage.getItem('dhwani_key')) keyInput.value = localStorage.getItem('dhwani_key');
            initSpeechRecognition();
        };

        // --- WAKE LOCK FUNCTION ---
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Screen Wake Lock Active');
                wakeLock.addEventListener('release', () => {
                    console.log('Screen Wake Lock Released');
                });
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }
        
        // Re-acquire lock if tab becomes visible again
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Browser does not support Speech API. Use Chrome.");
                talkBtn.disabled = true;
                talkBtn.textContent = "Browser Not Supported";
                return;
            }
            const SpeechReq = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechReq();
            recognition.continuous = false;
            recognition.lang = 'mr-IN'; 
            recognition.interimResults = false;
            
            recognition.onstart = () => { 
                if(appState === 'CONVERSATION') updateButtonState('LISTENING'); 
            };
            recognition.onresult = (e) => handleSpeech(e.results[e.results.length-1][0].transcript);
            recognition.onerror = (e) => { 
                if(appState === 'CONVERSATION' && e.error === 'no-speech') {
                    try { recognition.start(); } catch(e){} 
                } else if (e.error === 'not-allowed') {
                    alert("Microphone denied.");
                    forceEndSession();
                }
            };
            recognition.onend = () => {
                if(appState === 'CONVERSATION' && !isSpeaking) { 
                    try { recognition.start(); } catch(e){} 
                } else if (appState === 'IDLE') {
                    updateButtonState('IDLE');
                }
            };
        }

        talkBtn.addEventListener('click', async () => {
            if (appState === 'IDLE') {
                try {
                    await requestWakeLock(); // Request Screen Lock
                    try { await document.documentElement.requestFullscreen(); } catch(e){}
                    
                    appState = 'BUSY';
                    updateButtonState('BUSY');
                    
                    const hasHistory = localStorage.getItem('aayush_marathi_hist');
                    let prompt = "";
                    
                    if (historyCheck.checked && hasHistory) {
                        chatHistory = JSON.parse(hasHistory);
                        prompt = "System: I am back. Greet me in Marathi about cricket (Sachin/Virat) and REVISE the last topic.";
                    } else {
                        chatHistory = [];
                        prompt = "System: Start fresh. Greet Aayush (16yo cricketer) in Marathi. Ask about practice.";
                    }

                    const response = await callGemini(prompt, true); 
                    
                    updateChat(response, 'model');
                    await speak(response);
                    
                    appState = 'CONVERSATION';
                    try { recognition.start(); } catch(e) {}
                    
                } catch (err) {
                    alert("Error: " + err.message);
                    forceEndSession();
                }
            } else {
                forceEndSession();
            }
        });

        stopBtn.addEventListener('click', () => {
            if(synth.speaking) {
                synth.cancel();
                isSpeaking = false;
                if(appState !== 'IDLE') {
                   try { recognition.start(); } catch(e){}
                }
            }
        });

        pauseBtn.addEventListener('click', () => {
            if(synth.speaking && !synth.paused) {
                synth.pause();
            } else if (synth.paused) {
                synth.resume();
            }
        });

        replayBtn.addEventListener('click', () => {
            if(lastSpokenText && !isSpeaking) {
                try { recognition.stop(); } catch(e){}
                speak(lastSpokenText).then(() => {
                    if(appState === 'CONVERSATION') try { recognition.start(); } catch(e){}
                });
            }
        });

        newTopicBtn.addEventListener('click', () => {
            synth.cancel();
            try { recognition.stop(); } catch(e){}
            chatHistory = [];
            localStorage.removeItem('aayush_marathi_hist');
            chatLog.innerHTML = '<div class="text-gray-500 text-center mb-4">‡§µ‡§ø‡§∑‡§Ø ‡§¨‡§¶‡§≤‡§≤‡§æ ‡§Ü‡§π‡•á (Topic Cleared)</div>';
            
            appState = 'BUSY';
            updateButtonState('BUSY');
            setTimeout(async () => {
                const prompt = "System: Start a brand new topic. Ask Aayush what he wants to study in Marathi.";
                const response = await callGemini(prompt, true);
                updateChat(response, 'model');
                await speak(response);
                appState = 'CONVERSATION';
                try { recognition.start(); } catch(e){}
            }, 500);
        });

        endChatBtn.addEventListener('click', forceEndSession);

        function forceEndSession() {
            appState = 'IDLE';
            try { recognition.stop(); } catch(e){}
            synth.cancel();
            isSpeaking = false;
            updateButtonState('IDLE');
            if (wakeLock !== null) {
                wakeLock.release().then(() => { wakeLock = null; });
            }
        }

        async function handleSpeech(text) {
            recognition.stop();
            appState = 'BUSY';
            updateButtonState('BUSY');
            
            updateChat(text, 'user');
            
            const response = await callGemini(text, false);
            updateChat(response, 'model');
            
            await speak(response);
            
            appState = 'CONVERSATION';
            try { recognition.start(); } catch(e){}
        }

        async function callGemini(userInput, isHidden) {
            const key = keyInput.value.trim() || DEFAULT_API_KEY;
            
            const systemInst = `
            You are "Dhwani", a kind Marathi teacher from Maharashtra.
            Student: Aayush (16 years old, 10th Std, Cricketer).
            
            **STRICT RULES:**
            1. **LANGUAGE:** SPEAK ONLY IN MARATHI (Devanagari Script).
            2. **TONE:** Use a native, caring Maharashtrian tone (e.g., "‡§Ö‡§∞‡•á ‡§¨‡§æ‡§≥‡§æ", "‡§≤‡§ï‡•ç‡§∑‡§æ‡§§ ‡§†‡•á‡§µ", "‡§∂‡§æ‡§¨‡•ç‡§¨‡§æ‡§∏").
            3. **CONTEXT:** Always relate studies to Cricket (Sachin, Virat, Joe Root).
            4. **LENGTH:** Keep answers SHORT (Maximum 3 sentences).
            5. **GOAL:** Prepare for 10th Board Exams.
            
            Do not use markdown symbols like asterisks or brackets in your response. Clean text only.
            `;

            const msgObj = { role: 'user', parts: [{ text: userInput }] };
            const payloadHistory = [...chatHistory, msgObj];

            try {
                const req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: payloadHistory,
                        systemInstruction: { parts: [{ text: systemInst }] }
                    })
                });
                
                if(!req.ok) throw new Error("API Error");
                const data = await req.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                return "‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ, ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü‡§ö‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§π‡•á. ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.";
            }
        }

        function speak(text) {
            if(synth.speaking) synth.cancel();
            isSpeaking = true;
            lastSpokenText = text;
            updateButtonState('SPEAKING'); 

            return new Promise(resolve => {
                const utt = new SpeechSynthesisUtterance(cleanText(text));
                utt.rate = 0.9; 
                
                const v = voices.find(x => x.lang === 'mr-IN') || voices.find(x => x.lang === 'hi-IN');
                if(v) utt.voice = v;
                
                utt.onend = () => {
                    isSpeaking = false;
                    resolve();
                };
                utt.onerror = () => {
                    isSpeaking = false;
                    resolve();
                };
                synth.speak(utt);
            });
        }

        function updateButtonState(state) {
            if (state === 'IDLE') {
                talkBtn.textContent = "‡§∏‡•Å‡§∞‡•Å ‡§ï‡§∞‡§æ (Start) üèè";
                talkBtn.classList.replace('bg-red-600', 'bg-blue-600');
                talkBtn.classList.replace('hover:bg-red-700', 'hover:bg-blue-500');
                statusInd.className = "w-4 h-4 rounded-full bg-gray-500";
            } else if (state === 'BUSY') {
                talkBtn.textContent = "‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...";
                statusInd.className = "w-4 h-4 rounded-full bg-yellow-400";
            } else {
                talkBtn.textContent = "‡§ê‡§ï‡§§ ‡§Ü‡§π‡•á (Stop)";
                talkBtn.classList.replace('bg-blue-600', 'bg-red-600');
                talkBtn.classList.replace('hover:bg-blue-500', 'hover:bg-red-700');
                statusInd.className = "w-4 h-4 rounded-full bg-blue-500 listening-pulse";
            }

            if (state === 'IDLE') {
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                replayBtn.disabled = true; 
                newTopicBtn.disabled = true;
                endChatBtn.disabled = true;
            } else {
                newTopicBtn.disabled = false;
                endChatBtn.disabled = false;

                if (state === 'SPEAKING') {
                    pauseBtn.disabled = false;
                    stopBtn.disabled = false;
                    replayBtn.disabled = true; 
                } else {
                    pauseBtn.disabled = true;
                    stopBtn.disabled = true;
                    replayBtn.disabled = (lastSpokenText === ""); 
                }
            }
        }

        function updateChat(text, role) {
            if (!text) return;
            const logs = chatLog.querySelectorAll('div');
            if(logs.length > 0 && logs[logs.length-1].textContent.includes("‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...")) {
                logs[logs.length-1].remove();
            }

            const div = document.createElement('div');
            const name = role === 'user' ? '‡§Ü‡§Ø‡•Å‡§∑' : '‡§ß‡•ç‡§µ‡§®‡•Ä ‡§ü‡•Ä‡§ö‡§∞';
            const color = role === 'user' ? 'text-green-400' : 'text-cyan-400';
            
            div.innerHTML = `<strong class="${color}">${name}:</strong> ${cleanText(text)}`;
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;

            if(role !== 'system') {
                chatHistory.push({ role: role, parts: [{ text: text }] });
                if(chatHistory.length > 15) chatHistory = chatHistory.slice(-15);
                localStorage.setItem('aayush_marathi_hist', JSON.stringify(chatHistory));
            }
        }

        function cleanText(t) { return t.replace(/[*#]/g, '').trim(); }

        document.getElementById('advance-toggle-btn').onclick = () => {
            advanceBox.classList.toggle('hidden');
        };
        document.getElementById('custom-api-key-input').oninput = (e) => {
            localStorage.setItem('dhwani_key', e.target.value);
        };

    </script>
</body>
</html>