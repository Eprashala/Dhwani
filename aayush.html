<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani AI Teacher for Ayush</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Pulse Animation for Mic */
        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } /* Red pulse */
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Buttons */
        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-gray-700 hover:bg-gray-600 shadow-lg border border-gray-600
                   focus:outline-none focus:ring-2 focus:ring-blue-500
                   disabled:opacity-30 disabled:cursor-not-allowed disabled:bg-gray-800;
        }
        
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-gray-700 text-white hover:bg-gray-600 border border-gray-600
                   focus:outline-none focus:ring-2 focus:ring-blue-500
                   disabled:bg-gray-800 disabled:text-gray-600 disabled:cursor-not-allowed;
        }

        .custom-checkbox {
            @apply w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600;
        }
        
        .custom-input {
            @apply block w-full border border-gray-500 rounded-lg p-3 outline-none transition-all;
            background-color: #000000 !important; 
            color: #ffffff !important;             
        }

        /* Chat bubbles */
        .msg-user { @apply bg-blue-900/40 border border-blue-800 rounded-br-none; }
        .msg-ai { @apply bg-gray-700/50 border border-gray-600 rounded-bl-none; }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto border border-gray-700">
        
        <div class="flex items-center justify-between mb-4 shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">
                    <span class="text-blue-400">Dhwani</span> AI Tutor
                </h1>
                <p class="text-xs text-gray-400">Student: <b>Ayush (10th Std)</b> | Focus: Cricket & Exams</p>
            </div>
            <div id="status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-700 text-gray-400 border border-gray-600">
                OFFLINE
            </div>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-gray-900 rounded-xl p-4 mb-4 border border-gray-700 space-y-4 shadow-inner min-h-[300px]">
            <div class="text-gray-500 text-center mt-20 text-sm">
                Tap <b>"Start Class"</b> to begin.<br>
                <span class="opacity-70 text-xs">Remember: Quality over Quantity.</span>
            </div>
        </div>

        <div class="flex justify-center gap-4 mb-4 shrink-0 bg-gray-800/80 p-3 rounded-xl border border-gray-700/50">
            
            <button id="pause-resume-button" class="icon-btn" title="Pause/Resume Speech" disabled>
                <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>
                <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" /></svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn hover:bg-red-900/50 hover:border-red-500/50" title="Stop Speaking" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>
            </button>

            <button id="repeat-button" class="icon-btn hover:bg-green-900/50 hover:border-green-500/50" title="Repeat Last Answer" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <button id="talk-button" class="w-full py-5 px-6 rounded-xl text-lg font-bold tracking-wide transition-all duration-300 ease-in-out shrink-0 mb-4
                       bg-blue-600 text-white shadow-lg shadow-blue-900/40 border border-blue-500
                       hover:bg-blue-500 hover:shadow-blue-500/60 hover:-translate-y-0.5
                       disabled:bg-gray-700 disabled:text-gray-500 disabled:border-gray-600 disabled:cursor-not-allowed disabled:shadow-none">
            Start Class
        </button>

        <div class="grid grid-cols-3 gap-2 shrink-0">
            <button id="new-topic-button" class="utility-btn bg-emerald-800/40 hover:bg-emerald-700 border-emerald-700/50" disabled>New Topic</button>
            <button id="share-button" class="utility-btn">Share Notes</button>
            <button id="end-chat-button" class="utility-btn text-red-200 bg-red-900/20 hover:bg-red-900/40 border-red-900/50" disabled>End Class</button>
        </div>

        <div class="mt-4 flex flex-col items-center">
             <button id="advance-toggle-btn" class="text-xs text-gray-500 hover:text-gray-300 mb-2">â–¼ Settings (API & Memory)</button>
             <div id="advance-container" class="hidden w-full flex-col gap-2 p-3 bg-gray-800 rounded border border-gray-700">
                <div class="flex items-center justify-between">
                    <label class="text-sm text-gray-300">Remember History</label>
                    <input type="checkbox" id="remember-history-checkbox" class="custom-checkbox" checked>
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <input type="checkbox" id="use-custom-key-checkbox" class="custom-checkbox">
                    <label class="text-xs text-gray-400">Custom API Key</label>
                </div>
                <input type="text" id="custom-api-key-input" class="custom-input text-xs" placeholder="Paste AIza..." disabled>
             </div>
        </div>

    </div>

    <script>
        /* ==========================================================================
           Dhwani AI Teacher - Ayush (10th Std)
           ========================================================================== */

        const USER_NAME = "Ayush";
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 

        // DOM Elements
        const talkBtn = document.getElementById('talk-button');
        const statusBadge = document.getElementById('status-badge');
        const chatLog = document.getElementById('conversation-log');
        
        // Media Buttons
        const pauseBtn = document.getElementById('pause-resume-button');
        const stopBtn = document.getElementById('stop-speech-button');
        const repeatBtn = document.getElementById('repeat-button');
        const iconPause = document.getElementById('icon-pause');
        const iconPlay = document.getElementById('icon-play');

        // Action Buttons
        const newTopicBtn = document.getElementById('new-topic-button');
        const endChatBtn = document.getElementById('end-chat-button');
        const shareBtn = document.getElementById('share-button');

        // Settings
        const settingsBtn = document.getElementById('advance-toggle-btn');
        const settingsPanel = document.getElementById('advance-container');
        const rememberChk = document.getElementById('remember-history-checkbox');
        const customKeyChk = document.getElementById('use-custom-key-checkbox');
        const apiKeyInput = document.getElementById('custom-api-key-input');

        // State Variables
        let isSessionActive = false; // Is the class running?
        let isMicListening = false;  // Is mic currently grabbing audio?
        let chatHistory = [];
        let recognition;
        let lastSpokenText = ''; 
        let wakeLock = null;
        const synth = window.speechSynthesis;
        let voices = [];

        // --- 1. INITIALIZATION ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadSettings();
            loadVoices();
            requestWakeLock();
        };

        // --- 2. LOGIC: BUTTON EVENTS ---

        // Start Class
        talkBtn.addEventListener('click', async () => {
            if (!isSessionActive) {
                isSessionActive = true;
                setUIState('ACTIVE');
                await requestWakeLock();
                
                // Smart Resume Logic
                const saved = rememberChk.checked ? loadChatContext() : [];
                if (saved.length > 0) {
                    chatHistory = saved;
                    appendMessage('Dhwani', "Welcome back, Ayush.");
                    await speakAndThenListen("Welcome back, Ayush. Ready to continue our session?");
                } else {
                    chatHistory = [];
                    const intro = "Hello Ayush! I know you are tired from cricket, but let's focus. Which subject specifically shall we target today?";
                    appendMessage('Dhwani', intro);
                    await speakAndThenListen(intro);
                }
            } else {
                // If clicked while active, just toggle listening if not speaking
                if (!synth.speaking) toggleMic();
            }
        });

        // New Topic (Reset)
        newTopicBtn.addEventListener('click', async () => {
            stopEverything();
            isSessionActive = true;
            chatHistory = []; // Wipe context
            chatLog.innerHTML = ''; // Wipe screen
            saveChatContext(); // Save empty state
            setUIState('ACTIVE');
            
            const freshStart = "Okay, new topic. Screen cleared. What is the next subject, Captain?";
            appendMessage('Dhwani', freshStart);
            await speakAndThenListen(freshStart);
        });

        // Repeat Last Answer
        repeatBtn.addEventListener('click', () => {
            if (!lastSpokenText) return;
            // Stop mic first to prevent feedback
            if (recognition) recognition.stop();
            // Stop current speech if any
            synth.cancel();
            // Speak text, then auto-listen
            speakAndThenListen(lastSpokenText);
        });

        // Pause/Resume Speech
        pauseBtn.addEventListener('click', () => {
            if (synth.speaking) {
                if (synth.paused) {
                    synth.resume();
                    iconPause.classList.remove('hidden');
                    iconPlay.classList.add('hidden');
                } else {
                    synth.pause();
                    iconPause.classList.add('hidden');
                    iconPlay.classList.remove('hidden');
                }
            }
        });

        // Stop Speech
        stopBtn.addEventListener('click', () => {
            synth.cancel(); // Stop talking
            if (recognition) recognition.stop(); // Stop listening
            setUIState('IDLE_WAITING'); // Update UI to show we stopped
        });

        // End Class
        endChatBtn.addEventListener('click', () => {
            stopEverything();
            isSessionActive = false;
            setUIState('OFFLINE');
            appendMessage('System', 'Class Ended.');
        });

        // Share
        shareBtn.addEventListener('click', async () => {
            const text = chatLog.innerText;
            try { await navigator.share({ title: 'Dhwani Notes', text: text }); }
            catch { navigator.clipboard.writeText(text); alert("Notes copied!"); }
        });

        // --- 3. CORE FUNCTIONS ---

        function stopEverything() {
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}
            isMicListening = false;
        }

        async function speakAndThenListen(text) {
            // 1. Ensure Mic is OFF
            if (recognition) recognition.stop();
            isMicListening = false;
            updateStatusBadge("SPEAKING", "bg-yellow-500", "text-black");
            toggleControls(true); // Enable pause/stop/repeat

            lastSpokenText = text; // Save for repeat button

            // 2. Speak
            await new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9; 
                utterance.pitch = 1.0;
                
                // Language Detection
                const isDevanagari = /[\u0900-\u097F]/.test(text);
                const langCode = isDevanagari ? 'hi-IN' : 'en-IN';
                utterance.lang = langCode;

                // Voice Selection
                const preferredVoice = voices.find(v => v.lang === langCode && v.name.includes('Google')) || voices.find(v => v.lang === langCode);
                if (preferredVoice) utterance.voice = preferredVoice;

                utterance.onend = resolve;
                utterance.onerror = resolve;

                synth.speak(utterance);
                
                // Update Pause Icon state
                iconPause.classList.remove('hidden');
                iconPlay.classList.add('hidden');
            });

            // 3. Turn Mic ON (Wait for input)
            if (isSessionActive) {
                startListening();
            }
        }

        // --- 4. SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // We want turn-taking
            recognition.interimResults = false;
            recognition.lang = 'en-IN';

            recognition.onstart = () => {
                isMicListening = true;
                updateStatusBadge("LISTENING", "bg-red-500", "text-white");
                talkBtn.classList.add('bg-red-600', 'animate-pulse');
                talkBtn.textContent = "Listening...";
                toggleControls(false); // Disable speech controls while listening
            };

            recognition.onend = () => {
                isMicListening = false;
                talkBtn.classList.remove('bg-red-600', 'animate-pulse');
                // If we didn't just end the class, and not processing, go to IDLE waiting
                if (isSessionActive && statusBadge.innerText !== "THINKING") {
                    updateStatusBadge("WAITING", "bg-green-600", "text-white");
                    talkBtn.textContent = "Tap to Speak";
                    // Note: We don't auto-restart here to give Ayush time to think. 
                    // He must tap 'Tap to Speak' or we can add auto-restart logic if preferred.
                    // For now, let's keep it manual trigger if silence to avoid loops.
                }
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript.trim();
                if (!transcript) return;

                // User spoke -> Go to Thinking State
                appendMessage('Ayush', transcript);
                chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                saveChatContext();
                
                updateStatusBadge("THINKING", "bg-blue-500", "text-white");
                talkBtn.textContent = "Dhwani is thinking...";
                
                // Get AI Answer
                const reply = await getGeminiResponse();
                
                // AI Speaks -> Then Listens
                appendMessage('Dhwani', reply);
                chatHistory.push({ role: 'model', parts: [{ text: reply }] });
                saveChatContext();
                
                await speakAndThenListen(reply);
            };
        } else {
            alert("Chrome browser required for Voice.");
        }

        function startListening() {
            if (isSessionActive && recognition && !isMicListening) {
                try { recognition.start(); } catch(e) {}
            }
        }

        function toggleMic() {
            if (isMicListening) recognition.stop();
            else startListening();
        }

        // --- 5. AI LOGIC (GEMINI) ---
        async function getGeminiResponse() {
            const key = customKeyChk.checked && apiKeyInput.value ? apiKeyInput.value : DEFAULT_API_KEY;
            const systemPrompt = `
                You are Dhwani, an expert teacher.
                Student: Ayush (16, Cricketer, 10th Std Maharashtra Board).
                Context: He is tired, has little time.
                Goal: Teach High-Yield Exam Points.
                Rules:
                1. Concise (Max 6 lines).
                2. Simple English (0.9x speed style).
                3. If asked for Hindi/Marathi, switch language.
                4. End with a short check-in question.
            `;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: chatHistory,
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await res.json();
                let text = data.candidates[0].content.parts[0].text;
                return text.replace(/[*#]/g, '').trim(); // Remove markdown
            } catch (e) {
                return "Ayush, check your internet connection.";
            }
        }

        // --- 6. UTILITIES ---
        function setUIState(state) {
            if (state === 'ACTIVE') {
                talkBtn.disabled = false;
                newTopicBtn.disabled = false;
                endChatBtn.disabled = false;
                shareBtn.disabled = false;
                updateStatusBadge("ONLINE", "bg-green-600", "text-white");
            } else if (state === 'OFFLINE') {
                talkBtn.disabled = false;
                talkBtn.textContent = "Start Class";
                talkBtn.classList.remove('bg-red-600');
                newTopicBtn.disabled = true;
                endChatBtn.disabled = true;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                repeatBtn.disabled = true;
                updateStatusBadge("OFFLINE", "bg-gray-700", "text-gray-400");
            }
        }

        function updateStatusBadge(text, bgClass, textClass) {
            statusBadge.innerText = text;
            statusBadge.className = `px-3 py-1 rounded-full text-xs font-bold border border-gray-600 ${bgClass} ${textClass}`;
        }

        function toggleControls(enable) {
            pauseBtn.disabled = !enable;
            stopBtn.disabled = !enable;
            repeatBtn.disabled = !enable;
        }

        function appendMessage(sender, text) {
            const div = document.createElement('div');
            const isAI = sender === 'Dhwani';
            div.className = `p-3 rounded-xl max-w-[85%] text-sm ${isAI ? 'msg-ai self-start mr-auto' : 'msg-user self-end ml-auto'}`;
            div.innerHTML = `<div class="font-bold text-xs mb-1 ${isAI ? 'text-cyan-300' : 'text-blue-300'}">${sender}</div>${text}`;
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Local Storage
        function saveChatContext() {
            if(rememberChk.checked) localStorage.setItem('dhwani_ayush_history', JSON.stringify(chatHistory.slice(-10)));
        }
        function loadChatContext() {
            try { return JSON.parse(localStorage.getItem('dhwani_ayush_history')) || []; } catch { return []; }
        }
        
        // Wake Lock & Settings
        async function requestWakeLock() {
            if ('wakeLock' in navigator && !wakeLock) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
        }
        document.addEventListener('click', requestWakeLock);
        
        function loadSettings() {
            if(localStorage.getItem('dhwani_key')) {
                customKeyChk.checked = true;
                apiKeyInput.disabled = false;
                apiKeyInput.value = localStorage.getItem('dhwani_key');
            }
        }
        function loadVoices() { voices = synth.getVoices(); synth.onvoiceschanged = () => voices = synth.getVoices(); }
        
        // Settings UI Events
        settingsBtn.onclick = () => settingsPanel.classList.toggle('hidden');
        customKeyChk.onchange = (e) => { apiKeyInput.disabled = !e.target.checked; if(!e.target.checked) localStorage.removeItem('dhwani_key'); };
        apiKeyInput.oninput = (e) => localStorage.setItem('dhwani_key', e.target.value);

    </script>
</body>
</html>