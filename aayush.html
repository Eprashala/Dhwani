<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani AI Teacher for Ayush</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Pulse Animation */
        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* UI Components */
        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-gray-700 hover:bg-gray-600 shadow-lg
                   focus:outline-none focus:ring-2 focus:ring-blue-500
                   disabled:opacity-40 disabled:cursor-not-allowed;
        }
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-gray-700 text-white hover:bg-gray-600
                   focus:outline-none focus:ring-2 focus:ring-blue-500
                   disabled:bg-gray-800 disabled:text-gray-600;
        }
        .custom-checkbox {
            @apply w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600;
        }
        .custom-input {
            @apply block w-full border border-gray-500 rounded-lg p-3 outline-none transition-all;
            background-color: #000000 !important; 
            color: #ffffff !important;             
            caret-color: #ffffff !important;       
        }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto">
        
        <div class="flex items-center justify-between mb-4 shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                <span class="text-blue-400">Personal Tutor</span> "Dhwani"
                <span class="text-xs block text-gray-400 font-normal mt-1">For Ayush (10th Std - Maharashtra Board)</span>
            </h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-500 transition-colors" title="Offline"></div>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-gray-900 rounded-lg p-4 mb-4 border border-gray-700 space-y-4 shadow-inner min-h-[300px]">
            <div class="text-gray-400 text-center mt-10">
                Tap <b>"Start Class"</b> to begin.<br>
                <span class="text-sm opacity-70">Focus: Exam Prep & Time Management</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-gray-800/50 p-2 rounded-xl">
            <button id="pause-resume-button" class="icon-btn bg-blue-900/30 hover:bg-blue-800" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>
            </button>
            <button id="stop-speech-button" class="icon-btn bg-red-900/30 hover:bg-red-800" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>
            </button>
        </div>

        <div class="flex flex-col items-center gap-1 mb-4 shrink-0">
            <div class="flex items-center justify-center gap-2">
                <input type="checkbox" id="remember-history-checkbox" class="custom-checkbox" checked>
                <label for="remember-history-checkbox" class="text-sm text-gray-300 cursor-pointer select-none">
                    Remember Last Session
                </label>
            </div>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0">
            <button id="advance-toggle-btn" class="text-xs text-blue-400 hover:text-blue-300 underline mb-2 focus:outline-none">
                â–¼ API Key Settings
            </button>
            <div id="advance-container" class="hidden w-full bg-gray-800/80 border border-gray-700 rounded-lg p-4 flex flex-col gap-3 transition-all">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="use-custom-key-checkbox" class="custom-checkbox">
                    <label for="use-custom-key-checkbox" class="text-sm text-gray-300 cursor-pointer">Use custom API Key</label>
                </div>
                <input type="text" id="custom-api-key-input" class="custom-input text-xs" placeholder="Paste API Key (AIza...)" disabled>
                <button id="paste-key-btn" type="button" disabled class="utility-btn py-2 text-xs">Paste from Clipboard</button>
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all duration-300 ease-in-out shrink-0
                       bg-blue-600 text-white shadow-lg shadow-blue-900/50
                       hover:bg-blue-500 hover:shadow-blue-500/50 hover:-translate-y-0.5
                       disabled:bg-gray-600 disabled:cursor-not-allowed">
            Start Class
        </button>

        <div class="mt-4 grid grid-cols-2 gap-3 shrink-0">
            <button id="share-button" class="utility-btn bg-indigo-700 hover:bg-indigo-600">Share Notes</button>
            <button id="end-chat-button" class="utility-btn text-red-200 hover:bg-red-900/40" disabled>End Class</button>
        </div>

    </div>

    <script>
        /* ==========================================================================
           Dhwani AI Teacher - Ayush Configuration
           ========================================================================== */

        // --- CONSTANTS ---
        // Requirement 3: Hardcoded User Data
        const USER_NAME = "Ayush";
        const USER_AGE = 16;
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 

        // --- DOM ELEMENTS ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const rememberHistoryCheckbox = document.getElementById('remember-history-checkbox');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const endChatButton = document.getElementById('end-chat-button');
        const shareButton = document.getElementById('share-button');
        
        // API Settings
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        // --- STATE ---
        let appState = 'IDLE'; 
        let chatHistory = []; 
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        // --- REQUIREMENT 7: SCREEN ALWAYS ON ---
        // We try to request wake lock on load, but most browsers require a gesture.
        // So we also bind it to the first click on the document.
        async function requestWakeLock() {
            if ('wakeLock' in navigator && !wakeLock) { 
                try { 
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log("Wake Lock Active: Screen will stay on.");
                } catch (e) { console.log("Wake Lock pending user gesture."); }
            }
        }
        window.addEventListener('load', requestWakeLock);
        document.addEventListener('click', requestWakeLock); // Fallback for gesture requirement

        // --- INITIALIZATION ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadSettings();
            loadVoices();
            // Start loading context if history is checked
            if (rememberHistoryCheckbox.checked) {
                const prev = loadChatContext();
                if(prev.length > 0) logMessage('System', 'History loaded ready for resume.');
            }
        };

        // --- PROMPT ENGINEERING (THE BRAIN) ---
        // Requirement 5, 6, 9: 10th Std, English Medium, Exam Focus, 0.9x speed style
        function getSystemPrompt() {
            return `
            You are "Dhwani", an expert school teacher.
            Student: Ayush, 16 years old.
            Class: 10th Standard, Maharashtra State Board (English Medium).
            Context: Ayush is a state-level CRICKET player. He is very busy and tired.
            
            TEACHING RULES:
            1. TONE: Caring, encouraging, simple. Be like a supportive coach.
            2. LANGUAGE: 
               - Default: Simple Indian English (Easy vocabulary).
               - Exception: If asked to teach Hindi, Marathi, or Sanskrit, speak ONLY in that language.
            3. CONTENT: Focus on "High Yield" points. What will come in the exam? How to score marks?
            4. LENGTH: Strictly 6-7 lines maximum per answer. Use bullet points for keywords.
            5. INTERACTION: Always end with a short question to check if he is awake/listening (e.g., "Clear, captain?", "Shall we do next point?").
            6. Do not waste time with long greetings. Get straight to the point.
            `;
        }

        // --- SPEECH RECOGNITION (THE EAR) ---
        // Requirement 5: English Medium student -> Listen for English by default
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-IN'; // Default to Indian English

            recognition.onresult = handleSpeechResult;
            recognition.onend = () => {
                if (appState !== 'IDLE' && appState !== 'BUSY') startRecognitionSafe();
                else if (appState === 'IDLE') setState('IDLE');
            };
            recognition.onerror = (e) => {
                console.log("Mic Error:", e.error);
                if (appState !== 'IDLE' && e.error !== 'not-allowed') startRecognitionSafe(); // Auto restart
            };
        } else {
            alert("Browser not supported. Please use Chrome/Edge.");
        }

        function startRecognitionSafe() {
            try { recognition.start(); } catch (e) {}
        }

        // --- MAIN WORKFLOW ---
        talkButton.addEventListener('click', async () => {
            if (appState === 'IDLE') {
                // START SESSION
                talkButton.disabled = true;
                await requestWakeLock(); // Ensure screen stays on

                // Requirement 10: Smart Greeting
                let prevHistory = rememberHistoryCheckbox.checked ? loadChatContext() : [];
                
                if (prevHistory.length > 0) {
                    chatHistory = prevHistory;
                    // Resume Context
                    logMessage('Dhwani', "Welcome back Ayush.");
                    await speakText("Welcome back Ayush. Shall we continue where we left off?", 'en-IN');
                } else {
                    // Fresh Start
                    chatHistory = [];
                    const welcome = "Hello Ayush! Ready to study? Which subject shall we tackle quickly today?";
                    logMessage('Dhwani', welcome);
                    await speakText(welcome, 'en-IN');
                }

                setState('LISTENING');
                startRecognitionSafe();
            } else {
                // STOP SESSION
                endChat();
            }
        });

        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            
            recognition.stop();
            setState('BUSY'); // Thinking
            logMessage('Ayush', transcript);

            // Add to history
            chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
            saveChatContext();

            // API Call
            const responseText = await getGeminiResponse();
            
            // Clean Text & Add to history
            const cleanResponse = cleanText(responseText);
            chatHistory.push({ role: 'model', parts: [{ text: cleanResponse }] });
            saveChatContext();

            logMessage('Dhwani', cleanResponse);

            // DETECT LANGUAGE FOR TTS
            // If the text contains Devanagari characters, switch logic slightly
            const isDevanagari = /[\u0900-\u097F]/.test(cleanResponse);
            const langCode = isDevanagari ? 'hi-IN' : 'en-IN'; // Use Hindi voice for Marathi/Hindi text if available

            await speakText(cleanResponse, langCode);
            
            setState('LISTENING');
            startRecognitionSafe();
        }

        // --- GEMINI API ---
        async function getGeminiResponse() {
            const key = useCustomKeyCheckbox.checked && customApiKeyInput.value ? customApiKeyInput.value : DEFAULT_API_KEY;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        systemInstruction: { parts: [{ text: getSystemPrompt() }] }
                    })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                return "Network issue, Ayush. Check your connection.";
            }
        }

        // --- SPEECH SYNTHESIS (THE MOUTH) ---
        function loadVoices() {
            voices = synth.getVoices();
            synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        async function speakText(text, langCode) {
            if (synth.speaking) synth.cancel();
            speechManuallyStopped = false;

            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Requirement 6: Speed 0.9x
                utterance.rate = 0.9; 
                utterance.pitch = 1.1; // Slightly higher for "Caring/Female" tone
                utterance.lang = langCode;

                // Voice Selection Logic
                // Try to find a specific Google voice for better quality if on Android/Chrome
                let preferredVoice = null;
                if (langCode === 'en-IN') {
                    preferredVoice = voices.find(v => v.lang === 'en-IN' && v.name.includes('Google')) || voices.find(v => v.lang === 'en-IN');
                } else {
                    // For Marathi/Hindi
                    preferredVoice = voices.find(v => (v.lang === 'mr-IN' || v.lang === 'hi-IN') && v.name.includes('Google')) || voices.find(v => v.lang === 'hi-IN');
                }
                if (preferredVoice) utterance.voice = preferredVoice;

                utterance.onend = () => { resolve(); toggleMediaButtons(true); };
                utterance.onerror = () => { resolve(); toggleMediaButtons(true); };
                utterance.onstart = () => { toggleMediaButtons(false); };

                synth.speak(utterance);
            });
        }

        // --- UTILS & SETTINGS ---
        function setState(state) {
            appState = state;
            if (state === 'IDLE') {
                talkButton.textContent = "Start Class";
                talkButton.classList.replace('bg-red-600', 'bg-blue-600');
                statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-500';
            } else if (state === 'BUSY') {
                talkButton.textContent = "Dhwani is thinking...";
                talkButton.disabled = true;
                statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-400';
            } else {
                talkButton.textContent = "Listening... (Tap to Stop)";
                talkButton.disabled = false;
                talkButton.classList.replace('bg-blue-600', 'bg-red-600');
                statusIndicator.className = 'w-4 h-4 rounded-full bg-blue-500 listening-pulse';
            }
        }

        function cleanText(text) {
            return text.replace(/[*#]/g, '').trim();
        }

        function logMessage(sender, msg) {
            const div = document.createElement('div');
            const color = sender === 'Dhwani' ? 'text-cyan-300' : (sender === 'System' ? 'text-gray-400' : 'text-green-300');
            div.innerHTML = `<strong class="${color}">${sender}:</strong> <span class="text-white">${msg}</span>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        // Local Storage Logic
        function saveChatContext() {
            if (rememberHistoryCheckbox.checked) {
                // Keep last 15 turns only to save space
                localStorage.setItem('ayush_chat_history', JSON.stringify(chatHistory.slice(-15)));
            }
        }
        function loadChatContext() {
            try { return JSON.parse(localStorage.getItem('ayush_chat_history')) || []; } 
            catch { return []; }
        }

        function loadSettings() {
            const savedKey = localStorage.getItem('ayush_api_key');
            if (savedKey) {
                useCustomKeyCheckbox.checked = true;
                customApiKeyInput.value = savedKey;
                customApiKeyInput.disabled = false;
                pasteKeyBtn.disabled = false;
            }
        }

        // --- EVENT LISTENERS FOR CONTROLS ---
        stopSpeechButton.addEventListener('click', () => {
            synth.cancel();
            speechManuallyStopped = true;
        });

        pauseResumeButton.addEventListener('click', () => {
            if (synth.paused) synth.resume();
            else if (synth.speaking) synth.pause();
        });

        endChatButton.addEventListener('click', endChat);
        
        function endChat() {
            setState('IDLE');
            recognition.stop();
            synth.cancel();
            logMessage('System', 'Class Ended.');
        }

        // Share
        shareButton.addEventListener('click', async () => {
            const text = conversationLog.innerText;
            try { await navigator.share({ title: 'Dhwani Notes', text: text }); }
            catch { navigator.clipboard.writeText(text); alert("Notes copied to clipboard!"); }
        });

        // Advance Settings UI
        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
        });
        useCustomKeyCheckbox.addEventListener('change', (e) => {
            customApiKeyInput.disabled = !e.target.checked;
            pasteKeyBtn.disabled = !e.target.checked;
            if(!e.target.checked) localStorage.removeItem('ayush_api_key');
        });
        customApiKeyInput.addEventListener('input', (e) => localStorage.setItem('ayush_api_key', e.target.value));
        pasteKeyBtn.addEventListener('click', async () => {
            const text = await navigator.clipboard.readText();
            if(text) { customApiKeyInput.value = text; localStorage.setItem('ayush_api_key', text); }
        });

        function toggleMediaButtons(enabled) {
            stopSpeechButton.disabled = !enabled;
            pauseResumeButton.disabled = !enabled;
        }

    </script>
</body>
</html>