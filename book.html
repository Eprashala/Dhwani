<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ध्वनी - ग्रंथ मार्गदर्शक AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Theme: Peacock (Mor-pis) */
        .peacock-bg {
            background: radial-gradient(circle at top left, #1e1b4b, #0f766e, #312e81, #020617);
            background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Animation: Listening Pulse */
        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(20, 184, 166, 0); }
            100% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); }
        }

        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-teal-700 hover:bg-teal-600 shadow-lg border border-teal-500
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-teal-900 focus:ring-teal-500
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-indigo-900 text-teal-100 border border-indigo-700
                   hover:bg-indigo-800
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-indigo-900 focus:ring-indigo-500
                   disabled:bg-indigo-950 disabled:text-indigo-400 disabled:cursor-not-allowed;
        }

        .custom-checkbox {
            @apply w-4 h-4 text-teal-600 bg-indigo-950 border-teal-700 rounded focus:ring-teal-500 focus:ring-2 ring-offset-indigo-900;
        }
        
        .custom-input {
            @apply block w-3/4 mx-auto text-center border border-teal-800 rounded-lg p-3 outline-none transition-all;
            background-color: #020617 !important;
            color: #ccfbf1 !important;
            caret-color: #14b8a6 !important;
        }
        .custom-input::placeholder {
            color: #5eead4 !important;
            opacity: 0.6 !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #0f766e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #14b8a6; }
    </style>
</head>

<body class="peacock-bg text-teal-50 flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-[#020617]/90 backdrop-blur-md rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto border-t-4 border-teal-500 border-b-4 border-indigo-600 relative">
        
        <div id="error-banner" class="hidden absolute top-2 left-2 right-2 bg-red-900/90 text-red-100 p-2 rounded text-xs text-center z-50 border border-red-500">
            त्रुटी: कृपया API Key तपासा.
        </div>

        <div class="flex items-center justify-between mb-4 shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                <span class="text-teal-400">ध्वनी</span> <span class="text-indigo-300">AI</span> <span class="text-purple-400">ग्रंथ मार्गदर्शक</span>
            </h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-600 transition-colors" title="बंद आहे"></div>
        </div>
        <div class="text-center mb-2">
             <span class="text-xs text-teal-200 uppercase tracking-widest">|| ज्ञानं परमं बलम् ||</span>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-[#0f172a]/50 rounded-lg p-4 mb-4 border border-teal-900 space-y-4 shadow-inner min-h-[200px]">
            <div class="text-teal-300/60 text-center mt-10">
                सुरू करण्यासाठी खालील बटनावर क्लिक करा.<br>
                <span class="text-sm opacity-70 text-indigo-300">मी तुम्हाला पुस्तके समजून घेण्यास मदत करेन.</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-teal-900/20 p-2 rounded-xl border border-teal-900/30">
            <button id="pause-resume-button" class="icon-btn bg-teal-700 hover:bg-teal-600" title="थांबवा/पुन्हा सुरू करा" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn bg-red-900/50 hover:bg-red-800 border-red-800" title="बोलणे थांबवा" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>

            <button id="replay-button" class="icon-btn bg-green-900/50 hover:bg-green-800 border-green-800" title="पुन्हा ऐका" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <div class="flex flex-col gap-2 mb-4 shrink-0 w-full text-center">
            <div class="w-full">
                <label class="text-xs text-teal-400 mb-1 block">वाचकाचे नाव</label>
                <input type="text" id="manual-name" class="custom-input" placeholder="तुमचे नाव">
            </div>
            <div class="w-full">
                <label class="text-xs text-teal-400 mb-1 block">वय (वर्षे)</label>
                <input type="number" id="manual-age" class="custom-input" placeholder="उदा. २५">
            </div>
            <div class="w-full">
                <label class="text-xs text-teal-400 mb-1 block">कोणते पुस्तक समजून घ्यायचे आहे?</label>
                <input type="text" id="manual-book" class="custom-input" placeholder="उदा. श्रीमद्भगवद्गीता (गीता प्रेस आवृत्ती)">
            </div>
        </div>

        <div class="flex items-center justify-center gap-2 mb-2 shrink-0">
            <input type="checkbox" id="remember-me-checkbox" class="custom-checkbox">
            <label for="remember-me-checkbox" class="text-sm text-teal-200 cursor-pointer select-none">
                माहिती लक्षात ठेवा
            </label>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0">
            <button id="advance-toggle-btn" class="text-xs text-teal-500 hover:text-teal-400 underline mb-2 focus:outline-none">
                ▼ API Key सेटिंग्स (Required)
            </button>

            <div id="advance-container" class="hidden w-full bg-[#020617] border border-teal-800 rounded-lg p-4 flex flex-col gap-3 transition-all">
                <div class="text-xs text-yellow-200 text-center mb-2">
                    महत्त्वाचे: AI चालवण्यासाठी तुमची स्वतःची API Key टाकणे आवश्यक आहे.
                </div>
                
                <input type="text" id="custom-api-key-input" class="custom-input text-xs w-full !w-full" placeholder="API Key येथे पेस्ट करा">
                
                <button id="paste-key-btn" type="button" class="w-full py-2 px-4 bg-teal-900 hover:bg-teal-800 text-white text-xs rounded transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                    </svg>
                    पेस्ट करा
                </button>

                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-center w-full py-2 bg-[#020617] hover:bg-[#1e3a8a] text-xs text-teal-400 rounded transition-colors border border-teal-800">
                    मोफत Google Gemini API Key मिळवा ↗
                </a>
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all duration-300 ease-in-out shrink-0
                       bg-gradient-to-r from-teal-600 to-indigo-600 text-white shadow-lg shadow-indigo-900/50
                       hover:from-teal-500 hover:to-indigo-500 hover:shadow-teal-500/50 hover:-translate-y-0.5
                       focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50
                       disabled:from-gray-700 disabled:to-gray-800 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0">
            ध्वनी सोबत संवाद साधा
        </button>

        <div class="mt-4 grid grid-cols-3 gap-3 shrink-0">
            <button id="restart-chat-button" class="utility-btn" disabled>पुन्हा सुरू करा</button>
            <button id="share-button" class="utility-btn bg-yellow-900/30 hover:bg-yellow-800 text-yellow-100 border-yellow-800">शेअर करा</button>
            <button id="end-chat-button" class="utility-btn text-red-200 bg-red-900/30 hover:bg-red-900/50 border-red-900" disabled>थांबवा</button>
        </div>

    </div>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- DOM Elements ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');
        
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        const manualBookInput = document.getElementById('manual-book');

        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const shareButton = document.getElementById('share-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');
        const errorBanner = document.getElementById('error-banner');
        
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        // --- State Variables ---
        let appState = 'IDLE'; // IDLE, ASKING_NAME, ASKING_AGE, ASKING_BOOK, CONVERSATION
        let userName = '';
        let userAge = ''; 
        let currentBook = '';
        let chatHistory = [];
        let systemInstruction = '';
        
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        // --- Initialization ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData(); 
            // Load voices logic (Wait for browser to load voices)
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = () => { voices = synth.getVoices(); };
            }
            voices = synth.getVoices();
        };

        // --- Event Listeners ---
        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
        });

        // Always save Key on input
        customApiKeyInput.addEventListener('input', () => {
             saveUserData();
             if(customApiKeyInput.value.length > 5) errorBanner.classList.add('hidden');
        });

        pasteKeyBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    customApiKeyInput.value = text;
                    saveUserData();
                    errorBanner.classList.add('hidden');
                    const originalText = pasteKeyBtn.innerHTML;
                    pasteKeyBtn.textContent = "पेस्ट झाले!";
                    setTimeout(() => { pasteKeyBtn.innerHTML = originalText; }, 1000);
                }
            } catch (err) { alert('पेस्ट करता आले नाही. कृपया टाईप करा.'); }
        });

        // --- Core Functions ---
        function getApiKey() {
            return customApiKeyInput.value.trim();
        }

        function showError(msg) {
            errorBanner.textContent = msg;
            errorBanner.classList.remove('hidden');
            setTimeout(() => errorBanner.classList.add('hidden'), 5000);
        }

        function loadUserData() {
            try {
                const savedName = localStorage.getItem('dhwani_userName');
                const savedAge = localStorage.getItem('dhwani_userAge');
                const savedBook = localStorage.getItem('dhwani_book');
                const savedRemember = localStorage.getItem('dhwani_remember');
                const savedKey = localStorage.getItem('dhwani_apiKey');

                if (savedKey) customApiKeyInput.value = savedKey;

                if (savedRemember === 'true') {
                    rememberMeCheckbox.checked = true;
                    if (savedName) manualNameInput.value = savedName;
                    if (savedAge) manualAgeInput.value = savedAge;
                    if (savedBook) manualBookInput.value = savedBook;
                    if (savedName) talkButton.textContent = `नमस्ते ${savedName}`;
                }
            } catch (e) { console.error(e); }
        }

        function saveUserData() {
            try {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('dhwani_remember', 'true');
                    localStorage.setItem('dhwani_userName', manualNameInput.value.trim());
                    localStorage.setItem('dhwani_userAge', manualAgeInput.value.trim());
                    localStorage.setItem('dhwani_book', manualBookInput.value.trim());
                } else {
                    localStorage.removeItem('dhwani_remember');
                    localStorage.removeItem('dhwani_userName');
                    localStorage.removeItem('dhwani_userAge');
                    localStorage.removeItem('dhwani_book');
                }
                
                if (customApiKeyInput.value) {
                    localStorage.setItem('dhwani_apiKey', customApiKeyInput.value.trim());
                }
            } catch (e) { console.error(e); }
        }

        function loadChatContext(bookName) {
            if(!bookName) return [];
            const key = `dhwani_history_${bookName.toLowerCase().replace(/\s/g, '_')}`;
            const savedHistory = localStorage.getItem(key);
            try { return savedHistory ? JSON.parse(savedHistory) : []; } catch (e) { return []; }
        }

        function saveChatContext() {
            if (!currentBook) return;
            const key = `dhwani_history_${currentBook.toLowerCase().replace(/\s/g, '_')}`;
            const limitedHistory = chatHistory.slice(-20); 
            localStorage.setItem(key, JSON.stringify(limitedHistory));
        }

        // Auto-save listeners
        manualNameInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });
        manualAgeInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });
        manualBookInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });

        // --- Speech Recognition Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            logMessage('त्रुटी', 'हा ब्राउझर सपोर्ट करत नाही. कृपया Google Chrome वापरा.');
            talkButton.disabled = true;
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = false;
            recognition.lang = 'mr-IN'; 

            recognition.onresult = handleSpeechResult;
            recognition.onend = handleSpeechEnd;
            recognition.onerror = (event) => {
                console.error("Speech Error", event.error);
                if (event.error === 'not-allowed') {
                    showError("माईकची परवानगी नाकारली आहे.");
                    setState('IDLE');
                } else if (event.error === 'no-speech' && appState !== 'IDLE' && appState !== 'BUSY') {
                    // Just restart if silent
                    try { recognition.start(); } catch(e){}
                } else {
                    setState('IDLE');
                }
            };
        }

        function startRecognitionSafe() {
            if (!recognition) return;
            try { recognition.start(); } catch (e) { console.log("Recog start failed", e); }
        }

        // --- Main Controller ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        shareButton.addEventListener('click', shareChat);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);

        async function toggleListening() {
            // Check API Key First
            const key = getApiKey();
            if(!key) {
                showError("कृपया आधी API Key टाका. (Advanced Settings)");
                advanceContainer.classList.remove('hidden');
                advanceContainer.classList.add('flex');
                customApiKeyInput.focus();
                return;
            }

            if (appState === 'IDLE') {
                try {
                    // Logic to determine what to ask based on empty inputs
                    const inpName = manualNameInput.value.trim();
                    const inpAge = manualAgeInput.value.trim();
                    const inpBook = manualBookInput.value.trim();

                    if (!inpName) {
                        const msg = "नमस्कार, मी ध्वनी. तुमचे नाव काय आहे?";
                        logMessage('ध्वनी', msg);
                        await speakText(msg);
                        setState('ASKING_NAME');
                        startRecognitionSafe();
                    } else if (!inpAge) {
                        userName = inpName; // Update global var
                        const msg = `नमस्ते ${userName}, तुमचे वय काय आहे?`;
                        logMessage('ध्वनी', msg);
                        await speakText(msg);
                        setState('ASKING_AGE');
                        startRecognitionSafe();
                    } else if (!inpBook) {
                        userName = inpName;
                        userAge = inpAge;
                        const msg = "आज तुम्हाला कोणते पुस्तक समजून घ्यायचे आहे?";
                        logMessage('ध्वनी', msg);
                        await speakText(msg);
                        setState('ASKING_BOOK');
                        startRecognitionSafe();
                    } else {
                        // All inputs present
                        userName = inpName;
                        userAge = inpAge;
                        currentBook = inpBook;
                        saveUserData();
                        buildSystemPrompt();
                        
                        // Check history
                        const history = loadChatContext(currentBook);
                        if(history.length > 0) {
                            chatHistory = history;
                            const msg = `नमस्कार ${userName}, ${currentBook} बद्दल आपण पुढे बोलूया.`;
                            logMessage('ध्वनी', msg);
                            await speakText(msg);
                        } else {
                            const msg = `नमस्कार ${userName}, तुम्हाला ${currentBook} बद्दल काय माहिती पाहिजे?`;
                            logMessage('ध्वनी', msg);
                            await speakText(msg);
                        }
                        
                        setState('CONVERSATION');
                        startRecognitionSafe();
                    }
                } catch (error) {
                    console.error(error);
                    setState('IDLE');
                }
            } else {
                // If clicked while listening, stop everything
                setState('IDLE');
                recognition.stop();
                synth.cancel();
            }
        }

        function setState(newState) {
            appState = newState;
            if (newState === 'IDLE') {
                talkButton.textContent = 'ध्वनी सोबत संवाद साधा';
                talkButton.disabled = false;
                statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-600';
                endChatButton.disabled = true;
                talkButton.classList.remove('from-teal-700', 'to-indigo-700');
                talkButton.classList.add('from-teal-600', 'to-indigo-600');
                enableInputs(true);
            } else if (newState === 'BUSY') {
                talkButton.textContent = 'विचार करत आहे...';
                talkButton.disabled = true;
                statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500';
                endChatButton.disabled = false;
            } else {
                talkButton.textContent = 'ऐकणे थांबवा';
                talkButton.disabled = false;
                statusIndicator.className = 'w-4 h-4 rounded-full bg-teal-500 listening-pulse';
                endChatButton.disabled = false;
                talkButton.classList.remove('from-teal-600', 'to-indigo-600');
                talkButton.classList.add('from-teal-700', 'to-indigo-700');
                enableInputs(false);
            }
        }

        function enableInputs(enable) {
            manualNameInput.disabled = !enable;
            manualAgeInput.disabled = !enable;
            manualBookInput.disabled = !enable;
        }

        function handleSpeechEnd() {
            if (appState !== 'IDLE' && appState !== 'BUSY') {
                startRecognitionSafe();
            } else if (appState === 'IDLE') {
                setState('IDLE'); 
            }
        }
        
        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            
            // Stop mic while processing
            recognition.stop();
            const prevState = appState;
            setState('BUSY');

            try {
                switch (prevState) {
                    case 'ASKING_NAME':
                        logMessage('तुम्ही', transcript);
                        userName = transcript;
                        manualNameInput.value = userName;
                        
                        const msgAge = `नमस्ते ${userName}, तुमचे वय काय आहे?`;
                        logMessage('ध्वनी', msgAge);
                        await speakText(msgAge);
                        setState('ASKING_AGE');
                        startRecognitionSafe();
                        break;

                    case 'ASKING_AGE':
                        logMessage('तुम्ही', transcript);
                        let extractedAge = transcript.match(/\d+/);
                        userAge = extractedAge ? parseInt(extractedAge[0]) : transcript;
                        manualAgeInput.value = userAge;

                        const msgBook = "आज तुम्हाला कोणते पुस्तक समजून घ्यायचे आहे?";
                        logMessage('ध्वनी', msgBook);
                        await speakText(msgBook);
                        setState('ASKING_BOOK');
                        startRecognitionSafe();
                        break;
                    
                    case 'ASKING_BOOK':
                        logMessage('तुम्ही', transcript);
                        currentBook = transcript;
                        manualBookInput.value = currentBook;
                        saveUserData();
                        buildSystemPrompt();

                        const msgReady = `नमस्कार ${userName}, तुम्हाला ${currentBook} बद्दल काय माहिती पाहिजे?`;
                        logMessage('ध्वनी', msgReady);
                        await speakText(msgReady);
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;

                    case 'CONVERSATION':
                        logMessage(userName || 'तुम्ही', transcript);
                        chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                        saveChatContext();

                        // Call Gemini
                        const aiResponseText = await generateTextResponseFromChat();
                        
                        if(aiResponseText.startsWith("API Error")) {
                            logMessage('सिस्टम', "API Error: कृपया Key तपासा.");
                            setState('IDLE');
                            return;
                        }

                        // Clean text
                        const cleanedText = cleanText(aiResponseText);

                        chatHistory.push({ role: 'model', parts: [{ text: cleanedText }] });
                        saveChatContext();

                        logMessage('ध्वनी', cleanedText);
                        
                        try {
                            await speakText(cleanedText);
                        } catch (error) {
                            if (error.message === "Speech manually stopped") return;
                        }
                        
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;
                }
            } catch (error) {
                console.error("Logic Error:", error);
                setState('IDLE');
            }
        }

        // --- Brain (Gemini System Prompt) ---
        function buildSystemPrompt() {
            let ageNum = parseInt(userAge);
            if (isNaN(ageNum)) ageNum = 25;

            let toneInstruction = "";
            if (ageNum < 15) {
                toneInstruction = `User is a CHILD (${ageNum} years). Explain simply like a story. Speak slowly, lovingly. Use easy Marathi examples.`;
            } else {
                toneInstruction = `User is an ADULT (${ageNum} years). Give deep, analytical, and precise explanations. Use formal/pure Marathi.`;
            }

            systemInstruction = `
                You are "Dhwani", an expert library guide and scholar.
                Current Book: "${currentBook}".
                User Name: ${userName}, Age: ${ageNum}.

                INSTRUCTIONS:
                1. Answer ONLY based on the content of the book "${currentBook}".
                2. ${toneInstruction}
                3. **CITATION RULE:** You MUST quote the exact Paragraph, Verse (Shloka), or Chapter number before explaining.
                4. **FORMATTING:** Do NOT use symbols like *, #, (), [], <>. Do NOT use shortforms.
                5. LANGUAGE: Marathi (unless user asks for Hindi/English).
                6. Keep explanation deep and core to the book's philosophy.
                
                Structure:
                - Reference: (e.g. अध्याय ४ श्लोक ७)
                - Explanation in Marathi.
            `;
            restartChatButton.disabled = false;
        }

        async function generateTextResponseFromChat() {
            const key = getApiKey();
            if(!key) return "API Error: No Key";

            // Using gemini-1.5-flash which is more stable than preview models
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                
                if(!response.ok) {
                    return "API Error: Invalid Key or Limit Reached.";
                }

                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) { 
                return "संपर्क तुटला आहे. कृपया इंटरनेट तपासा."; 
            }
        }

        function cleanText(text) {
             // Removes *, brackets, and other markdown symbols
             return text.replace(/[\*\[\]\(\)<>`]/g, '')
                        .replace(/\(.*?\)/g, '')
                        .replace(/\[.*?\]/g, '')
                        .trim();
        }

        // --- Speech Output (TTS) ---
        function speakText(text) {
            if (synth.speaking) synth.cancel();
            lastSpokenText = text;
            speechManuallyStopped = false;
            
            // Reload voices if empty
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Determine Voice
                let voice = voices.find(v => v.lang === 'mr-IN') || voices.find(v => v.lang === 'hi-IN');
                if (voice) utterance.voice = voice;
                utterance.lang = 'mr-IN'; 
                
                // Adaptive Speed
                let ageVal = parseInt(userAge);
                if (isNaN(ageVal)) ageVal = 25;
                if (ageVal < 15) {
                    utterance.rate = 0.85; 
                    utterance.pitch = 1.1;
                } else {
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                }

                // --- Safety Timeout ---
                // If the browser TTS hangs, we forcefully resolve after X seconds to prevent freezing
                const estimatedTime = (text.length * 100) + 2000; // rough calc
                const safetyTimeout = setTimeout(() => {
                    if (synth.speaking) {
                        synth.cancel();
                        resolve(); // Resolve anyway so UI unfreezes
                    }
                }, Math.max(5000, estimatedTime));

                utterance.onstart = () => { toggleMediaButtons(false); };
                utterance.onend = () => {
                    clearTimeout(safetyTimeout);
                    toggleMediaButtons(true);
                    if (speechManuallyStopped) reject(new Error("Speech manually stopped"));
                    else resolve();
                };
                utterance.onerror = (e) => { 
                    clearTimeout(safetyTimeout);
                    toggleMediaButtons(true);
                    if (e.error === 'interrupted') resolve(); else reject(e.error); 
                };
                
                synth.speak(utterance);
            });
        }

        // --- Helpers ---
        function togglePauseResume() {
            if (synth.paused) synth.resume();
            else if (synth.speaking) { synth.pause(); recognition.stop(); setState('BUSY'); }
        }

        function stopSpeech() {
            if (!synth.speaking) return;
            speechManuallyStopped = true; 
            synth.cancel(); 
            recognition.stop(); 
            toggleMediaButtons(true);
            setTimeout(() => {
                speechManuallyStopped = false;
                if (appState !== 'IDLE') {
                    setState('CONVERSATION'); 
                    startRecognitionSafe();
                }
            }, 1000);
        }

        function replaySpeech() {
            if (lastSpokenText) { recognition.stop(); setState('BUSY'); speakText(lastSpokenText); }
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }
        
        function logMessage(sender, message) {
            const div = document.createElement('div');
            let senderClass = 'text-teal-300 font-semibold';
            let messageClass = 'text-white';

            if (sender === 'ध्वनी') { senderClass = 'text-indigo-300 font-bold'; messageClass = 'text-teal-50'; }
            else if (sender === 'तुम्ही') { senderClass = 'text-green-300 font-semibold'; }
            else if (sender === 'सिस्टम') { senderClass = 'text-red-400 font-bold'; messageClass = 'text-red-200'; }

            let formattedMessage = message.replace(/\n/g, '<br>');
            
            div.innerHTML = `<strong class="${senderClass}">${sender}:</strong> <span class="${messageClass}">${formattedMessage}</span>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function getChatLogAsText() {
            const messages = [];
            conversationLog.querySelectorAll('div').forEach(div => { if (div.textContent) messages.push(div.textContent); });
            return messages.join('\n');
        }

        async function shareChat() {
            const chatText = getChatLogAsText();
            if (!chatText.trim()) return;
            try { await navigator.share({ title: 'ध्वनी संवाद', text: chatText }); } 
            catch (err) { try { await navigator.clipboard.writeText(chatText); logMessage('माहिती', 'कॉपी केले'); } catch (e) {} }
        }

        async function endChat() {
            appState = 'IDLE'; setState('IDLE');
            speechManuallyStopped = true;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch (e) {}
            
            conversationLog.innerHTML = '<div class="text-gray-400 text-center">संवाद समाप्त.</div>';
            restartChatButton.disabled = true;
        }

        async function restartChat() {
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}
            appState = 'IDLE'; setState('IDLE');
            conversationLog.innerHTML = '';
            chatHistory = [];
            logMessage('माहिती', `सत्र पुन्हा सुरू झाले.`);
        }
    </script>
</body>
</html>