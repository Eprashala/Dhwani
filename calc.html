<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #e0e0e0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: width 0.3s; }
        
        /* Display Area */
        #display-container { position: relative; background: #212121; padding: 15px; flex-shrink: 0; border-bottom: 2px solid #673AB7; }
        #display { width: 100%; height: 60px; background: transparent; color: #fff; border: none; font-size: 38px; text-align: right; box-sizing: border-box; font-family: monospace; outline: none; }
        .indicators { position: absolute; top: 10px; left: 15px; font-size: 12px; font-weight: bold; color: #FF9800; display: flex; gap: 10px; }
        
        /* Layout Grids */
        .scientific-grid { display: none; grid-template-columns: repeat(5, 1fr); gap: 1px; background: #bdbdbd; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; flex: 1; background: #bdbdbd; }
        
        body.scientific-mode { flex-direction: row; }
        body.scientific-mode .scientific-grid { display: grid; width: 330px; }
        body.scientific-mode .main-panel { width: 320px; border-left: 2px solid #673AB7; }
        
        /* Buttons */
        button { border: none; background: #fafafa; font-size: 18px; cursor: pointer; transition: background 0.1s; user-select: none; }
        button:hover { background: #e0e0e0; }
        button:active { background: #bdbdbd; }
        
        .op { background: #f3e5f5; color: #673AB7; font-weight: bold; font-size: 22px; }
        .eq { background: #673AB7; color: white; font-size: 24px; }
        .eq:hover { background: #512da8; }
        .sci-btn { background: #e3f2fd; font-size: 15px; color: #1565C0; }
        .sci-btn:hover { background: #bbdefb; }
        .control-btn { background: #4CAF50; color: white; font-weight: bold; font-size: 14px; }
        .mem-btn { background: #fff3e0; color: #e65100; font-size: 14px; font-weight: bold; }
        
        .main-panel { flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; }
        .keypad-wrapper { display: flex; flex: 1; }
    </style>
</head>
<body>

<div class="scientific-grid" id="sciPanel">
    <button class="control-btn" id="degRadBtn" onclick="toggleMode()">DEG</button>
    <button class="sci-btn" onclick="input('sin(')">sin</button>
    <button class="sci-btn" onclick="input('cos(')">cos</button>
    <button class="sci-btn" onclick="input('tan(')">tan</button>
    <button class="sci-btn" onclick="input('fact(')">x!</button>

    <button class="sci-btn" onclick="input('asin(')">sin⁻¹</button>
    <button class="sci-btn" onclick="input('acos(')">cos⁻¹</button>
    <button class="sci-btn" onclick="input('atan(')">tan⁻¹</button>
    <button class="sci-btn" onclick="input('^')">xʸ</button>
    <button class="sci-btn" onclick="input('sqrt(')">√</button>

    <button class="sci-btn" onclick="input('ln(')">ln</button>
    <button class="sci-btn" onclick="input('log(')">log</button>
    <button class="sci-btn" onclick="input('e^')">eˣ</button>
    <button class="sci-btn" onclick="input('10^')">10ˣ</button>
    <button class="sci-btn" onclick="input('cbrt(')">∛</button>

    <button class="sci-btn" onclick="input('(')">(</button>
    <button class="sci-btn" onclick="input(')')">)</button>
    <button class="sci-btn" onclick="input('^-1')">x⁻¹</button>
    <button class="sci-btn" onclick="input('%')">%</button>
    <button class="sci-btn" onclick="input('π')">π</button>

    <button class="mem-btn" onclick="memory('MC')">MC</button>
    <button class="mem-btn" onclick="memory('MR')">MR</button>
    <button class="mem-btn" onclick="memory('M+')">M+</button>
    <button class="mem-btn" onclick="memory('M-')">M-</button>
    <button class="sci-btn" onclick="input('e')">e</button>
</div>

<div class="main-panel">
    <div id="display-container">
        <div class="indicators">
            <span id="ind-angle">DEG</span>
            <span id="ind-mem"></span>
        </div>
        <input type="text" id="display" readonly value="0">
    </div>
    
    <div class="keypad-wrapper">
        <div class="grid">
            <button onclick="clearAll()" style="color:#d32f2f; font-weight:bold;">AC</button>
            <button onclick="input('/')" class="op">÷</button>
            <button onclick="input('*')" class="op">×</button>
            <button onclick="clearLast()" class="op">⌫</button>
            
            <button onclick="input('7')">7</button>
            <button onclick="input('8')">8</button>
            <button onclick="input('9')">9</button>
            <button onclick="input('-')" class="op">−</button>
            
            <button onclick="input('4')">4</button>
            <button onclick="input('5')">5</button>
            <button onclick="input('6')">6</button>
            <button onclick="input('+')" class="op">+</button>
            
            <button onclick="input('1')">1</button>
            <button onclick="input('2')">2</button>
            <button onclick="input('3')">3</button>
            <button onclick="calculate()" class="eq" style="grid-row: span 2">=</button>
            
            <button onclick="input('0')" style="grid-column: span 2">0</button>
            <button onclick="input('.')">.</button>
        </div>
    </div>
</div>

<script>
    const display = document.getElementById('display');
    const indAngle = document.getElementById('ind-angle');
    const indMem = document.getElementById('ind-mem');
    
    let expression = "";
    let isDeg = true;
    let memValue = 0;

    /* --- MATH ENGINE WRAPPERS --- */
    function calcSin(x) { return isDeg ? Math.sin(x * Math.PI / 180) : Math.sin(x); }
    function calcCos(x) { return isDeg ? Math.cos(x * Math.PI / 180) : Math.cos(x); }
    function calcTan(x) { return isDeg ? Math.tan(x * Math.PI / 180) : Math.tan(x); }
    function calcAsin(x) { return isDeg ? Math.asin(x) * 180 / Math.PI : Math.asin(x); }
    function calcAcos(x) { return isDeg ? Math.acos(x) * 180 / Math.PI : Math.acos(x); }
    function calcAtan(x) { return isDeg ? Math.atan(x) * 180 / Math.PI : Math.atan(x); }
    
    // Custom Factorial Function
    function fact(n) {
        if (n < 0 || !Number.isInteger(n)) return NaN;
        if (n === 0 || n === 1) return 1;
        let r = 1; for(let i=2; i<=n; i++) r*=i; return r;
    }

    /* --- UI CONTROLS --- */
    function toggleMode() {
        isDeg = !isDeg;
        document.getElementById('degRadBtn').innerText = isDeg ? "DEG" : "RAD";
        indAngle.innerText = isDeg ? "DEG" : "RAD";
    }

    function input(v) {
        if(expression === "0" || expression === "Error") expression = "";
        expression += v;
        updateDisplay();
    }

    function updateDisplay() {
        // Clean up code visually for the user
        display.value = expression || "0";
        // Auto-scroll to end of long equations
        display.scrollLeft = display.scrollWidth; 
    }

    function clearAll() { expression = ""; updateDisplay(); }
    function clearLast() { expression = expression.slice(0, -1); updateDisplay(); }

    function memory(action) {
        if(action === 'MC') { memValue = 0; indMem.innerText = ''; return; }
        if(action === 'MR') { input(memValue.toString()); return; }
        
        try {
            calculate(); 
            let val = parseFloat(expression);
            if(action === 'M+') memValue += val;
            if(action === 'M-') memValue -= val;
            indMem.innerText = memValue !== 0 ? 'M' : '';
        } catch(e) {}
    }

    /* --- PARSING AND CALCULATION --- */
    function calculate() {
        if(!expression) return;
        try {
            // 1. Translate symbols to JS Math logic safely
            let evalStr = expression
                .replace(/π/g, 'Math.PI')
                .replace(/e\^/g, 'Math.E**')
                .replace(/e/g, 'Math.E')
                .replace(/10\^/g, '10**')
                .replace(/\^/g, '**')
                .replace(/sin\(/g, 'calcSin(')
                .replace(/cos\(/g, 'calcCos(')
                .replace(/tan\(/g, 'calcTan(')
                .replace(/asin\(/g, 'calcAsin(')
                .replace(/acos\(/g, 'calcAcos(')
                .replace(/atan\(/g, 'calcAtan(')
                .replace(/ln\(/g, 'Math.log(')
                .replace(/log\(/g, 'Math.log10(')
                .replace(/sqrt\(/g, 'Math.sqrt(')
                .replace(/cbrt\(/g, 'Math.cbrt(')
                .replace(/fact\(/g, 'fact(')
                .replace(/%/g, '/100'); 

            // Handle Inverse Powers (x^-1)
            evalStr = evalStr.replace(/\*\*-1/g, '**(-1)');

            // 2. Evaluate
            let result = eval(evalStr);
            
            // 3. Fix floating point errors (e.g. cos(90) returning 6.12e-17 instead of 0)
            result = Math.round(result * 1e12) / 1e12;
            
            if(!isFinite(result) || isNaN(result)) throw new Error("Math Error");
            
            expression = result.toString();
            updateDisplay();
        } catch(err) {
            display.value = "Error";
            expression = "";
        }
    }

    /* --- KEYBOARD SUPPORT --- */
    document.addEventListener('keydown', (e) => {
        const key = e.key;
        if (/[0-9\.\+\-\*\/\(\)\^%]/.test(key)) {
            e.preventDefault(); input(key);
        } else if (key === 'Enter' || key === '=') {
            e.preventDefault(); calculate();
        } else if (key === 'Backspace') {
            e.preventDefault(); clearLast();
        } else if (key === 'Escape') {
            e.preventDefault(); clearAll();
        }
    });

    /* --- LMS WINDOW LISTENER --- */
    window.addEventListener('message', function(e) {
        if(e.data === 'toggle-scientific') {
            document.body.classList.add('scientific-mode');
            indAngle.style.display = 'block';
        }
        if(e.data === 'toggle-normal') {
            document.body.classList.remove('scientific-mode');
            indAngle.style.display = 'none';
        }
    });
</script>
</body>
</html>