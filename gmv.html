<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marathi TTS Selector ‚Äî Eprashala (Improved)</title>
  <style>
    :root{ --bg:#071022; --muted:#9fb0c3; --card:#071826; color-scheme: dark; }
    body{font-family:Inter, Roboto, Arial; margin:0; background:linear-gradient(180deg,#071020,#021018); color:#e6eef6; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; width:100%; max-width:920px; box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    h1{margin:0 0 8px 0; font-size:20px;}
    p.small{margin:6px 0 12px 0; color:var(--muted); font-size:13px;}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px;}
    textarea{width:100%; min-height:110px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:inherit; resize:vertical;}
    select, input[type="text"], button{padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:inherit; font-size:14px;}
    .controls{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; align-items:center;}
    .muted{color:var(--muted); font-size:13px;}
    .warning{background:#3a1b00; color:#ffd6a5; padding:8px 10px; border-radius:8px; margin-top:10px; font-size:13px;}
    .small-btn{padding:6px 8px; font-size:13px;}
    .flex-col{display:flex; flex-direction:column; gap:8px;}
    .footer{margin-top:14px; color:var(--muted); font-size:13px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .badge{font-size:12px; color:#042; background:#9ff0d4; padding:2px 6px; border-radius:6px; margin-left:6px; color:#003; }
    .voice-item {font-size:13px; padding:6px 8px; border-radius:6px; margin:4px 0; background:rgba(255,255,255,0.01);}
    .marathi{border-left:4px solid #0ea5a6; padding-left:8px;}
    .debug {margin-top:12px; font-size:13px; color:var(--muted); background:rgba(255,255,255,0.01); padding:8px; border-radius:8px;}
    @media (max-width:560px){ .controls{flex-direction:column; align-items:stretch;} }
  </style>
</head>
<body>
  <div class="card" role="main" aria-live="polite">
    <h1>Marathi TTS Selector ‚Äî Improved detection</h1>
    <p class="small">All voices detected by the browser are listed. Likely Marathi voices are pinned to the top and marked <strong>[MARATHI]</strong>. If multiple Marathi voices still don't appear here, Android/Chrome may not expose them to the WebSpeech API ‚Äî check Android Settings ‚Üí Accessibility ‚Üí Text-to-speech output.</p>

    <div class="flex-col" style="margin-bottom:12px;">
      <div>
        <label for="mr-voice-select">Choose voice (Marathi candidates shown first)</label>
        <select id="mr-voice-select" aria-label="Marathi voice selector"></select>
        <div class="muted" style="margin-top:6px;">Tip: If you know the Google TTS engine has 3 Marathi voices on your phone but only one shows here, open Android Settings ‚Üí Text-to-speech output ‚Üí Preferred engine ‚Üí select Google Text-to-speech and ensure Marathi voices are downloaded/enabled.</div>
      </div>

      <div id="mr-warning" class="warning" style="display:none;">
        No obvious Marathi voice detected. Browser will use default. Try enabling Marathi voices in Android TTS settings.
      </div>
    </div>

    <div>
      <label for="tts-text">Text to speak (Marathi)</label>
      <textarea id="tts-text" placeholder="‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ‚Äî ‡§π‡•Ä ‡§è‡§ï ‡§Ü‡§µ‡§æ‡§ú ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§Ü‡§π‡•á."></textarea>
    </div>

    <div class="controls" role="toolbar" aria-label="TTS controls">
      <button id="btn-speak" title="Speak">üîä Speak</button>
      <button id="btn-stop" class="small-btn" title="Stop speaking">‚èπ Stop</button>
      <button id="btn-preview" class="small-btn" title="Preview voice">‚ñ∂ Preview</button>
      <button id="btn-refresh" class="small-btn" title="Refresh voices">‚Üª Refresh voices</button>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <label style="margin:0; font-size:13px; color:var(--muted);">Rate</label>
        <input id="rate" type="range" min="0.5" max="1.4" step="0.05" value="0.95" />
        <label style="margin:0 0 0 6px; font-size:13px; color:var(--muted);">Pitch</label>
        <input id="pitch" type="range" min="0.6" max="1.6" step="0.05" value="1.0" />
      </div>
    </div>

    <div class="footer">
      <div>Saved voice: <code id="saved-key">‚Äî</code></div>
      <div>Browser voices: <strong id="voice-count">0</strong></div>
      <div id="match-count">Marathi candidates: 0</div>
    </div>

    <div id="debug-panel" class="debug" aria-hidden="false" style="margin-top:12px;">
      <div><strong>Top matches (confidence &rarr; 0-100):</strong></div>
      <div id="matches-list" style="margin-top:6px;"></div>
      <hr style="opacity:0.06;margin:10px 0;">
      <div><strong>Full voice list (name ‚Äî lang ‚Äî default):</strong></div>
      <div id="full-list" style="margin-top:6px; max-height:160px; overflow:auto;"></div>
    </div>
  </div>

<script>
(function(){
  const synth = window.speechSynthesis;
  const select = document.getElementById('mr-voice-select');
  const btnSpeak = document.getElementById('btn-speak');
  const btnStop = document.getElementById('btn-stop');
  const btnPreview = document.getElementById('btn-preview');
  const btnRefresh = document.getElementById('btn-refresh');
  const txt = document.getElementById('tts-text');
  const rateRange = document.getElementById('rate');
  const pitchRange = document.getElementById('pitch');
  const mrWarning = document.getElementById('mr-warning');
  const savedKeyEl = document.getElementById('saved-key');
  const voiceCountEl = document.getElementById('voice-count');
  const matchCountEl = document.getElementById('match-count');
  const matchesList = document.getElementById('matches-list');
  const fullList = document.getElementById('full-list');

  const STORAGE_KEY = 'ganesha_mr_voice';

  function getAllVoices(){ return synth.getVoices() || []; }
  function voiceIdFor(v){ return `${v.name}||${v.lang}||${v.voiceURI || ''}`; }

  // Heuristic scoring for Marathi-likelihood
  function marathiScore(v){
    // Score factors: lang contains mr -> high. name includes 'marathi' -> high.
    // voiceURI may include 'marathi' too.
    let score = 0;
    const name = (v.name||'').toLowerCase();
    const lang = (v.lang||'').toLowerCase();
    const uri = (v.voiceURI||'').toLowerCase();

    if (lang.startsWith('mr')) score += 60;
    if (lang.includes('mr-')) score += 10;
    if (name.includes('marathi')) score += 50;
    if (uri.includes('marathi')) score += 50;
    // Some device voices may be labelled 'hi' or 'en' but include marathi in the name
    if (name.includes('mr') && !name.includes('mri')) score += 8;
    // If voice.lang is en-IN but name contains "Google" and voice name contains a regional hint
    if (name.match(/google/i) && (lang.includes('in') || lang.includes('en'))) score += 5;
    // reduce duplicates
    return Math.min(100, score);
  }

  function buildVoiceLists(){
    const all = getAllVoices();
    voiceCountEl.textContent = all.length;

    // Build match list with score
    const matches = all.map(v => ({voice: v, score: marathiScore(v)}))
                       .sort((a,b) => b.score - a.score || a.voice.name.localeCompare(b.voice.name));

    // Count likely Marathi (score >= 30) ‚Äî tune threshold if needed
    const likely = matches.filter(m => m.score >= 30);
    matchCountEl.textContent = `Marathi candidates: ${likely.length}`;

    // Populate dropdown: show likely Marathi first, then full list (but avoid duplicates)
    select.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '-- Choose voice (Marathi candidates first) --';
    select.appendChild(placeholder);

    const putOption = (v, score) => {
      const opt = document.createElement('option');
      opt.value = voiceIdFor(v);
      const flag = score >= 30 ? ' [MARATHI]' : '';
      opt.textContent = `${v.name} ‚Äî ${v.lang}${flag}${v.default ? ' (default)' : ''}`;
      if (score >= 30) opt.dataset.marathi = '1';
      select.appendChild(opt);
    };

    // Add likely first
    const seen = new Set();
    likely.forEach(m => { putOption(m.voice, m.score); seen.add(voiceIdFor(m.voice)); });

    // Add remaining voices
    matches.forEach(m => {
      const id = voiceIdFor(m.voice);
      if (!seen.has(id)) { putOption(m.voice, m.score); seen.add(id); }
    });

    // Show warning if likely list empty
    mrWarning.style.display = likely.length === 0 ? 'block' : 'none';

    // Show saved selection if present
    const saved = localStorage.getItem(STORAGE_KEY) || '';
    if (saved) {
      const foundOpt = Array.from(select.options).find(o => o.value === saved);
      if (foundOpt) select.value = saved;
    }
    savedKeyEl.textContent = localStorage.getItem(STORAGE_KEY) || '‚Äî';

    // Render debug lists
    matchesList.innerHTML = '';
    const top = matches.slice(0, 8);
    top.forEach(m => {
      const d = document.createElement('div');
      d.className = 'voice-item' + (m.score >= 30 ? ' marathi' : '');
      d.textContent = `[${m.score}] ${m.voice.name} ‚Äî ${m.voice.lang} ${m.voice.default ? '(default)' : ''}`;
      matchesList.appendChild(d);
    });

    fullList.innerHTML = '';
    matches.forEach(m => {
      const d = document.createElement('div');
      d.className = 'voice-item';
      d.textContent = `${m.voice.name} ‚Äî ${m.voice.lang} ‚Äî ${m.voice.voiceURI || 'no-uri'} ${m.voice.default? '(default)':''}`;
      fullList.appendChild(d);
    });
  }

  // Save on change
  select.addEventListener('change', ()=>{
    const v = select.value;
    if (v) localStorage.setItem(STORAGE_KEY, v);
    else localStorage.removeItem(STORAGE_KEY);
    savedKeyEl.textContent = localStorage.getItem(STORAGE_KEY) || '‚Äî';
    console.log('Saved preferred Marathi voice:', v);
  });

  btnRefresh.addEventListener('click', ()=>{ buildVoiceLists(); });

  function chooseVoice(){
    const all = getAllVoices();
    const saved = localStorage.getItem(STORAGE_KEY) || '';
    if (saved) {
      const found = all.find(v => voiceIdFor(v) === saved);
      if (found) return found;
    }
    // pick highest-scoring candidate
    const scored = all.map(v => ({v, s: marathiScore(v)})).sort((a,b)=>b.s-a.s);
    if (scored.length && scored[0].s >= 30) return scored[0].v;
    // try exact mr-IN
    const exact = all.find(v => (v.lang || '').toLowerCase().startsWith('mr'));
    if (exact) return exact;
    // fallback to default or first
    return all.find(v => v.default) || all[0] || null;
  }

  function speakText(text){
    if (!text || !text.trim()) return;
    if (synth.speaking) synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    const chosen = chooseVoice();
    if (chosen) {
      try { utter.voice = chosen; console.log('Using voice:', chosen.name, chosen.lang); } catch(e){ console.warn('set voice failed', e); }
    } else console.warn('No voice chosen');
    utter.lang = 'mr-IN';
    utter.rate = parseFloat(rateRange.value) || 0.95;
    utter.pitch = parseFloat(pitchRange.value) || 1.0;
    utter.onstart = ()=>console.log('TTS start');
    utter.onend = ()=>console.log('TTS end');
    utter.onerror = (e)=>console.error('TTS err', e);
    synth.speak(utter);
  }

  btnSpeak.addEventListener('click', ()=> speakText(txt.value || txt.placeholder) );
  btnStop.addEventListener('click', ()=> { if (synth.speaking) synth.cancel(); });
  btnPreview.addEventListener('click', ()=> speakText('‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞. ‡§π‡•Ä ‡§è‡§ï ‡§Ü‡§µ‡§æ‡§ú ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§Ü‡§π‡•á.') );

  // init voices
  function initVoices(){
    // populate now (may be empty first)
    buildVoiceLists();
    // try again shortly if empty
    setTimeout(()=>{ if (getAllVoices().length === 0) buildVoiceLists(); }, 300);
  }

  if ('onvoiceschanged' in synth) {
    synth.onvoiceschanged = () => { console.log('voiceschanged'); buildVoiceLists(); };
  }

  initVoices();

  // small debug helpers
  window.__ttsDebug = { voices: ()=>getAllVoices(), choose: chooseVoice, storageKey: STORAGE_KEY, scoreFn: marathiScore };

})();
</script>
</body>
</html>
