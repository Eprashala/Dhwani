<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani AI Teacher</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #FF9800;
            --primary-dark: #F57C00;
            --bg-light: #fdfdfd;
            --text-main: #333;
            --bubble-user: #FFF3E0;
            --bubble-ai: #E3F2FD;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-light);
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--text-main);
        }
        
        /* Settings / API Key Area */
        #settings-bar {
            background: #fff;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 12px;
        }
        #apiKeyInput {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Chat History */
        #chat-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .message img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        .message.user {
            background: var(--bubble-user);
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            border: 1px solid #FFE0B2;
        }
        .message.ai {
            background: var(--bubble-ai);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #BBDEFB;
        }
        
        /* Loader */
        .typing-indicator { display: none; align-self: flex-start; padding: 10px; color: #888; font-size: 12px; font-style: italic; }

        /* Quick Prompts */
        #quick-prompts {
            display: flex;
            gap: 8px;
            padding: 10px;
            overflow-x: auto;
            background: #fff;
            border-top: 1px solid #eee;
            white-space: nowrap;
        }
        #quick-prompts::-webkit-scrollbar { height: 4px; }
        #quick-prompts::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        
        .chip {
            background: #fff;
            border: 1px solid var(--primary);
            color: var(--primary-dark);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .chip:hover {
            background: var(--primary);
            color: white;
        }

        /* Input Area */
        #input-area {
            display: flex;
            padding: 10px;
            background: #fff;
            border-top: 1px solid #ddd;
            gap: 8px;
            align-items: flex-end;
        }
        #userInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            resize: none;
            max-height: 80px;
            font-family: inherit;
        }
        #sendBtn {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        #sendBtn:hover { transform: scale(1.05); }

        /* Context Visualizer */
        #context-preview {
            display: flex;
            gap: 5px;
            padding: 0 10px;
            background: #fff;
        }
        .ctx-thumb {
            width: 30px;
            height: 30px;
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 4px;
            object-fit: cover;
        }
    </style>
</head>
<body>

    <div id="settings-bar">
        <span title="Gemini API Key">ðŸ”‘</span>
        <input type="password" id="apiKeyInput" placeholder="Enter Gemini Flash 3.0 API Key..." onchange="saveApiKey()">
    </div>

    <div id="chat-container">
        <div class="message ai" id="greetingMsg">
            Namaste! I am Dhwani, your AI Teacher. I can see your board, textbook, and video. How can I help you today?
        </div>
        <div class="typing-indicator" id="typingIndicator">Dhwani is thinking...</div>
    </div>

    <div id="context-preview"></div>

    <div id="quick-prompts">
        <button class="chip" onclick="sendQuickPrompt('Explain this portion in detail.')">Explain in detail</button>
        <button class="chip" onclick="sendQuickPrompt('Give me a real-world example of this.')">Real-world example</button>
        <button class="chip" onclick="sendQuickPrompt('Generate a brief Q&A based on what is on the screen.')">Brief Q&A</button>
        <button class="chip" onclick="sendQuickPrompt('Generate Q&A in single sentences.')">1-Sentence Q&A</button>
        <button class="chip" onclick="sendQuickPrompt('Create a fun 3-question multiple choice quiz on this topic.')">Quiz me!</button>
        <button class="chip" onclick="sendQuickPrompt('Explain this to me like a story.')">Tell a story</button>
    </div>

    <div id="input-area">
        <textarea id="userInput" rows="1" placeholder="Ask a question..." onkeydown="handleEnter(event)"></textarea>
        <button id="sendBtn" onclick="sendMessage()">âž¤</button>
    </div>

    <script>
        // --- Initialization & State ---
        let chatHistory = [];
        let studentStandard = "Unknown";
        let studentName = "Student";

        window.onload = () => {
            // Load saved API key
            const savedKey = localStorage.getItem('dhwani_gemini_key');
            if(savedKey) document.getElementById('apiKeyInput').value = savedKey;

            // Attempt to get student info from parent window (Eprashala Index.html)
            try {
                if (window.parent && window.parent.currentUser) {
                    studentName = window.parent.currentUser.name || "Student";
                    studentStandard = window.parent.currentUser.std || "Unknown";
                    document.getElementById('greetingMsg').innerText = `Namaste ${studentName}! I am Dhwani. I can see what you are studying. How can I help you today?`;
                }
            } catch (e) {
                console.warn("Could not access parent window data. Running in standalone mode.");
            }
        };

        function saveApiKey() {
            localStorage.setItem('dhwani_gemini_key', document.getElementById('apiKeyInput').value.trim());
        }

        // --- Visual Context Capture ---
        // Grabs ONLY the active learning areas, ignoring toolbars.
        function captureVisualContext() {
            let images = [];
            const previewContainer = document.getElementById('context-preview');
            previewContainer.innerHTML = ''; // Clear old thumbnails

            try {
                const parentDoc = window.parent.document;

                // 1. Capture Board Canvas
                const board = parentDoc.getElementById('boardCanvas');
                if (board && window.parent.leftPanelState > 0) { 
                    const boardData = board.toDataURL('image/jpeg', 0.8);
                    images.push({ mimeType: 'image/jpeg', data: boardData.split(',')[1], label: 'Blackboard' });
                    addThumbnail(boardData, 'Board');
                }

                // 2. Capture PDF/Viewer Canvas
                const pdf = parentDoc.getElementById('pdfRenderCanvas');
                if (pdf && pdf.style.display !== 'none' && window.parent.rightPanelState > 0) {
                    const pdfData = pdf.toDataURL('image/jpeg', 0.8);
                    images.push({ mimeType: 'image/jpeg', data: pdfData.split(',')[1], label: 'Textbook Page' });
                    addThumbnail(pdfData, 'PDF');
                }

                // 3. Capture Video Frame
                const vid = parentDoc.getElementById('mainVideo');
                if (vid && parentDoc.getElementById('videoPlayerArea').style.display !== 'none' && vid.readyState >= 2) {
                    const canvas = document.createElement('canvas');
                    canvas.width = vid.videoWidth; 
                    canvas.height = vid.videoHeight;
                    canvas.getContext('2d').drawImage(vid, 0, 0);
                    const vidData = canvas.toDataURL('image/jpeg', 0.8);
                    images.push({ mimeType: 'image/jpeg', data: vidData.split(',')[1], label: 'Video Frame' });
                    addThumbnail(vidData, 'Video');
                }

            } catch (e) {
                console.warn("Cross-origin restriction or parent elements not found.");
            }

            return images;
        }

        function addThumbnail(src, title) {
            const img = document.createElement('img');
            img.src = src;
            img.className = 'ctx-thumb';
            img.title = 'Context: ' + title;
            document.getElementById('context-preview').appendChild(img);
        }

        // --- Chat UI Logic ---
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function sendQuickPrompt(text) {
            document.getElementById('userInput').value = text;
            sendMessage();
        }

        function appendMessage(sender, text) {
            const container = document.getElementById('chat-container');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            
            // Parse Markdown for AI responses (handles links, bold, code, etc.)
            if (sender === 'ai') {
                msgDiv.innerHTML = marked.parse(text);
            } else {
                msgDiv.innerText = text;
            }
            
            // Insert before typing indicator
            container.insertBefore(msgDiv, document.getElementById('typingIndicator'));
            container.scrollTop = container.scrollHeight;
        }

        // --- Gemini API Integration ---
        async function sendMessage() {
            const inputEl = document.getElementById('userInput');
            const text = inputEl.value.trim();
            const apiKey = document.getElementById('apiKeyInput').value.trim();

            if (!text) return;
            if (!apiKey) {
                alert("Please enter your Gemini API Key at the top.");
                return;
            }

            // UI Updates
            appendMessage('user', text);
            inputEl.value = '';
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;

            // Gather context
            const visualContext = captureVisualContext();
            
            // Prepare contents payload
            let userParts = [{ text: text }];
            
            // Append images to the prompt if they exist
            visualContext.forEach(img => {
                userParts.push({
                    inlineData: {
                        mimeType: img.mimeType,
                        data: img.data
                    }
                });
            });

            // Create System Instruction ensuring Age-Appropriate responses
            const systemInstruction = `You are Dhwani, an expert AI teacher built into the Eprashala Learning Management System. 
            The student you are teaching is named ${studentName} and is in Standard/Grade: ${studentStandard}. 
            CRITICAL INSTRUCTION: You MUST adapt your vocabulary, tone, and complexity to be perfectly appropriate for a child in Standard ${studentStandard}. 
            If the standard is unknown, assume they are a middle-school student.
            You have vision capabilities and can see the student's blackboard, textbook, or video. 
            When asked to explain, generate quizzes, or summarize, base it heavily on the visual context provided.
            You can recommend YouTube searches by providing links like [Watch on YouTube](https://www.youtube.com/results?search_query=topic).
            Be encouraging, highly educational, and format your answers using clear markdown.`;

            const payload = {
                systemInstruction: { parts: [{ text: systemInstruction }] },
                contents: [...chatHistory, { role: "user", parts: userParts }],
                generationConfig: { temperature: 0.7 }
            };

            try {
                // Using gemini-2.5-flash as the standard endpoint for multimodal fast responses
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                document.getElementById('typingIndicator').style.display = 'none';

                if (data.error) {
                    appendMessage('ai', `**Error:** ${data.error.message}`);
                    return;
                }

                const aiText = data.candidates[0].content.parts[0].text;
                
                // Add to history
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });

                appendMessage('ai', aiText);

            } catch (error) {
                document.getElementById('typingIndicator').style.display = 'none';
                appendMessage('ai', `**Connection Error:** Could not reach Gemini. Please check your internet or API key.`);
                console.error(error);
            }
        }
    </script>
</body>
</html>