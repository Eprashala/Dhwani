<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani AI Teacher</title>
    <style>
        :root { --primary: #FF9800; --bg: #f4f4f9; --user-msg: #e3f2fd; --ai-msg: #fff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .title { font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .settings-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; }
        .settings-btn:hover { opacity: 0.8; }

        /* Chat Area */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .message { max-width: 85%; padding: 12px 16px; border-radius: 15px; line-height: 1.5; font-size: 15px; position: relative; animation: fadeIn 0.3s ease; }
        .message.user { align-self: flex-end; background: var(--user-msg); border-bottom-right-radius: 2px; color: #333; border: 1px solid #bbdefb; }
        .message.ai { align-self: flex-start; background: var(--ai-msg); border-bottom-left-radius: 2px; color: #222; border: 1px solid #ddd; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* Interactive Elements inside Chat */
        .ref-image { max-width: 100%; border-radius: 8px; margin-top: 5px; border: 1px solid #ddd; }

        /* Input Area */
        .input-area { background: white; padding: 10px; display: flex; gap: 10px; border-top: 1px solid #ddd; align-items: center; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ccc; outline: none; font-size: 16px; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:hover { transform: scale(1.05); }
        .icon-btn.mic.listening { background: #d32f2f; animation: pulse 1.5s infinite; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 350px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #666; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }
    </style>
</head>
<body>

<header>
    <div class="title">ü§ñ Dhwani AI <span id="grade-badge" style="font-size:12px; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:10px;">Offline</span></div>
    <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
</header>

<div id="chat-container"></div>

<div class="input-area">
    <button class="icon-btn mic" id="micBtn" onclick="toggleVoice()">üéôÔ∏è</button>
    <input type="text" id="userInput" placeholder="Type or speak (Marathi/English)..." onkeydown="if(event.key==='Enter') sendMessage()">
    <button class="icon-btn" onclick="sendMessage()">‚û§</button>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeSettings()">&times;</span>
        <h3>Settings</h3>
        <p style="font-size:13px; color:#666;">Enter Google Gemini API Key to enable AI features.</p>
        <input type="password" id="apiKeyInput" placeholder="Paste API Key here..." style="width:100%; padding:10px; margin-bottom:15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px;">
        <button onclick="saveSettings()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer; font-weight: bold;">Save & Start</button>
        <p style="font-size:11px; margin-top:15px; text-align: center;"><a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary);">Get Free Key Here</a></p>
    </div>
</div>

<script>
    // --- 1. SETTINGS & INIT ---
    // Defined at top to ensure availability
    function openSettings() { 
        document.getElementById('settingsModal').style.display = 'flex'; 
    }
    
    function closeSettings() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    function saveSettings() {
        const key = document.getElementById('apiKeyInput').value.trim();
        if (key) {
            localStorage.setItem("dhwani_api_key", key);
            API_KEY = key;
            closeSettings();
            alert("Key Saved! You can now chat.");
            // Re-run init if this is the first time
            if(chatHistory.length === 1) initChat();
        } else {
            alert("Please enter a valid key.");
        }
    }

    // --- 2. CONFIGURATION ---
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";
    let API_KEY = localStorage.getItem("dhwani_api_key");
    
    const urlParams = new URLSearchParams(window.location.search);
    const contextStr = urlParams.get('context') || "General Knowledge";
    const userName = urlParams.get('user') || "Student";
    
    const pathParts = contextStr.split('/');
    const detectedStd = pathParts.find(p => p.toLowerCase().includes('std') || p.toLowerCase().includes('class')) || "Primary";
    const detectedSub = pathParts.find(p => !p.includes('root') && !p.includes('std') && !p.includes('class')) || "General";

    const SYSTEM_PROMPT = `
    You are 'Dhwani', a kind and expert school teacher. 
    User Context: Student Name: ${userName}. Current Topic/Path: ${contextStr}.
    Standard: ${detectedStd}. Subject: ${detectedSub}.
    
    Instructions:
    1. Language: Speak primarily in Marathi, but explain complex English terms in English.
    2. Tone: Encouraging, patient, adapted to a child (10-16 years).
    3. Methodology: 
       - Explain the concept based on the textbook context (${contextStr}).
       - Give practical examples.
       - Ask a follow-up question.
       - If appropriate, offer a "Fun Fact".
    4. Formatting: Use <b>bold</b> for key terms. Break lines for readability.
    5. Multimedia: If relevant, suggest an image tag: 

[Image of X]
 at the end.
    
    Start by introducing yourself as Dhwani, acknowledging the topic (${contextStr}), and asking what they want to learn.
    `;

    let chatHistory = [
        { role: "user", parts: [{ text: SYSTEM_PROMPT }] }
    ];

    // --- 3. LIFECYCLE ---
    window.onload = () => {
        document.getElementById('grade-badge').innerText = `${detectedStd} | ${detectedSub}`;
        if (!API_KEY) {
            // Delay slightly to ensure UI is ready
            setTimeout(openSettings, 500);
        } else {
            initChat();
        }
    };

    function initChat() {
        if(chatHistory.length > 1) return; // Already started
        addMessage("ai", `Namaskar ${userName}! Mi Dhwani. <br>Aapan sadhya <b>${contextStr}</b> abhyasat aahat. <br>Tumhala ya vishaya var kay mahiti pahije?`);
    }

    // --- 4. CHAT FUNCTIONS ---
    function addMessage(role, text) {
        const div = document.createElement('div');
        div.className = `message ${role}`;
        
        let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        
        // Image Placeholder Logic
        formatted = formatted.replace(/\/g, (match, query) => {
            const safeQuery = encodeURIComponent(query);
            return `<img class="ref-image" src="https://image.pollinations.ai/prompt/${safeQuery}?width=300&height=200&nologo=true" alt="${query}">`;
        });

        div.innerHTML = formatted;
        const container = document.getElementById('chat-container');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        if (role === 'ai') speak(text.replace(/<[^>]*>?/gm, '').replace(/\/g, ''));
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;
        
        if (!API_KEY) { openSettings(); return; }

        input.value = '';
        addMessage("user", text);
        chatHistory.push({ role: "user", parts: [{ text: text }] });

        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message ai';
        loadingDiv.innerText = "Thinking...";
        loadingDiv.id = "loading-msg";
        document.getElementById('chat-container').appendChild(loadingDiv);

        try {
            const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: chatHistory })
            });
            
            const data = await response.json();
            
            if(data.error) {
                throw new Error(data.error.message);
            }

            const aiText = data.candidates[0].content.parts[0].text;
            document.getElementById('loading-msg').remove();
            
            chatHistory.push({ role: "model", parts: [{ text: aiText }] });
            addMessage("ai", aiText);

        } catch (error) {
            const loader = document.getElementById('loading-msg');
            if(loader) loader.remove();
            alert("Error: " + error.message);
            if(error.message.includes('API key')) openSettings();
        }
    }

    // --- 5. SAFE VOICE LOGIC ---
    let recognition = null;
    let isListening = false;

    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'mr-IN'; 
            recognition.continuous = false;
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                setTimeout(sendMessage, 800);
            };

            recognition.onend = () => {
                document.getElementById('micBtn').classList.remove('listening');
                isListening = false;
            };
            
            recognition.onerror = (e) => {
                console.error("Speech Error:", e.error);
                document.getElementById('micBtn').classList.remove('listening');
                isListening = false;
            };
        } else {
            console.warn("Web Speech API not supported in this browser.");
            document.getElementById('micBtn').style.display = 'none';
        }
    } catch(e) {
        console.error("Speech Init Failed", e);
        document.getElementById('micBtn').style.display = 'none';
    }

    function toggleVoice() {
        if (!recognition) { alert("Voice input not supported in this browser."); return; }
        
        if (isListening) {
            recognition.stop();
        } else {
            try {
                recognition.start();
                document.getElementById('micBtn').classList.add('listening');
                isListening = true;
            } catch(e) {
                console.error(e);
            }
        }
    }

    function speak(text) {
        if(!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        // Priority: Marathi -> Hindi -> Google Hindi -> Default
        const voice = voices.find(v => v.lang === 'mr-IN') || 
                      voices.find(v => v.lang === 'hi-IN') || 
                      voices.find(v => v.name.includes('Google Hindi'));
        if (voice) utterance.voice = voice;
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
    }
</script>

</body>
</html>