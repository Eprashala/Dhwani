<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eप्रशाला ध्वनी LMS AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font for clean readability */
        body { font-family: 'Inter', sans-serif; }
        
        /* ANIMATION: Pulse effect to show the microphone is active/listening */
        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* UI: Icon Button Styles */
        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-gray-700 hover:bg-gray-600 shadow-lg
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        /* UI: General Buttons */
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-gray-700 text-white
                   hover:bg-gray-600
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500
                   disabled:bg-gray-800 disabled:text-gray-600 disabled:cursor-not-allowed;
        }

        /* UI: Custom Checkbox */
        .custom-checkbox {
            @apply w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 focus:ring-2 ring-offset-gray-800;
        }
        
        /* UI: High Contrast Inputs */
        .custom-input {
            @apply block w-3/4 mx-auto text-center border border-gray-500 rounded-lg p-3 outline-none transition-all;
            background-color: #000000 !important; 
            color: #ffffff !important;             
            caret-color: #ffffff !important;       
        }
        .custom-input::placeholder {
            color: #9ca3af !important;
            opacity: 1 !important;
        }

        /* UI: Chapter Context Badge */
        .context-badge {
            @apply bg-blue-900/50 text-blue-200 text-xs px-3 py-1 rounded-full border border-blue-700/50 mb-2 inline-block max-w-full truncate;
        }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto">
        
        <div class="flex items-center justify-between mb-2 shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                <span class="text-blue-400">Eप्रशाला</span> LMS <span class="text-pink-500">AI</span>
            </h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-500 transition-colors" title="Offline"></div>
        </div>

        <div id="lms-context-display" class="text-center mb-2 shrink-0 hidden">
            <span id="lms-chapter-badge" class="context-badge">Loading Context...</span>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-gray-900 rounded-lg p-4 mb-4 border border-gray-700 space-y-4 shadow-inner min-h-[200px]">
            <div class="text-gray-400 text-center mt-10">
                Initializing LMS Context...<br>
                <span class="text-sm opacity-70">Please wait.</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-gray-800/50 p-2 rounded-xl">
            <button id="pause-resume-button" class="icon-btn bg-blue-900/30 hover:bg-blue-800" title="Pause/Resume" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn bg-red-900/30 hover:bg-red-800" title="Stop Speaking" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>

            <button id="replay-button" class="icon-btn bg-green-900/30 hover:bg-green-800" title="Replay Last Message" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <div id="manual-inputs-container" class="flex flex-col gap-4 mb-4 shrink-0 w-full text-center">
            <div class="w-full">
                <label class="text-xs text-gray-400 mb-1 block">Name (नाव)</label>
                <input type="text" id="manual-name" class="custom-input" placeholder="Enter Name">
            </div>
            <div class="w-full">
                <label class="text-xs text-gray-400 mb-1 block">Age (वय)</label>
                <input type="number" id="manual-age" class="custom-input" placeholder="18">
            </div>
            <div class="flex items-center justify-center gap-2 mb-2 shrink-0">
                <input type="checkbox" id="remember-me-checkbox" class="custom-checkbox">
                <label for="remember-me-checkbox" class="text-sm text-gray-300 cursor-pointer select-none">
                    Remember my Name & Age
                </label>
            </div>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0">
            <button id="advance-toggle-btn" class="text-xs text-blue-400 hover:text-blue-300 underline mb-2 focus:outline-none">
                ▼ Advance Settings (API Key)
            </button>

            <div id="advance-container" class="hidden w-full bg-gray-800/80 border border-gray-700 rounded-lg p-4 flex flex-col gap-3 transition-all">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="use-custom-key-checkbox" class="custom-checkbox">
                    <label for="use-custom-key-checkbox" class="text-sm text-gray-300 cursor-pointer select-none">
                        Use your own API Key (Faster & better)
                    </label>
                </div>
                <input type="text" id="custom-api-key-input" class="custom-input text-xs w-full !w-full" placeholder="Paste your API Key here (AIza...)" disabled>
                <button id="paste-key-btn" type="button" disabled class="w-full py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white text-xs rounded transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    Paste API Key
                </button>
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all duration-300 ease-in-out shrink-0
                       bg-blue-600 text-white shadow-lg shadow-blue-900/50
                       hover:bg-blue-500 hover:shadow-blue-500/50 hover:-translate-y-0.5
                       focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50
                       disabled:bg-gray-600 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0">
            Start Listening
        </button>

        <div class="mt-4 grid grid-cols-3 gap-3 shrink-0">
            <button id="restart-chat-button" class="utility-btn" disabled>Restart</button>
            <button id="share-button" class="utility-btn bg-indigo-700 hover:bg-indigo-600">Share</button>
            <button id="end-chat-button" class="utility-btn text-red-200 hover:bg-red-900/40" disabled>End</button>
        </div>

    </div>

    <script>
        /* ==========================================================================
           LOGIC SECTION: Eprashala LMS Integration
           ========================================================================== */

        // --- DOM ELEMENTS ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const manualInputsContainer = document.getElementById('manual-inputs-container');
        const lmsContextDisplay = document.getElementById('lms-context-display');
        const lmsChapterBadge = document.getElementById('lms-chapter-badge');
        
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');
        
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const shareButton = document.getElementById('share-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');
        
        // Advance Settings
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        // --- CONFIGURATION & STATE ---
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 18;
        let lmsData = null; // Will hold { medium, standard, subject, chapter }
        let chatHistory = []; 
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        // --- INITIALIZATION ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData(); // Load local storage settings
            loadVoices();   // Load voices
            
            // LMS: Parse URL Parameters
            parseLMSParameters();
        };

        // --- LMS INTEGRATION LOGIC ---
        function parseLMSParameters() {
            try {
                const params = new URLSearchParams(window.location.search);
                const userParam = params.get('user');
                const contextParam = params.get('context'); // encoded file path

                if (userParam && contextParam) {
                    // 1. Set User Name
                    userName = userParam;
                    manualNameInput.value = userName;
                    
                    // 2. Decode Context Path
                    // Example: file:///D:/Eprashala_LMS/English%20Medium/Std02/Maths/11.%20Let's%20count%20numbers%20in%20steps.mp4
                    const decodedPath = decodeURIComponent(contextParam);
                    const parts = decodedPath.split(/[/\\]/); // Split by / or \

                    // Basic extraction based on typical directory structure
                    // Last part is filename (Chapter), before that Subject, before that Std, before that Medium
                    const fileName = parts[parts.length - 1];
                    const subject = parts[parts.length - 2];
                    const standardStr = parts[parts.length - 3]; // e.g., "Std02"
                    const medium = parts[parts.length - 4];

                    // Clean Chapter Name (Remove "11. " and ".mp4")
                    let chapterName = fileName.replace(/\.mp4$/i, '').replace(/\.pdf$/i, '').replace(/\.html$/i, '');
                    // Remove leading numbers like "11. " or "01 "
                    chapterName = chapterName.replace(/^\d+[\.\s]+/, '');

                    // Calculate Age from Standard (Std 1 = 6 years, Std 2 = 7 years, etc.)
                    // Formula: Age = Standard + 5
                    let standardNum = parseInt(standardStr.replace(/\D/g, '')); // Extract digits from "Std02"
                    if (isNaN(standardNum)) standardNum = 1; // Default
                    userAge = standardNum + 5;
                    manualAgeInput.value = userAge;

                    lmsData = {
                        medium: medium,
                        standard: standardStr,
                        subject: subject,
                        chapter: chapterName
                    };

                    // UI Updates for LMS Mode
                    manualInputsContainer.classList.add('hidden'); // Hide manual inputs
                    lmsContextDisplay.classList.remove('hidden');
                    lmsChapterBadge.textContent = `${subject} | ${chapterName}`;
                    conversationLog.innerHTML = `<div class="text-center text-green-400 mt-10">
                        Hello <b>${userName}</b>!<br>
                        Ready to learn <b>${chapterName}</b>.
                        <br><span class="text-sm text-gray-400">Press Start Listening</span>
                    </div>`;
                    talkButton.textContent = `Start Class`;

                } else {
                    // Fallback to manual mode
                    conversationLog.innerHTML = `<div class="text-gray-400 text-center mt-10">Press Start to begin.</div>`;
                }
            } catch (e) {
                console.error("LMS Parsing Error:", e);
                conversationLog.innerHTML = `<div class="text-red-400 text-center mt-10">LMS Context Error. Using Manual Mode.</div>`;
            }
        }

        // --- UI HANDLERS ---
        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
            const isHidden = advanceContainer.classList.contains('hidden');
            advanceToggleBtn.textContent = isHidden ? "▼ Advance Settings (API Key)" : "▲ Hide Settings";
        });

        useCustomKeyCheckbox.addEventListener('change', () => {
            const isChecked = useCustomKeyCheckbox.checked;
            customApiKeyInput.disabled = !isChecked;
            pasteKeyBtn.disabled = !isChecked;
            saveUserData(); 
            if (isChecked) customApiKeyInput.focus();
        });

        customApiKeyInput.addEventListener('input', saveUserData);

        pasteKeyBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    customApiKeyInput.value = text;
                    saveUserData();
                    const originalText = pasteKeyBtn.innerHTML;
                    pasteKeyBtn.textContent = "Pasted!";
                    setTimeout(() => { pasteKeyBtn.innerHTML = originalText; }, 1000);
                }
            } catch (err) { alert('Could not paste. Type manually.'); }
        });

        function getEffectiveApiKey() {
            if (useCustomKeyCheckbox.checked && customApiKeyInput.value.trim().length > 10) {
                return customApiKeyInput.value.trim();
            }
            return DEFAULT_API_KEY;
        }

        // --- STORAGE ---
        function loadUserData() {
            try {
                const savedRemember = localStorage.getItem('dhwani_remember');
                if (savedRemember === 'true') {
                    rememberMeCheckbox.checked = true;
                    manualNameInput.value = localStorage.getItem('dhwani_userName') || '';
                    manualAgeInput.value = localStorage.getItem('dhwani_userAge') || '18';
                }
                const savedUseKey = localStorage.getItem('dhwani_useCustomKey');
                if (savedUseKey === 'true') {
                    useCustomKeyCheckbox.checked = true;
                    customApiKeyInput.disabled = false;
                    pasteKeyBtn.disabled = false;
                    customApiKeyInput.value = localStorage.getItem('dhwani_customKey') || '';
                }
            } catch (e) {}
        }

        function saveUserData() {
            try {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('dhwani_remember', 'true');
                    localStorage.setItem('dhwani_userName', manualNameInput.value.trim());
                    localStorage.setItem('dhwani_userAge', manualAgeInput.value.trim());
                } else {
                    localStorage.removeItem('dhwani_remember');
                }
                localStorage.setItem('dhwani_useCustomKey', useCustomKeyCheckbox.checked);
                if (customApiKeyInput.value) localStorage.setItem('dhwani_customKey', customApiKeyInput.value.trim());
            } catch (e) {}
        }

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { talkButton.disabled = true; alert("Browser not supported. Use Chrome."); }
        else {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            // Default to English for LMS/English Medium
            recognition.lang = 'en-IN'; 

            recognition.onresult = handleSpeechResult;
            recognition.onend = handleSpeechEnd;
            recognition.onerror = (event) => {
                if (event.error === 'no-speech' && appState !== 'IDLE' && appState !== 'BUSY') startRecognitionSafe();
                else if (event.error === 'not-allowed') setState('IDLE');
            };
        }

        function startRecognitionSafe() {
            if (!recognition) return;
            try { recognition.start(); } catch (e) {}
        }

        // --- MAIN INTERACTION FLOW ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        shareButton.addEventListener('click', shareChat);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);
        document.addEventListener('visibilitychange', handleVisibilityChange);

        async function toggleListening() {
            if (appState === 'IDLE') {
                try { document.documentElement.requestFullscreen(); } catch(e) {}

                // Initialize
                if (!userName) userName = manualNameInput.value.trim();
                if (!userAge) userAge = parseInt(manualAgeInput.value.trim()) || 18;

                if (!userName) { alert("Please enter your name first."); return; }

                buildSystemPrompt(); 
                
                // If coming from LMS, skip the "What is your name?" loop
                if (lmsData) {
                    const welcomeText = `Namaskar ${userName}, how can I help you with this chapter: ${lmsData.chapter}?`;
                    logMessage('Dhwani', welcomeText);
                    setState('BUSY');
                    await speakText(welcomeText, 'en-IN'); // Greet in English
                    setState('CONVERSATION');
                    startRecognitionSafe();
                } else {
                    // Regular Loop
                    const welcomeText = `Hello ${userName}, I am ready. Ask me anything.`;
                    logMessage('Dhwani', welcomeText);
                    setState('BUSY');
                    await speakText(welcomeText, 'en-IN');
                    setState('CONVERSATION');
                    startRecognitionSafe();
                }
            } else {
                setState('IDLE');
                recognition.stop();
                if (synth.speaking) synth.cancel();
                await releaseWakeLock();
            }
        }

        function setState(newState) {
            appState = newState;
            switch (newState) {
                case 'IDLE':
                    talkButton.textContent = lmsData ? 'Start Class' : 'Start Listening';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-500 transition-colors';
                    endChatButton.disabled = true;
                    talkButton.className = "w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all bg-blue-600 text-white shadow-lg shadow-blue-900/50 hover:bg-blue-500";
                    break;
                case 'BUSY':
                    talkButton.textContent = 'Thinking...';
                    talkButton.disabled = true;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-400 transition-colors';
                    endChatButton.disabled = false;
                    break;
                default: // LISTENING
                    talkButton.textContent = 'Listening... (Tap to Stop)';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-blue-500 listening-pulse transition-colors';
                    endChatButton.disabled = false;
                    talkButton.className = "w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all bg-red-600 text-white shadow-lg shadow-red-900/50 hover:bg-red-500";
                    break;
            }
        }

        function handleSpeechEnd() {
            if (appState !== 'IDLE' && appState !== 'BUSY') startRecognitionSafe();
            else if (appState === 'IDLE') setState('IDLE'); 
        }
        
        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            
            recognition.stop(); 
            setState('BUSY');

            logMessage(userName, transcript);
            chatHistory.push({ role: 'user', parts: [{ text: transcript }] });

            const aiResponseText = await getAIResponse(chatHistory);
            const cleanedResponseText = cleanTextForTTS(aiResponseText);

            chatHistory.push({ role: 'model', parts: [{ text: cleanedResponseText }] });
            logMessage('Dhwani', cleanedResponseText);
            
            try {
                // DETECT LANGUAGE OF RESPONSE TO SWITCH VOICE
                // If response contains Devanagari, use Marathi voice/lang, else English
                const hasDevanagari = /[\u0900-\u097F]/.test(cleanedResponseText);
                const langToUse = hasDevanagari ? 'mr-IN' : 'en-IN';
                
                await speakText(cleanedResponseText, langToUse);
            } catch (error) { if (error.message !== "Speech manually stopped") console.error(error); }
            
            setState('CONVERSATION');
            startRecognitionSafe();
        }

        // --- AI LOGIC ---
        function buildSystemPrompt() {
            // DYNAMIC AGE/LENGTH INSTRUCTIONS
            let tone = "";
            let length = "";
            let depth = "";

            if (userAge <= 10) {
                // Primary School (Std 1-4)
                tone = "You are a very kind, polite, grandmotherly AI teacher. Speak softly.";
                length = "STRICT: Keep answers extremely short (2-3 sentences max).";
                depth = "Use simple analogies (like toys, chocolates, games).";
            } else if (userAge <= 14) {
                // Middle School (Std 5-8)
                tone = "You are an encouraging and energetic teacher.";
                length = "Keep answers concise (4-5 sentences).";
                depth = "Explain concepts clearly with one real-world example.";
            } else {
                // High School +
                tone = "You are an expert subject matter expert. Professional and direct.";
                length = "Provide detailed but structured answers.";
                depth = "Go deep into the topic.";
            }

            // LMS CONTEXT INJECTION
            let contextInstruction = "";
            if (lmsData) {
                contextInstruction = `
                CURRENT CONTEXT:
                - Subject: ${lmsData.subject}
                - Chapter: "${lmsData.chapter}"
                - Standard: ${lmsData.standard}
                - Medium: ${lmsData.medium}
                
                TEACHING STRATEGY (Follow this strictly):
                1. STAY INSIDE THE CHAPTER: Do not discuss other topics unless asked.
                2. FLOW: When user asks "Explain", first explain strictly based on textbook scope.
                3. PROGRESSION: Only after explaining, offer "Extra Information". Then offer a "Summary". Then "Question & Answers". Finally a "Quiz".
                4. RESOURCES: At the very end, ask if they want video/image references.
                `;
            } else {
                contextInstruction = "You are a general knowledge teacher.";
            }

            systemInstruction = `
                You are "Dhwani", an expert AI Teacher. 
                User: ${userName}, Age: approx ${userAge}.
                Default Language: English (Unless user asks in Marathi/Hindi).
                
                ${tone}
                ${length}
                ${depth}
                ${contextInstruction}
            `;
        }

        async function getAIResponse(historyData) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: historyData,
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) { return "I am having trouble connecting. Please check your internet or API Key."; }
        }

        function cleanTextForTTS(text) {
            return text.replace(/\[.*?\]|\(.*?\)|{.*?}/g, "").replace(/[\*#`]/g, ' ').replace(/\s+/g, ' ').trim();
        }

        // --- SPEECH SYNTHESIS ---
        function loadVoices() {
            voices = synth.getVoices();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        function togglePauseResume() {
            if (synth.paused) synth.resume();
            else if (synth.speaking) { synth.pause(); recognition.stop(); setState('BUSY'); }
        }

        function stopSpeech() {
            if (!synth.speaking) return;
            speechManuallyStopped = true; 
            synth.cancel(); 
            recognition.stop(); 
            toggleMediaButtons(true);
            setTimeout(() => {
                speechManuallyStopped = false;
                if (appState !== 'IDLE') { setState('CONVERSATION'); startRecognitionSafe(); }
            }, 1000);
        }

        function replaySpeech() {
            if (lastSpokenText) { recognition.stop(); setState('BUSY'); speakText(lastSpokenText); }
        }
        
        async function speakText(text, lang = 'en-IN') {
            if (synth.speaking) synth.cancel();
            lastSpokenText = text;
            speechManuallyStopped = false;
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Select Voice based on Lang
                // Priority: Google English/Marathi -> Microsoft English/Marathi -> Any matching lang
                let selectedVoice = null;
                
                if (lang.includes('en')) {
                     selectedVoice = voices.find(v => v.name.includes("Google") && v.lang.includes("en")) || 
                                     voices.find(v => v.lang.includes("en-IN")) || 
                                     voices.find(v => v.lang.includes("en-US"));
                } else {
                     selectedVoice = voices.find(v => v.lang.includes("mr")) || voices.find(v => v.lang.includes("hi"));
                }
                
                if (selectedVoice) utterance.voice = selectedVoice;
                utterance.lang = lang; // Set lang explicitly
                
                // Speed adjustment for kids
                utterance.rate = (userAge <= 10) ? 0.85 : 1.0; 
                
                utterance.onstart = () => { toggleMediaButtons(false); };
                utterance.onend = () => { toggleMediaButtons(true); if(!speechManuallyStopped) resolve(); };
                utterance.onerror = () => { toggleMediaButtons(true); resolve(); };
                
                synth.speak(utterance);
            });
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }
        
        // --- HELPERS ---
        function logMessage(sender, message) {
            const div = document.createElement('div');
            let senderClass = 'text-blue-300 font-semibold';
            let messageClass = 'text-white';
            if (sender === 'Dhwani') senderClass = 'text-pink-400 font-semibold';
            else if (sender === userName) senderClass = 'text-green-300 font-semibold';

            div.innerHTML = `<strong class="${senderClass}">${sender}:</strong> <span class="${messageClass}">${message}</span>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        async function shareChat() {
            const chatText = Array.from(conversationLog.children).map(c => c.textContent).join('\n');
            try { await navigator.share({ title: 'Dhwani Chat', text: chatText }); } catch (e) {}
        }

        async function acquireWakeLock() {
            if ('wakeLock' in navigator) { 
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} 
            }
        }
        async function releaseWakeLock() {
            if (wakeLock) { try { await wakeLock.release(); wakeLock = null; } catch (e) {} }
        }
        async function handleVisibilityChange() {
            if (appState !== 'IDLE' && document.visibilityState === 'visible') await acquireWakeLock();
        }

        function endChat() {
            appState = 'IDLE'; setState('IDLE');
            if (synth.speaking) synth.cancel();
            if (recognition) recognition.stop();
            chatHistory = [];
            conversationLog.innerHTML = '<div class="text-gray-400 text-center">Class Ended.</div>';
        }

        function restartChat() {
            endChat();
            setTimeout(() => { 
                conversationLog.innerHTML = ''; 
                toggleListening(); // Auto restart
            }, 500);
        }
    </script>
</body>
</html>