<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhwani - Interactive Aptitude Assessment</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; display: flex; justify-content: center; height: 100dvh; box-sizing: border-box; }
        .container { background: white; max-width: 800px; width: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Shared Styles */
        button { background: #2980b9; color: white; border: none; padding: 14px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        button:disabled { background: #bdc3c7; }
        input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        
        /* Setup Screen */
        #setup-screen { padding: 40px 20px; text-align: center; overflow-y: auto; height: 100%; }
        
        /* Test Screen */
        #test-screen { display: none; flex-direction: column; height: 100%; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 15px; }
        #stage-indicator { background: #e67e22; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; display: inline-block; margin-top: 5px; }
        
        #chat-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 90%; padding: 14px; border-radius: 10px; font-size: 15px; line-height: 1.5; }
        .bot-msg { background: #e3f2fd; color: #0b3c7c; align-self: flex-start; border-bottom-left-radius: 0; }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; }
        .sys-msg { text-align: center; font-size: 12px; color: #7f8c8d; margin: 10px 0; }
        
        .controls-area { padding: 15px; background: white; border-top: 1px solid #eee; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .input-row { display: flex; gap: 10px; align-items: center; }
        #micBtn { background: #e67e22; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; flex-shrink: 0; border: none; padding: 0;}
        #micBtn.listening { background: #c0392b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        /* Loading Overlay */
        #full-loader { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box;}
        
        /* Report & Consult Screen */
        #report-screen { display: none; flex-direction: column; height: 100%; }
        #report-content { flex: 1; overflow-y: auto; padding: 20px; background: white; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 20px; border-radius: 0 8px 8px 0; }
        
        #consult-area { background: #eef2f5; padding: 20px; border-top: 2px solid #ddd; }
        #consult-history { max-height: 250px; overflow-y: auto; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd;}
        #android-fallback { display: none; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen">
        <h2>Eprashala - Dhwani Assessment</h2>
        <p style="color: #666; font-size: 14px;">A 30-minute deep-dive psychometric evaluation.</p>
        <input type="password" id="apiKey" placeholder="Gemini API Key" required>
        <input type="text" id="childName" placeholder="Student's Name" required>
        <input type="number" id="childAge" placeholder="Age (e.g., 14)" required>
        <input type="text" id="childCity" placeholder="City/Town (e.g., Mumbai)" required>
        <button onclick="startTest()">Begin Assessment</button>
    </div>

    <div id="test-screen">
        <div class="header">
            <div id="test-header">Dhwani Session</div>
            <div id="stage-indicator">Stage 0: Initialization</div>
        </div>
        <div id="chat-history"></div>
        
        <div class="controls-area">
            <div class="input-row">
                <button id="micBtn" onclick="toggleSpeech()">ðŸŽ¤</button>
                <input type="text" id="userInput" placeholder="Type answer here..." onkeypress="handleEnter(event)">
                <button id="sendBtn" onclick="submitAnswer()" style="width: auto; margin:0;">Send</button>
            </div>
        </div>
    </div>

    <div id="report-screen">
        <div id="report-content">
            </div>
        <div id="consult-area">
            <h3 style="margin-top:0; color:#2c3e50;">Post-Test AI Consultation</h3>
            <p style="font-size:12px; color:#666;">Ask Dhwani about colleges, courses, or career shifts based on your report.</p>
            <div id="consult-history"></div>
            <div class="input-row">
                <input type="text" id="consultInput" placeholder="e.g. Which Udemy course should I take?" onkeypress="if(event.key === 'Enter') sendConsult()">
                <button onclick="sendConsult()" style="width: auto; margin:0;">Ask</button>
            </div>
            <button onclick="downloadChatAsText()" style="background: #27ae60;">Download Chat Report (.txt)</button>
            
            <div id="android-fallback">
                <p style="font-size: 11px; color: #c0392b; margin-bottom: 5px;">If download fails (WebView restriction), copy text below:</p>
                <textarea id="fallback-text" style="width: 100%; height: 100px; font-size: 12px;" readonly></textarea>
            </div>
        </div>
    </div>

    <div id="full-loader">
        <h2 id="loader-text">Dhwani is analyzing...</h2>
        <p>Please wait.</p>
    </div>
</div>

<script>
    let childData = { name: "", age: 0, city: "" };
    let apiKey = "";
    
    // Assessment State
    let currentStage = 0;
    let questionCount = 0;
    const questionsPerStage = 5; // 5 stages * 5 Qs = 25 total (approx 30 mins)
    let testHistory = []; 
    let consultHistory = [];
    
    const STAGES = {
        0: { name: "Stage 0: Basics (MCQ)", type: "Single option (A, B, C, or D)", desc: "Ask a 4-option multiple choice question to gauge basic likes (subjects, hobbies)." },
        1: { name: "Stage 1: Quick Fire (Yes/No)", type: "1 word (Yes, No, or Maybe)", desc: "Ask a question that requires a simple Yes, No, or Maybe. Focus on their working style." },
        2: { name: "Stage 2: Short Thoughts", type: "1 sentence", desc: "Ask a question requiring a 1-sentence answer about a minor problem they solved or an achievement." },
        3: { name: "Stage 3: Exploration", type: "2-3 sentences", desc: "Dig into a career/field they showed interest in. Ask *why* they like it." },
        4: { name: "Stage 4: Stress Test", type: "Detailed paragraph", desc: "FRUSTRATE THEM mildly. Play devil's advocate. Give a complex scenario based on their city. If they like tech, say 'AI is replacing coders, what is your backup plan?'. Challenge their choices to see their resilience." }
    };

    // Speech Recognition Setup (Audio only, no recording overhead)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;
    
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.onstart = () => { isListening = true; document.getElementById('micBtn').classList.add('listening'); };
        recognition.onresult = (e) => { document.getElementById('userInput').value = e.results[0][0].transcript; };
        recognition.onend = () => { isListening = false; document.getElementById('micBtn').classList.remove('listening'); };
    }

    function startTest() {
        apiKey = document.getElementById('apiKey').value.trim();
        childData.name = document.getElementById('childName').value.trim();
        childData.age = parseInt(document.getElementById('childAge').value);
        childData.city = document.getElementById('childCity').value.trim();

        if(!apiKey || !childData.name || !childData.age || !childData.city) { alert("Fill all fields."); return; }

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('test-screen').style.display = 'flex';
        
        testHistory.push({ role: "user", parts: [{ text: "Start the test." }] });
        processTurn();
    }

    function toggleSpeech() {
        if (!recognition) return alert("Speech recognition not supported.");
        isListening ? recognition.stop() : recognition.start();
    }

    function submitAnswer() {
        const input = document.getElementById('userInput');
        if (!input.value.trim()) return;
        
        addMessage(input.value, 'user', 'chat-history');
        testHistory.push({ role: "user", parts: [{ text: input.value }] });
        input.value = '';
        
        questionCount++;
        if (questionCount >= questionsPerStage) {
            currentStage++;
            questionCount = 0;
        }

        if (currentStage > 4) {
            generateFinalReport();
        } else {
            processTurn();
        }
    }

    function handleEnter(e) { if (e.key === 'Enter') submitAnswer(); }

    function getSystemPrompt() {
        const stage = STAGES[currentStage];
        const ageContext = childData.age <= 14 
            ? "Keep vocabulary simple. Focus on school subjects, basic hobbies, and foundational life skills." 
            : "Use mature vocabulary. Focus on college streams, career shifts, current market trends, and complex situational awareness.";

        return `You are Dhwani, an AI aptitude evaluator for Eprashala LMS.
        User: ${childData.name} | Age: ${childData.age} | City: ${childData.city}.
        
        CURRENT STAGE: ${stage.name}
        Stage Goal: ${stage.desc}
        Expected User Answer Length: ${stage.type} (Frame your question to elicit this length naturally).
        
        AGE CONTEXT: ${ageContext}
        
        CRITICAL RULES:
        1. Keep YOUR questions SHORT and simple. It is the user's test, not yours.
        2. Ask EXACTLY ONE question. Do not bundle questions.
        3. ALWAYS output strictly in this JSON format:
        {
            "bot_reply": "Your short question to the user.",
            "internal_analysis": "Brief psychological note based on their previous answer."
        }`;
    }

    async function processTurn() {
        setLoading(true, "Dhwani is thinking...");
        document.getElementById('stage-indicator').innerText = STAGES[currentStage].name;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: getSystemPrompt() }] },
                    contents: testHistory,
                    generationConfig: { response_mime_type: "application/json" }
                })
            });

            const data = await response.json();
            const aiData = JSON.parse(data.candidates[0].content.parts[0].text);
            
            testHistory.push({ role: "model", parts: [{ text: aiData.bot_reply }] });
            addMessage(aiData.bot_reply, 'bot', 'chat-history');
            
        } catch (e) { alert("API Error. Please retry."); }
        setLoading(false);
    }

    async function generateFinalReport() {
        setLoading(true, "Compiling 30-minute psychometric data. Generating final Eprashala Report...");
        
        const reportPrompt = `You are Dhwani. The user has finished all 5 stages of the aptitude test. 
        Analyze their entire history. Generate a highly professional, real-world acceptable aptitude test report.
        Output ONLY raw, clean HTML (no markdown tags like \`\`\`html). 
        Include:
        - <h2 style='color:#2980b9'>Executive Summary</h2>
        - <div class='report-card'><b>Personality Traits & Virtues:</b> Real, honest assessment.</div>
        - <div class='report-card'><b>Problem Solving & Stress Response:</b> Based on how they handled the Stage 4 stress test.</div>
        - <div class='report-card'><b>Recommended Paths:</b> Top 3 Streams/Colleges/Careers.</div>`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: reportPrompt }] },
                    contents: testHistory
                })
            });

            const data = await response.json();
            const htmlReport = data.candidates[0].content.parts[0].text.replace(/```html|```/g, '');
            
            document.getElementById('test-screen').style.display = 'none';
            document.getElementById('report-screen').style.display = 'flex';
            document.getElementById('report-content').innerHTML = htmlReport;
            
            // Initialize consult history with context
            consultHistory.push({ role: "user", parts: [{ text: "I have read my report. Let's start the consultation." }] });
            
        } catch (e) { alert("Error generating report."); }
        setLoading(false);
    }

    // --- CONSULTATION LOGIC ---
    async function sendConsult() {
        const input = document.getElementById('consultInput');
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, 'user', 'consult-history');
        consultHistory.push({ role: "user", parts: [{ text: text }] });
        input.value = '';
        
        const sysPrompt = `You are Dhwani, an AI career consultant. The user (${childData.age} yrs old) just finished their aptitude test and is reading their report. Answer their questions about colleges, Udemy courses, YouTube videos, or career shifts directly and conversationally. Do not use JSON. Use plain text.`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: sysPrompt }] },
                    contents: consultHistory
                })
            });

            const data = await response.json();
            const reply = data.candidates[0].content.parts[0].text;
            
            consultHistory.push({ role: "model", parts: [{ text: reply }] });
            addMessage(reply, 'bot', 'consult-history');
        } catch(e) { alert("Error connecting to Dhwani."); }
    }

    function downloadChatAsText() {
        let textToSave = `--- Eprashala: Dhwani Consultation for ${childData.name} ---\n\n`;
        consultHistory.forEach(msg => {
            let role = msg.role === 'user' ? childData.name : 'Dhwani AI';
            if (msg.parts[0].text.includes("I have read my report")) return; // Skip sys message
            textToSave += `${role}: ${msg.parts[0].text}\n\n`;
        });

        // WebView Fallback
        document.getElementById('android-fallback').style.display = 'block';
        document.getElementById('fallback-text').value = textToSave;

        // Standard Web Download
        const blob = new Blob([textToSave], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${childData.name}_Consultation.txt`;
        link.click();
    }

    function addMessage(text, sender, containerId) {
        const chat = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = `message ${sender}-msg`;
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function setLoading(show, text="") {
        const loader = document.getElementById('full-loader');
        document.getElementById('loader-text').innerText = text;
        loader.style.display = show ? 'flex' : 'none';
        
        // Disable inputs while loading
        const inputs = document.querySelectorAll('input, button');
        inputs.forEach(el => el.disabled = show);
    }
</script>
</body>
</html>