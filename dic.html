<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eprashala Dictation Master</title>
    <style>
        :root { --primary: #6c5ce7; --accent: #00cec9; --bg: #dfe6e9; --text: #2d3436; --cmd-glow: #0984e3; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: var(--primary); margin-bottom: 5px; font-weight: 800; }
        .tagline { text-align: center; color: #636e72; font-size: 0.9em; margin-bottom: 25px; }

        /* Controls */
        .controls { display: flex; gap: 12px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
        button, select { padding: 12px 24px; border-radius: 50px; border: 1px solid #b2bec3; font-size: 15px; cursor: pointer; transition: all 0.2s; background: white; font-weight: 600; }
        
        #startBtn { background: var(--primary); color: white; border: none; min-width: 160px; }
        #startBtn.listening { background: #ff7675; animation: pulse 1.5s infinite; }
        #readBtn { background: var(--accent); color: white; border: none; min-width: 140px; }
        #readBtn.paused { background: #fdcb6e; color: #2d3436; }
        
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Editor Area */
        #editor-wrapper { position: relative; }
        
        #finalText { 
            width: 100%; height: 400px; padding: 25px; 
            border: 3px solid #e2e8f0; border-radius: 15px; 
            font-size: 1.2em; line-height: 1.6; resize: vertical; 
            font-family: 'Calibri', 'Roboto', sans-serif;
            transition: all 0.3s ease;
            outline: none; 
            caret-color: var(--primary); /* Custom blinking cursor */
        }
        
        /* The Blue Light Effect for Commands */
        #finalText.command-mode {
            border-color: var(--cmd-glow) !important;
            box-shadow: 0 0 25px rgba(9, 132, 227, 0.5); /* Stronger Blue Glow */
        }

        /* Focus State */
        #finalText:focus { border-color: #a29bfe; }

        /* Status Bar */
        .status-bar { display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.9em; color: #636e72; padding: 0 10px; }
        .timer-indicator { font-weight: bold; color: #e17055; opacity: 0; transition: opacity 0.3s; }
        .timer-indicator.visible { opacity: 1; }

        details { margin-top: 25px; background: #f1f2f6; border-radius: 12px; overflow: hidden; }
        summary { padding: 15px; cursor: pointer; font-weight: 700; color: var(--primary); }
        .help-content { padding: 0 20px 20px; font-size: 0.95em; line-height: 1.6; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 118, 117, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0); } }
    </style>
</head>
<body>

<div class="container">
    <h2>üéôÔ∏è Eprashala Master Dictation</h2>
    <div class="tagline">Say "Dhwani", "Dhoni", "Dvani" to command</div>
    
    <div class="controls">
        <select id="langSelect" onchange="resetDictation()">
            <option value="en-IN" selected>English (India)</option>
            <option value="hi-IN">Hindi (India)</option>
            <option value="mr-IN">Marathi (India)</option>
            <option value="gu-IN">Gujarati (India)</option>
            <option value="ta-IN">Tamil (India)</option>
        </select>
        <button id="startBtn" onclick="toggleDictation()">Start Dictation</button>
        <button id="readBtn" onclick="toggleReadAloud()">üîä Read Aloud</button>
        <button onclick="copyText()">üìã Copy</button>
        <button onclick="clearText()">üóëÔ∏è Clear</button>
    </div>

    <div id="editor-wrapper">
        <textarea id="finalText" placeholder="Tap Start. The cursor will blink here..." spellcheck="false"></textarea>
    </div>

    <div class="status-bar">
        <span id="statusMsg">Status: Ready</span>
        <span id="timerMsg" class="timer-indicator">...</span>
    </div>

    <details>
        <summary>View Voice Commands</summary>
        <div class="help-content">
            <p><strong>Wake Words:</strong> "Dhwani", "Dhoni", "Dvani"</p>
            <p><strong>Commands:</strong> "Dhwani New Line", "Dhwani New Para", "Dhwani Pause", "Dhwani Delete"</p>
            <p><strong>Auto-Punctuation:</strong> Pause 3s for Comma ( , ) ‚Ä¢ Pause 5s for Full Stop ( . )</p>
        </div>
    </details>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const synth = window.speechSynthesis;
    
    let recognition;
    let isListening = false;
    let isPaused = false;
    let silenceTimer = null;
    let punctuationStage = 0;
    let selectedVoice = null;

    const textArea = document.getElementById('finalText');
    const startBtn = document.getElementById('startBtn');
    const readBtn = document.getElementById('readBtn');
    const statusMsg = document.getElementById('statusMsg');
    const timerMsg = document.getElementById('timerMsg');
    const langSelect = document.getElementById('langSelect');

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.maxAlternatives = 1;
    }

    // Load Voices
    speechSynthesis.onvoiceschanged = () => {
        const voices = synth.getVoices();
        selectedVoice = voices.find(v => v.lang.includes('mr-IN') && v.name.includes('Google')) || 
                        voices.find(v => v.lang.includes('hi-IN')) || 
                        voices.find(v => v.lang.includes('en-IN')) || 
                        voices[0];
    };

    // --- 2. DICTATION LOGIC ---
    function toggleDictation() { isListening ? stopDictation() : startDictation(); }

    function startDictation() {
        recognition.lang = langSelect.value;
        try { recognition.start(); } catch(e) {}
        isListening = true;
        isPaused = false;
        startBtn.textContent = "Stop Listening";
        startBtn.classList.add("listening");
        statusMsg.textContent = "Status: Listening...";
        textArea.focus();
    }

    function stopDictation() {
        recognition.stop();
        isListening = false;
        clearTimeout(silenceTimer); // Kill timer
        startBtn.textContent = "Start Dictation";
        startBtn.classList.remove("listening");
        statusMsg.textContent = "Status: Stopped";
        timerMsg.classList.remove("visible");
    }

    function resetDictation() {
        if(isListening) { stopDictation(); setTimeout(startDictation, 500); }
    }

    // --- 3. SPEECH PROCESSING ---
    recognition.onresult = (event) => {
        // Reset timer on ANY sound
        resetSilenceTimer();

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            let transcript = event.results[i][0].transcript;

            if (event.results[i].isFinal) {
                let clean = transcript.trim();
                let wakeWordRegex = /^(dhwani|dhoni|dvani|dhawani|doni|dwani)\s+/i;
                
                if (wakeWordRegex.test(clean)) {
                    // COMMAND DETECTED
                    let cmd = clean.replace(wakeWordRegex, "").trim();
                    
                    // CRITICAL FIX: Kill punctuation timer immediately when command is heard
                    clearTimeout(silenceTimer); 
                    timerMsg.classList.remove("visible");
                    
                    triggerCommandMode(); // Blue Light
                    executeCommand(cmd);
                } 
                else if (!isPaused) {
                    insertText(clean);
                }
            }
        }
    };

    function insertText(text) {
        // Auto-Capitalize
        if (textArea.value.length === 0 || textArea.value.endsWith('. ') || textArea.value.endsWith('\n')) {
            text = text.charAt(0).toUpperCase() + text.slice(1);
        }

        // Logic to prevent spaces at start of new line
        let prefix = " ";
        if (textArea.value.length === 0 || textArea.value.endsWith('\n') || textArea.value.endsWith(' ')) {
            prefix = "";
        }
        
        textArea.value += prefix + text;
        textArea.scrollTop = textArea.scrollHeight;
        textArea.focus(); // Keep cursor blinking
    }

    // --- 4. AUTO-PUNCTUATION (THE FIX) ---
    function resetSilenceTimer() {
        clearTimeout(silenceTimer);
        timerMsg.classList.remove("visible");
        punctuationStage = 0;

        if (isListening && !isPaused) {
            // 3s Timer for Comma
            silenceTimer = setTimeout(() => {
                applyPunctuation(',');
                
                // 5s Total Timer for Dot
                silenceTimer = setTimeout(() => {
                    convertCommaToDot();
                }, 2000); 

            }, 3000);
        }
    }

    function applyPunctuation(symbol) {
        // Safe Trim: Only remove Spaces, NEVER NewLines
        let val = textArea.value.replace(/ +$/, ""); 
        
        if (val.length > 0 && !val.endsWith('\n')) {
            textArea.value = val + symbol + " ";
            punctuationStage = 1;
            timerMsg.textContent = "Auto-inserted: ,";
            timerMsg.classList.add("visible");
        }
    }

    function convertCommaToDot() {
        if (punctuationStage === 1) {
            // Safe Trim: Only remove Spaces and the Comma we just added
            let val = textArea.value.replace(/, $/, "").replace(/,$/, "");
            
            // Check again to ensure we don't eat a newline
            if (!val.endsWith('\n')) {
                textArea.value = val + ". ";
                timerMsg.textContent = "Auto-inserted: .";
                timerMsg.classList.add("visible");
                punctuationStage = 2;
            }
        }
    }

    // --- 5. COMMAND EXECUTION ---
    function triggerCommandMode() {
        textArea.classList.add('command-mode');
        setTimeout(() => textArea.classList.remove('command-mode'), 800);
    }

    function executeCommand(cmd) {
        cmd = cmd.toLowerCase();
        
        if (cmd.includes("pause")) { isPaused = true; statusMsg.textContent = "Paused (Say 'Dhwani Start Typing')"; }
        else if (cmd.includes("start typing")) { isPaused = false; statusMsg.textContent = "Listening..."; }
        
        // Navigation & Format
        else if (cmd.includes("new para")) textArea.value += "\n\n";
        else if (cmd.includes("new line") || cmd.includes("next line")) textArea.value += "\n";
        else if (cmd.includes("delete")) {
             let words = textArea.value.trim().split(/\s+/);
             words.pop();
             textArea.value = words.join(" ");
        }
        else if (cmd.includes("clear")) { if(confirm("Clear All?")) textArea.value = ""; }
        
        // Punctuation
        else if (cmd.includes("full stop")) textArea.value += ".";
        else if (cmd.includes("comma")) textArea.value += ",";
        else if (cmd.includes("question")) textArea.value += "?";
        
        // Always focus back after command
        textArea.focus();
    }

    // --- 6. READ ALOUD ---
    function toggleReadAloud() {
        if (synth.speaking) {
            if (synth.paused) {
                synth.resume();
                readBtn.textContent = "‚è∏ Pause";
                readBtn.classList.remove("paused");
            } else {
                synth.pause();
                readBtn.textContent = "‚ñ∂ Resume";
                readBtn.classList.add("paused");
            }
        } else {
            let text = textArea.value;
            if (!text) return alert("Nothing to read!");
            
            let utterance = new SpeechSynthesisUtterance(text);
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 0.9;

            utterance.onend = () => {
                readBtn.textContent = "üîä Read Aloud";
                readBtn.classList.remove("paused");
            };

            synth.speak(utterance);
            readBtn.textContent = "‚è∏ Pause";
        }
    }

    function copyText() {
        textArea.select();
        document.execCommand('copy');
        setTimeout(() => textArea.focus(), 100);
    }
    function clearText() { textArea.value = ""; textArea.focus(); }

    recognition.onend = () => { if(isListening) recognition.start(); };

</script>
</body>
</html>