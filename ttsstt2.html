<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhwani AI - Studio Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .mode-active {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .push-btn { transition: transform 0.1s; }
        .push-btn:active, .push-btn.pressed { transform: scale(0.96); filter: brightness(1.2); }

        textarea { field-sizing: content; min-height: 120px; }
        .no-select { -webkit-user-select: none; user-select: none; }
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-950 h-[100dvh] w-full flex flex-col overflow-hidden text-slate-100">

    <header class="glass-panel z-50 shrink-0 px-4 py-3 pb-4 rounded-b-3xl shadow-2xl relative">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center text-white font-bold text-xl shadow-lg">D</div>
                <div class="flex flex-col">
                    <span class="font-bold text-lg leading-none">Dhwani Studio</span>
                    <span class="text-[10px] text-slate-400 font-medium tracking-widest uppercase">Expert Edition</span>
                </div>
            </div>
            <div class="flex bg-slate-900/80 rounded-lg p-1 border border-slate-700/50">
                <button onclick="setMode('tts')" id="tab-tts" class="mode-active px-4 py-1.5 rounded-md text-xs font-bold transition-all">TTS</button>
                <button onclick="setMode('stt')" id="tab-stt" class="text-slate-400 px-4 py-1.5 rounded-md text-xs font-bold transition-all hover:text-white">STT</button>
            </div>
        </div>

        <div class="flex gap-3">
            <div class="flex-1">
                <label class="text-[10px] font-bold text-purple-400 uppercase block mb-1 pl-1">Native (Input)</label>
                <select id="lang-native" class="w-full text-xs p-3 rounded-xl border border-slate-700 bg-slate-900 text-slate-200 outline-none focus:border-purple-500 appearance-none font-medium"></select>
            </div>
            <div class="flex flex-col justify-center pt-5 text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
            </div>
            <div class="flex-1">
                <label class="text-[10px] font-bold text-pink-400 uppercase block mb-1 pl-1">Guest (Output)</label>
                <select id="lang-guest" class="w-full text-xs p-3 rounded-xl border border-slate-700 bg-slate-900 text-slate-200 outline-none focus:border-pink-500 appearance-none font-medium"></select>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col p-4 overflow-y-auto no-scrollbar relative z-0">
        
        <div id="view-tts" class="flex flex-col h-full animate-fade-in">
            <div class="flex justify-between items-end mb-2 px-1">
                <label class="text-xs text-slate-400 font-bold uppercase tracking-wide">Type to Speak</label>
                <div id="tts-status" class="text-[10px] font-bold text-purple-400 opacity-0 transition-opacity">Ready</div>
            </div>
            <textarea id="tts-input" class="w-full flex-grow bg-slate-900/60 border border-slate-700/50 rounded-2xl p-5 text-base leading-relaxed focus:outline-none focus:ring-1 focus:ring-purple-500 resize-none placeholder-slate-600 shadow-inner text-slate-200" placeholder="Type here..."></textarea>
            
            <a id="btn-download" href="#" target="_blank" class="hidden mt-3 bg-slate-800 border border-slate-600 py-3 rounded-xl font-bold text-green-400 text-xs justify-center items-center gap-2 hover:bg-slate-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Download Recorded MP3
            </a>
            <p id="dl-warning" class="hidden text-[10px] text-red-400 text-center mt-1">Text too long for recording generator.</p>
        </div>

        <div id="view-stt" class="hidden flex-col h-full gap-4 animate-fade-in">
            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex justify-between items-end mb-1 px-1">
                    <label class="text-[10px] text-purple-400 font-bold uppercase tracking-wider">Hearing (Native)</label>
                    <button onclick="clearStt()" class="text-[10px] text-slate-500 hover:text-white uppercase font-bold px-2 py-1 bg-slate-800 rounded">Clear</button>
                </div>
                <div id="stt-console" class="flex-grow bg-slate-900/60 border border-slate-700/50 rounded-2xl p-4 text-sm text-slate-200 overflow-y-auto whitespace-pre-wrap shadow-inner"></div>
            </div>

            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex justify-between items-end mb-1 px-1">
                    <label class="text-[10px] text-pink-400 font-bold uppercase tracking-wider">Translated (Guest)</label>
                </div>
                <div id="stt-result" class="flex-grow bg-gradient-to-br from-slate-900/60 to-slate-800/60 border border-slate-700/50 border-dashed rounded-2xl p-4 text-sm text-pink-100 overflow-y-auto italic shadow-inner">
                    <span class="text-slate-600 not-italic text-xs">Translation appears here...</span>
                </div>
            </div>
        </div>
    </main>

    <div class="glass-panel mt-auto pb-safe pt-4 px-4 pb-6 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] shrink-0 z-50">
        
        <div id="controls-tts" class="flex flex-col gap-3">
            <button id="btn-speak" class="push-btn w-full bg-gradient-to-r from-purple-600 to-indigo-600 py-4 rounded-xl font-bold text-white shadow-lg flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                <span class="tracking-widest">SPEAK</span>
            </button>
        </div>

        <div id="controls-stt" class="hidden grid grid-cols-4 gap-3">
            <button id="btn-listen" class="no-select push-btn col-span-2 bg-gradient-to-r from-purple-600 to-pink-600 py-3 rounded-xl font-bold text-white shadow-lg flex flex-col items-center justify-center h-20 border-t border-white/20">
                <span class="text-base tracking-widest drop-shadow-md">LISTEN</span>
                <span class="text-[9px] text-purple-100 uppercase font-medium opacity-80 mt-1">Hold to Speak</span>
            </button>
            <button id="btn-translate" class="no-select push-btn col-span-1 bg-slate-800 border border-slate-600/50 rounded-xl flex flex-col items-center justify-center text-slate-300 hover:text-white h-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1 text-pink-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" /></svg>
                <span class="text-[9px] font-bold">TRANS</span>
            </button>
            <button id="btn-copy" class="no-select push-btn col-span-1 bg-slate-800 border border-slate-600/50 rounded-xl flex flex-col items-center justify-center text-slate-300 hover:text-white h-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                <span class="text-[9px] font-bold">COPY</span>
            </button>
        </div>
    </div>

    <script>
        const LANGUAGES = [
            { code: 'en-IN', name: 'English (India)' }, { code: 'hi-IN', name: 'Hindi (हिंदी)' },
            { code: 'mr-IN', name: 'Marathi (मराठी)' }, { code: 'gu-IN', name: 'Gujarati (ગુજરાતી)' },
            { code: 'ta-IN', name: 'Tamil (தமிழ்)' }, { code: 'te-IN', name: 'Telugu (తెలుగు)' },
            { code: 'pa-IN', name: 'Punjabi (ਪੰਜਾਬੀ)' }, { code: 'bn-IN', name: 'Bengali (বাংলা)' },
            { code: 'kn-IN', name: 'Kannada (ಕನ್ನಡ)' }, { code: 'ml-IN', name: 'Malayalam (മലയാളം)' },
            { code: 'en-US', name: 'English (US)' }, { code: 'zh-CN', name: 'Chinese (Mandarin)' },
            { code: 'ja-JP', name: 'Japanese' }, { code: 'ko-KR', name: 'Korean' },
            { code: 'fr-FR', name: 'French' }, { code: 'es-ES', name: 'Spanish' },
            { code: 'de-DE', name: 'German' }, { code: 'ru-RU', name: 'Russian' },
            { code: 'ar-SA', name: 'Arabic' }
        ];

        let synth = window.speechSynthesis;
        let recognition = null;
        let currentMode = 'tts'; 
        let finalTranscript = ''; 
        let isListening = false;
        
        const els = {
            langNative: document.getElementById('lang-native'),
            langGuest: document.getElementById('lang-guest'),
            viewTts: document.getElementById('view-tts'), viewStt: document.getElementById('view-stt'),
            controlsTts: document.getElementById('controls-tts'), controlsStt: document.getElementById('controls-stt'),
            tabTts: document.getElementById('tab-tts'), tabStt: document.getElementById('tab-stt'),
            ttsInput: document.getElementById('tts-input'), ttsStatus: document.getElementById('tts-status'),
            btnDownload: document.getElementById('btn-download'), dlWarning: document.getElementById('dl-warning'),
            sttConsole: document.getElementById('stt-console'), sttResult: document.getElementById('stt-result'),
            btnListen: document.getElementById('btn-listen')
        };

        function init() {
            LANGUAGES.forEach(l => {
                els.langNative.add(new Option(l.name, l.code));
                els.langGuest.add(new Option(l.name, l.code));
            });
            els.langNative.value = 'en-IN';
            els.langGuest.value = 'hi-IN';

            // STT Setup - EXACT LOGIC from your stable file
            if (window.SpeechRecognition || window.webkitSpeechRecognition) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false; // PREVENTS ANDROID LOOP BUG
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    const result = event.results[event.results.length - 1];
                    const text = result[0].transcript;
                    if (result.isFinal) finalTranscript += text + " ";
                    els.sttConsole.innerText = finalTranscript + (result.isFinal ? '' : text);
                    els.sttConsole.scrollTop = els.sttConsole.scrollHeight;
                };

                recognition.onend = () => {
                    if (isListening) try { recognition.start(); } catch(e) {}
                };
            }

            setupTtsListeners();
            setupSttListeners();
        }

        function setupTtsListeners() {
            document.getElementById('btn-speak').onclick = async () => {
                const text = els.ttsInput.value.trim();
                if (!text) return;

                // 1. Reset Download Link (Delete old file logic)
                els.btnDownload.classList.add('hidden');
                els.btnDownload.classList.remove('flex');
                els.btnDownload.href = '#';

                const sLang = els.langNative.value;
                const tLang = els.langGuest.value;
                let textToSpeak = text;
                
                updateTtsStatus("Processing...", 1);

                // 2. Translate if needed
                if (sLang !== tLang) {
                    try {
                        updateTtsStatus("Translating...", 1);
                        textToSpeak = await translateText(text, sLang, tLang);
                    } catch (e) { console.error(e); }
                }

                updateTtsStatus("Speaking...", 1);
                
                // 3. Play Audio
                speak(textToSpeak, tLang);
                
                // 4. GENERATE RECORDING (MP3 File)
                generateMp3Link(textToSpeak, tLang);
            };
        }

        // --- NEW: MP3 GENERATOR with 404 FIX ---
        function generateMp3Link(text, langCode) {
            if (text.length > 200) {
                els.dlWarning.classList.remove('hidden');
                return;
            }
            els.dlWarning.classList.add('hidden');

            // FIX 404: Google API hates 'hi-IN', it wants 'hi'
            // We strip the region code for the download link
            const cleanLang = langCode.split('-')[0]; 
            
            // Construct Google TTS URL
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=${cleanLang}&client=tw-ob`;
            
            els.btnDownload.href = url;
            els.btnDownload.classList.remove('hidden');
            els.btnDownload.classList.add('flex');
        }

        function setupSttListeners() {
            const btnListen = els.btnListen;

            const start = (e) => {
                e.preventDefault();
                if(isListening) return;
                isListening = true;
                btnListen.classList.add('pressed', 'ring-2', 'ring-purple-400');
                btnListen.querySelector('span').innerText = "LISTENING...";
                if(recognition) { recognition.lang = els.langNative.value; try { recognition.start(); } catch(e){} }
            };

            const stop = (e) => {
                e.preventDefault();
                if(!isListening) return;
                isListening = false;
                if(recognition) recognition.stop();
                btnListen.classList.remove('pressed', 'ring-2', 'ring-purple-400');
                btnListen.querySelector('span').innerText = "LISTEN";
            };

            btnListen.addEventListener('mousedown', start);
            btnListen.addEventListener('touchstart', start);
            btnListen.addEventListener('mouseup', stop);
            btnListen.addEventListener('touchend', stop);
            btnListen.addEventListener('mouseleave', stop);

            document.getElementById('btn-translate').onclick = async () => {
                const text = els.sttConsole.innerText.trim();
                if(!text) return;
                const sLang = els.langNative.value;
                const tLang = els.langGuest.value;

                if(sLang === tLang) {
                    els.sttResult.innerHTML = `<span class="not-italic text-white">${text}</span>`;
                    return;
                }
                els.sttResult.innerHTML = `<span class="animate-pulse">Translating...</span>`;
                try {
                    const trans = await translateText(text, sLang, tLang);
                    els.sttResult.innerHTML = `<span class="not-italic text-white font-medium">${trans}</span>`;
                } catch(e) { els.sttResult.innerText = "Error"; }
            };

            document.getElementById('btn-copy').onclick = () => {
                const txt = els.sttResult.innerText;
                if(txt && !txt.includes("Translation")) navigator.clipboard.writeText(txt);
            };
            
            window.clearStt = () => {
                finalTranscript = '';
                els.sttConsole.innerText = '';
                els.sttResult.innerHTML = '<span class="text-slate-600 not-italic text-xs">Translation appears here...</span>';
            };
        }

        async function translateText(text, s, t) {
            const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${s}|${t}`;
            const res = await fetch(url);
            const data = await res.json();
            if(data.responseData) {
                const area = document.createElement('textarea');
                area.innerHTML = data.responseData.translatedText;
                return area.value;
            }
            throw new Error("API Error");
        }

        function speak(text, lang) {
            if(synth.speaking) synth.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = lang;
            const voices = synth.getVoices();
            const voice = voices.find(v => v.lang === lang) || voices.find(v => v.lang.startsWith(lang.split('-')[0]));
            if(voice) ut.voice = voice;
            ut.onend = () => updateTtsStatus("Ready", 0);
            synth.speak(ut);
        }

        function updateTtsStatus(msg, opacity) {
            els.ttsStatus.innerText = msg;
            els.ttsStatus.style.opacity = opacity;
            if(opacity === 0) setTimeout(() => els.ttsStatus.innerText = "Ready", 500);
        }

        function setMode(mode) {
            if(mode === 'tts') {
                els.viewTts.classList.remove('hidden', 'flex'); els.viewTts.classList.add('flex');
                els.viewStt.classList.add('hidden'); els.viewStt.classList.remove('flex');
                els.controlsTts.classList.remove('hidden'); els.controlsStt.classList.add('hidden');
                els.tabTts.classList.add('mode-active'); els.tabTts.classList.remove('text-slate-400');
                els.tabStt.classList.remove('mode-active'); els.tabStt.classList.add('text-slate-400');
            } else {
                els.viewTts.classList.add('hidden'); els.viewTts.classList.remove('flex');
                els.viewStt.classList.remove('hidden', 'flex'); els.viewStt.classList.add('flex');
                els.controlsTts.classList.add('hidden'); els.controlsStt.classList.remove('hidden', 'grid'); els.controlsStt.classList.add('grid');
                els.tabStt.classList.add('mode-active'); els.tabStt.classList.remove('text-slate-400');
                els.tabTts.classList.remove('mode-active'); els.tabTts.classList.add('text-slate-400');
            }
        }
        window.setMode = setMode;
        window.onload = init;
    </script>
</body>
</html>