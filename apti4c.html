<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhwani AI - Eprashala Assessment</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; display: flex; justify-content: center; height: 100dvh; box-sizing: border-box; }
        .container { background: white; max-width: 800px; width: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        button { background: #2980b9; color: white; border: none; padding: 14px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        button:disabled { background: #bdc3c7; }
        input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        
        #setup-screen { padding: 40px 20px; text-align: center; overflow-y: auto; height: 100%; }
        #test-screen { display: none; flex-direction: column; height: 100%; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 15px; }
        #stage-indicator { background: #e67e22; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; display: inline-block; margin-top: 5px; }
        
        #chat-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 90%; padding: 14px; border-radius: 10px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; }
        .bot-msg { background: #e3f2fd; color: #0b3c7c; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #bbdefb; }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .controls-area { padding: 15px; background: white; border-top: 1px solid #eee; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .input-row { display: flex; gap: 10px; align-items: center; }
        
        /* PTT Mic Button Styling */
        #micBtn { 
            background: #e67e22; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; flex-shrink: 0; border: none; padding: 0; transition: 0.2s;
            -webkit-user-select: none; -webkit-touch-callout: none; user-select: none; touch-action: none;
        }
        #micBtn.listening { background: #e74c3c; box-shadow: 0 0 15px rgba(231, 76, 60, 0.6); transform: scale(1.08); }
        
        #full-loader { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box;}
        #report-screen { display: none; flex-direction: column; height: 100%; }
        #report-content { flex: 1; overflow-y: auto; padding: 20px; background: white; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 20px; border-radius: 0 8px 8px 0; }
        #consult-area { background: #eef2f5; padding: 20px; border-top: 2px solid #ddd; }
        #consult-history { max-height: 250px; overflow-y: auto; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd;}
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen">
        <h2>Dhwani AI Assessment</h2>
        <p style="color: #666; font-size: 14px;">Eprashala Native Indian Evaluation</p>
        <input type="password" id="apiKey" placeholder="Gemini API Key" required>
        <input type="text" id="childName" placeholder="Student's Name" required>
        <input type="number" id="childAge" placeholder="Age (e.g., 14)" required>
        <input type="text" id="childCity" placeholder="City/Town (e.g., Pune, Nashik)" required>
        <button onclick="startTest()">Begin Assessment</button>
    </div>

    <div id="test-screen">
        <div class="header">
            <div id="test-header">Dhwani Session</div>
            <div id="stage-indicator">Stage 0: Initialization</div>
        </div>
        <div id="chat-history"></div>
        
        <div class="controls-area">
            <p id="mic-status" style="font-size: 11px; color: #7f8c8d; margin: 0 0 5px 0; text-align: center;">Hold mic to speak. Auto-sends on release.</p>
            <div class="input-row">
                <button id="micBtn">ðŸŽ¤</button>
                <input type="text" id="userInput" placeholder="Type or hold mic..." onkeypress="handleEnter(event)">
                <button id="sendBtn" onclick="submitAnswer()" style="width: auto; margin:0; display: none;">Send</button>
            </div>
        </div>
    </div>

    <div id="report-screen">
        <div id="report-content"></div>
        <div id="consult-area">
            <h3 style="margin-top:0; color:#2c3e50;">Consult Dhwani</h3>
            <div id="consult-history"></div>
            <div class="input-row">
                <input type="text" id="consultInput" placeholder="Ask about colleges, streams..." onkeypress="if(event.key === 'Enter') sendConsult()">
                <button onclick="sendConsult()" style="width: auto; margin:0;">Ask</button>
            </div>
            <button onclick="downloadChatAsText()" style="background: #27ae60;">Download Full Report (.txt)</button>
        </div>
    </div>

    <div id="full-loader">
        <h2 id="loader-text">Dhwani is analyzing...</h2>
    </div>
</div>

<script>
/* ==============================
   DHWANI OPTIMIZED ENGINE v2
   API CALLS REDUCED BY ~80%
================================ */

let childData = { name: "", age: 0, city: "" };
let apiKey = "";

let currentStage = 0;
let questionIndex = 0;

let stageQuestions = [];
let stageAnswers = {};
let fullTranscript = "";

const STAGES = [
    { name: "Stage 0: Basics", type: "Multiple choice (A/B/C/D)" },
    { name: "Stage 1: Quick Fire", type: "Yes or No only" },
    { name: "Stage 2: Short Thoughts", type: "1 short sentence" },
    { name: "Stage 3: Exploration", type: "2-3 sentences" },
    { name: "Stage 4: Deep Dive", type: "Detailed explanation" }
];

/* ==============================
   START TEST
================================ */

function startTest() {
    apiKey = document.getElementById('apiKey').value.trim();
    childData.name = document.getElementById('childName').value.trim();
    childData.age = parseInt(document.getElementById('childAge').value);
    childData.city = document.getElementById('childCity').value.trim();

    if(!apiKey || !childData.name || !childData.age || !childData.city){
        alert("Fill all fields.");
        return;
    }

    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('test-screen').style.display = 'flex';

    generateStageQuestions();
}

/* ==============================
   GENERATE 5 QUESTIONS AT ONCE
================================ */

async function generateStageQuestions() {

    if(currentStage > 4){
        generateFinalReport();
        return;
    }

    setLoading(true, "Preparing " + STAGES[currentStage].name);

    const prompt = `
You are Dhwani AI, Indian aptitude evaluator.

Student:
Name: ${childData.name}
Age: ${childData.age}
City: ${childData.city}

Generate 5 aptitude questions for:
${STAGES[currentStage].name}

Expected Answer Type:
${STAGES[currentStage].type}

Rules:
- Questions must be short.
- Indian context (marks, tuition, stream, batch, etc).
- Return ONLY valid JSON:
{
 "questions": ["Q1","Q2","Q3","Q4","Q5"]
}
`;

    try {

        await delay(1200); // throttle

        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                })
            }
        );

        const data = await response.json();

        if(!response.ok) throw new Error(data.error?.message);

        let raw = data.candidates[0].content.parts[0].text;
        raw = raw.replace(/```json|```/g, "").trim();

        const parsed = JSON.parse(raw);

        stageQuestions = parsed.questions;
        stageAnswers[currentStage] = [];
        questionIndex = 0;

        askNextQuestion();

    } catch(e){
        alert("Stage generation error: " + e.message);
    }

    setLoading(false);
}

/* ==============================
   ASK QUESTION LOCALLY
================================ */

function askNextQuestion(){

    if(questionIndex >= stageQuestions.length){
        currentStage++;
        generateStageQuestions();
        return;
    }

    const question = stageQuestions[questionIndex];

    addMessage(question, 'bot', 'chat-history');
}

/* ==============================
   SUBMIT ANSWER
================================ */

function submitAnswer(){

    const input = document.getElementById('userInput');
    const answer = input.value.trim();
    if(!answer) return;

    addMessage(answer, 'user', 'chat-history');

    stageAnswers[currentStage].push({
        question: stageQuestions[questionIndex],
        answer: answer
    });

    fullTranscript += `Q: ${stageQuestions[questionIndex]}\nA: ${answer}\n\n`;

    input.value = "";
    questionIndex++;

    askNextQuestion();
}

/* ==============================
   FINAL REPORT (ONLY 1 CALL)
================================ */

async function generateFinalReport(){

    setLoading(true, "Analyzing full performance...");

    const prompt = `
You are Dhwani AI.

Student Details:
${childData.name}, Age ${childData.age}, ${childData.city}

Transcript:
${fullTranscript}

Analyze deeply.

Return ONLY HTML:

<h2 style='color:#2980b9'>Executive Summary</h2>
<div class='report-card'><b>Personality Traits:</b> ...</div>
<div class='report-card'><b>Strengths & Weaknesses:</b> ...</div>
<div class='report-card'><b>Best Career Streams (India):</b> Top 3 paths.</div>
`;

    try{

        await delay(1500);

        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                })
            }
        );

        const data = await response.json();
        if(!response.ok) throw new Error(data.error?.message);

        let rawHtml = data.candidates[0].content.parts[0].text;
        rawHtml = rawHtml.replace(/```html|```/g, "").trim();

        document.getElementById('test-screen').style.display = 'none';
        document.getElementById('report-screen').style.display = 'flex';
        document.getElementById('report-content').innerHTML = rawHtml;

    }catch(e){
        alert("Report error: " + e.message);
    }

    setLoading(false);
}

/* ==============================
   HELPERS
================================ */

function addMessage(text, sender, containerId){
    const chat = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = `message ${sender}-msg`;
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function setLoading(show, text=""){
    document.getElementById('full-loader').style.display = show ? 'flex' : 'none';
    document.getElementById('loader-text').innerText = text;
}

function delay(ms){
    return new Promise(resolve => setTimeout(resolve, ms));
}
</script>
</body>
</html>