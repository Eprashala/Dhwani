<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhwani AI - Eprashala Aptitude Test</title>
    <script src="qa.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; display: flex; justify-content: center; height: 100dvh; box-sizing: border-box; }
        .container { background: white; max-width: 800px; width: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        button { background: #2980b9; color: white; border: none; padding: 14px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.2s; }
        button:hover { background: #1c5980; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        /* Specific button colors */
        .btn-green { background: #27ae60; } .btn-green:hover { background: #219653; }
        .btn-purple { background: #8e44ad; } .btn-purple:hover { background: #732d91; }
        .btn-orange { background: #f39c12; } .btn-orange:hover { background: #d68910; }
        .btn-red { background: #c0392b; } .btn-red:hover { background: #a53125; }

        input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        input[type="file"] { width: 100%; padding: 10px; border: 1px dashed #2980b9; border-radius: 8px; background: #f9fbfc; cursor: pointer; }
        
        #setup-screen, #api-key-screen { padding: 40px 20px; text-align: center; overflow-y: auto; height: 100%; }
        #api-key-screen { display: none; } 
        
        #test-screen { display: none; flex-direction: column; height: 100%; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 15px; }
        #stage-indicator { background: #e67e22; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; display: inline-block; margin-top: 5px; }
        
        #chat-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 90%; padding: 14px; border-radius: 10px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; }
        .bot-msg { background: #e3f2fd; color: #0b3c7c; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #bbdefb; }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .controls-area { padding: 15px; background: white; border-top: 1px solid #eee; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .input-row { display: flex; gap: 10px; align-items: center; }
        
        #micBtn { 
            background: #e67e22; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; flex-shrink: 0; border: none; padding: 0; transition: 0.2s;
            -webkit-user-select: none; -webkit-touch-callout: none; user-select: none; touch-action: none;
        }
        #micBtn.listening { background: #e74c3c; box-shadow: 0 0 15px rgba(231, 76, 60, 0.6); transform: scale(1.08); }
        
        #full-loader { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box;}
        
        #report-screen { display: none; flex-direction: column; height: 100%; }
        #report-content { flex: 1; overflow-y: auto; padding: 20px; background: white; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 20px; border-radius: 0 8px 8px 0; }
        #consult-area { background: #eef2f5; padding: 20px; border-top: 2px solid #ddd; }
        #consult-history { max-height: 250px; overflow-y: auto; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd;}
        
        .tts-controls { display: flex; gap: 10px; padding: 0 20px 15px 20px; justify-content: center; }
        .tts-controls button { width: auto; flex: 1; margin-top: 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen">
        <h2>Dhwani AI - Aptitude Test</h2>
        <p style="color: #666; font-size: 14px;">Eprashala Hybrid Architecture</p>
        <input type="text" id="childName" placeholder="Student's Name" required>
        <input type="number" id="childAge" placeholder="Age (e.g., 14)" required>
        <input type="text" id="childCity" placeholder="City/Town (e.g., Pune)" required>
        <button onclick="startTest()">Begin Assessment (Offline)</button>

        <hr style="border:0; border-top:1px dashed #ccc; margin: 30px 0 20px 0;">
        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Already took the test? Skip directly to the report generation.</p>
        <button onclick="skipToUpload()" class="btn-orange" style="margin-top: 0;">‚è≠Ô∏è Skip to Upload Assessment</button>
    </div>

    <div id="test-screen">
        <div class="header">
            <div id="test-header">Dhwani Session</div>
            <div id="stage-indicator">Welcome</div>
        </div>
        <div id="chat-history"></div>
        <div class="controls-area">
            <p id="mic-status" style="font-size: 11px; color: #7f8c8d; margin: 0 0 5px 0; text-align: center;">Hold mic to speak. Auto-sends on release.</p>
            <div class="input-row">
                <button id="micBtn">üé§</button>
                <input type="text" id="userInput" placeholder="Type or hold mic..." onkeypress="handleEnter(event)">
                <button id="sendBtn" onclick="submitAnswer()" style="display: none;">Send</button>
            </div>
        </div>
    </div>

    <div id="api-key-screen">
        <h2>Assessment Complete!</h2>
        
        <div style="background: #fff3cd; border-left: 4px solid #f39c12; padding: 15px; text-align: left; margin-bottom: 20px; border-radius: 4px;">
            <p style="color: #d35400; font-weight: bold; font-size: 14px; margin-top:0;">‚ö†Ô∏è IMPORTANT BACKUP REQUIRED</p>
            <p style="color: #555; font-size: 13px; margin-bottom: 10px;">Please download your raw assessment transcript and keep it handy. If the AI server is busy or fails to generate the report, you can reload the page and upload this file to try again without retaking the 30-minute test.</p>
            <button onclick="downloadRawTranscript()" class="btn-green" style="margin-top: 0;">‚¨áÔ∏è Download Raw Transcript</button>
        </div>

        <div style="text-align: left; margin-bottom: 25px;">
            <p style="color: #666; font-size: 13px; font-weight: bold;">Restore Previous Session:</p>
            <input type="file" id="transcriptUpload" accept=".txt" onchange="uploadRawTranscript(event)">
        </div>
        
        <hr style="border:0; border-top:1px dashed #ccc; margin: 20px 0;">
        
        <p style="color: #666; font-size: 14px; font-weight: bold;">Enter Gemini API Key for Analysis:</p>
        <input type="password" id="apiKey" placeholder="Enter Gemini API Key" required>
        <button onclick="generateFinalReport()">Generate Final Report</button>
    </div>

    <div id="report-screen">
        <div id="report-content"></div>
        
        <h4 style="text-align: center; color: #2c3e50; margin-bottom: 10px;">üîä Read Report Aloud</h4>
        <div class="tts-controls">
            <button onclick="playReportText()" class="btn-purple">‚ñ∂Ô∏è Play</button>
            <button onclick="pauseReportText()" class="btn-orange">‚è∏Ô∏è Pause</button>
            <button onclick="stopReportText()" class="btn-red">‚èπÔ∏è Stop</button>
        </div>

        <div style="padding: 0 20px;">
            <button onclick="downloadInitialReport()" style="background: #e67e22; margin-bottom: 20px;">‚¨áÔ∏è Download Report & Q&A</button>
        </div>

        <div id="consult-area">
            <h3 style="margin-top:0; color:#2c3e50;">Consult Dhwani AI</h3>
            <div id="consult-history"></div>
            <div class="input-row">
                <input type="text" id="consultInput" placeholder="Ask about colleges, streams..." onkeypress="if(event.key === 'Enter') sendConsult()">
                <button onclick="sendConsult()" style="width: auto; margin:0;">Ask</button>
            </div>
            <button onclick="downloadFullSession()" class="btn-green">‚¨áÔ∏è Export Entire Session</button>
        </div>
    </div>

    <div id="full-loader">
        <h2 id="loader-text">Dhwani is analyzing...</h2>
    </div>
</div>

<script>
    let childData = { name: "", age: 0, city: "" };
    let apiKey = "";
    
    let currentStage = 0;
    let questionCount = 0;
    const questionsPerStage = 10; 
    let fullTranscript = ""; 
    let generatedReportHtml = ""; 
    let lastBotQuestion = ""; 
    let consultHistory = [];
    let isProcessing = false;
    let questionStartTime = 0; 
    let reportUtterance = null; 
    
    let currentSpeechUtterance = null; // Global variable to prevent TTS garbage collection bugs

    const STAGE_NAMES = ["Stage 0: Basics", "Stage 1: Quick Fire", "Stage 2: Short Thoughts", "Stage 3: Exploration", "Stage 4: Stress Test"];

    if (typeof QUESTION_BANK === 'undefined') {
        alert("CRITICAL ERROR: qa.js file is missing or failed to load. The app cannot run.");
    }

    let activeQuestionQueues = {};

    function initializeQuestionQueues() {
        for (let stage in QUESTION_BANK) {
            activeQuestionQueues[stage] = [...QUESTION_BANK[stage]].sort(() => 0.5 - Math.random());
        }
    }

    // --- NEW: Skip to Upload ---
    function skipToUpload() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('api-key-screen').style.display = 'block';
    }

    // --- PUSH-TO-TALK LOGIC ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isButtonHeld = false; 
    let committedText = ""; 

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false; 
        recognition.interimResults = true; 
        recognition.lang = 'en-IN'; 
        
        recognition.onstart = () => { 
            document.getElementById('micBtn').classList.add('listening'); 
            document.getElementById('mic-status').innerText = "Listening... Release to send.";
            document.getElementById('userInput').placeholder = "Listening...";
        };
        
        recognition.onresult = (e) => { 
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = e.resultIndex; i < e.results.length; ++i) {
                if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
                else interimTranscript += e.results[i][0].transcript;
            }
            
            if (finalTranscript) {
                if (committedText.length > 0 && !committedText.endsWith(' ') && !finalTranscript.startsWith(' ')) committedText += ' ';
                committedText += finalTranscript;
            }
            document.getElementById('userInput').value = committedText + interimTranscript;
        };

        recognition.onend = () => { 
            if (isButtonHeld) {
                try { recognition.start(); } catch(err) {}
            } else {
                stopListeningUI();
                setTimeout(() => {
                    const inputVal = document.getElementById('userInput').value.trim();
                    if (inputVal.length > 0) submitAnswer();
                }, 500);
            }
        };

        recognition.onerror = (e) => { if (e.error !== 'no-speech') stopListeningUI(); };
    }

    const micBtn = document.getElementById('micBtn');

    function startListening(e) {
        if (e) e.preventDefault();
        if (isProcessing || isButtonHeld || !recognition) return;
        isButtonHeld = true;
        committedText = document.getElementById('userInput').value;
        if (committedText.length > 0 && !committedText.endsWith(' ')) committedText += ' ';
        try { recognition.start(); } catch(err) {}
    }

    function stopListening(e) {
        if (e) e.preventDefault();
        if (!isButtonHeld) return;
        isButtonHeld = false; 
        try { recognition.stop(); } catch(err) {} 
    }

    micBtn.addEventListener('touchstart', startListening, { passive: false });
    micBtn.addEventListener('touchend', stopListening);
    micBtn.addEventListener('touchcancel', stopListening);
    micBtn.addEventListener('mousedown', startListening);
    micBtn.addEventListener('mouseup', stopListening);
    micBtn.addEventListener('mouseleave', stopListening);

    function stopListeningUI() {
        document.getElementById('micBtn').classList.remove('listening'); 
        document.getElementById('mic-status').innerText = "Hold mic to speak. Auto-sends on release.";
        document.getElementById('userInput').placeholder = "Type or hold mic...";
    }

    // --- TTS SETUP & CONTROL (UPDATED WITH CALLBACKS) ---
    function unlockAndroidAudio() {
        const silentUtterance = new SpeechSynthesisUtterance('');
        silentUtterance.volume = 0;
        window.speechSynthesis.speak(silentUtterance);
    }

    function speakDhwaniResponse(text, onCompleteCallback = null) {
        if (!('speechSynthesis' in window)) {
            // Fallback if browser doesn't support TTS
            if (onCompleteCallback) setTimeout(onCompleteCallback, text.length * 50);
            return;
        }
        
        window.speechSynthesis.cancel(); 
        
        currentSpeechUtterance = new SpeechSynthesisUtterance(text);
        
        let voices = window.speechSynthesis.getVoices();
        let targetVoice = voices.find(v => 
            (v.lang.includes('en-IN') || v.lang.includes('hi-IN') || v.lang.includes('mr-IN')) && 
            (v.name.toLowerCase().includes('female') || v.name.includes('Google'))
        ) || voices.find(v => v.lang === 'en-IN');
        
        if (targetVoice) currentSpeechUtterance.voice = targetVoice;
        currentSpeechUtterance.rate = 0.85; 
        currentSpeechUtterance.pitch = 1.1; 

        // THIS FIXES THE INTERRUPTION BUG!
        if (onCompleteCallback) {
            currentSpeechUtterance.onend = function() {
                setTimeout(onCompleteCallback, 500); // Small 500ms pause after speaking before moving on
            };
            currentSpeechUtterance.onerror = function(e) {
                console.warn("TTS Error, skipping to next function:", e);
                setTimeout(onCompleteCallback, 500);
            };
        }

        window.speechSynthesis.speak(currentSpeechUtterance);
    }

    // --- CORE LOCAL LOGIC ---
    function startTest() {
        childData.name = document.getElementById('childName').value.trim();
        childData.age = parseInt(document.getElementById('childAge').value);
        childData.city = document.getElementById('childCity').value.trim();

        if(!childData.name || !childData.age || !childData.city) { alert("Please fill all fields."); return; }

        unlockAndroidAudio(); 
        initializeQuestionQueues(); 
        
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('test-screen').style.display = 'flex';
        
        isProcessing = true;
        let introMsg = `Namaste ${childData.name}. Welcome to the Eprashala Aptitude Assessment. I am Dhwani. Please take a deep breath, relax, and stay calm. This test will take about 30 minutes. Please give the answers that naturally come to your mind without the influence of any person in or around you. Let's begin with Stage 0.`;
        
        addMessage(introMsg, 'bot', 'chat-history');
        
        // Wait until intro completely finishes speaking before asking first question
        speakDhwaniResponse(introMsg, () => {
            isProcessing = false;
            askNextLocalQuestion();
        });
    }

    function askNextLocalQuestion() {
        document.getElementById('stage-indicator').innerText = STAGE_NAMES[currentStage];
        
        let nextQuestion = activeQuestionQueues[currentStage].pop();
        if (!nextQuestion) nextQuestion = "Please tell me a bit more about your career interests.";

        lastBotQuestion = nextQuestion;
        addMessage(nextQuestion, 'bot', 'chat-history');
        speakDhwaniResponse(nextQuestion);
        
        questionStartTime = Date.now();
    }

    function submitAnswer() {
        if (isProcessing) return;
        if (isButtonHeld) { isButtonHeld = false; try { recognition.stop(); } catch(e){} }

        const input = document.getElementById('userInput');
        const answerTxt = input.value.trim();
        if (!answerTxt) return;
        
        isProcessing = true; 
        
        let responseTimeSecs = (Date.now() - questionStartTime) / 1000;
        let cognitiveTrait = "";
        if (responseTimeSecs < 4) cognitiveTrait = "Impulsive/Impatient";
        else if (responseTimeSecs > 25) cognitiveTrait = "Deep Thinking/Hesitant";
        else cognitiveTrait = "Stable/Calculated";
        
        addMessage(answerTxt, 'user', 'chat-history');
        
        fullTranscript += `Stage ${currentStage} - Q: ${lastBotQuestion}\nUser (${childData.name}) [Response Time: ${responseTimeSecs.toFixed(1)}s - ${cognitiveTrait}]: ${answerTxt}\n\n`;

        input.value = '';
        committedText = ''; 
        questionCount++;
        
        if (questionCount >= questionsPerStage) {
            currentStage++;
            questionCount = 0;
            
            const chat = document.getElementById('chat-history');
            const divider = document.createElement('div');
            divider.innerHTML = `<hr style="border:0; border-top:1px dashed #ccc; margin: 20px 0;">`;
            chat.appendChild(divider);

            if (currentStage > 4) {
                document.getElementById('test-screen').style.display = 'none';
                document.getElementById('api-key-screen').style.display = 'block';
                speakDhwaniResponse("The offline assessment is complete. Please download your backup file and provide the API key for analysis.");
                return;
            } else {
                let transitionMsg = "";
                if (currentStage === 1) transitionMsg = `Congratulations on completing the Basics, ${childData.name}! We will now move on to Stage 1: Quick Fire. In this stage, you must answer strictly with a 'Yes' or 'No'. Rely on your immediate gut instinct.`;
                else if (currentStage === 2) transitionMsg = `Well done! You have successfully completed Stage 1. Let's move to Stage 2: Short Thoughts. Here, I need you to summarize your answers in exactly one clear sentence.`;
                else if (currentStage === 3) transitionMsg = `Excellent work so far. We are entering Stage 3: Exploration. For these questions, take your time. I want 2 to 3 sentences explaining your analytical reasoning and thought process.`;
                else if (currentStage === 4) transitionMsg = `You have reached the final stage, ${childData.name}. Please listen to me carefully. Stage 4 is the Stress Test. The upcoming questions will be intentionally frustrating, blunt, and confrontational. Frustrating you is a deliberate part of this stage to measure your raw resilience. I request you to stay calm, focus, and give me answers as per your real mindset. Let's begin.`;

                addMessage(transitionMsg, 'bot', 'chat-history');
                
                // Wait until transition message is FULLY spoken before asking next question
                speakDhwaniResponse(transitionMsg, () => {
                    isProcessing = false;
                    askNextLocalQuestion();
                });
                return;
            }
        }

        // Just a normal question delay, no speaking conflict here
        setTimeout(() => {
            isProcessing = false;
            askNextLocalQuestion();
        }, 500);
    }

    function handleEnter(e) { if (e.key === 'Enter') submitAnswer(); }
    function cleanText(text) { return text.replace(/\*\*(.*?)\*\*/g, '$1').replace(/\*/g, ''); }

    // --- TRANSCRIPT BACKUP & RESTORE LOGIC ---
    function downloadRawTranscript() {
        if (!fullTranscript) { alert("The transcript is empty. You must take the test first."); return; }
        
        let header = `--- EPRASHALA RAW ASSESSMENT BACKUP ---\n`;
        header += `Name: ${childData.name || 'Student'}\nAge: ${childData.age || 'N/A'}\nCity: ${childData.city || 'N/A'}\n\n`;
        
        triggerDownload(header + fullTranscript, `Dhwani_Raw_Backup_${childData.name || 'Student'}.txt`);
    }

    function uploadRawTranscript(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            fullTranscript = e.target.result;
            
            if(!childData.name) {
                const nameMatch = fullTranscript.match(/Name: (.*)/);
                if(nameMatch) childData.name = nameMatch[1];
            }
            alert("Backup transcript successfully loaded! You can now enter your API key to generate the report.");
        };
        reader.readAsText(file);
    }

    // --- GEMINI API: REPORT GENERATION ---
    async function generateFinalReport() {
        apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) { alert("Please enter the API key to generate the report."); return; }
        if (!fullTranscript) { alert("No transcript found! Please take the test or upload a backup file."); return; }

        setLoading(true, "Sending transcript to Dhwani Cloud for deep analysis...");
        
        const reportPrompt = `You are an Expert Career Consultant and Master Psychologist. The user (${childData.name}, Age ${childData.age}, from ${childData.city}) just completed a highly stressful 30-minute psychometric aptitude test.
        Here is the full flat-text transcript of their answers. Notice the "Response Time" tags (Impulsive vs Stable vs Deep Thinking) attached to every answer.
        
        ${fullTranscript}
        
        Act as an expert career consultant to give the right direction to the future of the child. Make it as realistic and brutally honest as possible.
        Analyze their cognitive speed (based on the Response Time metadata), emotional resilience in Stage 4, and core interests.
        
        Output ONLY raw HTML. DO NOT use markdown like \`\`\`html.
        Format strictly:
        <h2 style='color:#2980b9'>Dhwani Eprashala: Expert Psychometric Report</h2>
        <div class='report-card'><b>Cognitive Processing & Stability:</b> (Analyze their response times here. Are they impatient, stable, or hesitant?)</div>
        <div class='report-card'><b>Resilience & Stress Handling:</b> (How did they handle the Stage 4 frustration?)</div>
        <div class='report-card'><b>Personality & Flaws:</b> Honest assessment based on text.</div>
        <div class='report-card'><b>Recommended Indian Career Streams:</b> Top 3 paths perfectly suitable for their psychology.</div>`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ role: "user", parts: [{ text: reportPrompt }] }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" }
                    ]
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || "Report Generation Failed");

            let rawHtml = data.candidates[0].content.parts[0].text;
            rawHtml = rawHtml.replace(/^```html\n|```\n?$/gm, '').trim();
            generatedReportHtml = rawHtml; 

            document.getElementById('api-key-screen').style.display = 'none';
            document.getElementById('report-screen').style.display = 'flex';
            document.getElementById('report-content').innerHTML = rawHtml;
            
            speakDhwaniResponse("Assessment complete. Your final report is ready. You can use the playback buttons to listen to it, or consult me for advice below.");
        } catch (e) { 
            console.error("Report Error:", e);
            alert(`Error generating report: ${e.message}`); 
        } finally {
            setLoading(false);
            isProcessing = false;
        }
    }

    // --- REPORT TTS PLAYBACK CONTROLS ---
    function playReportText() {
        if (!('speechSynthesis' in window)) { alert("Your browser does not support Speech Synthesis."); return; }
        
        if (window.speechSynthesis.paused && reportUtterance) {
            window.speechSynthesis.resume();
            return;
        }
        
        window.speechSynthesis.cancel(); 
        
        const pureText = document.getElementById('report-content').innerText;
        if (!pureText) return;

        reportUtterance = new SpeechSynthesisUtterance(pureText);
        
        let voices = window.speechSynthesis.getVoices();
        let targetVoice = voices.find(v => (v.lang.includes('en-IN') || v.lang.includes('hi-IN')) && (v.name.toLowerCase().includes('female') || v.name.includes('Google'))) || voices.find(v => v.lang === 'en-IN');
        if (targetVoice) reportUtterance.voice = targetVoice;
        
        reportUtterance.rate = 0.85; 
        reportUtterance.pitch = 1.0;

        window.speechSynthesis.speak(reportUtterance);
    }

    function pauseReportText() {
        if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
            window.speechSynthesis.pause();
        }
    }

    function stopReportText() {
        window.speechSynthesis.cancel();
    }

    // --- GEMINI API: CONSULTATION ---
    async function sendConsult() {
        const input = document.getElementById('consultInput');
        const text = input.value.trim();
        if (!text) return;
        addMessage(text, 'user', 'consult-history');
        
        consultHistory.push({ role: "user", parts: [{ text: text }] });
        input.value = '';
        
        const systemPrompt = `You are Dhwani, an expert Indian career consultant. 
        The user (${childData.name}) just took a deep aptitude test. Here is their offline test transcript:
        ---
        ${fullTranscript}
        ---
        Based on their psychological profile, give practical, realistic advice on Indian colleges, coaching, skills, and entrance exams. 
        Reply in plain text. DO NOT USE MARKDOWN. Keep your tone professional, guiding, and expert.`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: systemPrompt }] },
                    contents: consultHistory
                })
            });
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error?.message || "API Error");
            
            const reply = cleanText(data.candidates[0].content.parts[0].text);
            
            consultHistory.push({ role: "model", parts: [{ text: reply }] });
            addMessage(reply, 'bot', 'consult-history');
            speakDhwaniResponse(reply); 
        } catch(e) { 
            console.error(e);
            alert(`Error connecting to Dhwani: ${e.message}`); 
            consultHistory.pop(); 
        }
    }

    // --- EXPORT OPTIONS ---
    function downloadInitialReport() {
        let cleanSummary = generatedReportHtml.replace(/<[^>]*>?/gm, ''); 
        let textToSave = `--- EPRASHALA APTITUDE REPORT: ${childData.name || 'Student'} ---\n\n`;
        textToSave += `--- OFFLINE TEST TRANSCRIPT ---\n${fullTranscript}\n\n`;
        textToSave += `--- AI EXECUTIVE SUMMARY ---\n${cleanSummary}\n`;
        triggerDownload(textToSave, `Dhwani_Report_${childData.name || 'Student'}.txt`);
    }

    function downloadFullSession() {
        let cleanSummary = generatedReportHtml.replace(/<[^>]*>?/gm, ''); 
        let textToSave = `--- EPRASHALA FULL SESSION: ${childData.name || 'Student'} ---\n\n`;
        textToSave += `--- OFFLINE TEST TRANSCRIPT ---\n${fullTranscript}\n\n`;
        textToSave += `--- AI EXECUTIVE SUMMARY ---\n${cleanSummary}\n\n`;
        textToSave += `--- POST-TEST AI CONSULTATION ---\n`;
        
        consultHistory.forEach(msg => { 
            let roleName = msg.role === 'user' ? (childData.name || 'Student') : 'Dhwani';
            textToSave += `${roleName}: ${msg.parts[0].text}\n\n`; 
        });
        
        triggerDownload(textToSave, `Dhwani_Full_Session_${childData.name || 'Student'}.txt`);
    }

    function triggerDownload(content, filename) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([content], { type: "text/plain" }));
        link.download = filename;
        link.click();
    }

    function addMessage(text, sender, containerId) {
        const chat = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = `message ${sender}-msg`;
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function setLoading(show, text="") {
        document.getElementById('full-loader').style.display = show ? 'flex' : 'none';
        document.getElementById('loader-text').innerText = text;
    }
</script>
</body>
</html>