<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Blaster - AI Mentor (Sachin)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Tricolor Pulse Animation - Saffron/Green/White glow */
        .listening-pulse { animation: tricolor-pulse 2s infinite ease-in-out; }
        @keyframes tricolor-pulse {
            0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); } /* Saffron */
            50% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0.1); } /* White */
            100% { box-shadow: 0 0 0 20px rgba(22, 163, 74, 0); } /* Green */
        }

        /* UI: Icon Button Styles - Blue Jersey Theme */
        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-slate-800 hover:bg-blue-700 shadow-lg border border-slate-600
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-orange-500
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        /* UI: Utility Buttons */
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-slate-800 text-gray-200 border border-slate-700
                   hover:bg-blue-800 hover:border-blue-500
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-blue-500
                   disabled:bg-slate-900 disabled:text-gray-600 disabled:cursor-not-allowed;
        }

        /* UI: Inputs - Pitch Dark */
        .custom-input {
            @apply block w-3/4 mx-auto text-center border border-slate-600 rounded-lg p-3 outline-none transition-all;
            background-color: #020617 !important; /* Slate 950 */
            color: #f97316 !important;             /* Orange 500 */
            caret-color: #22c55e !important;       /* Green caret */
        }
        .custom-input::placeholder {
            color: #475569 !important;
            opacity: 1 !important;
        }

        /* Scrollbar for chat */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
    </style>
</head>

<body class="bg-slate-950 text-white flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-slate-900 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto border-t-4 border-orange-500 border-b-4 border-green-600 relative overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 via-white to-green-600 opacity-50"></div>

        <div class="flex items-center justify-between mb-4 shrink-0 relative z-10">
            <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-2">
                <span class="text-blue-400">Master</span> Blaster
                <span class="text-xs bg-orange-600 text-white px-2 py-0.5 rounded-full ml-1">AI</span>
            </h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-600 transition-colors border border-gray-400" title="Pavilion (Offline)"></div>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-[#0B1120] rounded-lg p-4 mb-4 border border-slate-700 space-y-4 shadow-inner min-h-[200px] relative z-10">
            <div class="text-gray-500 text-center mt-10">
                Say "Sachin", "Master" or "Tendulkar".<br>
                <span class="text-sm opacity-70 text-blue-300">Wisdom from the Pitch to Life.</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-slate-800/40 p-2 rounded-xl border border-slate-700/50 relative z-10">
            <button id="pause-resume-button" class="icon-btn" title="Pause/Resume" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-orange-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn" title="Stop Speaking" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-red-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>

            <button id="replay-button" class="icon-btn" title="Replay Last Message" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-green-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <div class="flex flex-col gap-4 mb-4 shrink-0 w-full text-center relative z-10">
            <div class="w-full">
                <label class="text-xs text-orange-400 mb-1 block font-semibold">PLAYER NAME (नाव)</label>
                <input type="text" id="manual-name" class="custom-input" placeholder="Arjun / Your Name">
            </div>
            <div class="w-full">
                <label class="text-xs text-green-500 mb-1 block font-semibold">AGE (वय) - For Guidance Level</label>
                <input type="number" id="manual-age" class="custom-input" placeholder="25">
            </div>
        </div>

        <div class="flex items-center justify-center gap-2 mb-2 shrink-0 relative z-10">
            <input type="checkbox" id="remember-me-checkbox" class="w-4 h-4 text-blue-600 bg-slate-800 border-slate-600 rounded focus:ring-blue-500">
            <label for="remember-me-checkbox" class="text-sm text-gray-400 cursor-pointer select-none hover:text-white transition-colors">
                Remember Stats
            </label>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0 relative z-10">
            <button id="advance-toggle-btn" class="text-xs text-slate-500 hover:text-blue-400 mb-2 focus:outline-none transition-colors">
                ▼ API Settings
            </button>

            <div id="advance-container" class="hidden w-full bg-slate-800/90 border border-slate-700 rounded-lg p-4 flex flex-col gap-3 transition-all backdrop-blur-sm">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="use-custom-key-checkbox" class="w-4 h-4 text-orange-500 bg-slate-900 border-slate-600 rounded">
                    <label for="use-custom-key-checkbox" class="text-sm text-gray-300">Use custom API Key</label>
                </div>
                <input type="text" id="custom-api-key-input" class="custom-input text-xs w-full !w-full border-blue-900" placeholder="Paste Gemini API Key" disabled>
                <button id="paste-key-btn" type="button" disabled class="w-full py-2 px-4 bg-blue-900/50 hover:bg-blue-800 text-white text-xs rounded border border-blue-700">Paste</button>
                <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-center w-full py-2 text-xs text-blue-300 hover:text-white hover:underline">Get API Key ↗</a>
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-bold tracking-wide transition-all duration-300 ease-in-out shrink-0 relative z-10
                       bg-gradient-to-r from-blue-700 to-blue-600 text-white shadow-lg shadow-blue-900/50 border border-blue-500
                       hover:from-blue-600 hover:to-blue-500 hover:shadow-blue-500/30 hover:-translate-y-0.5
                       focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50
                       disabled:from-slate-700 disabled:to-slate-800 disabled:border-slate-600 disabled:text-gray-500 disabled:cursor-not-allowed">
            ENTER STADIUM (Start)
        </button>

        <div class="mt-4 grid grid-cols-3 gap-3 shrink-0 relative z-10">
            <button id="restart-chat-button" class="utility-btn hover:text-orange-400" disabled>New Innings</button>
            <button id="share-button" class="utility-btn bg-slate-800 hover:bg-slate-700 text-green-400 border-green-900">Share Score</button>
            <button id="end-chat-button" class="utility-btn text-red-400 hover:bg-red-900/20 border-red-900/30" disabled>Declare</button>
        </div>

    </div>

    <script>
        // --- UTILITY: PREVENT RIGHT CLICK ---
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- UTILITY: FULLSCREEN ---
        function enterFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen(); } 
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } 
            else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
        }

        // --- DOM ELEMENTS ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const shareButton = document.getElementById('share-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');
        
        // Advance Settings
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        // --- CONFIGURATION ---
        // Placeholder Key - User should ideally provide their own
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 18; 
        let chatHistory = [];
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        // --- INITIALIZATION ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData(); 
            loadVoices();   
        };

        // --- UI LOGIC ---
        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
        });

        useCustomKeyCheckbox.addEventListener('change', () => {
            const isChecked = useCustomKeyCheckbox.checked;
            customApiKeyInput.disabled = !isChecked;
            pasteKeyBtn.disabled = !isChecked;
            saveUserData(); 
            if (isChecked) customApiKeyInput.focus();
        });

        customApiKeyInput.addEventListener('input', saveUserData);

        pasteKeyBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    customApiKeyInput.value = text;
                    saveUserData();
                    const originalText = pasteKeyBtn.innerHTML;
                    pasteKeyBtn.textContent = "Done!";
                    setTimeout(() => { pasteKeyBtn.innerHTML = originalText; }, 1000);
                }
            } catch (err) { alert('Paste manually.'); }
        });

        function getEffectiveApiKey() {
            if (useCustomKeyCheckbox.checked && customApiKeyInput.value.trim().length > 10) {
                return customApiKeyInput.value.trim();
            }
            return DEFAULT_API_KEY;
        }

        // --- STORAGE LOGIC (UPDATED KEYS FOR SACHIN) ---
        function loadUserData() {
            try {
                const savedName = localStorage.getItem('sachin_userName');
                const savedAge = localStorage.getItem('sachin_userAge');
                const savedRemember = localStorage.getItem('sachin_remember');

                if (savedRemember === 'true') {
                    rememberMeCheckbox.checked = true;
                    if (savedName) manualNameInput.value = savedName;
                    if (savedAge) manualAgeInput.value = savedAge;
                    if (savedName && savedAge) talkButton.textContent = `Resume as ${savedName}`;
                }

                const savedUseKey = localStorage.getItem('sachin_useCustomKey');
                const savedKey = localStorage.getItem('sachin_customKey');

                if (savedUseKey === 'true') {
                    useCustomKeyCheckbox.checked = true;
                    customApiKeyInput.disabled = false;
                    pasteKeyBtn.disabled = false;
                    if (savedKey) customApiKeyInput.value = savedKey;
                }
            } catch (e) { console.error(e); }
        }

        function saveUserData() {
            try {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('sachin_remember', 'true');
                    localStorage.setItem('sachin_userName', manualNameInput.value.trim());
                    localStorage.setItem('sachin_userAge', manualAgeInput.value.trim());
                } else {
                    localStorage.removeItem('sachin_remember');
                    localStorage.removeItem('sachin_userName');
                    localStorage.removeItem('sachin_userAge');
                }
                localStorage.setItem('sachin_useCustomKey', useCustomKeyCheckbox.checked);
                if (customApiKeyInput.value) {
                    localStorage.setItem('sachin_customKey', customApiKeyInput.value.trim());
                }
            } catch (e) { console.error(e); }
        }

        function loadChatContext(name) {
            const key = `sachin_history_${name.toLowerCase()}`;
            const savedHistory = localStorage.getItem(key);
            try { return savedHistory ? JSON.parse(savedHistory) : []; } catch (e) { return []; }
        }

        function saveChatContext() {
            if (!userName) return;
            const key = `sachin_history_${userName.toLowerCase()}`;
            const limitedHistory = chatHistory.slice(-20); 
            localStorage.setItem(key, JSON.stringify(limitedHistory));
        }

        manualNameInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });
        manualAgeInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });


        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            logMessage('Error', 'Browser not supported. Use Chrome on Android/Desktop.');
            talkButton.disabled = true;
            talkButton.textContent = "Browser Not Supported";
        } else {
            try {
                recognition = new SpeechRecognition();
                recognition.continuous = false; 
                recognition.interimResults = false;
                recognition.lang = 'mr-IN'; 

                recognition.onresult = handleSpeechResult;
                recognition.onend = handleSpeechEnd;
                
                recognition.onerror = (event) => {
                    console.log("Mic Error:", event.error);
                    if (event.error === 'no-speech' && appState !== 'IDLE' && appState !== 'BUSY') {
                        startRecognitionSafe();
                    } else if (event.error === 'not-allowed') {
                        setState('IDLE');
                        alert("Microphone access denied.");
                    }
                };
            } catch (e) { alert("Mic Error: " + e.message); }
        }

        function startRecognitionSafe() {
            if (!recognition) return;
            try { recognition.start(); } catch (e) {}
        }

        // --- MAIN INTERACTION FLOW ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        shareButton.addEventListener('click', shareChat);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);
        document.addEventListener('visibilitychange', handleVisibilityChange);

        async function toggleListening() {
            if (appState === 'IDLE') {
                try { enterFullScreen(); } catch(e) {}
            }

            try {
                if (appState === 'IDLE') {
                    talkButton.textContent = "Warming Up...";
                    talkButton.disabled = true;
                    await acquireWakeLock(); 
                    
                    const inputName = manualNameInput.value.trim();
                    const inputAge = manualAgeInput.value.trim();

                    if (inputName && inputAge) {
                        userName = inputName;
                        userAge = parseInt(inputAge);
                        if(userAge < 5) userAge = 5; 
                        saveUserData(); 
                        buildSystemPrompt(); 

                        // CHECK HISTORY
                        const previousHistory = loadChatContext(userName);
                        
                        if (previousHistory.length > 0) {
                            chatHistory = previousHistory;
                            logMessage('System', 'Resuming previous innings...');
                            
                            setState('BUSY');
                            const welcomeBackPrompt = "The player has returned to the crease. Greet them in Marathi as Sachin. Say 'Namaskar [Name], welcome back to the pitch'.";
                            
                            const tempHistory = [...chatHistory, { role: 'user', parts: [{ text: welcomeBackPrompt }] }];
                            const welcomeText = await getAIResponse(tempHistory);
                            
                            logMessage('Sachin', welcomeText);
                            await speakText(welcomeText, 'mr-IN');
                            setState('CONVERSATION');
                            startRecognitionSafe();

                        } else {
                            if (chatHistory.length === 0) {
                                chatHistory.push({ role: 'user', parts: [{ text: "Start session." }] });
                                chatHistory.push({ role: 'model', parts: [{ text: `Namaskar ${userName}.` }] });
                            }
                            const welcomeText = `नमस्कार ${userName}, मी सचिन बोलतोय. आज आपण कोणत्या आव्हानावर चर्चा करणार आहोत?`;
                            logMessage('Sachin', welcomeText);
                            
                            setState('BUSY'); 
                            await speakText(welcomeText, 'mr-IN');
                            setState('CONVERSATION');
                            startRecognitionSafe();
                        }

                    } else {
                        setState('LISTENING_FOR_WAKEWORD');
                        startRecognitionSafe();
                        if (conversationLog.childElementCount < 3) logMessage('Info', 'Say "Sachin", "Master" or "Tendulkar"');
                    }

                } else {
                    setState('IDLE');
                    recognition.stop();
                    if (synth.speaking) synth.cancel();
                    await releaseWakeLock();
                }
            } catch (error) {
                console.error(error);
                setState('IDLE');
            }
        }

        function setState(newState) {
            appState = newState;
            switch (newState) {
                case 'IDLE':
                    talkButton.textContent = 'ENTER STADIUM (Start)';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-500 transition-colors border border-gray-400';
                    statusIndicator.title = "Offline";
                    endChatButton.disabled = true;
                    talkButton.className = "w-full py-4 px-6 rounded-lg text-lg font-bold tracking-wide transition-all duration-300 ease-in-out shrink-0 relative z-10 bg-gradient-to-r from-blue-700 to-blue-600 text-white shadow-lg shadow-blue-900/50 border border-blue-500 hover:from-blue-600 hover:to-blue-500 hover:shadow-blue-500/30 hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50";
                    manualNameInput.disabled = false;
                    manualAgeInput.disabled = false;
                    break;
                case 'BUSY':
                    talkButton.textContent = 'Analyzing Field Placement...';
                    talkButton.disabled = true;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-orange-500 transition-colors border border-orange-300';
                    statusIndicator.title = "Thinking";
                    endChatButton.disabled = false;
                    break;
                default:
                    talkButton.textContent = 'Listening (Tap to Stop)';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-green-500 listening-pulse transition-colors border border-green-300';
                    statusIndicator.title = "Listening";
                    endChatButton.disabled = false;
                    // Red Theme for Stop button
                    talkButton.className = "w-full py-4 px-6 rounded-lg text-lg font-bold tracking-wide transition-all duration-300 ease-in-out shrink-0 relative z-10 bg-gradient-to-r from-red-700 to-red-600 text-white shadow-lg shadow-red-900/50 border border-red-500 hover:from-red-600 hover:to-red-500 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50";
                    manualNameInput.disabled = true;
                    manualAgeInput.disabled = true;
                    break;
            }
        }

        function handleSpeechEnd() {
            if (appState !== 'IDLE' && appState !== 'BUSY') startRecognitionSafe();
            else if (appState === 'IDLE') setState('IDLE'); 
        }
        
        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            console.log(`Heard: ${transcript}`);
            
            const currentState = appState;
            recognition.stop();
            setState('BUSY');

            try {
                switch (currentState) {
                    // WAKE WORD: Sachin, Master, Tendulkar
                    case 'LISTENING_FOR_WAKEWORD':
                        const t = transcript.toLowerCase();
                        if (t.includes('sachin') || t.includes('master') || t.includes('tendulkar') || t.includes('sir') || t.includes('सचिन') || t.includes('सर')) {
                            const greeting = "नमस्कार. मी सचिन बोलतोय. तुमचे नाव काय आहे?";
                            logMessage('Sachin', greeting);
                            await speakText(greeting, 'mr-IN');
                            setState('LISTENING_FOR_NAME');
                            startRecognitionSafe(); 
                        } else {
                            setState('LISTENING_FOR_WAKEWORD');
                            startRecognitionSafe();
                        }
                        break;

                    case 'LISTENING_FOR_NAME':
                        logMessage('You', transcript);
                        userName = await extractNameFromTranscript(transcript);
                        manualNameInput.value = userName; 
                        
                        const agePrompt = `हॅलो ${userName}, तुमचे वय काय आहे?`;
                        logMessage('Sachin', agePrompt);
                        await speakText(agePrompt, 'mr-IN');
                        setState('LISTENING_FOR_AGE');
                        startRecognitionSafe();
                        break;

                    case 'LISTENING_FOR_AGE':
                        logMessage('You', transcript);
                        userAge = await extractAgeFromTranscript(transcript);
                        if(userAge < 5) userAge = 15; // default fallback
                        manualAgeInput.value = userAge; 
                        
                        saveUserData();
                        buildSystemPrompt(); 

                        const history = loadChatContext(userName);
                        if(history.length > 0) chatHistory = history;

                        const startPrompt = `सांग मित्रा, तुला आयुष्याच्या खेळपट्टीवर काय समस्या भेडसावत आहे? दडपण आहे का?`;
                        logMessage('Sachin', startPrompt);
                        await speakText(startPrompt, 'mr-IN');
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;

                    case 'CONVERSATION':
                        logMessage(userName || 'You', transcript);
                        chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                        saveChatContext();

                        const aiResponseText = await generateTextResponseFromChat();
                        // Clean text for TTS and Display
                        const cleanedResponseText = cleanTextForTTS(aiResponseText);

                        chatHistory.push({ role: 'model', parts: [{ text: cleanedResponseText }] });
                        saveChatContext();

                        logMessage('Sachin', cleanedResponseText);
                        
                        try {
                            await speakText(cleanedResponseText, 'mr-IN');
                        } catch (error) {
                            if (error.message === "Speech manually stopped") return;
                            throw error;
                        }
                        
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;
                }
            } catch (error) {
                console.error(error);
                if (systemInstruction) { setState('CONVERSATION'); startRecognitionSafe(); }
                else { setState('LISTENING_FOR_WAKEWORD'); startRecognitionSafe(); }
            }
        }

        // --- THE BRAIN: SACHIN TENDULKAR'S LOGIC ---
        function buildSystemPrompt() {
            // Determine Complexity based on Age (Cricket Metaphors)
            let complexityInstruction = "";
            if (userAge <= 12) {
                complexityInstruction = "User is a CHILD. Speak like a gentle coach (Achrekar Sir style). Focus on enjoying the game, hard work (practice), and listening to elders. Use simple cricket examples like 'keeping your eye on the ball'.";
            } else if (userAge <= 18) {
                complexityInstruction = "User is a TEENAGER. Focus on DISCIPLINE, avoiding distractions, and managing exam/match pressure. Emphasize that talent is nothing without hard work.";
            } else if (userAge <= 30) {
                complexityInstruction = "User is a YOUNG ADULT. Focus on CAREER, dealing with failure (getting out on 99), patience, and team spirit. Reference the 2011 World Cup victory - persistence pays off.";
            } else {
                complexityInstruction = "User is an ADULT/ELDER. Discuss longevity, adapting to change (like changing batting stance), humility, health, and mentoring the next generation.";
            }

            systemInstruction = `
                You are SACHIN TENDULKAR, the "God of Cricket".
                Reference Book: "Playing It My Way" (Autobiography).
                User: ${userName}, Age: ${userAge}. Language: MARATHI (Respectful, Polite, Gender-neutral).

                **CORE VIRTUES TO EMBODY:**
                1. **Discipline & Hard Work:** "There are no shortcuts."
                2. **Focus (Ekagrata):** "When I bat, I don't hear the crowd."
                3. **Humility:** "The game is always bigger than the individual."
                4. **Patriotism:** "Playing for India is the greatest honor."
                5. **Resilience:** How to bounce back after failure (or injury).

                **RULES:**
                1. **LANGUAGE:** Speak ONLY in polite Marathi (Devanagari). Use words like 'मित्र' (Friend), 'आव्हाने' (Challenges), 'प्रयत्न' (Effort).
                2. **FORMAT:** No Markdown. No asterisks. Plain text only.
                3. **TONE:** Very humble, soft-spoken, encouraging, but firm about discipline.
                4. **CONTENT:** Solve their life/mental problems using Cricket analogies and events from your life. 
                   - *Example:* If they are stressed, talk about the pressure of the 2003 World Cup against Pakistan.
                   - *Example:* If they failed, talk about getting out early but practicing harder the next day.
                
                **GOAL:** Motivate them to play the "innings of their life" with honesty and pride.
                ${complexityInstruction}
            `;
            restartChatButton.disabled = false;
        }

        // --- API CALLS ---
        async function getAIResponse(historyData) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: historyData,
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) { return "नेटवर्क त्रुटी. कृपया पुन्हा प्रयत्न करा. (Network Error)"; }
        }

        async function generateTextResponseFromChat() { return await getAIResponse(chatHistory); }

        async function extractNameFromTranscript(transcript) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Extract First Name from Marathi audio: "${transcript}". If unclear return "मित्र".` }] }] })
                });
                const result = await response.json();
                let name = result.candidates[0].content.parts[0].text.trim();
                return (name.length < 2) ? "मित्र" : name.replace(/['".]/g, '');
            } catch (error) { return "मित्र"; }
        }

        async function extractAgeFromTranscript(transcript) {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${getEffectiveApiKey()}`;
             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Extract age number from: "${transcript}". Return ONLY digits. Default 25.` }] }] })
                });
                const result = await response.json();
                let age = parseInt(result.candidates[0].content.parts[0].text.trim());
                return isNaN(age) ? 25 : age;
            } catch (e) { return 25; }
        }
        
        function cleanTextForTTS(text) {
            // Remove any potential markdown or special chars
            let cleaned = text.replace(/[*#`_]/g, ''); 
            cleaned = cleaned.replace(/\[.*?\]|\(.*?\)|{.*?}/g, ""); 
            return cleaned.replace(/\s+/g, ' ').trim();
        }

        // --- SPEECH SYNTHESIS ---
        function loadVoices() {
            voices = synth.getVoices();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        function togglePauseResume() {
            if (synth.paused) synth.resume();
            else if (synth.speaking) { synth.pause(); recognition.stop(); setState('BUSY'); }
        }

        function stopSpeech() {
            if (!synth.speaking) return;
            speechManuallyStopped = true; 
            synth.cancel(); 
            recognition.stop(); 
            toggleMediaButtons(true);
            logMessage('Info', 'Umpire Signal: Dead Ball (Stopped).');
            setTimeout(() => {
                speechManuallyStopped = false;
                if (appState !== 'IDLE') {
                    if (systemInstruction) { setState('CONVERSATION'); startRecognitionSafe(); }
                    else { setState('LISTENING_FOR_WAKEWORD'); startRecognitionSafe(); }
                }
            }, 1500);
        }

        function replaySpeech() {
            if (lastSpokenText) { recognition.stop(); setState('BUSY'); speakText(lastSpokenText); }
        }
        
        async function speakText(text, lang = 'mr-IN') {
            if (synth.speaking) synth.cancel();
            lastSpokenText = text;
            speechManuallyStopped = false;
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.onstart = () => { toggleMediaButtons(false); };
                utterance.onend = () => {
                    toggleMediaButtons(true);
                    if (speechManuallyStopped) reject(new Error("Speech manually stopped"));
                    else resolve();
                };
                utterance.onerror = (e) => { 
                    toggleMediaButtons(true);
                    if (e.error === 'interrupted') resolve(); else reject(e.error); 
                };

                // Try to find a Marathi or Hindi voice
                let marathiVoice = voices.find(voice => voice.lang === 'mr-IN') || voices.find(voice => voice.lang === 'hi-IN');
                if (marathiVoice) utterance.voice = marathiVoice;
                utterance.lang = 'mr-IN';
                
                // Polite, calm, measured pace (Sachin's style)
                utterance.rate = 0.9; 
                utterance.pitch = 1.0;
                
                synth.speak(utterance);
            });
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }
        
        function logMessage(sender, message) {
            const div = document.createElement('div');
            let senderClass = 'text-green-400 font-semibold';
            let messageClass = 'text-gray-100';

            if (sender === 'Sachin') { senderClass = 'text-orange-400 font-bold'; }
            else if (sender === 'You') { senderClass = 'text-blue-400 font-semibold'; }

            div.innerHTML = `<strong class="${senderClass}">${sender}:</strong> <span class="${messageClass}">${message}</span>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function getChatLogAsText() {
            const messages = [];
            conversationLog.querySelectorAll('div').forEach(div => { if (div.textContent) messages.push(div.textContent); });
            return messages.join('\n');
        }

        async function shareChat() {
            const chatText = getChatLogAsText();
            if (!chatText.trim()) return;
            try { await navigator.share({ title: 'Advice from Master Blaster', text: chatText }); } 
            catch (err) { try { await navigator.clipboard.writeText(chatText); logMessage('Info', 'Scorecard Copied'); } catch (e) {} }
        }

        // --- WAKE LOCK (Keep screen on during innings) ---
        async function acquireWakeLock() {
            if ('wakeLock' in navigator) { 
                try { 
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        if (appState !== 'IDLE' && document.visibilityState === 'visible') acquireWakeLock();
                    });
                } catch (e) {} 
            }
        }

        async function releaseWakeLock() {
            if (wakeLock) { try { await wakeLock.release(); wakeLock = null; } catch (e) {} }
        }

        async function handleVisibilityChange() {
            if (appState !== 'IDLE' && document.visibilityState === 'visible') await acquireWakeLock();
        }

        async function endChat() {
            appState = 'IDLE'; setState('IDLE');
            speechManuallyStopped = true;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch (e) {}
            await releaseWakeLock();
            userName = ''; userAge = 25; chatHistory = []; systemInstruction = '';
            conversationLog.innerHTML = '<div class="text-gray-500 text-center">Match Ended. Press "Enter Stadium".</div>';
            restartChatButton.disabled = true;
        }

        async function restartChat() {
            if (!systemInstruction) return;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}
            appState = 'IDLE'; setState('IDLE');
            await releaseWakeLock();
            conversationLog.innerHTML = '';
            if(userName) {
                localStorage.removeItem(`sachin_history_${userName.toLowerCase()}`);
                chatHistory = [];
            }
            logMessage('Info', `Pitch Cleared. Ready for new innings.`);
        }
    </script>
</body>
</html>