<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ - ‡§¨‡§æ‡§≤‡§∏‡§Ç‡§∏‡•ç‡§ï‡§æ‡§∞ (‡§Æ‡§®‡•Å‡§∏‡•ç‡§Æ‡•É‡§§‡•Ä)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ‡§´‡•â‡§®‡•ç‡§ü - ‡§Æ‡•Å‡§≤‡§æ‡§Ç‡§∏‡§æ‡§†‡•Ä ‡§Æ‡•ã‡§†‡§æ ‡§Ü‡§£‡§ø ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü */
        body { font-family: 'Mukta', 'Inter', sans-serif; }
        
        /* ‡§•‡•Ä‡§Æ - ‡§â‡§¨‡§¶‡§æ‡§∞ ‡§Ü‡§£‡§ø ‡§Ü‡§®‡§Ç‡§¶‡§¶‡§æ‡§Ø‡•Ä (Warm & Pleasant) */
        .ancient-bg {
            background: radial-gradient(circle at center, #5d4037, #3e2723, #1a0f0d);
            background-size: 200% 200%;
        }

        /* ‡•≤‡§®‡§ø‡§Æ‡•á‡§∂‡§® - ‡§¨‡•ã‡§≤‡§§‡§æ‡§®‡§æ‡§ö‡•Ä ‡§π‡§æ‡§≤‡§ö‡§æ‡§≤ */
        .listening-pulse { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 167, 38, 0.6); } 
            70% { box-shadow: 0 0 0 20px rgba(255, 167, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 167, 38, 0); }
        }

        .icon-btn {
            @apply p-4 rounded-full text-white transition-all duration-200
                   shadow-lg border-2 border-orange-300 bg-orange-700 hover:bg-orange-600
                   focus:outline-none focus:ring-4 focus:ring-orange-400
                   disabled:opacity-50 disabled:cursor-not-allowed;
        }

        /* ‡§Æ‡•Å‡§≤‡§æ‡§Ç‡§∏‡§æ‡§†‡•Ä ‡§Æ‡•ã‡§†‡•á ‡§á‡§®‡§™‡•Å‡§ü ‡§´‡•Ä‡§≤‡•ç‡§° */
        .custom-input {
            @apply block w-full text-center border-4 border-orange-800 rounded-2xl p-4 outline-none transition-all font-bold text-xl;
            background-color: #fff8e1 !important; /* Cream Color */
            color: #3e2723 !important;             /* Dark Brown Text */
        }
        .custom-input::placeholder { color: #8d6e63 !important; }

        /* ‡§ö‡•Ö‡§ü ‡§¨‡•â‡§ï‡•ç‡§∏ - ‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§∏‡§æ‡§∞‡§ñ‡§æ (Textbook Style) */
        .textbook-style {
            background-color: #fff8e1; /* Paper/Cream color */
            border: 8px solid #8d6e63; /* Wood border */
            border-radius: 20px;
            font-family: 'Mukta', sans-serif;
            color: #2c1503;
        }

        /* ‡§∏‡•ç‡§ï‡•ç‡§∞‡•ã‡§≤‡§¨‡§æ‡§∞ */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #3e2723; }
        ::-webkit-scrollbar-thumb { background: #ffca28; border-radius: 6px; border: 3px solid #3e2723; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body class="ancient-bg flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-black/40 backdrop-blur-md rounded-3xl shadow-2xl p-6 w-full max-w-3xl flex flex-col h-[95vh] border-8 border-orange-900/60">
        
        <div class="flex items-center justify-between mb-4 shrink-0 bg-orange-900/80 p-4 rounded-2xl border-2 border-orange-400">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-wide">
                <span class="text-yellow-400">‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ</span> <span class="text-orange-200 text-xl block md:inline">- ‡§¨‡§æ‡§≤‡§ó‡•Å‡§∞‡•Å</span>
            </h1>
            <div id="status-indicator" class="w-6 h-6 rounded-full bg-gray-400 border-4 border-white transition-colors" title="‡§∂‡§æ‡§Ç‡§§"></div>
        </div>

        <div id="conversation-log" class="textbook-style flex-grow overflow-y-auto p-6 mb-4 shadow-inner min-h-[200px] space-y-6">
            <div class="text-center mt-10">
                <p class="text-3xl font-bold text-orange-900 mb-4">‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‡§¨‡§æ‡§≥‡§æ! üôè</p>
                <p class="text-xl font-semibold text-orange-800">
                    ‡§Æ‡•Ä ‡§§‡•Å‡§ù‡•Ä ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ø‡§ï‡§æ '‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ' ‡§Ü‡§π‡•á.<br>
                    ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä <span class="text-red-700">"‡§ó‡•Å‡§∞‡•Å‡§ú‡•Ä"</span> ‡§ï‡§ø‡§Ç‡§µ‡§æ <span class="text-red-700">"‡§Æ‡•Ö‡§°‡§Æ"</span> ‡§Æ‡•ç‡§π‡§£.
                </p>
            </div>
        </div>

        <div class="flex justify-center gap-6 mb-6 shrink-0">
            <button id="pause-resume-button" class="icon-btn bg-yellow-600 hover:bg-yellow-500" disabled>‚è∏</button>
            <button id="stop-speech-button" class="icon-btn bg-red-600 hover:bg-red-500" disabled>‚èπ</button>
            <button id="replay-button" class="icon-btn bg-green-600 hover:bg-green-500" disabled>üîÑ</button>
        </div>

        <div id="setup-panel" class="flex flex-col gap-4 mb-4 shrink-0 w-full text-center bg-orange-900/30 p-4 rounded-2xl">
            <input type="text" id="manual-name" class="custom-input" placeholder="‡§§‡•Å‡§ù‡•á ‡§®‡§æ‡§µ ‡§ï‡§æ‡§Ø ‡§Ü‡§π‡•á?">
            <input type="number" id="manual-age" class="custom-input" placeholder="‡§§‡•Å‡§ù‡•á ‡§µ‡§Ø (‡§â‡§¶‡§æ. ‡•´)" value="5">
            
            <div class="flex items-center justify-center gap-3 mt-2">
                <input type="checkbox" id="remember-me-checkbox" class="w-6 h-6 text-orange-600 rounded focus:ring-orange-500">
                <label for="remember-me-checkbox" class="text-lg text-white font-bold cursor-pointer">‡§®‡§æ‡§µ ‡§≤‡§ï‡•ç‡§∑‡§æ‡§§ ‡§†‡•á‡§µ‡§æ</label>
            </div>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-2 shrink-0">
            <button id="advance-toggle-btn" class="text-sm text-orange-300 underline focus:outline-none">‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</button>
            <div id="advance-container" class="hidden w-full bg-black/80 rounded-lg p-2 mt-2">
                <input type="checkbox" id="use-custom-key-checkbox" class="mr-2"> <span class="text-white text-sm">Custom API Key</span>
                <input type="text" id="custom-api-key-input" class="w-full p-1 rounded mt-1 text-black" placeholder="API Key" disabled>
            </div>
        </div>

        <button id="talk-button" class="w-full py-6 rounded-2xl text-2xl font-extrabold transition-all duration-300 shadow-xl
                       bg-gradient-to-r from-orange-600 to-red-600 text-white border-4 border-orange-300
                       hover:scale-105 hover:from-orange-500 hover:to-red-500
                       disabled:grayscale disabled:scale-100 disabled:cursor-not-allowed">
            üé§ ‡§¨‡•ã‡§≤‡§æ (Start)
        </button>

        <div class="mt-4 flex justify-between gap-4 shrink-0">
            <button id="restart-chat-button" class="py-3 px-6 bg-yellow-800 text-yellow-100 rounded-xl font-bold border-2 border-yellow-600 w-full hover:bg-yellow-700" disabled>üîÑ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ</button>
        </div>

    </div>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- ‡§µ‡•ç‡§π‡•á‡§∞‡§ø‡§è‡§¨‡§≤‡•ç‡§∏ ---
        const talkButton = document.getElementById('talk-button');
        const conversationLog = document.getElementById('conversation-log');
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        const statusIndicator = document.getElementById('status-indicator');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const restartChatButton = document.getElementById('restart-chat-button');
        
        // API ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');

        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 5; // ‡§°‡§ø‡§´‡•â‡§≤‡•ç‡§ü ‡§µ‡§Ø ‡•´ ‡§µ‡§∞‡•ç‡§∑‡•á
        let chatHistory = [];
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        // --- ‡§á‡§®‡§ø‡§∂‡§ø‡§è‡§≤‡§æ‡§Ø‡§ù‡•á‡§∂‡§® ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData(); 
            loadVoices();   
        };

        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
        });

        useCustomKeyCheckbox.addEventListener('change', () => {
            customApiKeyInput.disabled = !useCustomKeyCheckbox.checked;
            saveUserData();
        });

        customApiKeyInput.addEventListener('input', saveUserData);

        // --- ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ---
        function loadUserData() {
            try {
                if (localStorage.getItem('acharya_remember') === 'true') {
                    rememberMeCheckbox.checked = true;
                    manualNameInput.value = localStorage.getItem('acharya_userName') || '';
                    manualAgeInput.value = localStorage.getItem('acharya_userAge') || '5';
                }
                if (localStorage.getItem('acharya_useCustomKey') === 'true') {
                    useCustomKeyCheckbox.checked = true;
                    customApiKeyInput.disabled = false;
                    customApiKeyInput.value = localStorage.getItem('acharya_customKey') || '';
                }
            } catch (e) {}
        }

        function saveUserData() {
            if (rememberMeCheckbox.checked) {
                localStorage.setItem('acharya_remember', 'true');
                localStorage.setItem('acharya_userName', manualNameInput.value);
                localStorage.setItem('acharya_userAge', manualAgeInput.value);
            } else {
                localStorage.removeItem('acharya_remember');
            }
            localStorage.setItem('acharya_useCustomKey', useCustomKeyCheckbox.checked);
            localStorage.setItem('acharya_customKey', customApiKeyInput.value);
        }

        function getEffectiveApiKey() {
            return (useCustomKeyCheckbox.checked && customApiKeyInput.value.length > 10) ? customApiKeyInput.value : DEFAULT_API_KEY;
        }

        // --- ‡§∏‡•ç‡§™‡•Ä‡§ö ‡§∞‡•á‡§ï‡§ó‡•ç‡§®‡§ø‡§∂‡§® (Speech to Text) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'mr-IN';
            recognition.onresult = handleSpeechResult;
            recognition.onend = handleSpeechEnd;
        } else {
            alert("‡§π‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞ ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§§ ‡§®‡§æ‡§π‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ Chrome ‡§µ‡§æ‡§™‡§∞‡§æ.");
        }

        function startRecognitionSafe() {
            try { recognition.start(); } catch (e) {}
        }

        // --- ‡§á‡§µ‡•ç‡§π‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞‡•ç‡§∏ ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', () => { if(synth.paused) synth.resume(); else synth.pause(); });
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', () => speakText(lastSpokenText));
        restartChatButton.addEventListener('click', restartChat);

        // --- ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§≤‡•â‡§ú‡§ø‡§ï ---
        async function toggleListening() {
            if (appState === 'IDLE') {
                const name = manualNameInput.value.trim();
                const age = manualAgeInput.value.trim();
                
                if (!name) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§ù‡•á ‡§®‡§æ‡§µ ‡§∏‡§æ‡§Ç‡§ó!"); return; }
                
                userName = name;
                userAge = parseInt(age) || 5;
                saveUserData();
                buildSystemPrompt();
                
                // ‡§™‡§π‡§ø‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§¶‡§æ‡§ö ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§‡§æ‡§®‡§æ
                if (chatHistory.length === 0) {
                    const welcomeMsg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${userName}! ‡§Æ‡•Ä ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ ‡§Ü‡§π‡•á. ‡§§‡•Ç ${userAge} ‡§µ‡§∞‡•ç‡§∑‡§æ‡§Ç‡§ö‡§æ ‡§Ü‡§π‡•á‡§∏. ‡§Ü‡§™‡§£ ‡§õ‡§æ‡§® ‡§ó‡•ã‡§∑‡•ç‡§ü‡•Ä ‡§∂‡§ø‡§ï‡•Ç‡§Ø‡§æ. ‡§§‡•Å‡§≤‡§æ ‡§ï‡§æ‡§Ø ‡§µ‡§ø‡§ö‡§æ‡§∞‡§æ‡§Ø‡§ö‡•á ‡§Ü‡§π‡•á?`;
                    logMessage('‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ', welcomeMsg);
                    await speakText(welcomeMsg);
                    chatHistory.push({ role: 'model', parts: [{ text: welcomeMsg }] });
                }
                
                setState('LISTENING');
                startRecognitionSafe();
            } else {
                stopSpeech();
            }
        }

        function handleSpeechEnd() {
            if (appState === 'LISTENING') startRecognitionSafe();
        }

        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;

            recognition.stop();
            setState('THINKING');
            logMessage(userName, transcript);

            chatHistory.push({ role: 'user', parts: [{ text: transcript }] });

            const aiResponse = await getAIResponse(chatHistory);
            
            // Text formatting for Kids (No symbols in visual)
            const visualText = cleanTextForDisplay(aiResponse);
            // Text cleaning for TTS (No symbols in audio)
            const audioText = cleanTextForTTS(aiResponse);

            chatHistory.push({ role: 'model', parts: [{ text: visualText }] });
            logMessage('‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ', visualText);
            
            await speakText(audioText);
            
            setState('LISTENING');
            startRecognitionSafe();
        }

        function setState(state) {
            appState = state;
            if (state === 'IDLE') {
                talkButton.textContent = "üé§ ‡§¨‡•ã‡§≤‡§æ (Start)";
                talkButton.classList.remove('animate-pulse');
                statusIndicator.className = "w-6 h-6 rounded-full bg-gray-400 border-4 border-white";
                document.getElementById('setup-panel').style.display = 'block';
            } else if (state === 'LISTENING') {
                talkButton.textContent = "üëÇ ‡§ê‡§ï‡§§ ‡§Ü‡§π‡•á...";
                talkButton.classList.add('animate-pulse');
                statusIndicator.className = "w-6 h-6 rounded-full bg-green-500 border-4 border-white listening-pulse";
                document.getElementById('setup-panel').style.display = 'none';
            } else if (state === 'THINKING') {
                talkButton.textContent = "ü§î ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...";
                statusIndicator.className = "w-6 h-6 rounded-full bg-yellow-500 border-4 border-white animate-bounce";
            }
        }

        // --- ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü (Teacher Persona for Kids) ---
        function buildSystemPrompt() {
            systemInstruction = `
                You are "Acharya" (‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ), a loving, soft-spoken female teacher (Guru Ma) teaching ancient Indian wisdom (Manusmriti/Vedas) to a small child.
                User Name: ${userName}, Age: ${userAge} (Very young).

                YOUR STYLE:
                1. **Tone:** Very gentle, motherly, slow, and encouraging. Like a grandmother or kindergarten teacher.
                2. **Language:** Simple Marathi. No difficult Sanskrit words without simple explanation. Use words like "‡§¨‡§æ‡§≥‡§æ", "‡§¨‡•á‡§ü‡§æ", "‡§∏‡•ã‡§®‡•Å‡§≤‡•ç‡§Ø‡§æ".
                3. **Teaching:** Explain concepts like "Respect for elders", "Truth", "Discipline", and "Hygiene" using simple examples.
                
                STRICT FORMATTING RULES (For Textbook Look):
                1. **No Markdown Symbols:** Do NOT use *, #, -, >, [ ], ( ). 
                2. **Big & Clear:** Write short sentences. Use line breaks.
                3. **Structure:**
                   - Start with a sweet acknowledgement (e.g., "‡§õ‡§æ‡§® ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§µ‡§ø‡§ö‡§æ‡§∞‡§≤‡§æ‡§∏ ‡§¨‡§æ‡§≥‡§æ!").
                   - Give a simple answer based on ancient values.
                   - End with a sweet question or blessing.

                Example:
                ‡§Ö‡§∞‡•á ‡§µ‡§æ ‡§ï‡§ø‡§§‡•Ä ‡§õ‡§æ‡§® ‡§™‡•ç‡§∞‡§∂‡•ç‡§®
                ‡§Ü‡§™‡§≤‡•ç‡§Ø‡§æ‡§≤‡§æ ‡§∞‡•ã‡§ú ‡§∏‡§ï‡§æ‡§≥‡•Ä ‡§≤‡§µ‡§ï‡§∞ ‡§â‡§†‡§æ‡§Ø‡§≤‡§æ ‡§™‡§æ‡§π‡§ø‡§ú‡•á
                ‡§Ø‡§æ‡§®‡•á ‡§Ü‡§™‡§≤‡•á ‡§∂‡§∞‡•Ä‡§∞ ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§π‡•ã‡§§‡•á
                ‡§§‡•Ç ‡§â‡§¶‡•ç‡§Ø‡§æ ‡§≤‡§µ‡§ï‡§∞ ‡§â‡§†‡§∂‡•Ä‡§≤ ‡§®‡§æ ‡§¨‡§æ‡§≥‡§æ
            `;
        }

        // --- API Call ---
        async function getAIResponse(history) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: history, systemInstruction: { parts: [{ text: systemInstruction }] } })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return "‡§¨‡§æ‡§≥‡§æ, ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ú‡•ã‡§°‡§≤‡•á‡§≤‡•á ‡§®‡§æ‡§π‡•Ä."; }
        }

        // --- Text Cleaning (‡§Æ‡§π‡§§‡•ç‡§µ‡§æ‡§ö‡•á) ---
        function cleanTextForDisplay(text) {
            // ‡§µ‡•ç‡§π‡§ø‡§ú‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü‡§∏‡§æ‡§†‡•Ä ‡§´‡§ï‡•ç‡§§ ‡§†‡§≥‡§ï‡§™‡§£‡§æ ‡§ï‡§æ‡§¢‡•Ç‡§® ‡§ü‡§æ‡§ï‡§æ, ‡§™‡§£ ‡§µ‡§æ‡§ï‡•ç‡§Ø‡§∞‡§ö‡§®‡§æ ‡§†‡•á‡§µ‡§æ
            return text.replace(/[\*#`<>]/g, '').trim();
        }

        function cleanTextForTTS(text) {
            // ‡§¨‡•ã‡§≤‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§∏‡§∞‡•ç‡§µ ‡§ö‡§ø‡§®‡•ç‡§π‡•á ‡§ï‡§æ‡§¢‡•Ç‡§® ‡§ü‡§æ‡§ï‡§æ ‡§ú‡•á‡§£‡•á‡§ï‡§∞‡•Ç‡§® ‡§§‡•á ‡§µ‡§æ‡§ö‡§≤‡•á ‡§ú‡§æ‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä‡§§
            // Remove emojis, brackets, stars, dashes, etc.
            return text.replace(/[\*\[\]\(\)<>`#\-_=]/g, ' ') // ‡§ö‡§ø‡§®‡•ç‡§π‡•á ‡§ï‡§æ‡§¢‡§æ
                       .replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '') // Emojis ‡§ï‡§æ‡§¢‡§æ
                       .replace(/\s+/g, ' ') // ‡§è‡§ï‡•ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§æ ‡§∏‡•ç‡§™‡•á‡§∏ ‡§ï‡§æ‡§¢‡§æ
                       .trim();
        }

        // --- TTS (‡§Ü‡§µ‡§æ‡§ú ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§ú) ---
        function loadVoices() {
            voices = synth.getVoices();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        async function speakText(text) {
            if (synth.speaking) synth.cancel();
            lastSpokenText = text;
            
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // 1. ‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä‡§ö‡§æ ‡§Ü‡§µ‡§æ‡§ú ‡§∂‡•ã‡§ß‡§æ (Female Voice)
                let teacherVoice = voices.find(v => (v.lang === 'mr-IN' || v.lang === 'hi-IN') && v.name.includes('Female')) || 
                                   voices.find(v => (v.lang === 'mr-IN' || v.lang === 'hi-IN'));

                if (teacherVoice) utterance.voice = teacherVoice;
                
                utterance.lang = 'mr-IN';
                
                // 2. ‡§ó‡§§‡•Ä (Speed) 0.8X - ‡§≤‡§π‡§æ‡§® ‡§Æ‡•Å‡§≤‡§æ‡§Ç‡§∏‡§æ‡§†‡•Ä
                utterance.rate = 0.8; 
                
                // 3. ‡§Ü‡§µ‡§æ‡§ú (Pitch) ‡§•‡•ã‡§°‡§æ ‡§â‡§Ç‡§ö (Soft/Female like)
                utterance.pitch = 1.1; 

                utterance.onend = resolve;
                utterance.onerror = resolve;

                toggleMediaButtons(false);
                synth.speak(utterance);
            });
        }

        function stopSpeech() {
            synth.cancel();
            recognition.stop();
            setState('IDLE');
            toggleMediaButtons(true);
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }

        function logMessage(sender, message) {
            const div = document.createElement('div');
            
            // Styling for Textbook look
            if (sender === '‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ') {
                // ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ - ‡§Æ‡•ã‡§†‡•á, ‡§†‡§≥‡§ï, ‡§≤‡§æ‡§≤‡§∏‡§∞ ‡§§‡§™‡§ï‡§ø‡§∞‡•Ä
                div.innerHTML = `
                    <p class="text-sm font-bold text-red-800 mb-1">üë©‚Äçüè´ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø‡§æ:</p>
                    <p class="text-2xl font-bold leading-loose text-orange-950">${message.replace(/\n/g, '<br>')}</p>
                `;
                div.className = "bg-orange-100/50 p-4 rounded-xl border border-orange-200";
            } else {
                // ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä - ‡§®‡§ø‡§≥‡•á/‡§µ‡•á‡§ó‡§≥‡•á
                div.innerHTML = `
                    <p class="text-sm font-bold text-blue-800 mb-1">üë¶ ‡§§‡•Ç:</p>
                    <p class="text-xl font-semibold text-blue-900">${message}</p>
                `;
                div.className = "bg-blue-50 p-4 rounded-xl border border-blue-100 ml-10";
            }
            
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        async function restartChat() {
            stopSpeech();
            chatHistory = [];
            conversationLog.innerHTML = '';
            toggleListening(); // Restart process
        }
    </script>
</body>
</html>