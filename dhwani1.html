<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhwani Jr - Marathi & English Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- CHILD TEXTBOOK UI --- */
        body { 
            font-family: 'Fredoka', sans-serif; 
            background-color: #fdf6e3; 
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 100% 2rem; 
            overscroll-behavior: none; 
        }

        /* TEXTBOOK FORMATTING */
        .textbook-text {
            font-family: 'Comic Neue', cursive; 
            font-size: 1.25rem; 
            line-height: 1.6;  
            font-weight: 700;  
            color: #2c3e50;
        }

        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }

        .fun-btn {
            @apply shadow-[0_4px_0_rgb(0,0,0,0.2)] active:shadow-none active:translate-y-[4px] transition-all;
        }

        #conversation-log::-webkit-scrollbar { width: 8px; }
        #conversation-log::-webkit-scrollbar-track { background: #fff8dc; }
        #conversation-log::-webkit-scrollbar-thumb { background: #f39c12; border-radius: 10px; }
        
        .kids-select {
            @apply w-full p-2 text-base rounded-xl border-2 border-indigo-200 text-indigo-900 font-bold focus:border-pink-400 focus:outline-none bg-white shadow-sm;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center h-[100dvh] p-2 bg-yellow-50 overflow-hidden">

    <div class="bg-white rounded-2xl shadow-xl border-4 border-yellow-300 w-full max-w-lg flex flex-col h-full relative overflow-hidden">
        
        <div class="flex items-center justify-between p-3 z-10 bg-white border-b border-gray-100 shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-indigo-600 tracking-wide">
                    üë©‚Äçüè´ Dhwani <span class="text-pink-500">Jr.</span>
                </h1>
            </div>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-300 border-2 border-gray-100 shadow-md" title="Offline"></div>
        </div>

        <div class="grid grid-cols-2 gap-2 p-2 z-10 bg-blue-50 border-b border-blue-100 shrink-0">
            <div>
                <select id="subject-select" class="kids-select"></select>
            </div>
            <div>
                <select id="chapter-select" class="kids-select"></select>
            </div>
        </div>

        <div id="conversation-log" class="flex-1 min-h-0 overflow-y-auto bg-yellow-50 p-4 space-y-4 relative">
            <div class="text-center mt-10 opacity-40">
                <p class="text-5xl mb-2">üìñ</p>
                <p class="text-lg font-bold text-gray-500">Ready to learn!</p>
            </div>
        </div>

        <div class="p-3 bg-white border-t-2 border-gray-100 shrink-0 z-20 flex flex-col gap-2">
            
            <div class="flex justify-center gap-4">
                <button id="pause-resume-button" class="p-3 rounded-full bg-blue-100 text-blue-600 fun-btn" disabled><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg></button>
                <button id="stop-speech-button" class="p-3 rounded-full bg-red-100 text-red-600 fun-btn" disabled><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg></button>
                <button id="replay-button" class="p-3 rounded-full bg-green-100 text-green-600 fun-btn" disabled><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg></button>
            </div>

            <button id="talk-button" class="w-full py-3 px-6 rounded-xl text-xl font-bold text-white shadow-lg transition-all 
                        bg-gradient-to-r from-pink-500 to-rose-500 fun-btn
                        disabled:opacity-50 uppercase tracking-wider">
                Start Class üéí
            </button>

            <div class="flex justify-between items-center px-1">
                <button id="restart-chat-button" class="text-gray-400 font-bold text-xs p-2">‚Ü∫ RESTART</button>
                <div class="flex items-center gap-1">
                    <input type="checkbox" id="remember-me-checkbox" class="w-4 h-4 text-pink-500 rounded">
                    <label for="remember-me-checkbox" class="text-xs font-bold text-gray-400">Memory</label>
                </div>
                <button id="advance-toggle-btn" class="text-indigo-400 font-bold text-xs p-2 bg-indigo-50 rounded">‚öôÔ∏è API KEY</button>
            </div>

            <div id="advance-container" class="hidden w-full bg-gray-50 border rounded p-2 flex-col gap-2">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="use-custom-key-checkbox" class="w-4 h-4">
                    <label class="text-xs font-bold text-gray-500">Use Custom Key</label>
                </div>
                <input type="text" id="custom-api-key-input" class="w-full p-2 text-xs border rounded" placeholder="Paste Gemini Key here">
            </div>
        </div>

    </div>

    <script>
        /* ==========================================================================
           LOGIC: Std 1 Syllabus + MARATHI TEACHING + ORIGINAL VOICE
           ========================================================================== */
        const SYLLABUS = {
            "english": { name: "English Balbharati", book_link: "https://ebooks.ebalbharati.in/pdfs/103030001.pdf", chapters: ["Unit 1: A Happy Song", "Unit 1: Nature", "Unit 2: Rain", "Unit 2: Things in my Classroom", "Unit 3: Toto - The Hen", "Unit 4: Greeting Cards", "Unit 5: The Monkey and the Log", "Unit 6: Alphabet Song", "Unit 7: Traffic Rules", "Unit 8: The Sun and the Wind"] },
            "maths": { name: "Mathematics", book_link: "https://ebooks.ebalbharati.in/pdfs/103030004.pdf", chapters: ["Small - Big", "Behind - In front of", "Above - Below", "One - Many", "Understand 1 to 9", "Introduction to Zero", "Less - More", "Increasing - Decreasing Order", "Let's Add", "Let's Subtract"] },
            "marathi": { name: "Marathi Balbharati", book_link: "https://ebooks.ebalbharati.in/pdfs/101000543.pdf", chapters: ["‡§≠‡§æ‡§ó ‡•ß: ‡§∏‡§∞‡•Ä (‡§ó‡§æ‡§£‡•á)", "‡§≠‡§æ‡§ó ‡•ß: ‡§¶‡•ã‡§ò‡•á‡§π‡•Ä ‡§ú‡§ø‡§Ç‡§ï‡•Ç", "‡§≠‡§æ‡§ó ‡•ß: ‡§ñ‡•á‡§≥ ‡§ñ‡•á‡§≥‡•Ç‡§Ø‡§æ", "‡§≠‡§æ‡§ó ‡•®: ‡§´‡§≥‡§æ‡§Ç‡§ö‡§æ ‡§∞‡§æ‡§ú‡§æ", "‡§≠‡§æ‡§ó ‡•®: ‡§™‡§ï‡•ç‡§∑‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•á ‡§ú‡§ó", "‡§≠‡§æ‡§ó ‡•©: ‡§ì‡§≥‡§ñ ‡§Ü‡§™‡§≤‡•Ä", "‡§≠‡§æ‡§ó ‡•©: ‡§Ö‡§Ç‡§ï ‡§ó‡§æ‡§£‡•á", "‡§≠‡§æ‡§ó ‡•©: ‡§¨‡§æ‡§ú‡§æ‡§∞"] },
            "playdolearn": { name: "Play, Do, Learn", book_link: "https://ebooks.ebalbharati.in/pdfs/103000620.pdf", chapters: ["Health & Hygiene", "Different Games", "Paper Work", "Clay Work", "Our Surroundings", "Animals & Birds", "Water"] }
        };

        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        let appState = 'IDLE'; 
        let chatHistory = []; 
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        const synth = window.speechSynthesis;
        let voices = [];
        
        const talkButton = document.getElementById('talk-button');
        const conversationLog = document.getElementById('conversation-log');
        const statusIndicator = document.getElementById('status-indicator');
        const subjectSelect = document.getElementById('subject-select');
        const chapterSelect = document.getElementById('chapter-select');

        window.onload = () => {
            populateSubjects();
            loadUserData();
            voices = synth.getVoices();
            if(voices.length === 0) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        };

        function populateSubjects() {
            subjectSelect.innerHTML = '';
            for (let key in SYLLABUS) {
                let option = document.createElement('option');
                option.value = key; option.text = SYLLABUS[key].name;
                subjectSelect.add(option);
            }
            populateChapters();
        }
        subjectSelect.addEventListener('change', populateChapters);
        function populateChapters() {
            const subKey = subjectSelect.value;
            chapterSelect.innerHTML = '';
            SYLLABUS[subKey].chapters.forEach(chap => {
                let option = document.createElement('option');
                option.value = chap; option.text = chap;
                chapterSelect.add(option);
            });
        }

        async function getAIResponse(historyData) {
            buildSystemPrompt();
            const apiKey = getEffectiveApiKey();
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: historyData, systemInstruction: { parts: [{ text: systemInstruction }] } })
                });
                const result = await response.json();
                if(result.error) throw new Error(result.error.message);
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) { return "Check internet or API key."; }
        }

        function buildSystemPrompt() {
            const subject = SYLLABUS[subjectSelect.value].name;
            const chapter = chapterSelect.value;
            // MODIFIED PROMPT: Teach in Marathi + English
            systemInstruction = `
            You are "Dhwani Teacher," a very loving primary teacher for Std 1 (Age 5).
            Subject: ${subject}. Chapter: ${chapter}.
            
            **LANGUAGE INSTRUCTION:**
            - You must explain EVERYTHING in **MARATHI** (‡§Æ‡§∞‡§æ‡§†‡•Ä) first, then simple English.
            - Example: "Cat means ‡§Æ‡§æ‡§Ç‡§ú‡§∞" (Cat ‡§Æ‡•ç‡§π‡§£‡§ú‡•á ‡§Æ‡§æ‡§Ç‡§ú‡§∞).
            - Keep the Marathi simple and sweet.

            **TEACHING RULES:**
            1. **Format:** Short sentences. Mix Marathi and English.
            2. **Style:** Be cheerful! Use emojis üåü.
            3. **Pattern:** Explain concept in Marathi (3 lines) -> Fun Summary -> Ask 1 easy question in Marathi.
            4. **Formatting:** Use **Bold** for main words. 
            5. **Ending:** Always add: [üîó Show Picture](https://www.google.com/search?q=${subject}+${chapter}+cartoon&tbm=isch).
            `;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'mr-IN'; // CHANGED TO LISTEN IN MARATHI/INDIAN ENGLISH
            recognition.onresult = handleSpeechResult;
            recognition.onend = () => { if(appState === 'LISTENING') recognition.start(); else setState('IDLE'); };
        }

        talkButton.addEventListener('click', async () => {
            if (appState === 'IDLE') {
                talkButton.textContent = "Loading... üéà";
                talkButton.disabled = true;
                setState('BUSY');
                if (chatHistory.length === 0) {
                    // Trigger first message from AI
                    chatHistory.push({ role: 'user', parts: [{ text: "Namaskar Teacher! I am ready." }] });
                    const response = await getAIResponse(chatHistory);
                    chatHistory.push({ role: 'model', parts: [{ text: response }] });
                    logMessage('Dhwani', response);
                    await speakText(response);
                } else { startListeningSafe(); }
                setState('LISTENING');
            } else { stopAll(); }
        });

        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            recognition.stop(); setState('BUSY');
            logMessage('Student', transcript);
            chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
            const response = await getAIResponse(chatHistory);
            chatHistory.push({ role: 'model', parts: [{ text: response }] });
            logMessage('Dhwani', response);
            await speakText(response);
            setState('LISTENING'); startListeningSafe();
        }

        function startListeningSafe() { try { recognition.start(); } catch(e){} }
        function stopAll() { setState('IDLE'); recognition.stop(); synth.cancel(); }

        // --- TTS LOGIC: RESTORED EXACTLY FROM Dhwani.html ---
        async function speakText(text) {
            if (synth.speaking) synth.cancel();
            
            // CLEAN FILTER: Only removing emojis/markdown for cleaner speech
            let speakableText = text
                .replace(/\[.*?\]\(.*?\)/g, "") // Links
                .replace(/https?:\/\/\S+/g, "") // URLs
                .replace(/\p{Extended_Pictographic}/gu, "") // Emojis
                .replace(/[*#_`~>]/g, "") // Symbols
                .replace(/\s+/g, " ")
                .trim();
            
            lastSpokenText = text; 
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(speakableText);
                
                // === EXACT LOGIC FROM Dhwani.html START ===
                let marathiVoice = voices.find(voice => voice.lang === 'mr-IN') || voices.find(voice => voice.lang === 'hi-IN');
                if (marathiVoice) utterance.voice = marathiVoice;
                utterance.lang = 'mr-IN';
                
                // Fixed Age Logic (Child < 7)
                utterance.rate = 0.7; 
                // === EXACT LOGIC FROM Dhwani.html END ===

                utterance.onend = resolve; 
                utterance.onerror = resolve;
                synth.speak(utterance);
            });
        }

        function logMessage(sender, msg) {
            const div = document.createElement('div');
            // Format for DISPLAY
            let displayHtml = msg.replace(/\[(.*?)\]\((.*?)\)/g, '<br><a href="$2" target="_blank" class="inline-block mt-2 bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm border-2 border-blue-200">üîó $1</a>')
                               .replace(/\*\*(.*?)\*\*/g, '<span class="text-indigo-700 font-black">$1</span>')
                               .replace(/\n/g, '<br>');

            if (sender === 'Dhwani') {
                div.innerHTML = `<div class="bg-white p-4 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl border-2 border-indigo-100 shadow-sm"><span class="text-xs font-bold text-indigo-400 block mb-1">üë©‚Äçüè´ TEACHER</span><div class="textbook-text leading-snug">${displayHtml}</div></div>`;
            } else {
                div.innerHTML = `<div class="bg-pink-50 p-3 rounded-tl-2xl rounded-bl-2xl rounded-br-2xl border-2 border-pink-100 shadow-sm ml-auto max-w-[85%] text-right"><span class="text-xs font-bold text-pink-400 block mb-1">üë∂ ME</span><div class="text-lg font-bold text-gray-700 font-comic">${msg}</div></div>`;
            }
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function setState(st) {
            appState = st;
            if(st === 'IDLE') {
                talkButton.textContent = "Start Class üéí"; talkButton.disabled = false;
                statusIndicator.className = "w-4 h-4 rounded-full bg-gray-300 border-2 border-gray-100";
                talkButton.classList.replace('bg-rose-500', 'bg-gradient-to-r');
            } else if (st === 'BUSY') {
                talkButton.textContent = "Thinking... ü§î"; talkButton.disabled = true;
                statusIndicator.className = "w-4 h-4 rounded-full bg-yellow-400 animate-bounce";
            } else {
                talkButton.textContent = "STOP CLASS üõë"; talkButton.disabled = false;
                talkButton.classList.replace('bg-gradient-to-r', 'bg-rose-500');
                statusIndicator.className = "w-4 h-4 rounded-full bg-pink-500 listening-pulse";
            }
        }

        function getEffectiveApiKey() {
            const el = document.getElementById('custom-api-key-input');
            const chk = document.getElementById('use-custom-key-checkbox');
            return (chk.checked && el.value.length > 10) ? el.value.trim() : DEFAULT_API_KEY;
        }

        function loadUserData() {
            document.getElementById('advance-toggle-btn').onclick = () => document.getElementById('advance-container').classList.toggle('hidden');
            document.getElementById('restart-chat-button').onclick = () => { conversationLog.innerHTML = ''; chatHistory = []; };
            document.getElementById('pause-resume-button').onclick = () => { synth.speaking ? (synth.paused ? synth.resume() : synth.pause()) : null; };
            document.getElementById('stop-speech-button').onclick = stopAll;
            document.getElementById('replay-button').onclick = () => speakText(lastSpokenText);
        }
    </script>
</body>
</html>