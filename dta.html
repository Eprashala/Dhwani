<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani - Smart AI Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        
        .active-turn { border-color: #facc15 !important; box-shadow: 0 0 20px rgba(250, 204, 21, 0.2); transform: scale(1.01); opacity: 1 !important; }
        .inactive-turn { opacity: 0.5; filter: grayscale(0.6); pointer-events: none; }
        
        .mic-listening { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; border-color: #ef4444 !important; }
        .speaking-now { border-color: #8b5cf6 !important; box-shadow: 0 0 30px rgba(139, 92, 246, 0.5); }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        select { background-color: #334155; color: white; border: 1px solid #475569; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        .msg-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Live Text Styling */
        .live-preview { color: #fbbf24; font-size: 0.85rem; margin-top: 8px; font-style: italic; min-height: 20px; word-wrap: break-word; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>

<body class="flex flex-col items-center min-h-screen p-2 md:p-6" oncontextmenu="return false;">

    <header class="w-full max-w-4xl flex justify-between items-center mb-4 p-4 glass-panel rounded-2xl shadow-lg shrink-0">
        <div class="flex items-center gap-3">
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">
                Dhwani <span class="text-xs text-green-400 font-mono border border-green-500/30 px-2 py-1 rounded">Smart AI Translator</span>
            </h1>
        </div>
        <div>
            <button id="start-btn" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-full font-bold shadow-lg transition transform hover:scale-105">START</button>
            <button id="stop-btn" class="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-full font-bold shadow-lg transition hidden">END</button>
        </div>
    </header>

    <main class="w-full max-w-4xl flex-grow flex flex-col gap-4 overflow-hidden h-full">
        
        <div id="chat-container" class="flex-grow bg-slate-900/50 rounded-2xl border border-slate-800 p-4 overflow-y-auto min-h-[300px] flex flex-col gap-3 shadow-inner relative">
            <div id="welcome-msg" class="text-center text-slate-500 mt-10 text-sm">
                Select Languages & Click <b>START</b>.<br>
                Auto-detects 5s silence. Optimized for Android.
            </div>
        </div>

        <div class="flex justify-center gap-4 shrink-0">
            <button id="repeat-btn" class="text-indigo-400 hover:text-white text-xs flex items-center gap-1 disabled:opacity-30" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg> Repeat
            </button>
            <button id="share-btn" class="text-emerald-400 hover:text-white text-xs flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" /></svg> Share
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-1 shrink-0 pb-2">
            <div id="panel-u1" class="glass-panel p-4 rounded-xl border-t-4 border-indigo-500 flex flex-col gap-3 transition-all">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-indigo-400 font-bold text-sm uppercase flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-indigo-500"></span> User 1</span>
                    <div id="status-u1" class="text-xs font-mono text-gray-400 font-bold">READY</div>
                </div>
                <select id="lang-u1"></select>
                <div id="live-u1" class="live-preview"></div>
                
                <div class="relative flex items-center gap-4">
                    <div id="mic-icon-u1" class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center transition-all border border-slate-600 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" /></svg>
                    </div>
                    <div class="flex-grow flex flex-col justify-center h-12">
                        <div id="timer-u1" class="hidden text-xs text-indigo-300 font-mono">Silence: <span id="countdown-u1">0</span>s</div>
                        <button id="manual-send-u1" class="hidden bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-3 py-1 rounded w-fit mt-1">Finish</button>
                    </div>
                </div>
            </div>

            <div id="panel-u2" class="glass-panel p-4 rounded-xl border-t-4 border-emerald-500 flex flex-col gap-3 transition-all">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-emerald-400 font-bold text-sm uppercase flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> User 2</span>
                    <div id="status-u2" class="text-xs font-mono text-gray-400 font-bold">READY</div>
                </div>
                <select id="lang-u2"></select>
                <div id="live-u2" class="live-preview"></div>

                <div class="relative flex items-center gap-4">
                    <div id="mic-icon-u2" class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center transition-all border border-slate-600 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" /></svg>
                    </div>
                    <div class="flex-grow flex flex-col justify-center h-12">
                        <div id="timer-u2" class="hidden text-xs text-emerald-300 font-mono">Silence: <span id="countdown-u2">0</span>s</div>
                        <button id="manual-send-u2" class="hidden bg-emerald-600 hover:bg-emerald-500 text-white text-xs px-3 py-1 rounded w-fit mt-1">Finish</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="global-status" class="w-full text-center py-1 text-[10px] text-gray-500 font-mono uppercase tracking-widest">System Idle</div>
    </main>

    <script>
        // --- LANGUAGES ---
        const languages = [
            { code: "en-IN", name: "English (India)" }, { code: "hi-IN", name: "Hindi (हिंदी)" },
            { code: "mr-IN", name: "Marathi (मराठी)" }, { code: "gu-IN", name: "Gujarati (ગુજરાતી)" },
            { code: "bn-IN", name: "Bengali (বাংলা)" }, { code: "ta-IN", name: "Tamil (தமிழ்)" },
            { code: "te-IN", name: "Telugu (తెలుగు)" }, { code: "kn-IN", name: "Kannada (ಕನ್ನಡ)" },
            { code: "ml-IN", name: "Malayalam (മലയാളം)" }, { code: "es-ES", name: "Spanish (Español)" },
            { code: "fr-FR", name: "French (Français)" }, { code: "de-DE", name: "German (Deutsch)" },
            { code: "ja-JP", name: "Japanese (日本語)" }, { code: "ru-RU", name: "Russian (Pусский)" },
            { code: "ar-SA", name: "Arabic (العربية)" }
        ];

        // --- GLOBAL VARIABLES ---
        let recognition, isConversationActive = false, activeTurn = 0;
        let silenceTimer = null, pauseSeconds = 0, pauseInterval = null;
        
        // **ANDROID FIX: SEPARATE BUFFERS**
        let finalTranscript = ""; 
        
        let lastSpokenText = "", lastSpokenLang = "";
        let synth = window.speechSynthesis, voices = [];

        const els = {
            startBtn: document.getElementById('start-btn'), stopBtn: document.getElementById('stop-btn'),
            shareBtn: document.getElementById('share-btn'), repeatBtn: document.getElementById('repeat-btn'),
            chat: document.getElementById('chat-container'), welcome: document.getElementById('welcome-msg'),
            status: document.getElementById('global-status'),
            u1: { panel: document.getElementById('panel-u1'), lang: document.getElementById('lang-u1'), status: document.getElementById('status-u1'), mic: document.getElementById('mic-icon-u1'), timer: document.getElementById('timer-u1'), countdown: document.getElementById('countdown-u1'), btn: document.getElementById('manual-send-u1'), live: document.getElementById('live-u1') },
            u2: { panel: document.getElementById('panel-u2'), lang: document.getElementById('lang-u2'), status: document.getElementById('status-u2'), mic: document.getElementById('mic-icon-u2'), timer: document.getElementById('timer-u2'), countdown: document.getElementById('countdown-u2'), btn: document.getElementById('manual-send-u2'), live: document.getElementById('live-u2') }
        };

        // --- INIT ---
        window.onload = () => {
            languages.forEach(l => { els.u1.lang.add(new Option(l.name, l.code)); els.u2.lang.add(new Option(l.name, l.code)); });
            els.u1.lang.value = "en-IN"; els.u2.lang.value = "hi-IN";
            
            const loadVoices = () => { voices = synth.getVoices(); };
            if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();

            if (!('webkitSpeechRecognition' in window)) { alert("Use Chrome."); els.startBtn.disabled = true; } 
            else { setupRecognition(); }
        };

        function setupRecognition() {
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRec();
            recognition.continuous = true; 
            recognition.interimResults = true;

            recognition.onstart = () => {
                if (!isConversationActive) return;
                const u = activeTurn === 1 ? els.u1 : els.u2;
                u.status.textContent = "LISTENING...";
                u.mic.classList.add('mic-listening');
                startSilenceWatcher();
            };

            recognition.onend = () => {
                if (isConversationActive && activeTurn !== 0) { try { recognition.start(); } catch(e){} }
            };

            // **ANDROID FIX: LOGIC CHANGE**
            recognition.onresult = (event) => {
                resetSilenceWatcher();
                
                let interim = "";
                // Loop only through new results, but since Android sends everything, we reconstruct
                // We rely on 'finalTranscript' variable which accumulates only committed results
                
                // IMPORTANT: In continuous mode, event.results grows.
                // We must rebuild the whole string from resultIndex 0 if we want full context,
                // OR handle the specific index.
                // The cleanest way for Android: Rebuild current turn string from scratch every event.
                
                let currentSessionText = "";
                
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interim += event.results[i][0].transcript;
                    }
                }

                // Display
                const display = finalTranscript + interim;
                const u = activeTurn === 1 ? els.u1 : els.u2;
                
                if (display.trim()) {
                    u.live.textContent = display.substring(Math.max(0, display.length - 100)); // Show last 100 chars
                    u.status.textContent = "HEARING...";
                }
            };
            
            recognition.onerror = (e) => { if(e.error === 'not-allowed') toggleStop(); };
        }

        function startSilenceWatcher() {
            clearInterval(pauseInterval); pauseSeconds = 0; updateTimerUI(0);
            pauseInterval = setInterval(() => {
                pauseSeconds++; updateTimerUI(pauseSeconds);
                if (pauseSeconds >= 5) {
                    // Check if we have text
                    if (finalTranscript.trim().length > 0) processTurn();
                    else pauseSeconds = 0; // Reset if silence but no text (ghost trigger)
                }
            }, 1000);
        }

        function resetSilenceWatcher() { pauseSeconds = 0; updateTimerUI(0); }
        function stopSilenceWatcher() { clearInterval(pauseInterval); pauseSeconds = 0; els.u1.timer.classList.add('hidden'); els.u2.timer.classList.add('hidden'); }
        function updateTimerUI(sec) {
            const u = activeTurn === 1 ? els.u1 : els.u2;
            u.timer.classList.remove('hidden'); u.countdown.textContent = sec;
        }

        // --- FLOW ---
        els.startBtn.onclick = () => { isConversationActive = true; els.startBtn.classList.add('hidden'); els.stopBtn.classList.remove('hidden'); els.welcome.style.display='none'; activateUser(1); };
        els.stopBtn.onclick = toggleStop;
        function toggleStop() { isConversationActive = false; activeTurn = 0; if(recognition) recognition.stop(); if(synth) synth.cancel(); stopSilenceWatcher(); resetUI(); els.startBtn.classList.remove('hidden'); els.stopBtn.classList.add('hidden'); els.status.textContent = "STOPPED"; }

        function activateUser(num) {
            if (!isConversationActive) return;
            activeTurn = num; 
            
            // **RESET BUFFERS**
            finalTranscript = "";
            els.u1.live.textContent = "";
            els.u2.live.textContent = "";

            resetUIStyles();
            const active = num === 1 ? els.u1 : els.u2;
            const inactive = num === 1 ? els.u2 : els.u1;
            
            active.panel.classList.replace('inactive-turn', 'active-turn');
            active.btn.classList.remove('hidden');
            inactive.panel.classList.replace('active-turn', 'inactive-turn');
            
            els.status.textContent = `USER ${num} SPEAKING`;
            recognition.lang = active.lang.value;
            try { recognition.start(); } catch(e){}
        }

        els.u1.btn.onclick = () => processTurn(); els.u2.btn.onclick = () => processTurn();

        async function processTurn() {
            if (!isConversationActive) return;
            stopSilenceWatcher(); if(recognition) recognition.stop();
            
            const src = activeTurn, tgt = src === 1 ? 2 : 1;
            const text = finalTranscript.trim(); // Use only FINAL text for translation
            
            if (!text) { activateUser(src); return; }

            activeTurn = 0; resetUIStyles();
            els.status.textContent = "TRANSLATING..."; els.chat.classList.add('speaking-now');
            addChatBubble(src, text, false);

            const sLang = src === 1 ? els.u1.lang.value : els.u2.lang.value;
            const tLang = tgt === 1 ? els.u1.lang.value : els.u2.lang.value;
            const pair = `${sLang}|${tLang}`;

            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${pair}`);
                const data = await res.json();
                if (data.responseData) {
                    const trans = data.responseData.translatedText;
                    addChatBubble(tgt, trans, true);
                    await speakText(trans, tLang);
                    if (isConversationActive) { els.chat.classList.remove('speaking-now'); activateUser(tgt); }
                } else throw new Error("API Limit");
            } catch (e) {
                console.error(e);
                addChatBubble(src, "Translation Failed", true, true);
                if (isConversationActive) activateUser(tgt);
            }
        }

        function speakText(text, lang) {
            return new Promise((resolve) => {
                if (!text) { resolve(); return; }
                if (synth.speaking) synth.cancel();
                lastSpokenText = text; lastSpokenLang = lang; els.repeatBtn.disabled = false;
                
                const utt = new SpeechSynthesisUtterance(text);
                utt.lang = lang; utt.rate = 0.9;
                
                if(voices.length===0) voices = synth.getVoices();
                let v = voices.find(v => v.lang === lang && v.name.includes("Google"));
                if(!v) v = voices.find(v => v.lang === lang);
                if(v) utt.voice = v;

                utt.onend = resolve; utt.onerror = resolve;
                synth.speak(utt);
                
                const wake = setInterval(() => {
                    if (!synth.speaking) clearInterval(wake);
                    else { synth.pause(); synth.resume(); }
                }, 14000);
            });
        }

        els.repeatBtn.onclick = () => { if(lastSpokenText) { const u = new SpeechSynthesisUtterance(lastSpokenText); u.lang = lastSpokenLang; u.rate = 0.9; synth.speak(u); } };
        els.shareBtn.onclick = async () => { try { await navigator.clipboard.writeText(els.chat.innerText); alert("Copied!"); } catch(e){} };

        function resetUIStyles() {
            els.u1.panel.classList.remove('active-turn'); els.u2.panel.classList.remove('active-turn');
            els.u1.panel.classList.add('inactive-turn'); els.u2.panel.classList.add('inactive-turn');
            els.u1.btn.classList.add('hidden'); els.u2.btn.classList.add('hidden');
            els.u1.mic.classList.remove('mic-listening'); els.u2.mic.classList.remove('mic-listening');
            els.u1.status.textContent = "WAITING"; els.u2.status.textContent = "WAITING";
        }
        function resetUI() { resetUIStyles(); els.chat.classList.remove('speaking-now'); }

        function addChatBubble(u, txt, isTrans, isErr=false) {
            const d = document.createElement('div');
            const align = u === 1 ? 'self-start text-left' : 'self-end text-right';
            let bg = u === 1 ? 'bg-indigo-900/80 border-indigo-700' : 'bg-emerald-900/80 border-emerald-700';
            if (isErr) bg = 'bg-red-900/80 border-red-700';
            d.className = `max-w-[85%] ${align} p-3 rounded-xl border ${bg} mb-2 shadow-lg msg-enter`;
            d.innerHTML = `<div class="text-[10px] uppercase text-gray-400 font-bold mb-1">User ${u} ${isTrans?'(Trans)':''}</div><div class="text-white text-lg">${txt}</div>`;
            els.chat.appendChild(d); els.chat.scrollTop = els.chat.scrollHeight;
        }
    </script>
</body>
</html>