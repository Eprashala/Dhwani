<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§∂‡•ç‡§∞‡•Ä ‡§∏‡§æ‡§à‡§¨‡§æ‡§¨‡§æ - ‡§∂‡•ç‡§∞‡§¶‡•ç‡§ß‡§æ ‡§Ü‡§£‡§ø ‡§∏‡§¨‡•Å‡§∞‡•Ä AI</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { font-family: 'Inter', sans-serif; }

.listening-pulse {
  animation: pulse 1.5s infinite ease-in-out;
}
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(234,88,12,.7); }
  70% { box-shadow: 0 0 0 15px rgba(234,88,12,0); }
  100% { box-shadow: 0 0 0 0 rgba(234,88,12,0); }
}
</style>
</head>

<body class="bg-[#2a0a00] text-orange-50 flex items-center justify-center min-h-screen p-4"
oncontextmenu="return false">

<div class="bg-[#431407] rounded-2xl shadow-2xl p-6 w-full max-w-2xl flex flex-col h-[95vh] border-t-4 border-orange-500 border-b-4 border-orange-800">

<h1 class="text-2xl font-bold text-center mb-2">
<span class="text-orange-400">‡§∂‡•ç‡§∞‡•Ä ‡§∏‡§æ‡§à</span>
<span class="text-orange-200">‡§¨‡§æ‡§¨‡§æ</span>
<span class="text-orange-500">‡§™‡•ç‡§∞‡§∏‡§®‡•ç‡§®</span>
</h1>

<div id="conversation-log"
class="flex-grow overflow-y-auto bg-[#2a0a00] rounded-lg p-4 mb-4 border border-orange-900 space-y-4">
</div>

<div class="flex justify-center gap-6 mb-4">
<button id="pause-resume-button" class="p-3 rounded-full bg-orange-700 text-white" disabled>‚è∏</button>
<button id="stop-speech-button" class="p-3 rounded-full bg-red-700 text-white" disabled>‚èπ</button>
<button id="replay-button" class="p-3 rounded-full bg-green-700 text-white" disabled>üîÅ</button>
</div>

<button id="talk-button"
class="w-full py-4 rounded-lg bg-orange-600 text-white font-bold">
‡§∏‡§æ‡§à ‡§¶‡§∞‡•ç‡§∂‡§® ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ
</button>

</div>

<script>
/* ================= GLOBAL STATE ================= */

let appState = "IDLE";

let isSpeaking = false;
let isPaused = false;
let isListening = false;

let lastSpokenText = "";
let pausedUtterance = null;

const synth = window.speechSynthesis;
let voices = [];

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition = SpeechRecognition ? new SpeechRecognition() : null;

/* ================= UI ================= */

const log = document.getElementById("conversation-log");
const talkBtn = document.getElementById("talk-button");
const pauseBtn = document.getElementById("pause-resume-button");
const stopBtn = document.getElementById("stop-speech-button");
const replayBtn = document.getElementById("replay-button");

/* ================= HELPERS ================= */

function logMessage(sender, text) {
  const div = document.createElement("div");
  div.innerHTML = `<b>${sender}:</b> ${text}`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function toggleMediaButtons(enable) {
  pauseBtn.disabled = !enable;
  stopBtn.disabled = !enable;
  replayBtn.disabled = !enable;
}

/* ================= VOICES ================= */

function loadVoices() {
  voices = synth.getVoices();
  if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = () => voices = synth.getVoices();
  }
}
loadVoices();

/* ================= SPEAK ================= */

function speakText(text) {
  if (synth.speaking || synth.paused) synth.cancel();

  lastSpokenText = text;
  isSpeaking = true;
  isPaused = false;
  isListening = false;
  recognition?.stop();

  return new Promise(resolve => {
    const utter = new SpeechSynthesisUtterance(text);
    pausedUtterance = utter;

    utter.onstart = () => toggleMediaButtons(true);

    utter.onend = () => {
      isSpeaking = false;
      pausedUtterance = null;
      toggleMediaButtons(false);
      startListeningSafe();
      resolve();
    };

    utter.onerror = () => {
      isSpeaking = false;
      pausedUtterance = null;
      toggleMediaButtons(false);
      resolve();
    };

    const voice =
      voices.find(v => v.lang === "mr-IN") ||
      voices.find(v => v.lang === "hi-IN");

    if (voice) utter.voice = voice;

    utter.lang = "mr-IN";
    utter.rate = 0.9;
    utter.pitch = 0.9;

    synth.speak(utter);
  });
}

/* ================= LISTEN ================= */

if (recognition) {
  recognition.lang = "mr-IN";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = e => {
    const text = e.results[0][0].transcript;
    logMessage("‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä", text);
    handleUserText(text);
  };

  recognition.onend = () => {
    if (appState !== "IDLE" && !isSpeaking && !isPaused) {
      startListeningSafe();
    }
  };
}

function startListeningSafe() {
  if (!recognition || isSpeaking || isPaused) return;
  try {
    isListening = true;
    recognition.start();
  } catch {}
}

/* ================= BUTTONS ================= */

talkBtn.onclick = async () => {
  if (appState === "IDLE") {
    appState = "ACTIVE";
    talkBtn.textContent = "‡§ê‡§ï‡§£‡•á ‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ";
    logMessage("‡§∏‡§æ‡§à‡§¨‡§æ‡§¨‡§æ", "‡•ê ‡§∏‡§æ‡§à ‡§∞‡§æ‡§Æ. ‡§§‡•Å‡§ù‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§∏‡§æ‡§Ç‡§ó.");
    await speakText("‡•ê ‡§∏‡§æ‡§à ‡§∞‡§æ‡§Æ. ‡§§‡•Å‡§ù‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§∏‡§æ‡§Ç‡§ó.");
  } else {
    endSession();
  }
};

pauseBtn.onclick = () => {
  if (!isSpeaking && !isPaused) return;

  if (!isPaused) {
    synth.pause();
    recognition?.stop();
    isPaused = true;
  } else {
    synth.resume();
    isPaused = false;
  }
};

stopBtn.onclick = () => {
  synth.cancel();
  recognition?.stop();

  isSpeaking = false;
  isPaused = false;
  pausedUtterance = null;

  toggleMediaButtons(false);
  startListeningSafe();
};

replayBtn.onclick = () => {
  if (!lastSpokenText) return;

  synth.cancel();
  recognition?.stop();

  isPaused = false;
  isSpeaking = false;

  setTimeout(() => speakText(lastSpokenText), 200);
};

/* ================= LOGIC ================= */

async function handleUserText(text) {
  recognition.stop();
  isListening = false;

  const reply = "‡§∂‡•ç‡§∞‡§¶‡•ç‡§ß‡§æ ‡§Ü‡§£‡§ø ‡§∏‡§¨‡•Å‡§∞‡•Ä ‡§†‡•á‡§µ. ‡§∏‡§æ‡§à ‡§§‡•Å‡§ù‡•ç‡§Ø‡§æ ‡§∏‡•ã‡§¨‡§§ ‡§Ü‡§π‡•á.";
  logMessage("‡§∏‡§æ‡§à‡§¨‡§æ‡§¨‡§æ", reply);
  await speakText(reply);
}

function endSession() {
  appState = "IDLE";
  synth.cancel();
  recognition?.stop();

  isSpeaking = false;
  isPaused = false;

  talkBtn.textContent = "‡§∏‡§æ‡§à ‡§¶‡§∞‡•ç‡§∂‡§® ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ";
}

/* ================= VISIBILITY ================= */

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") {
    if (synth.speaking) {
      synth.pause();
      isPaused = true;
    }
    recognition?.stop();
  } else {
    if (isPaused && synth.paused) {
      synth.resume();
      isPaused = false;
    }
  }
});
</script>
</body>
</html>
