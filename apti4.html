<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhwani AI - Eprashala Assessment</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; display: flex; justify-content: center; height: 100dvh; box-sizing: border-box; }
        .container { background: white; max-width: 800px; width: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        button { background: #2980b9; color: white; border: none; padding: 14px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        button:disabled { background: #bdc3c7; }
        input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        
        #setup-screen { padding: 40px 20px; text-align: center; overflow-y: auto; height: 100%; }
        #test-screen { display: none; flex-direction: column; height: 100%; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 15px; }
        #stage-indicator { background: #e67e22; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; display: inline-block; margin-top: 5px; }
        
        #chat-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 90%; padding: 14px; border-radius: 10px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; }
        .bot-msg { background: #e3f2fd; color: #0b3c7c; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #bbdefb; }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .controls-area { padding: 15px; background: white; border-top: 1px solid #eee; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .input-row { display: flex; gap: 10px; align-items: center; }
        
        /* PTT Mic Button Styling */
        #micBtn { 
            background: #e67e22; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; flex-shrink: 0; border: none; padding: 0; transition: 0.2s;
            -webkit-user-select: none; -webkit-touch-callout: none; user-select: none; touch-action: none;
        }
        #micBtn.listening { background: #e74c3c; box-shadow: 0 0 15px rgba(231, 76, 60, 0.6); transform: scale(1.08); }
        
        #full-loader { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box;}
        #report-screen { display: none; flex-direction: column; height: 100%; }
        #report-content { flex: 1; overflow-y: auto; padding: 20px; background: white; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 20px; border-radius: 0 8px 8px 0; }
        #consult-area { background: #eef2f5; padding: 20px; border-top: 2px solid #ddd; }
        #consult-history { max-height: 250px; overflow-y: auto; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd;}
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen">
        <h2>Dhwani AI Assessment</h2>
        <p style="color: #666; font-size: 14px;">Eprashala Native Indian Evaluation</p>
        <input type="password" id="apiKey" placeholder="Gemini API Key" required>
        <input type="text" id="childName" placeholder="Student's Name" required>
        <input type="number" id="childAge" placeholder="Age (e.g., 14)" required>
        <input type="text" id="childCity" placeholder="City/Town (e.g., Pune, Nashik)" required>
        <button onclick="startTest()">Begin Assessment</button>
    </div>

    <div id="test-screen">
        <div class="header">
            <div id="test-header">Dhwani Session</div>
            <div id="stage-indicator">Stage 0: Initialization</div>
        </div>
        <div id="chat-history"></div>
        
        <div class="controls-area">
            <p id="mic-status" style="font-size: 11px; color: #7f8c8d; margin: 0 0 5px 0; text-align: center;">Hold mic to speak. Auto-sends on release.</p>
            <div class="input-row">
                <button id="micBtn">ðŸŽ¤</button>
                <input type="text" id="userInput" placeholder="Type or hold mic..." onkeypress="handleEnter(event)">
                <button id="sendBtn" onclick="submitAnswer()" style="width: auto; margin:0; display: none;">Send</button>
            </div>
        </div>
    </div>

    <div id="report-screen">
        <div id="report-content"></div>
        <div id="consult-area">
            <h3 style="margin-top:0; color:#2c3e50;">Consult Dhwani</h3>
            <div id="consult-history"></div>
            <div class="input-row">
                <input type="text" id="consultInput" placeholder="Ask about colleges, streams..." onkeypress="if(event.key === 'Enter') sendConsult()">
                <button onclick="sendConsult()" style="width: auto; margin:0;">Ask</button>
            </div>
            <button onclick="downloadChatAsText()" style="background: #27ae60;">Download Full Report (.txt)</button>
        </div>
    </div>

    <div id="full-loader">
        <h2 id="loader-text">Dhwani is analyzing...</h2>
    </div>
</div>

<script>
    let childData = { name: "", age: 0, city: "" };
    let apiKey = "";
    
    let currentStage = 0;
    let questionCount = 0;
    const questionsPerStage = 5; 
    
    // TOKEN OPTIMIZATION ARRAYS
    let currentStageHistory = []; 
    let fullTranscript = ""; 
    let lastBotQuestion = ""; 
    let consultHistory = [];
    
    const STAGES = {
        0: { name: "Stage 0: Basics", type: "Multiple choice (A, B, C, or D)" },
        1: { name: "Stage 1: Quick Fire", type: "Yes or No only" },
        2: { name: "Stage 2: Short Thoughts", type: "1 short sentence" },
        3: { name: "Stage 3: Exploration", type: "2 to 3 sentences" },
        4: { name: "Stage 4: Deep Dive", type: "Detailed explanation" }
    };

    // --- 1. PUSH-TO-TALK LOGIC (FIXED FOR ANDROID REPETITION) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isButtonHeld = false; // Tracks physical touch state
    let committedText = ""; 

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        // EXPERT FIX: Set continuous to FALSE to prevent Android buffer repetition
        recognition.continuous = false; 
        recognition.interimResults = true; 
        recognition.lang = 'en-IN'; 
        
        recognition.onstart = () => { 
            document.getElementById('micBtn').classList.add('listening'); 
            document.getElementById('mic-status').innerText = "Listening... Release to send.";
            document.getElementById('userInput').placeholder = "Listening...";
        };
        
        recognition.onresult = (e) => { 
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = e.resultIndex; i < e.results.length; ++i) {
                if (e.results[i].isFinal) {
                    finalTranscript += e.results[i][0].transcript;
                } else {
                    interimTranscript += e.results[i][0].transcript;
                }
            }
            
            // Append safely to our committed buffer
            if (finalTranscript) {
                // Add a space to prevent word-mashing between restarts
                if (committedText.length > 0 && !committedText.endsWith(' ') && !finalTranscript.startsWith(' ')) {
                    committedText += ' ';
                }
                committedText += finalTranscript;
            }
            
            document.getElementById('userInput').value = committedText + interimTranscript;
        };

        // EXPERT FIX: Use onend to seamlessly restart if button is still held
        recognition.onend = () => { 
            if (isButtonHeld) {
                // User is still holding the button, restart recognition silently
                try { recognition.start(); } catch(err) {}
            } else {
                // User let go of the button. Process the text.
                stopListeningUI();
                
                // AUTO-SUBMIT LOGIC
                setTimeout(() => {
                    const inputVal = document.getElementById('userInput').value.trim();
                    if (inputVal.length > 0) submitAnswer();
                }, 500);
            }
        };

        recognition.onerror = (e) => {
            if (e.error !== 'no-speech') {
                console.error("Mic error:", e.error);
                stopListeningUI();
            }
        };
    }

    const micBtn = document.getElementById('micBtn');

    function startListening(e) {
        if (e) e.preventDefault();
        if (isButtonHeld || !recognition) return;
        
        isButtonHeld = true;
        
        // Grab any manually typed text before they hit record
        committedText = document.getElementById('userInput').value;
        if (committedText.length > 0 && !committedText.endsWith(' ')) committedText += ' ';
        
        try { recognition.start(); } catch(err) {}
    }

    function stopListening(e) {
        if (e) e.preventDefault();
        if (!isButtonHeld) return;
        
        isButtonHeld = false; // This flag tells onend to NOT restart
        try { recognition.stop(); } catch(err) {} // Forces onend to trigger
    }

    micBtn.addEventListener('touchstart', startListening, { passive: false });
    micBtn.addEventListener('touchend', stopListening);
    micBtn.addEventListener('touchcancel', stopListening);
    micBtn.addEventListener('mousedown', startListening);
    micBtn.addEventListener('mouseup', stopListening);
    micBtn.addEventListener('mouseleave', stopListening);

    function stopListeningUI() {
        document.getElementById('micBtn').classList.remove('listening'); 
        document.getElementById('mic-status').innerText = "Hold mic to speak. Auto-sends on release.";
        document.getElementById('userInput').placeholder = "Type or hold mic...";
    }

    // --- 2. NATIVE INDIAN FEMALE TTS SETUP ---
    window.speechSynthesis.onvoiceschanged = () => {};

    function unlockAndroidAudio() {
        const silentUtterance = new SpeechSynthesisUtterance('');
        silentUtterance.volume = 0;
        window.speechSynthesis.speak(silentUtterance);
    }

    function speakDhwaniResponse(text) {
        if (!('speechSynthesis' in window)) return;
        window.speechSynthesis.cancel(); 
        const utterance = new SpeechSynthesisUtterance(text);
        
        let voices = window.speechSynthesis.getVoices();
        
        // Priority 1: explicitly female Indian/Marathi/Hindi voices
        let targetVoice = voices.find(v => 
            (v.lang.includes('en-IN') || v.lang.includes('hi-IN') || v.lang.includes('mr-IN')) && 
            (v.name.toLowerCase().includes('female') || v.name.includes('Google'))
        );
        
        if (!targetVoice) targetVoice = voices.find(v => v.lang === 'en-IN' || v.lang === 'hi-IN');
        if (targetVoice) utterance.voice = targetVoice;
        
        utterance.rate = 0.90; 
        utterance.pitch = 1.1; 
        window.speechSynthesis.speak(utterance);
    }

    // --- 3. CORE LOGIC & ROBUST API HANDLING ---
    function startTest() {
        apiKey = document.getElementById('apiKey').value.trim();
        childData.name = document.getElementById('childName').value.trim();
        childData.age = parseInt(document.getElementById('childAge').value);
        childData.city = document.getElementById('childCity').value.trim();

        if(!apiKey || !childData.name || !childData.age || !childData.city) { alert("Fill all fields."); return; }

        unlockAndroidAudio(); 
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('test-screen').style.display = 'flex';
        
        currentStageHistory.push({ role: "user", parts: [{ text: "Namaste Dhwani. Start the assessment." }] });
        processTurn();
    }

    function submitAnswer() {
        if (isButtonHeld) {
            isButtonHeld = false;
            try { recognition.stop(); } catch(e){}
        }

        const input = document.getElementById('userInput');
        const answerTxt = input.value.trim();
        if (!answerTxt) return;
        
        addMessage(answerTxt, 'user', 'chat-history');
        currentStageHistory.push({ role: "user", parts: [{ text: answerTxt }] });
        fullTranscript += `Q: ${lastBotQuestion}\nUser (${childData.name}): ${answerTxt}\n\n`;

        input.value = '';
        committedText = ''; 
        
        questionCount++;
        
        if (questionCount >= questionsPerStage) {
            currentStage++;
            questionCount = 0;
            currentStageHistory = [{ role: "user", parts: [{ text: `Moving to ${STAGES[currentStage]?.name || 'Final phase'}. Ask the first question of this stage.` }] }];
            
            const chat = document.getElementById('chat-history');
            const divider = document.createElement('div');
            divider.innerHTML = `<hr style="border:0; border-top:1px dashed #ccc; margin: 20px 0;">`;
            chat.appendChild(divider);
        }

        if (currentStage > 4) {
            generateFinalReport();
        } else {
            processTurn();
        }
    }

    function handleEnter(e) { if (e.key === 'Enter') submitAnswer(); }

    function getSystemPrompt() {
        const stage = STAGES[currentStage];
        const ageContext = childData.age <= 14 
            ? "Focus on school standard, extra classes, tuitions, marks, and hobbies." 
            : "Focus on college batches, entrance exams, streams (Science/Commerce/Arts), placements, and Indian job market realities.";

        return `You are Dhwani, an AI aptitude evaluator for Indian students. User: ${childData.name} | Age: ${childData.age} | City: ${childData.city}.
        
        CURRENT STAGE: ${stage.name}.
        EXPECTED ANSWER LENGTH FROM USER: ${stage.type}. 
        
        CULTURE & TONE: 
        - Use native Indian English vocabulary (e.g., 'marks', 'tuition', 'standard', 'batch', 'college', 'stream').
        - Format your questions neatly.
        - Be warm but strictly evaluative.
        
        RULES: Keep YOUR questions SHORT. Ask EXACTLY ONE question.`;
    }

    async function processTurn() {
        setLoading(true, "Dhwani is thinking...");
        document.getElementById('stage-indicator').innerText = STAGES[currentStage].name;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: getSystemPrompt() }] },
                    contents: currentStageHistory, 
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" }
                    ],
                    generationConfig: { 
                        response_mime_type: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                bot_reply: { type: "STRING" },
                                internal_analysis: { type: "STRING" }
                            },
                            required: ["bot_reply", "internal_analysis"]
                        }
                    }
                })
            });

            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error?.message || `HTTP ${response.status}`);
            if (data.promptFeedback?.blockReason || data.candidates?.[0]?.finishReason === 'SAFETY') {
                throw new Error("Response blocked by safety filters.");
            }

            let rawText = data.candidates[0].content.parts[0].text;
            rawText = rawText.replace(/^```json\n|```\n?$/gm, '').trim(); 
            
            const aiData = JSON.parse(rawText);
            
            lastBotQuestion = aiData.bot_reply; 
            currentStageHistory.push({ role: "model", parts: [{ text: aiData.bot_reply }] });
            
            addMessage(aiData.bot_reply, 'bot', 'chat-history');
            speakDhwaniResponse(aiData.bot_reply);
            
        } catch (e) { 
            console.error("Dhwani API Error Details:", e);
            alert(`Communication Error: ${e.message}`); 
            currentStageHistory.pop(); // Remove user message so they can retry
        } finally {
            setLoading(false);
        }
    }

    async function generateFinalReport() {
        setLoading(true, "Generating Eprashala Report based on transcript...");
        
        const reportPrompt = `You are Dhwani. The user (${childData.name}, Age ${childData.age}) finished their aptitude test.
        Here is the full flat-text transcript of their answers:
        
        ${fullTranscript}
        
        Analyze this transcript. Output ONLY raw HTML. 
        Format strictly:
        <h2 style='color:#2980b9'>Executive Summary</h2>
        <div class='report-card'><b>Personality Traits:</b> Honest assessment.</div>
        <div class='report-card'><b>Strengths & Areas of Improvement:</b> ...</div>
        <div class='report-card'><b>Recommended Indian Career Streams:</b> Top 3 paths.</div>`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ role: "user", parts: [{ text: reportPrompt }] }] 
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || "Report Generation Failed");

            let rawHtml = data.candidates[0].content.parts[0].text;
            rawHtml = rawHtml.replace(/^```html\n|```\n?$/gm, '').trim();

            document.getElementById('test-screen').style.display = 'none';
            document.getElementById('report-screen').style.display = 'flex';
            document.getElementById('report-content').innerHTML = rawHtml;
            
            consultHistory.push({ role: "user", parts: [{ text: "I have read my report. Let's start the post-test consultation." }] });
            speakDhwaniResponse("Assessment complete. Your report is generated. You can now consult me below.");
        } catch (e) { 
            console.error("Report Error Details:", e);
            alert(`Error generating report: ${e.message}`); 
        } finally {
            setLoading(false);
        }
    }

    async function sendConsult() {
        const input = document.getElementById('consultInput');
        const text = input.value.trim();
        if (!text) return;
        addMessage(text, 'user', 'consult-history');
        consultHistory.push({ role: "user", parts: [{ text: text }] });
        input.value = '';
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: "You are Dhwani, an Indian career consultant. Give advice on Indian colleges, coaching, Udemy, and entrance exams. Reply in plain text, nicely formatted." }] },
                    contents: consultHistory
                })
            });
            const data = await response.json();
            const reply = data.candidates[0].content.parts[0].text;
            consultHistory.push({ role: "model", parts: [{ text: reply }] });
            addMessage(reply, 'bot', 'consult-history');
            speakDhwaniResponse(reply); 
        } catch(e) { alert("Error connecting."); }
    }

    function downloadChatAsText() {
        let textToSave = `--- Dhwani Report for ${childData.name} ---\n\n`;
        textToSave += `Test Transcript:\n${fullTranscript}\n\n`;
        textToSave += `--- Consultation Log ---\n`;
        consultHistory.forEach(msg => { if (!msg.parts[0].text.includes("I have read my report")) textToSave += `${msg.role}: ${msg.parts[0].text}\n\n`; });
        
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([textToSave], { type: "text/plain" }));
        link.download = `Eprashala_Dhwani_${childData.name}.txt`;
        link.click();
    }

    function addMessage(text, sender, containerId) {
        const chat = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = `message ${sender}-msg`;
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function setLoading(show, text="") {
        document.getElementById('full-loader').style.display = show ? 'flex' : 'none';
        document.getElementById('loader-text').innerText = text;
    }
</script>
</body>
</html>