async function processTurn() {
        setLoading(true, "Dhwani is thinking...");
        document.getElementById('stage-indicator').innerText = STAGES[currentStage].name;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: getSystemPrompt() }] },
                    contents: currentStageHistory, 
                    // 1. Lower Safety Thresholds to allow "Devil's Advocate" questioning
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" }
                    ],
                    generationConfig: { 
                        response_mime_type: "application/json",
                        // 2. Lock the JSON Schema so the AI cannot hallucinate the format
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                bot_reply: { type: "STRING" },
                                internal_analysis: { type: "STRING" }
                            },
                            required: ["bot_reply", "internal_analysis"]
                        }
                    }
                })
            });

            const data = await response.json();
            
            // 3. Catch HTTP Errors (like 429 Too Many Requests or 400 Bad Request)
            if (!response.ok) {
                throw new Error(data.error?.message || `HTTP Error: ${response.status}`);
            }

            // 4. Catch Safety Blocks
            if (data.promptFeedback?.blockReason || (data.candidates && data.candidates[0]?.finishReason === 'SAFETY')) {
                throw new Error("Response blocked by safety filters. Adjust the prompt tone.");
            }

            // 5. Clean potential Markdown before parsing
            let rawText = data.candidates[0].content.parts[0].text;
            rawText = rawText.replace(/^```json\n|```\n?$/gm, '').trim(); 
            
            const aiData = JSON.parse(rawText);
            
            lastBotQuestion = aiData.bot_reply; 
            currentStageHistory.push({ role: "model", parts: [{ text: aiData.bot_reply }] });
            
            addMessage(aiData.bot_reply, 'bot', 'chat-history');
            speakDhwaniResponse(aiData.bot_reply);
            
        } catch (e) { 
            // 6. Log the actual error to the console for debugging, rather than a silent fail
            console.error("Dhwani API Error Details:", e);
            alert(`Communication Error: ${e.message}\nCheck console for details.`); 
            
            // Remove the user's last input from history so they can try clicking Send again
            currentStageHistory.pop();
        } finally {
            setLoading(false);
        }
    }