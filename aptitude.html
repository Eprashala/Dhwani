<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani - Advanced Aptitude Assessment</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; max-width: 900px; width: 100%; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Setup Screen */
        #setup-screen { padding: 40px; text-align: center; }
        #setup-screen input { display: block; width: 80%; margin: 15px auto; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .api-note { font-size: 12px; color: #666; margin-bottom: 20px; }
        button { background: #2980b9; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #1c5980; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        
        /* Test Screen */
        #test-screen { display: none; flex-direction: column; height: 90vh; }
        .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        #stage-indicator { background: #f39c12; padding: 5px 10px; border-radius: 4px; font-size: 14px; }
        
        .main-content { display: flex; flex: 1; overflow: hidden; }
        
        /* Video Panel */
        .video-panel { width: 30%; background: #000; position: relative; display: flex; flex-direction: column; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        .recording-badge { position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.8); color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* Chat & Results Panel */
        .interaction-panel { width: 70%; display: flex; flex-direction: column; border-left: 1px solid #eee; position: relative; }
        #chat-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 85%; padding: 12px 18px; border-radius: 8px; line-height: 1.5; font-size: 15px; }
        .bot-msg { background: #e3f2fd; color: #0d47a1; align-self: flex-start; border-bottom-left-radius: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .system-msg { background: #fff3cd; color: #856404; font-size: 13px; text-align: center; margin: 10px auto; border-radius: 4px; padding: 8px; width: 80%; border: 1px solid #ffeeba; }
        
        .input-area { display: flex; padding: 15px; background: white; border-top: 1px solid #eee; }
        .input-area input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; font-size: 16px; }
        
        /* Loading overlay */
        #loading { display: none; position: absolute; bottom: 70px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        
        /* Final Report Screen */
        #report-screen { display: none; padding: 40px; overflow-y: auto; height: 90vh; background: white; }
        .report-header { text-align: center; border-bottom: 2px solid #2980b9; padding-bottom: 20px; margin-bottom: 30px; }
        .report-content h3 { color: #2c3e50; margin-top: 25px; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 15px; border-radius: 0 4px 4px 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen">
        <h2>Dhwani Career & Aptitude Evaluator</h2>
        <p>Expert counseling platform for Indian students.</p>
        <input type="password" id="apiKey" placeholder="Gemini API Key" required>
        <p class="api-note">Your key is kept securely in your browser and used directly to communicate with Google's servers.</p>
        <input type="text" id="childName" placeholder="Student's Name" required>
        <input type="number" id="childAge" placeholder="Student's Age (e.g., 14)" required>
        <button onclick="startTest()">Initialize Session</button>
    </div>

    <div id="test-screen">
        <div class="header">
            <span id="test-header">Dhwani Session</span>
            <span id="stage-indicator">Stage 1: Exploration</span>
        </div>
        <div class="main-content">
            <div class="video-panel">
                <div class="recording-badge">REC</div>
                <video id="webcam" autoplay muted playsinline></video>
                <button style="border-radius: 0; background: #e74c3c; width: 100%; margin-top: auto;" onclick="forceEndTest()">Abort Session</button>
            </div>
            <div class="interaction-panel">
                <div id="chat-history"></div>
                <div id="loading">Dhwani is analyzing...</div>
                <div class="input-area">
                    <input type="text" id="userInput" placeholder="Type your answer in detail..." onkeypress="handleEnter(event)">
                    <button id="sendBtn" onclick="processUserAnswer()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="report-screen">
        <div class="report-header">
            <h1 style="color: #2980b9;">Comprehensive Aptitude Report</h1>
            <h3 id="report-name-age"></h3>
            <p>Generated by Dhwani AI Expert System</p>
        </div>
        <div id="report-body" class="report-content">
            </div>
        <center><button onclick="location.reload()" style="margin-top: 30px;">Start New Session</button></center>
    </div>
</div>

<script>
    let mediaRecorder;
    let recordedChunks = [];
    let childData = { name: "", age: 0 };
    let apiKey = "";
    
    // Test State Management
    let currentStage = 1;
    let questionCount = 0;
    let maxQuestionsPerStage = 4; // Adjust this to make the test longer (e.g., 7 or 8 for a full 30 min test)
    let conversationHistory = []; // Array of {role: 'user'|'model', parts: [{text: ''}]}

    async function startTest() {
        apiKey = document.getElementById('apiKey').value.trim();
        childData.name = document.getElementById('childName').value.trim();
        childData.age = parseInt(document.getElementById('childAge').value);

        if(!apiKey || !childData.name || !childData.age) {
            alert("Please fill all fields, including the API key.");
            return;
        }

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('test-screen').style.display = 'flex';
        document.getElementById('test-header').innerText = `${childData.name}'s Assessment`;

        await initCamera();
        
        // Initial Greeting
        const greeting = `Hello ${childData.name}! I am Dhwani, a career guide. I'm here to help you figure out what you are naturally great at and what subjects you might enjoy in the future. There are no wrong answers here, just be honest and think aloud. Ready? Tell me a little bit about what you enjoy doing in your free time.`;
        addMessage(greeting, 'bot');
        
        // Initialize history for API
        conversationHistory.push({ role: "user", parts: [{ text: "Start the test." }] });
        conversationHistory.push({ role: "model", parts: [{ text: greeting }] });
    }

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('webcam').srcObject = stream;
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.start();
        } catch (err) {
            alert("Camera access is required for proctoring.");
        }
    }

    function getSystemInstruction() {
        return `You are Dhwani, an expert Indian career counselor and psychometric aptitude test conductor. You are assessing a ${childData.age}-year-old student named ${childData.name}.
        The goal is to determine their ideal academic stream after class 10 (Science PCM/PCB, Commerce, or Arts/Humanities) and suggest specific career paths.
        
        You are currently in STAGE ${currentStage} of 4.
        Question number in current stage: ${questionCount + 1} of ${maxQuestionsPerStage}.

        Test Structure:
        - Stage 1: Basic exploration across logic, language, arts, and business.
        - Stage 2: Narrow down based on Stage 1 answers. Drop the weakest stream. Probe the top two.
        - Stage 3: Deep dive into their preferred field. Ask scenario-based aptitude questions (e.g., a math puzzle for science, a moral dilemma for law/arts, a profit scenario for commerce).
        - Stage 4: Nuance and final confirmation of specific careers within their chosen stream.

        IMPORTANT INSTRUCTIONS:
        1. Ask ONLY ONE question at a time.
        2. Wait for the user's answer before proceeding.
        3. Make the questions scenario-based and engaging, not like a school exam.
        4. YOU MUST RESPOND STRICTLY IN THE FOLLOWING JSON FORMAT. DO NOT OUTPUT RAW TEXT OUTSIDE THIS JSON.

        JSON FORMAT:
        {
            "bot_reply": "Your conversational response and the next question for the child.",
            "internal_analysis": "Your hidden notes on their aptitude (e.g., 'Strong analytical skills shown, leaning towards Science').",
            "stage_summary": "If the stage is changing, provide a brief summary of findings to show the user. Otherwise, leave empty string.",
            "is_test_complete": boolean (true ONLY if Stage 4 is completely finished),
            "final_report_html": "If is_test_complete is true, generate a beautifully formatted HTML report using <h3>, <ul>, <p>, and .report-card divs detailing their Strengths, Recommended Streams (Science/Commerce/Arts), and specific Career Options for the Indian context. Otherwise, leave empty string."
        }`;
    }

    async function processUserAnswer() {
        const inputField = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const answer = inputField.value.trim();
        if (!answer) return;

        addMessage(answer, 'user');
        inputField.value = '';
        inputField.disabled = true;
        sendBtn.disabled = true;
        document.getElementById('loading').style.display = 'block';

        conversationHistory.push({ role: "user", parts: [{ text: answer }] });
        questionCount++;

        if (questionCount >= maxQuestionsPerStage && currentStage < 4) {
            currentStage++;
            questionCount = 0;
            document.getElementById('stage-indicator').innerText = `Stage ${currentStage}: ${getStageName(currentStage)}`;
        }

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: getSystemInstruction() }] },
                    contents: conversationHistory,
                    generationConfig: { response_mime_type: "application/json" }
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            const aiResponseText = data.candidates[0].content.parts[0].text;
            const aiData = JSON.parse(aiResponseText);

            // Update history so AI remembers its own questions
            conversationHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

            if (aiData.stage_summary) {
                addSystemMessage(`Stage Update: ${aiData.stage_summary}`);
            }

            if (aiData.is_test_complete) {
                endTestAndShowReport(aiData.final_report_html);
            } else {
                addMessage(aiData.bot_reply, 'bot');
                console.log("Dhwani Internal Notes:", aiData.internal_analysis); // For debugging/admin
            }

        } catch (error) {
            console.error("API Error:", error);
            addSystemMessage("Connection error with AI. Please check your API key and try again.");
        } finally {
            inputField.disabled = false;
            sendBtn.disabled = false;
            document.getElementById('loading').style.display = 'none';
            inputField.focus();
        }
    }

    function getStageName(stage) {
        if(stage===1) return "Exploration";
        if(stage===2) return "Interest Alignment";
        if(stage===3) return "Aptitude Verification";
        if(stage===4) return "Specialization";
    }

    function addMessage(text, sender) {
        const chatHistory = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}-msg`;
        msgDiv.innerText = text;
        chatHistory.appendChild(msgDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function addSystemMessage(text) {
        const chatHistory = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `system-msg`;
        msgDiv.innerText = text;
        chatHistory.appendChild(msgDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function handleEnter(event) {
        if (event.key === 'Enter') processUserAnswer();
    }

    function forceEndTest() {
        if (confirm("Are you sure you want to end the test early? No report will be generated.")) {
            stopCamera();
            location.reload();
        }
    }

    function stopCamera() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById('webcam').srcObject.getTracks().forEach(track => track.stop());
        }
    }

    function endTestAndShowReport(htmlReport) {
        stopCamera();
        
        // Handle Video Download
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${childData.name}_Aptitude_Session.webm`;
        a.click();
        
        document.getElementById('test-screen').style.display = 'none';
        document.getElementById('report-screen').style.display = 'block';
        document.getElementById('report-name-age').innerText = `Student: ${childData.name} | Age: ${childData.age}`;
        document.getElementById('report-body').innerHTML = htmlReport;
    }
</script>
</body>
</html>