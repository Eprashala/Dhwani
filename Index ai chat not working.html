<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Eprashala LMS </title>

  <!-- External libs (kept as CDN to avoid huge single-file size) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script src="data.js"></script>
  

  <style>
/* ==== css/style.css ==== */
:root { --primary-color: #FF9800; --text-dark: #333; --bg-light: #f4f4f9; }
html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-light); display: flex; flex-direction: column; user-select: none; -webkit-tap-highlight-color: transparent; }

/* Top Bar - Compact for Large Screens */
.top-bar { 
    background-color: var(--primary-color); 
    padding: 0 10px; /* Reduced padding */
    display: flex; 
    align-items: center; 
    gap: 8px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.15); 
    z-index: 100; 
    height: 48px; /* Reduced from 65px */
    min-height: 48px; 
    width: 100%; 
    box-sizing: border-box; 
    overflow-x: auto; 
    white-space: nowrap; 
}
.top-bar::-webkit-scrollbar { display: none; }

.logo { font-size: 18px; font-weight: bold; color: white; margin-right: 5px; flex-shrink: 0; }

.nav-btn-group { display: flex; gap: 5px; flex-shrink: 0; }

/* Main Top Buttons - Compact */
.top-btn { 
    background: rgba(255, 255, 255, 0.2); 
    border: 1px solid rgba(255, 255, 255, 0.5); 
    color: white; 
    border-radius: 50%; 
    width: 34px; /* Reduced from 48px */
    height: 34px; 
    font-size: 18px; /* Reduced icon size */
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: 0.2s; 
    padding: 0; 
    line-height: 1; 
    flex-shrink: 0; 
    position: relative; 
}
.top-btn:active { transform: scale(0.95); }
.top-btn:hover { background: white; color: var(--primary-color); }
.top-btn.close-app-btn { background: #d32f2f; border-color: #b71c1c; margin-left: auto; font-size: 18px; }
.top-btn.fav-active { background: white; color: red; border-color: white; box-shadow: 0 0 5px rgba(255, 0, 0, 0.5); }

.progress-btn { border: 2px solid rgba(255,255,255,0.8); }
.progress-btn.state-0 { background: rgba(255,255,255,0.2); color: white; } 
.progress-btn.state-1 { background: #ff5252; color: white; border-color: white; box-shadow: 0 0 5px #ff5252; } 
.progress-btn.state-2 { background: #ffeb3b; color: #333; border-color: white; box-shadow: 0 0 5px #ffeb3b; } 
.progress-btn.state-3 { background: #4caf50; color: white; border-color: white; box-shadow: 0 0 5px #4caf50; } 

.search-container { flex-grow: 0; width: 150px; margin: 0 5px; flex-shrink: 0; }
#searchInput { width: 100%; padding: 6px 12px; border-radius: 30px; border: none; font-size: 14px; outline: none; }

/* Workspace */
.workspace-container { display: flex; flex: 1; height: calc(100vh - 48px); position: relative; overflow: hidden; width: 100%; }

/* Resizers */
.resizer { width: 10px; background: #e0e0e0; cursor: col-resize; z-index: 70; display: flex; align-items: center; justify-content: center; touch-action: none; flex-shrink: 0; }
.resizer::after { content: '|'; color: #888; font-weight: bold; font-size: 10px; }

/* Text Input */
#tempTextInput { position: absolute; display: none; background: rgba(255, 255, 255, 0.95); border: 2px dashed #FF9800; outline: none; padding: 5px; z-index: 5000; min-width: 150px; font-size: 18px; }

/* Video Player Controls (Compact) */
#videoControlsGroup { display: none; align-items: center; gap: 4px; background: rgba(0, 0, 0, 0.25); padding: 3px 8px; border-radius: 30px; margin-left:5px; flex-shrink: 0; }
.vid-btn { 
    background: white; 
    color: var(--primary-color); 
    border: none; 
    border-radius: 4px; 
    padding: 0; 
    height: 28px; /* Reduced from 36px */
    width: 28px; 
    font-weight:bold; 
    cursor:pointer; 
    font-size:14px; 
    display: flex; 
    align-items: center; 
    justify-content: center;
}
.vid-btn.stop { background: #d32f2f; color: white; }
.vid-select { height: 28px; border-radius: 4px; border:none; padding: 0 5px; cursor: pointer; font-weight: bold; font-size: 12px; background: white; color: #333;}
input[type=range].vol-slider { width: 60px; cursor: pointer; height: 5px; }

/* Modals */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 15px; width: 500px; max-width: 90%; position: relative; color: #333; max-height: 90vh; overflow-y: auto; }
.btn-submit { background: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 15px; font-weight: bold; }
.form-group { margin-bottom: 12px; } .form-group label { display: block; margin-bottom: 3px; font-weight: bold; font-size: 14px;} .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 14px; }

/* Login Screen */
#loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #FF9800, #F57C00); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
.login-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 800px; margin-top: 30px; overflow-y: auto; max-height: 70vh; width:100%;}
.teacher-card { background: white; color: #333; width: 180px; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: transform 0.2s; flex-shrink: 0; margin-bottom:10px; }
.teacher-card:hover { transform: scale(1.05); }
.teacher-avatar { width: 90px; height: 90px; border-radius: 50%; background: #ddd; margin: 0 auto 10px; overflow: hidden;}
.teacher-avatar img { width: 100%; height: 100%; object-fit: cover; }
.admin-btn { position: absolute; top: 20px; left: 20px; background: transparent; border: 1px solid white; color: white; padding: 8px 18px; cursor: pointer; border-radius: 20px; font-size: 16px; }

/* STACKING FIXES */
#teacherProfileModal, #licenseViewModal, #passwordModal, #imgInstructionModal { z-index: 11000 !important; background: rgba(0,0,0,0.6); }

/* ==== css/board.css ==== */
/* Left Panel (Board) */
.left-panel { width: 0; background: #212121; display: flex; flex-direction: column; border-right: 1px solid #ccc; position: relative; z-index: 60; transition: width 0.3s ease; min-width: 0; overflow: visible; }

/* UI Components */
.left-toggle-container { position: absolute; right: -25px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 3px; z-index: 200; transition: right 0.3s ease; }
.left-toggle-container.docked-inside { right: 0px !important; }
.left-toggle-btn { background: #4CAF50; color: white; border: none; width: 25px; height: 40px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; border-radius: 0 8px 8px 0; box-shadow: 2px 0 4px rgba(0,0,0,0.2); transition: background 0.2s; }
.docked-inside .left-toggle-btn { border-radius: 8px 0 0 8px; box-shadow: -2px 0 4px rgba(0,0,0,0.2); }
.left-toggle-btn:hover { background: #388E3C; }

/* Hide toolbar by default so it doesn't bleed out when width is 0 */
.panel-header { 
    display: none; 
    padding: 3px 5px; 
    background: #eee; 
    align-items: center; 
    border-bottom: 1px solid #ccc; 
    height: 40px; 
    flex-shrink: 0; 
    overflow-x: visible; 
    white-space: nowrap; 
}

/* Only display the toolbar when the panel is active (open) */
.left-panel.active .panel-header {
    display: flex;
}


.tool-btn-style { border: 1px solid #ccc; background: white; border-radius: 3px; padding: 0; cursor: pointer; font-size: 16px; margin: 0 2px; min-width: 30px; height: 30px; display:flex; align-items:center; justify-content:center; flex-shrink: 0; }
.tool-btn-style:hover { background: #ddd; }
.tool-btn-style.active { background: #4CAF50; color: white; border-color: #388E3C; }
.tool-btn-style.undo-redo { background: #FF9800; color: white; border-color: #F57C00; }
.tool-btn-style.share-btn { color: #2196F3; border-color: #2196F3; }

/* Magic Pen Active State */
.tool-btn-style.magic-active {
    background: #E91E63;
    color: white;
    border-color: #C2185B;
    animation: magicPulse 1.5s infinite;
}
@keyframes magicPulse {
    0% { box-shadow: 0 0 0 0 rgba(233, 30, 99, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(233, 30, 99, 0); }
    100% { box-shadow: 0 0 0 0 rgba(233, 30, 99, 0); }
}

/* Generic Popup Menus (Geo, Size, Color) */
.geo-dropdown-menu, .popup-menu { display: none; position: absolute; top: 35px; left: 0; background: white; border: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 5000; border-radius: 4px; padding: 5px 0; min-width: 140px; }
.geo-dropdown-menu.show, .popup-menu.show { display: block; }

/* Menu Items (Geo & Size) */
.geo-item, .menu-item { padding: 8px 15px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 8px; justify-content: space-between; }
.geo-item:hover, .menu-item:hover { background: #f0f0f0; }

/* Color Grid Specifics */
.popup-menu.color-grid {
    width: 130px; 
    padding: 8px;
    display: none; 
    flex-wrap: wrap;
    gap: 5px;
}
.popup-menu.color-grid.show {
    display: flex; 
}
.color-swatch {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    border: 2px solid transparent;
}

.color-swatch:hover { transform: scale(1.1); }
.color-swatch.active-color { border-color: #333; }

.page-counter { font-family: monospace; font-weight: bold; font-size: 14px; background: #fff; padding: 0 6px; border-radius: 3px; border: 1px solid #ccc; white-space: nowrap; margin: 0 2px; display:inline-block; vertical-align:middle; line-height:28px;}
.divider { width: 1px; height: 20px; background: #ccc; margin: 0 4px; display:inline-block; vertical-align:middle; flex-shrink: 0;}

/* Canvas & Layers */
.board-container { flex: 1; position: relative; overflow: hidden; width: 100%; height: 100%; background-color: #212121; }
#boardScaleWrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform-origin: 0 0; transition: transform 0.1s ease-out; }
#boardCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; touch-action: none; z-index: 10; }
#objectLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; overflow: hidden; }
.smart-object-wrapper { position: absolute; pointer-events: auto; box-sizing: border-box; touch-action: none; transform-origin: center; user-select: none;}
.smart-object-wrapper img, .smart-object-wrapper svg { width: 100%; height: 100%; display: block; object-fit: contain; pointer-events: none; user-select: none; }
.smart-object-wrapper.selected { filter: drop-shadow(0 0 5px rgba(255,152,0,0.8)); cursor: move; }
.geo-tool-svg text { font-family: 'Arial', sans-serif; font-weight: 500; }
.geo-tool-svg line { vector-effect: non-scaling-stroke; }
.tool-close-btn { position: absolute; top: -10px; right: -10px; width: 22px; height: 22px; background: #F44336; border: 2px solid white; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; font-size: 12px; z-index: 50; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.tool-close-btn:hover { background: #D32F2F; transform: scale(1.1); }
.rotate-handle { width: 24px; height: 24px; background: #2196F3; border: 2px solid white; border-radius: 50%; color: white; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); display: none; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; z-index: 40; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.smart-object-wrapper.selected .rotate-handle { display: flex; }
.compass-arm { transition: transform 0.1s; transform-origin: 15px 15px; } 

#annotationToolbar { position: fixed; top: 5px; left: 50%; transform: translateX(-50%); background: white; padding: 3px 15px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: none; align-items: center; gap: 5px; z-index: 3000; height: 42px; border: 2px solid var(--primary-color); white-space: nowrap; }
#overlayCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; pointer-events: none; }

.stick-btn {
    position: absolute;
    top: -10px;
    left: -10px;
    width: 22px;
    height: 22px;
    background: #4CAF50; /* Green */
    border: 2px solid white;
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
    z-index: 50;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.stick-btn:hover { background: #388E3C; transform: scale(1.1); }

.resize-handle-corn {
    position: absolute;
    bottom: -5px;
    right: -5px;
    width: 15px;
    height: 15px;
    background: #2196F3;
    border: 2px solid white;
    cursor: nwse-resize;
    z-index: 51;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* NEW: Compass Controls */
.compass-nav {
    position: absolute;
    top: -25px; /* Above the handle */
    left: 20px;
    display: flex;
    align-items: center;
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    padding: 2px 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 55;
    border: 1px solid #ccc;
}
.compass-btn {
    width: 20px;
    height: 20px;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 50%;
    font-weight: bold;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 3px;
}
.compass-btn:hover { background: #1976D2; }
.compass-val {
    font-family: monospace;
    font-size: 11px;
    font-weight: bold;
    color: #333;
    min-width: 45px;
    text-align: center;
}
/* ==== FINAL UI FIXES ==== */

/* 1. By default, HIDE the left panel header so it doesn't show when width is 0 */
.left-panel .panel-header {
    display: none !important; 
}

/* 2. When the panel is ACTIVE (Open), show it as Flex and allow Dropdowns (overflow) */
.left-panel.active .panel-header {
    display: flex !important;
    overflow: visible !important; 
}

/* 3. Keep the right panel header scrollable (for PDF tools) */
.right-panel .panel-header {
    overflow-x: auto !important;
}
/* ==== css/viewer.css ==== */
/* Center Panel */
.center-panel { flex: 1; position: relative; overflow: hidden; background: #f4f4f9; display: flex; flex-direction: column; min-width: 0; z-index: 10; }
.content-area { flex: 1; padding: 15px; overflow-y: auto; -webkit-overflow-scrolling: touch; height: 100%; box-sizing: border-box; }

/* Right Panel Main Container */
.right-panel { 
    width: 0; 
    background: white; 
    display: flex; 
    flex-direction: column; 
    border-left: 1px solid #ccc; 
    position: relative; 
    z-index: 60; 
    transition: width 0.3s ease; 
    min-width: 0; 
    overflow: visible !important; 
}

/* Compact Right Handle */
.right-toggle-container {
    position: absolute; 
    left: -25px; /* Adjusted for smaller handle */
    top: 50%; 
    transform: translateY(-50%);
    display: flex; 
    flex-direction: column; 
    gap: 3px; 
    z-index: 2000 !important; 
    transition: left 0.3s ease;
    pointer-events: auto;
}
.right-toggle-container.docked-inside { left: 0px !important; }

.right-toggle-btn {
    background: #FF9800; 
    color: white; 
    border: none; 
    width: 25px; /* Slimmer */
    height: 40px; /* Shorter */
    cursor: pointer; 
    font-size: 16px; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    border-radius: 8px 0 0 8px; /* Rounded on left side */
    box-shadow: -2px 0 4px rgba(0,0,0,0.2);
    transition: background 0.2s;
}
.docked-inside .right-toggle-btn { border-radius: 0 8px 8px 0; box-shadow: 2px 0 4px rgba(0,0,0,0.2); }
.right-toggle-btn:hover { background: #F57C00; }

/* Viewer Scrolling Area */
.viewer-container { flex: 1; position: relative; overflow: hidden; background: #525659; display: flex; flex-direction: column; height: 100%; }
/* Optimized Viewer Layout */
#pdf-scroll-container {
    flex: 1;
    width: 100%;
    height: 100%;
    overflow: auto; /* Required for the scrollbar to appear */
    display: block; /* Change from flex to block for better docx compatibility */
    background: #525659;
}

#pdf-wrapper {
    position: relative;
    margin: 20px auto;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    display: inline-block; /* Crucial: Shrink-wraps to content size */
    min-width: 100%;
}
#pdfOverlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 10; /* Sits above content */
    pointer-events: auto; /* Controlled by the "Hand" tool logic */
}

#universal-html-layer {
    position: relative;
    z-index: 5; /* Sits below canvas */
    width: 100%;
}
/* Specific fix for the Excel table container */
.excel-wrapper {
    width: 100%;
    overflow: auto;
    padding: 20px;
    background: white;
}

.excel-table {
    border-collapse: collapse;
    width: 100%; /* Forces table to use full width */
    font-size: 14px;
}

.excel-table td, .excel-table th {
    border: 1px solid #ccc;
    padding: 5px;
}
#docViewer {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1; /* ‡§Æ‡§ú‡§ï‡•Ç‡§∞ ‡§Æ‡§æ‡§ó‡•á */
}
#docViewer pre { white-space: pre-wrap; word-wrap: break-word; font-family: monospace; padding: 10px; }

/* Video Player Area (Unchanged but ensures z-index) */
#videoPlayerArea { display: none; flex-direction: column; width: 100%; height: 100%; background: black; position: absolute; top: 0; left: 0; z-index: 50; }
video { width: 100%; height: 100%; object-fit: contain; }
#gestureLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 55; cursor: pointer; }
.video-feedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 50px; font-weight: bold; opacity: 0; pointer-events: none; z-index: 65; transition: opacity 0.3s; }

/* Grid / Cards (Existing styles, no change needed for sizing usually) */
.grid { display: grid; gap: 15px; padding-bottom: 50px; }
.grid.view-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
.grid.view-grid .card { height: 140px; flex-direction: column; text-align: center; }
.grid.view-grid .card-icon { font-size: 45px; margin-bottom: 10px; }
.grid.view-list { grid-template-columns: 1fr; gap: 10px; }
.grid.view-list .card { height: 60px; flex-direction: row; padding: 0 20px; justify-content: flex-start; text-align: left; }
.grid.view-list .card-icon { font-size: 30px; margin-bottom: 0; margin-right: 20px; }
.grid.view-details { grid-template-columns: 1fr; gap: 5px; }
.grid.view-details .card { height: 40px; flex-direction: row; padding: 0 15px; justify-content: flex-start; border-radius: 5px; }
.grid.view-details .card-icon { font-size: 20px; margin-right: 15px; margin-bottom: 0;}
.grid.view-normal { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
.grid.view-normal .card { height: 180px; flex-direction: column; }
.grid.view-normal .card-icon { font-size: 60px; }
.card { background: white; border-radius: 15px; padding: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid #eee; text-align: center; display: flex; align-items: center; justify-content: center; transition: all 0.2s; position: relative;}
.card:hover { transform: translateY(-3px); border-color: var(--primary-color); }
.card.active-chapter { border: 2px solid #4CAF50; background: #e8f5e9; } 
.card-fav-btn { position: absolute; top: 8px; right: 8px; font-size: 20px; cursor: pointer; color: #ccc; z-index: 5; transition: transform 0.2s; }
.card-fav-btn:hover { transform: scale(1.2); }
.card-fav-btn.is-fav { color: red; }
.card-status-dot { position: absolute; bottom: 8px; right: 8px; width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); z-index: 5; }
.card-status-red { background-color: #ff5252; }
.card-status-yellow { background-color: #ffeb3b; }
.card-status-green { background-color: #4caf50; }

/* =========================================
   COMPACT RIGHT PANEL TOOLBAR (No Dividers)
   ========================================= */

.panel-header {
    display: flex;
    align-items: center;
    padding: 4px 6px; 
    background: #f8f9fa;
    border-bottom: 1px solid #ccc;
    gap: 2px; /* Very tight gap between buttons */
    flex-shrink: 0;
    min-height: 34px; 
    overflow-x: auto; 
    white-space: nowrap;
}

/* Button Styles */
.tool-btn-style {
    background: transparent;
    border: 1px solid transparent;
    cursor: pointer;
    font-size: 18px; 
    padding: 3px; 
    border-radius: 3px;
    color: #444;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px; 
    height: 24px;
}

.tool-btn-style:hover {
    background: #e0e0e0;
}

.tool-btn-style.active {
    background: #e3f2fd;
    color: #1976d2;
    border-color: #bbdefb;
}

.tool-btn-style.close-panel-btn {
    font-size: 12px;
    margin-right: 2px;
    color: #666;
}

/* HIDDEN DIVIDERS */
.divider {
    display: none; /* Hides the vertical lines completely */
}

/* Compact Dropdowns */
.tool-select {
    padding: 2px 4px;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 11px;
    height: 22px;
    background: white;
    cursor: pointer;
    margin-left: 2px; /* Tiny margin since dividers are gone */
}

/* Page Indicator Text */
.page-counter {
    font-size: 11px;
    margin: 0 5px;
    font-weight: bold;
    color: #555;
    min-width: 30px;
    text-align: center;
}

/* ==== css/screen-recorder.css ==== */
/* css/screen-recorder.css */

/* The floating overlay that centers the toolbar */
.recorder-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none; /* Allows clicking through the empty space */
    z-index: 10000; /* Ensure it's above everything */
    display: flex;
    justify-content: center;
    align-items: center;
}

/* The actual white toolbar */
.recorder-toolbar {
    pointer-events: auto; /* Re-enable clicks on the buttons */
    background: white;
    padding: 10px 20px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    display: flex;
    gap: 15px;
    align-items: center;
    border: 2px solid #ff9800; /* Orange border to match theme */
}

/* Common button styles */
.rec-btn {
    border: none;
    background: #f0f0f0;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.2s;
    color: #555;
}

.rec-btn:hover { background: #e0e0e0; }

/* Specific button colors */
.rec-btn.start { color: #ff4d4d; font-size: 24px; } /* Red Dot */
.rec-btn.pause { color: #333; }
.rec-btn.mic.active { background: #e3f2fd; color: #2196f3; border: 1px solid #2196f3; }
.rec-btn.finish { background: #4caf50; color: white; } /* Green Tick */
.rec-btn.finish:hover { background: #45a049; }

/* Audio Settings Popup */
.audio-control-wrapper { position: relative; }

.audio-options-popup {
    position: absolute;
    bottom: 60px; /* Appear above the toolbar */
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 1px solid #ccc;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    width: 200px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    text-align: left;
    color: black;
    font-size: 14px;
}

.audio-options-popup label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

/* Browser Toolbar Styles inside Index.html */
.browser-controls {
    padding: 8px;
    display: flex;
    gap: 8px;
    background: #333;
    border-bottom: 1px solid #444;
}
.browser-controls input {
    flex: 1;
    padding: 6px;
    border-radius: 4px;
    border: none;
    font-size: 14px;
}
.browser-btn {
    cursor: pointer;
    padding: 5px 12px;
    border-radius: 4px;
    border: none;
    background: #555;
    color: white;
    font-size: 14px;
}
.browser-btn:hover { background: #666; }
.browser-shortcuts {
    padding: 5px;
    display: flex;
    gap: 5px;
    background: #444;
    flex-wrap: wrap; /* ‡§¨‡§ü‡§®‡•á ‡§ú‡§æ‡§∏‡•ç‡§§ ‡§ù‡§æ‡§≤‡•Ä ‡§§‡§∞ ‡§ñ‡§æ‡§≤‡•Ä ‡§Ø‡•á‡§§‡•Ä‡§≤ */
    justify-content: center;
}
.shortcut-btn {
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 12px; /* Rounded look */
    border: none;
    background: #666;
    color: white;
    font-size: 12px;
}
.shortcut-btn:hover { background: #FF9800; }
/* Minimised state ‡§∏‡§æ‡§†‡•Ä ‡§∂‡•à‡§≤‡•Ä */
.browser-minimised {
    height: 35px !important; /* ‡§´‡§ï‡•ç‡§§ ‡§π‡•á‡§°‡§∞ ‡§¶‡§ø‡§∏‡•á‡§≤ */
    width: 250px !important;
    overflow: hidden !important;
}
#pdfFrame {
    flex: 1;
    width: 100%;
    height: 100%;
    border: none;
    display: none; /* Hidden by default */
}

  </style>
</head>


<body>

  <!-- Inline components (previously loaded via fetch in app-loader.js) -->
  <div id="login-container">
<div id="loginScreen">
    <button onclick="window.close()" style="position: absolute; top: 20px; right: 20px; background: #d32f2f; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold; z-index: 10000; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">‚úñ</button>
	<button class="admin-btn" onclick="requireAdminAuth(openAdminPanel)">üîí Admin Dashboard</button>
    <div style="font-size:50px; margin-bottom:10px;">üéì Eprashala LMS</div>
    <p>Select your profile to start class</p>
    <div class="login-grid" id="teacherListDisplay"></div>
</div>
  </div>

  <div id="modals-container">
<div id="adminAuthModal" class="modal">
    <div class="modal-content" style="width:300px; text-align:center;">
        <span style="position:absolute; top:15px; right:20px; font-size:24px; cursor:pointer;" onclick="closeModals()">&times;</span>
        <h3 id="adminAuthTitle">Admin Password</h3>
        <input type="password" id="adminPassInput" style="margin-bottom:15px; padding:10px; width:60%; text-align:center; display:block; margin-left:auto; margin-right:auto;" onkeydown="if(event.key==='Enter')submitAdminAuth()">
        <button id="adminAuthBtn" class="btn-submit" onclick="submitAdminAuth()">Verify</button>
    </div>
</div>

<div id="teacherProfileModal" class="modal">
    <div class="modal-content">
        <span style="position:absolute; top:15px; right:20px; font-size:24px; cursor:pointer;" onclick="closeSubModal('teacherProfileModal')">&times;</span>
        
        <h2 id="modalTitle">Teacher Profile</h2>
        
        <div id="editSelectContainer" class="form-group" style="display:none; background:#e3f2fd; padding:10px; border-radius:5px;">
            <label>Select Teacher to Edit:</label><select id="editTeacherSelect" onchange="populateEditForm()"></select>
        </div>
        
        <div class="form-group"><label>Full Name *</label><input type="text" id="tName"></div>
        <div style="display:flex; gap:15px;"><div class="form-group" style="flex:1"><label>Standard</label><input type="text" id="tStd"></div><div class="form-group" style="flex:1"><label>Subjects</label><input type="text" id="tSub"></div></div>
        <div style="display:flex; gap:15px;"><div class="form-group" style="flex:1"><label>Email</label><input type="email" id="tEmail"></div><div class="form-group" style="flex:1"><label>Phone</label><input type="tel" id="tPhone"></div></div>
        <div class="form-group"><label>Password</label><input type="password" id="tPass"></div>
        <input type="hidden" id="tId">
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button id="btnDeleteTeacher" class="btn-submit" style="background:#d32f2f; flex:1; display:none;" onclick="deleteTeacher()">üóëÔ∏è Delete</button>
            <button class="btn-submit" style="flex:2; margin-top:0;" onclick="saveTeacherProfile()">Save Profile</button>
        </div>
    </div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content" style="width:300px; text-align:center;">
        <span style="position:absolute; top:15px; right:20px; font-size:24px; cursor:pointer;" onclick="closeModals()">&times;</span>
        <h3 id="pwdTitle">Enter Password</h3>
        <input type="password" id="loginPassInput" style="margin-bottom:15px; padding:10px; width:60%; text-align:center; display:block; margin-left:auto; margin-right:auto;" onkeydown="if(event.key==='Enter')verifyPassword()">
        <button class="btn-submit" onclick="verifyPassword()">Login</button>
    </div>
</div>

<div id="adminModal" class="modal">
    <div class="modal-content" style="width:800px; max-width:95%; max-height:90vh; overflow-y:auto;">
        <span style="position:absolute; top:15px; right:20px; font-size:24px; cursor:pointer;" onclick="closeModals()">&times;</span>
        <h2 style="border-bottom:1px solid #ddd; padding-bottom:10px;">Admin Dashboard</h2>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div style="background:#f5f5f5; padding:15px; border-radius:10px; border:1px solid #ddd;">
                    <h3 style="margin-top:0;">üìä Activity Logs</h3>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1;"><label style="font-size:12px; font-weight:bold;">Teacher:</label><select id="adminTeacherSelect" style="width:100%; padding:8px;"></select></div>
                        <div style="flex:1;"><label style="font-size:12px; font-weight:bold;">Date:</label><input type="date" id="adminDateSelect" style="width:100%; padding:8px;"></div>
                    </div>
                    <button class="btn-submit" style="margin-top:5px; background:#4CAF50;" onclick="downloadLogs()">‚¨á Download Report</button>
                </div>

                <div style="background:#fff3e0; padding:15px; border-radius:10px; border:1px solid #ffe0b2;">
                    <h3 style="margin-top:0; color:#E65100;">üîë License Info</h3>
                    <p style="font-size:13px; color:#555; margin-bottom:10px;">View Client Key, Registration Key & Validity.</p>
                    <button class="btn-submit" style="background:#FF9800; font-size:14px;" onclick="showAdminLicenseInfo()">üìÑ View License Details</button>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:20px;">
                <div style="background:#e3f2fd; padding:15px; border-radius:10px; border:1px solid #90caf9;">
                    <h3 style="margin-top:0; color:#1565C0;">üë• Manage Teachers</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-submit" style="margin-top:5px; background:#1976D2; font-size:14px; flex:1;" onclick="openTeacherModal('create')">‚ûï Add New</button>
                        <button class="btn-submit" style="margin-top:5px; background:#42a5f5; font-size:14px; flex:1;" onclick="openTeacherModal('edit')">‚úèÔ∏è Edit</button>
                    </div>
                </div>

                <div style="background:#e8f5e9; padding:15px; border-radius:10px; border:1px solid #c8e6c9;">
                    <h3 style="margin-top:0; color:#2E7D32;">üìÇ Content Source</h3>
                    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Set Root Directory (Local Drive):</label>
                    <div id="currentRootDisplay" style="font-size:12px; color:#555; margin-bottom:10px; font-style:italic;">Current: Default (data.js)</div>
                    <input type="file" id="adminFolderInput" webkitdirectory directory multiple style="display:none" onchange="handleAdminFolderSelect(this)">
                    <button class="btn-submit" style="background:#388E3C; font-size:14px;" onclick="document.getElementById('adminFolderInput').click()">üìÅ Browse & Load Folder</button>
                    <p style="font-size:11px; margin-top:5px; color:#666;">*Select the main folder containing your videos/PDFs.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="licenseViewModal" class="modal">
    <div class="modal-content" style="width:500px;">
        <span style="position:absolute; top:15px; right:20px; font-size:24px; cursor:pointer;" onclick="document.getElementById('licenseViewModal').style.display='none'">&times;</span>
        <h2>System License</h2>
        <div id="licDetailContent" style="background:#333; color:#0f0; padding:15px; border-radius:5px; font-family:monospace; white-space:pre-wrap; word-break:break-all; margin-bottom:15px; max-height:300px; overflow-y:auto; font-size:14px; line-height:1.4;">Loading...</div>
        <button class="btn-submit" onclick="copyLicenseInfo()">üìã Copy All Information</button>
    </div>
</div>
<div id="imgInstructionModal" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <h3 style="margin-top:0">Image Placement</h3>
        <p>Click once to set Top-Left corner, then Drag or Click again to set size.</p>
        <div style="margin: 20px 0; text-align: left; background: #eee; padding: 10px; border-radius: 5px;">
            <label style="cursor:pointer; display: flex; align-items: center; width: 100%;">
                <input type="checkbox" id="dontShowImgInst" style="width: 20px; height: 20px; margin-right: 10px;"> 
                <span style="font-weight:bold;">Do not show this again</span>
            </label>
        </div>
        <button class="btn-submit" onclick="closeImgInstruction()">Got it</button>
    </div>
</div>
  </div>

  <div id="top-bar-container">
<div class="top-bar">
    <div class="logo">üéì Eprashala</div>
    <div class="nav-btn-group">
        <button class="top-btn" onclick="goBack()">‚¨Ö</button>
        <button class="top-btn" onclick="goHome()" title="Go to Root Folder">üè†</button>
        <button class="top-btn" onclick="goForward()">‚û°</button>
		
        <button class="top-btn" onclick="openSearchWidget()" title="Search & AI">üîç</button>
        <button class="top-btn open-file-btn" onclick="triggerFilePicker()" title="Open File (PDF, Video, Txt, Img)">üìÇ</button>
        
        <button class="top-btn annotate-btn" onclick="toggleOverlayMode()" title="Screen Annotate">‚úèÔ∏è</button>
		<button class="top-btn" onclick="openRecorderToolbar()" title="Screen Recorder">üî¥</button> 
        <button class="top-btn" onclick="cycleViewMode()" title="Change View">üëÅ</button>
        <button class="top-btn" id="favFilterBtn" onclick="toggleFavFilter()" title="Show Favorites Only">‚ô°</button>
        <button class="top-btn progress-btn state-0" id="progressFilterBtn" onclick="cycleProgressFilter()" title="Lesson Progress Filter">‚óè</button>
    </div>
   
    	
    <div id="videoControlsGroup">
        <button class="vid-btn" onclick="controlVideo('play')">‚ñ∂</button>
        <button class="vid-btn" onclick="controlVideo('pause')">‚è∏</button>
        <button class="vid-btn stop" onclick="controlVideo('stop')">‚èπ</button>
        <button class="vid-btn" onclick="controlVideo('fullscreen')" title="Fullscreen">‚õ∂</button>
        <span style="color:white; font-size:12px; margin-left:10px">üîä</span>
        <input type="range" class="vol-slider" min="0" max="1" step="0.1" value="1" oninput="adjustVolume(this.value)">
        <span style="color:white; font-size:12px; margin-left:10px">‚ö°</span>
        <input type="range" class="vol-slider" id="speedSlider" min="0.25" max="2.0" step="0.25" value="1" oninput="changeSpeed(this.value)">
        <span id="speedDisplay" style="color:white; font-size:12px; font-weight:bold; min-width:35px; margin-left:2px;">1.0x</span>
    </div>
    <div style="flex-grow:1"></div>
    
	<div class="nav-btn-group">

	<button class="top-btn" onclick="openGraph()" title="2D Graph Plotter" style="background: #00BCD4; color: white; border: 2px solid white;">üìà</button>
    <button class="top-btn" onclick="openTimer()" title="Class Timer" style="background: #FF5722; color: white; border: 2px solid white;">‚è±Ô∏è</button>
<button class="top-btn" onclick="openPrompter()" title="Teleprompter" style="background: #607D8B; color: white; border: 2px solid white;">üìú</button>
		<button class="top-btn" onclick="openMirrorBrowser()" title="Mirror Mobile Screen" style="background: #2196F3; color: white; border: 2px solid white;">üì±</button>
</div>
	<button class="top-btn" onclick="openDictationTool()" title="Voice Dictation"  background: #4CAF50; color: white; border: 2px solid white; width: auto; padding: 0 10px; border-radius: 20px; font-weight: bold; font-size: 14px;">
    üé§ 
</button>
	<button class="top-btn" onclick="openCalculator()" title="LMS Calculator" style="background: #673AB7; color: white; border: 2px solid white;">üßÆ</button>
	<button class="top-btn" onclick="openWebBrowser()" title="Eprashala Browser">üåê</button>
<button class="top-btn" onclick="openQAHandler()" title="Q&A and Exams"  background: #E91E63; color: white; border: 2px solid white; width: auto; padding: 0 10px; border-radius: 20px; font-weight: bold; font-size: 14px;">
    ‚úç 
</button>

<button class="top-btn" onclick="launchDhwaniSnip()" title="Dhwani Snip (Vision AI)" 
        style="background: #673AB7; color: white; border: 2px solid white; width: auto; padding: 0 10px; border-radius: 20px; font-weight: bold; font-size: 14px; gap: 5px;">
    üì∏AI
</button>
    <button class="top-btn" onclick="toggleDhwaniWidget()" title="Ask Dhwani AI"  background: white; color: #FF9800; border: 2px solid white; width: auto; padding: 0 10px; border-radius: 20px; font-weight: bold; font-size: 14px; gap: 5px;">
    ü§ñ 
</button>

    <div style="color:white; font-weight:bold; margin-right:10px; flex-shrink:0; cursor:pointer; text-decoration: underline;" id="loggedInUserDisplay" onclick="editCurrentUser()"></div>
    <button class="top-btn close-app-btn" onclick="logout()">‚úñ</button>
</div>

<input type="file" id="localFilePicker" accept=".pdf,.mp4,.webm,.ogg,.txt,.html,.htm,.jpg,.jpeg,.png,.gif,.webp,.docx,.enc,.xls,.xlsx,.csv" style="display:none" onchange="handleLocalFileSelect(this)">
  </div>

  <div id="annotation-toolbar-container">
<div id="annotationToolbar">
    <b>Screen: </b>
    <button class="tool-btn-style undo-redo" onclick="performUndo('overlay')" title="Undo">‚Ü∂</button>
    <button class="tool-btn-style undo-redo" onclick="performRedo('overlay')" title="Redo">‚Ü∑</button>
    <div class="divider"></div>
    <button class="tool-btn-style active" id="btnPenOverlay" onclick="setTool('pen','overlay')">üñä</button>
    <button class="tool-btn-style" id="btnHighOverlay" onclick="setTool('highlighter','overlay')">üñç</button>
    <button class="tool-btn-style" id="btnTextOverlay" onclick="setTool('text','overlay')">‚å®Ô∏è</button>
    <button class="tool-btn-style" id="btnEraserOverlay" onclick="setTool('eraser','overlay')">üßº</button>
    <select class="tool-select" id="overlaySizeSel" onchange="updateContextSettings('overlay', 'size', this.value)">
        <option value="2">Thin</option><option value="4" selected>Normal</option><option value="8">Thick</option><option value="15">Marker</option>
    </select>
    <select class="tool-select" id="overlayColorSel" onchange="updateContextSettings('overlay', 'color', this.value)">
        <option value="red" selected>Red</option><option value="blue">Blue</option><option value="#00e676">Green</option><option value="black">Black</option><option value="white">White</option>
    </select>
    <div class="divider"></div>
    <button class="tool-btn-style share-btn" onclick="captureZone('body')" title="Share Screen">üì∏</button>
    <button class="tool-btn-style" style="color:red" onclick="clearCanvas('overlayCanvas')" title="Clear All">üóëÔ∏è</button>
    
    <button class="tool-btn-style" style="background:#4CAF50; color:white" onclick="finishAnnotation()">Done</button>
</div>
  </div>

  <!-- Hidden pickers used by the app -->
  
  <input type="file" id="resourceImagePicker" accept="image/*" style="display:none" onchange="handleResourceImage(this)">
  <input type="text" id="tempTextInput" placeholder="Type..." onkeydown="handleTextEnter(event)" onblur="finalizeText()">

  <div class="workspace-container" id="mainWorkspace">
    <canvas id="overlayCanvas"></canvas>

    <div class="left-panel" id="leftPanel">
<div class="left-toggle-container"></div>
            
<div class="panel-header">
    <button class="tool-btn-style" onclick="cycleBoardColor()" title="Board Bg">üé®</button>
    <div class="divider"></div>
    <button class="tool-btn-style" onclick="changeBoardZoom(0.1)" title="Zoom In">‚ûï</button>
    <button class="tool-btn-style" onclick="changeBoardZoom(-0.1)" title="Zoom Out">‚ûñ</button>
    <div class="divider"></div>
    <button class="tool-btn-style active" id="bPen" onclick="setTool('pen','board')">üñä</button>
    <button class="tool-btn-style" id="bHigh" onclick="setTool('highlighter','board')">üñç</button>
    <button class="tool-btn-style" id="bText" onclick="setTool('text','board')">‚å®Ô∏è</button>
    <button class="tool-btn-style" id="bEraser" onclick="setTool('eraser','board')">üßº</button>
    <button class="tool-btn-style" id="bImage" onclick="triggerResourcePicker()" title="Insert Image">üñºÔ∏è</button>
    
    <div style="position: relative; display: inline-block;">
        <button class="tool-btn-style" id="bGeo" onclick="togglePopup('geoDropdown')" title="Geometry Box">üìê</button>
        <div id="geoDropdown" class="geo-dropdown-menu">
            <div class="geo-item" onclick="activateMagicPen()" style="border-bottom:1px solid #eee; color:#E91E63; font-weight:bold;">‚ú® Auto-Shape Pen</div>
            <div class="geo-item" onclick="addGeoTool('ruler')">üìè 15cm Ruler (cm/in)</div>
            <div class="geo-item" onclick="addGeoTool('protractor')">‚è± Protractor (360¬∞)</div>
            <div class="geo-item" onclick="addGeoTool('triangle45')">üìê Set Square (45¬∞)</div>
            <div class="geo-item" onclick="addGeoTool('triangle60')">üìê Set Square (60¬∞)</div>
            <div class="geo-item" onclick="addGeoTool('compass')">‚≠ï Compass (Draw)</div>
            <div class="geo-item" onclick="addGeoTool('divider')">‚úÇÔ∏è Divider</div>
        </div>
    </div>

    <div class="divider"></div>

    <div style="position: relative; display: inline-block;">
        <button class="tool-btn-style" id="bSize" onclick="togglePopup('sizeDropdown')" title="Pen Size">
            <div id="currentSizeIndicator" style="width: 6px; height: 6px; background: #555; border-radius: 50%;"></div>
        </button>
        <div id="sizeDropdown" class="popup-menu">
            <div class="menu-item" onclick="updateBoardSize(2)">
                <span style="font-size:12px;">Thin</span>
                <div style="height: 2px; width: 30px; background: #555; border-radius: 1px;"></div>
            </div>
            <div class="menu-item" onclick="updateBoardSize(5)">
                <span style="font-size:12px;">Med</span>
                <div style="height: 5px; width: 30px; background: #555; border-radius: 2px;"></div>
            </div>
            <div class="menu-item" onclick="updateBoardSize(10)">
                <span style="font-size:12px;">Thick</span>
                <div style="height: 10px; width: 30px; background: #555; border-radius: 5px;"></div>
            </div>
            <div class="menu-item" onclick="updateBoardSize(20)">
                <span style="font-size:12px;">Huge</span>
                <div style="height: 16px; width: 30px; background: #555; border-radius: 8px;"></div>
            </div>
        </div>
    </div>

    <div style="position: relative; display: inline-block;">
        <button class="tool-btn-style" id="bColor" onclick="togglePopup('colorDropdown')" title="Pen Color">
            <div id="currentColorIndicator" style="width: 18px; height: 18px; background: white; border: 1px solid #ccc; border-radius: 50%;"></div>
        </button>
        <div id="colorDropdown" class="popup-menu color-grid">
            <div class="color-swatch" style="background:white; border:1px solid #ccc;" onclick="updateBoardColor('white')"></div>
            <div class="color-swatch" style="background:black" onclick="updateBoardColor('black')"></div>
            <div class="color-swatch" style="background:#F44336" onclick="updateBoardColor('#F44336')"></div>
            <div class="color-swatch" style="background:#2196F3" onclick="updateBoardColor('#2196F3')"></div>
            <div class="color-swatch" style="background:#4CAF50" onclick="updateBoardColor('#4CAF50')"></div>
            <div class="color-swatch" style="background:#FFEB3B" onclick="updateBoardColor('#FFEB3B')"></div>
            <div class="color-swatch" style="background:#9C27B0" onclick="updateBoardColor('#9C27B0')"></div>
            <div class="color-swatch" style="background:#FF9800" onclick="updateBoardColor('#FF9800')"></div>
            <div class="color-swatch" style="background:#795548" onclick="updateBoardColor('#795548')"></div>
        </div>
    </div>

    <div class="divider"></div>
    <button class="tool-btn-style undo-redo" onclick="performUndo('board')">‚Ü∂</button>
    <button class="tool-btn-style undo-redo" onclick="performRedo('board')">‚Ü∑</button>
    <div class="divider"></div>
    <button class="tool-btn-style" onclick="changeBoardPage(-1)">‚óÄ</button>
    <span id="pageIndicator" class="page-counter">1/1</span>
    <button class="tool-btn-style" onclick="changePdfPage(1)">‚ñ∂</button>
    <button class="tool-btn-style" style="color:green" onclick="addNewPage()">+</button>
    <div class="divider"></div>
    <button class="tool-btn-style share-btn" onclick="captureZone('leftPanel')">üì∏</button>
    <button class="tool-btn-style" style="color:red" onclick="clearCanvas('boardCanvas')">üóëÔ∏è</button>
</div>

<div class="board-container">
    <div id="boardScaleWrapper">
        <canvas id="boardCanvas"></canvas>
        <div id="objectLayer"></div>
    </div>
<input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
</div>
    </div>
    <div class="resizer" id="leftResizer"></div>

    <div class="center-panel" id="centerPanel">
<div class="content-area">
    <h2 id="folderTitle" style="margin-top:0; border-bottom: 2px solid #eee;">Home</h2>
    <div class="grid view-grid" id="fileGrid"></div>
</div>
<div id="videoPlayerArea">
    <div id="gestureLayer"></div>
    <div id="vidFeedback" class="video-feedback"></div>
    <video id="mainVideo"></video>
</div>
    </div>
    <div class="resizer" id="rightResizer"></div>

    <div class="right-panel" id="rightPanel">
<div class="right-toggle-container">
    </div>

<div class="panel-header">
    <button class="tool-btn-style close-panel-btn" onclick="setRightPanel(0)" title="Close Panel">‚úñ</button>
    <div class="divider"></div>
    
    <button class="tool-btn-style open-file-btn" onclick="triggerFilePicker()" title="Open Local File">üìÇ</button>
    
    <div class="divider"></div>
    <button class="tool-btn-style" onclick="changePdfZoom(0.1)" title="Zoom In">‚ûï</button>
    <button class="tool-btn-style" onclick="changePdfZoom(-0.1)" title="Zoom Out">‚ûñ</button>
    <div class="divider"></div>
    
    <button class="tool-btn-style active" id="pdfHand" onclick="setTool('hand','pdfPanel')" title="Scroll / Default Toolbar">‚úã</button>
    
    <div class="divider"></div>
    <button class="tool-btn-style undo-redo" onclick="performUndo('pdfPanel')">‚Ü∂</button>
    <button class="tool-btn-style undo-redo" onclick="performRedo('pdfPanel')">‚Ü∑</button>
    <div class="divider"></div>
    
    <button class="tool-btn-style" id="pdfPen" onclick="setTool('pen','pdfPanel')">üñä</button>
    <button class="tool-btn-style" id="pdfHigh" onclick="setTool('highlighter','pdfPanel')">üñç</button>
    <button class="tool-btn-style" id="pdfText" onclick="setTool('text','pdfPanel')">‚å®Ô∏è</button>
    <button class="tool-btn-style" id="pdfEraser" onclick="setTool('eraser','pdfPanel')">üßº</button>
    
    <select class="tool-select" onchange="updateContextSettings('pdfPanel', 'size', this.value)" style="width:50px;">
        <option value="2">Thin</option><option value="5" selected>Med</option><option value="10">Thick</option>
    </select>
    <select class="tool-select" onchange="updateContextSettings('pdfPanel', 'color', this.value)" style="width:60px;">
        <option value="red" selected>Red</option><option value="blue">Blue</option><option value="#00e676">Green</option><option value="black">Black</option>
    </select>
    
    <div class="divider"></div>
    
    <button class="tool-btn-style" onclick="changePdfPage(-1)">‚óÄ</button>
    <span id="pdfPageIndicator" class="page-counter">--/--</span>
    <button class="tool-btn-style" onclick="changePdfPage(1)">‚ñ∂</button>
    
    <div class="divider"></div>
    
    <button class="tool-btn-style share-btn" onclick="captureZone('rightPanel')">üì∏</button>
    <button class="tool-btn-style" style="color:red" onclick="clearCanvas('pdfOverlayCanvas')">üóëÔ∏è</button>
</div>

<div class="viewer-container">
    <div id="pdf-scroll-container">
        <div id="pdf-wrapper">
            <canvas id="pdfRenderCanvas"></canvas>
            <canvas id="pdfOverlayCanvas"></canvas>
        </div>
    </div>
    
    <iframe id="pdfFrame"></iframe> 
    <div id="docViewer" style="padding:20px; overflow:auto; display:none; background:white; height:100%; width:100%;"></div>
    <div id="sideVideo"></div>
</div>
    </div>
  </div>

  <!-- Minimal Screen Recorder UI (required by ScreenRecorder.js so it won't throw) -->
  <div id="recorder-overlay" style="display:none;">
    <div class="recorder-toolbar">
      <button id="rec-toggle-btn" class="rec-btn" title="Start/Pause/Resume" onclick="toggleRecordState()">‚è∫</button>
      <button id="rec-mic-btn" class="rec-btn" title="Audio settings" onclick="toggleAudioSettings()">üéô</button>
      <button id="rec-close-btn" class="rec-btn" title="Close" onclick="closeRecorder()">‚úñ</button>
    </div>

    <div id="audio-settings-popup" style="display:none;">
      <label style="display:block; margin:6px 0;">
        <input type="checkbox" id="chk-sys-sound" checked> System sound
      </label>
      <label style="display:block; margin:6px 0;">
        <input type="checkbox" id="chk-mic-sound" checked> Microphone
      </label>
    </div>
  </div>

  <script>


// ==== js/state.js ====
let currentUser=null;
let currentSession={start:null,activities:[]};
let activeActivity=null;
let currentFolder=null;
let historyStack=[], forwardStack=[];
let isFavoritesFilterActive = false;
let currentProgressFilter = 0;
let currentVideoPath = null; 
let leftPanelState = 0; 
let currentBoardScale = 1.0;
let boardPages=[{history:[],step:-1, objects: []}];
let currentPageIndex=0; 
let pdfPages=[{history:[],step:-1}];
let currentPdfPageIndex=0;
let pdfDoc = null;
let currentPdfScale = 1.0; 
const VIEW_MODES = ['view-grid', 'view-list', 'view-details', 'view-normal']; 
let currentViewModeIndex = 0;
let contexts={
    overlay:{color:'red',size:4,tool:'pen',history:[],step:-1,id:'overlayCanvas'},
    board:{color:'white',size:5,tool:'pen',id:'boardCanvas',bg:'#212121'},
    pdfPanel:{color:'red',size:5,tool:'hand',id:'pdfOverlayCanvas'}
};
let isDrawing=false, lastX=0, lastY=0, isTyping=false;
let pendingResourceImage = null, isPlacingImage = false, placementStartX = 0, placementStartY = 0;
let activeObject = null, isDraggingObj = false, isResizingObj = false, isRotatingObj = false;
let dragOffset = {x:0, y:0}, initialResize = {w:0, h:0, x:0, y:0, mx:0, my:0}, initialAngle = 0;
let rotateCenter = {x:0, y:0};
let pendingEdit = false;
let pendingT=null;
const BOARD_COLORS = [{bg:'#212121', pen:'white'}, {bg:'#2e7d32', pen:'white'}, {bg:'#ffffff', pen:'black'}]; 
let colorIdx = 0;

// ==== js/auth.js ====
// ... [DB CONSTANT & INIT - SAME AS BEFORE] ...
const DB={getTeachers:()=>JSON.parse(localStorage.getItem('eprashala_teachers')||'[]'),saveTeachers:(d)=>localStorage.setItem('eprashala_teachers',JSON.stringify(d)),getLogs:()=>JSON.parse(localStorage.getItem('eprashala_logs')||'[]'),saveLog:(l)=>{let g=DB.getLogs();g.push(l);localStorage.setItem('eprashala_logs',JSON.stringify(g))},getAdmin:()=>localStorage.getItem('eprashala_admin_pass')};
const APP_SECRET = "Eprashala_Secret_2026";
let IS_REGISTERED = false, LICENSE_CHECK_DONE = false, pendingAdminCallback = null;
// Add this at the top of your scripts
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
function initAuth() {
    renderLoginScreen();
    checkLicense();
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('click', enforceFullscreen, { capture: true });
    document.addEventListener('touchstart', enforceFullscreen, { capture: true });
}
function enforceFullscreen() { if (!currentUser) return; if (screen.orientation && screen.orientation.lock) { screen.orientation.lock('landscape-primary').catch(err => {}); } if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e => {}); } }
function renderLoginScreen(){const l=document.getElementById('teacherListDisplay'),ts=DB.getTeachers();l.innerHTML='';ts.forEach(t=>{const c=document.createElement('div');c.className='teacher-card';c.innerHTML=`<div class="teacher-avatar"><img src="https://ui-avatars.com/api/?name=${t.name}&background=random"></div><b>${t.name}</b>`;c.onclick=()=>attemptLogin(t);l.appendChild(c);});if(ts.length===0)l.innerHTML='<p style="color:white">No profiles. Click Admin Dashboard to add.</p>';}
function attemptLogin(t){ if(!LICENSE_CHECK_DONE){checkLicense();return;} if(!IS_REGISTERED){checkLicense();return;} if(t.pass){pendingT=t;document.getElementById('pwdTitle').innerText="Password for "+t.name;document.getElementById('passwordModal').style.display='flex'; setTimeout(()=>document.getElementById('loginPassInput').focus(),100);}else completeLogin(t);}
function verifyPassword(){const input=document.getElementById('loginPassInput').value; if(pendingEdit){if(input===currentUser.pass){closeModals();pendingEdit=false;openTeacherModal('edit_self');}else{alert("Wrong Password");}return;} if(pendingT&&input===pendingT.pass)completeLogin(pendingT);else alert("Wrong Password");}
function completeLogin(t){ currentUser=t; if(!currentUser.favorites) currentUser.favorites = []; if(!currentUser.progress) currentUser.progress = {}; currentSession={start:new Date().toISOString(),teacherName:t.name,activities:[]};document.getElementById('loginScreen').style.display='none';document.getElementById('loggedInUserDisplay').innerText="üë§ "+t.name; enforceFullscreen(); closeModals();}
function logout() {
    if (!currentUser) return;
    
    if (confirm("Logout?")) {
        // ‡•ß. ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§™‡•Ç‡§∞‡•ç‡§£‡§™‡§£‡•á ‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ (Stop Video Logic Added Here)
        if (typeof controlVideo === "function") {
            controlVideo('stop');
        }

        // ‡•®. ‡§ç‡§ï‡•ç‡§ü‡§ø‡§µ‡•ç‡§π‡§ø‡§ü‡•Ä ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ (‡§§‡•Å‡§Æ‡§ö‡§æ ‡§ú‡•Å‡§®‡§æ ‡§ï‡•ã‡§°)
        closeActivity();
        
        DB.saveLog({
            teacher: currentUser.name,
            date: new Date().toLocaleDateString(),
            loginTime: currentSession.start,
            logoutTime: new Date().toISOString(),
            activities: currentSession.activities
        });

        // ‡•©. ‡§Ø‡•Ç‡§ú‡§∞ ‡§°‡•á‡§ü‡§æ ‡§∞‡§ø‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ (‡§§‡•Å‡§Æ‡§ö‡§æ ‡§ú‡•Å‡§®‡§æ ‡§ï‡•ã‡§°)
        currentUser = null;
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('videoPlayerArea').style.display = 'none';
        
        // ‡§¨‡•ã‡§∞‡•ç‡§° ‡§Ü‡§£‡§ø ‡§á‡§§‡§∞ ‡§ó‡•ã‡§∑‡•ç‡§ü‡•Ä ‡§ï‡•ç‡§≤‡•Ä‡§® ‡§ï‡§∞‡§æ
        clearCanvas('boardCanvas');
        boardPages = [{history:[], step:-1, objects:[]}];
        currentPageIndex = 0;
        document.getElementById('objectLayer').innerHTML = '';
        
        // ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞‡•ç‡§∏ ‡§∞‡§ø‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ
        isFavoritesFilterActive = false;
        document.getElementById('favFilterBtn').innerHTML = '‚ô°';
        document.getElementById('favFilterBtn').classList.remove('fav-active');
        currentProgressFilter = 0;
        document.getElementById('progressFilterBtn').className = 'top-btn progress-btn state-0';
        
        // ‡§≤‡§æ‡§Ø‡§∏‡§®‡•ç‡§∏ ‡§ö‡•á‡§ï ‡§ï‡§∞‡§æ
        checkLicense();
    }
}

// --- MODAL MANAGEMENT (UPDATED) ---
function closeModals(){
    document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
    pendingT=null; pendingEdit=false;
}

// NEW: Close specific sub-modal without closing everything (Fixes Admin Dashboard closing)
function closeSubModal(id) {
    document.getElementById(id).style.display = 'none';
}

function requireAdminAuth(cb){ const pass=DB.getAdmin(); if(!pass){document.getElementById('adminAuthTitle').innerText="Set New Admin Password";document.getElementById('adminAuthBtn').innerText="Set & Continue";pendingAdminCallback=(v)=>{if(v){localStorage.setItem('eprashala_admin_pass',v);alert("Password Set!");if(cb)cb();}};} else{document.getElementById('adminAuthTitle').innerText="Enter Admin Password";document.getElementById('adminAuthBtn').innerText="Verify";pendingAdminCallback=(v)=>{if(v===pass){if(cb)cb();}else alert("Incorrect Password");};} document.getElementById('adminPassInput').value=''; document.getElementById('adminAuthModal').style.display='flex'; setTimeout(()=>document.getElementById('adminPassInput').focus(),100); }
function submitAdminAuth(){const v=document.getElementById('adminPassInput').value; if(pendingAdminCallback)pendingAdminCallback(v); document.getElementById('adminAuthModal').style.display='none';}

// --- REUSABLE UI POPULATOR ---
function populateAdminDashboard() {
    // 1. Populate Teacher Dropdown in Logs
    const s = document.getElementById('adminTeacherSelect');
    const ts = DB.getTeachers();
    s.innerHTML = '<option value="all">All</option>';
    ts.forEach(t => s.innerHTML += `<option value="${t.name}">${t.name}</option>`);
    
    // 2. Populate Teacher Dropdown in Edit Form (Refresh if open)
    const es = document.getElementById('editTeacherSelect');
    if(es) {
        es.innerHTML = '<option value="">Select</option>';
        ts.forEach(t => es.innerHTML += `<option value="${t.id}">${t.name}</option>`);
    }
}

function openAdminPanel(){
    populateAdminDashboard();
    populateRootFolderSelect(); // from previous step
    // Reset or update display status
    document.getElementById('currentRootDisplay').innerText = (window.DYNAMIC_LIBRARY_LOADED) ? "Current: Custom Loaded Folder" : "Current: Default (data.js)";
    document.getElementById('adminModal').style.display = 'flex';
}

// --- TEACHER CRUD OPERATIONS ---

function openTeacherModal(m){
    document.getElementById('teacherProfileModal').style.display='flex';
    document.getElementById('editSelectContainer').style.display=m==='edit'?'block':'none';
    
    // Clear Form
    ['tName','tStd','tSub','tEmail','tPhone','tPass','tId'].forEach(i=>document.getElementById(i).value='');
    
    const btnDel = document.getElementById('btnDeleteTeacher');
    
    if(m==='edit'){
        editMode=true;
        document.getElementById('modalTitle').innerText="Edit Profile";
        btnDel.style.display = 'block'; // SHOW DELETE
        populateAdminDashboard(); // Ensure select is fresh
    } else if(m==='edit_self'){
        editMode=true;
        document.getElementById('modalTitle').innerText="Edit My Profile";
        btnDel.style.display = 'none'; // Cannot delete self from here easily
        const t=currentUser;
        document.getElementById('tName').value=t.name;
        document.getElementById('tStd').value=t.std||'';
        document.getElementById('tSub').value=t.sub||'';
        document.getElementById('tEmail').value=t.email||'';
        document.getElementById('tPhone').value=t.phone||'';
        document.getElementById('tPass').value=t.pass||'';
        document.getElementById('tId').value=t.id;
    } else {
        editMode=false;
        document.getElementById('modalTitle').innerText="Add New";
        btnDel.style.display = 'none'; // Hide delete
    }
}

function populateEditForm(){
    const id=document.getElementById('editTeacherSelect').value;
    const t=DB.getTeachers().find(x=>x.id==id);
    if(t){
        document.getElementById('tName').value=t.name;
        document.getElementById('tStd').value=t.std||'';
        document.getElementById('tSub').value=t.sub||'';
        document.getElementById('tEmail').value=t.email||'';
        document.getElementById('tPhone').value=t.phone||'';
        document.getElementById('tPass').value=t.pass||'';
        document.getElementById('tId').value=t.id;
    }
}

function saveTeacherProfile(){
    const n=document.getElementById('tName').value;
    if(!n)return alert("Name Required");
    let ts=DB.getTeachers();
    const d={name:n,std:document.getElementById('tStd').value,sub:document.getElementById('tSub').value,email:document.getElementById('tEmail').value,phone:document.getElementById('tPhone').value,pass:document.getElementById('tPass').value, favorites: [], progress: {}};
    
    if(editMode){
        const id=document.getElementById('tId').value;
        const i=ts.findIndex(x=>x.id==id);
        if(i!==-1) ts[i]={...ts[i],...d, favorites: ts[i].favorites || [], progress: ts[i].progress || {}};
    } else {
        d.id=Date.now();
        ts.push(d);
    }
    DB.saveTeachers(ts);
    
    // UX Update: Only close profile, keep admin open
    closeSubModal('teacherProfileModal'); 
    
    // Refresh background and admin UI
    renderLoginScreen();
    populateAdminDashboard(); 
}

// NEW: Delete Teacher Function
function deleteTeacher() {
    const id = document.getElementById('tId').value;
    if (!id) {
        // If they haven't selected a teacher in the dropdown yet
        alert("Please select a teacher to delete first.");
        return;
    }
    
    if(confirm("Are you sure you want to PERMANENTLY delete this teacher?")) {
        let ts = DB.getTeachers();
        ts = ts.filter(t => t.id != id);
        DB.saveTeachers(ts);
        
        alert("Teacher Deleted.");
        
        closeSubModal('teacherProfileModal');
        renderLoginScreen();
        populateAdminDashboard();
    }
}

function editCurrentUser(){if(!currentUser)return;if(currentUser.pass){pendingEdit=true;document.getElementById('pwdTitle').innerText="Verify Password to Edit";document.getElementById('passwordModal').style.display='flex';setTimeout(()=>document.getElementById('loginPassInput').focus(),100);}else{openTeacherModal('edit_self');}}

// --- FOLDER SELECTION LOGIC ---
function populateRootFolderSelect() {
    const sel = document.getElementById('adminRootFolderSelect');
    if(!sel) return; // safety
    sel.innerHTML = '';
    const savedRoot = localStorage.getItem('eprashala_root_path') || "";
    let options = [`<option value="" ${savedRoot === "" ? "selected" : ""}>üîÑ Default (Root of Data.js)</option>`];
    if (typeof LIBRARY_DATA === 'undefined') { sel.innerHTML = '<option value="">Error: data.js not loaded</option>'; return; }
    function traverse(node, depth) {
        if (node.type === 'folder') {
            const indent = "&nbsp;&nbsp;".repeat(depth);
            const isSelected = (node.path === savedRoot) ? 'selected' : '';
            const name = node.name || node.path;
            if (node.path) { options.push(`<option value="${node.path}" ${isSelected}>${indent}üìÅ ${name}</option>`); }
            if (node.children) { node.children.forEach(child => traverse(child, depth + 1)); }
        }
    }
    traverse(LIBRARY_DATA, 0);
    sel.innerHTML = options.join('');
}

function handleAdminFolderSelect(input) {
    if (input.files && input.files.length > 0) {
        if(window.processLocalFolder) {
            window.processLocalFolder(input.files);
            alert("Folder Loaded Successfully!\nThe content is now updated.");
            document.getElementById('currentRootDisplay').innerText = "Current: " + input.files[0].webkitRelativePath.split('/')[0] + "/...";
        } else {
            alert("Error: Viewer logic not loaded.");
        }
    }
}

// --- LOGS & LICENSE ---
function downloadLogs(){const t=document.getElementById('adminTeacherSelect').value,d=document.getElementById('adminDateSelect').value,ls=DB.getLogs();let x="LOGS\n====\n",f=ls.filter(l=>(t==='all'||l.teacher===t)&&(!d||l.date===new Date(d).toLocaleDateString()));f.forEach(l=>{x+=`User:${l.teacher}|${l.date}\nActivity:\n`;l.activities.forEach(a=>x+=` - ${a.time}: ${a.item} (${a.duration})\n`);x+="\n";});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([x],{type:'text/plain'}));a.download="Log.txt";a.click();}
function startActivity(n){closeActivity();activeActivity={name:n,start:Date.now()};}
function closeActivity(){if(activeActivity){const d=Math.round((Date.now()-activeActivity.start)/1000);if(d>5)currentSession.activities.push({item:activeActivity.name,time:new Date().toLocaleTimeString(),duration:d+"s"});activeActivity=null;}}

async function showAdminLicenseInfo() {
    const deviceID = await getDeviceID();
    const savedKey = localStorage.getItem('eprashala_license_key') || "Not Found";
    let validity = "Unknown";
    let status = "Inactive";
    if (savedKey !== "Not Found") {
        const res = await validateLicenseKey(deviceID, savedKey);
        status = res.valid ? "ACTIVE" : "EXPIRED / INVALID";
        validity = res.msg;
    }
    const infoText = `CLIENT KEY (Device ID):\n${deviceID}\n\nLICENSE KEY:\n${savedKey}\n\nSTATUS: ${status}\nVALIDITY: ${validity}`;
    document.getElementById('licDetailContent').innerText = infoText;
    document.getElementById('licenseViewModal').style.display = 'flex';
}
function copyLicenseInfo() { copyToClip(document.getElementById('licDetailContent').innerText); }

// --- SECURITY & HELPERS (Unchanged) ---
async function digestMessage(m){try{if(window.crypto&&window.crypto.subtle){const b=new TextEncoder().encode(m),h=await window.crypto.subtle.digest('SHA-256',b);return Array.from(new Uint8Array(h));}}catch(e){}const b=new TextEncoder().encode(m);return sha256_js(b);}
async function getDeviceID(){const c=document.createElement('canvas'),ctx=c.getContext('2d'),txt="Eprashala_LMS_Hardware_Lock_v2";ctx.textBaseline="top";ctx.font="14px 'Arial'";ctx.textBaseline="alphabetic";ctx.fillStyle="#f60";ctx.fillRect(125,1,62,20);ctx.fillStyle="#069";ctx.fillText(txt,2,15);ctx.fillStyle="rgba(102,204,0,0.7)";ctx.fillText(txt,4,17);const d=c.toDataURL(),r=d+navigator.userAgent+navigator.hardwareConcurrency+navigator.deviceMemory,h=await digestMessage(r);return h.map(b=>b.toString(16).padStart(2,'0')).join('').substring(0,12).toUpperCase();}
async function validateLicenseKey(id,k){try{const r=atob(k.trim()),p=r.split('|');if(p.length!==2)return{valid:false,msg:"Invalid Key Format"};const py=p[0],s=p[1],e=id+py+APP_SECRET,h=await digestMessage(e),es=h.map(b=>b.toString(16).padStart(2,'0')).join('').substring(0,16).toUpperCase();if(s!==es)return{valid:false,msg:"Signature Mismatch"};if(py==="PERMANENT")return{valid:true,msg:"Lifetime License Active"};else{const ed=new Date(py),t=new Date();t.setHours(0,0,0,0);ed.setHours(0,0,0,0);if(isNaN(ed.getTime()))return{valid:false,msg:"Invalid Expiry Date"};if(t>ed)return{valid:false,msg:"License Expired on "+py};return{valid:true,msg:"Valid until "+py};}}catch(e){return{valid:false,msg:"Corrupt or Empty Key"};}}
async function checkLicense(){try{const id=await getDeviceID(),k=localStorage.getItem('eprashala_license_key');if(k){const s=await validateLicenseKey(id,k);if(s.valid){IS_REGISTERED=true;LICENSE_CHECK_DONE=true;const e=document.getElementById('eprashala-lock-screen');if(e)e.remove();}else{IS_REGISTERED=false;LICENSE_CHECK_DONE=true;showRegistrationModal(id,s.msg);}}else{IS_REGISTERED=false;LICENSE_CHECK_DONE=true;showRegistrationModal(id,"New Installation");}}catch(e){IS_REGISTERED=false;LICENSE_CHECK_DONE=true;showRegistrationModal("UNKNOWN","System Context Error");}}
function showRegistrationModal(id,msg){if(document.getElementById('eprashala-lock-screen'))return;const ie=msg.toLowerCase().includes('expired'),ac=ie?'#ff4444':'#FF9800',ic=ie?'‚è≥':'üîí',ti=ie?'License Expired':'Application Locked';const m=document.createElement('div');m.id='eprashala-lock-screen';m.style=`position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center,#222 0%,#000 100%);color:white;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100000;font-family:'Segoe UI',sans-serif;`;m.innerHTML=`<div style="background:rgba(255,255,255,0.05);padding:40px;border-radius:20px;text-align:center;max-width:600px;width:90%;border:1px solid #333;box-shadow:0 20px 50px rgba(0,0,0,0.5);"><div style="font-size:80px;margin-bottom:20px;">${ic}</div><h1 style="color:${ac};margin:0 0 10px 0;text-transform:uppercase;letter-spacing:2px;">${ti}</h1><p style="font-size:18px;color:#aaa;margin-bottom:30px;">Reason: <b style="color:white;">${msg}</b></p><div style="background:#111;padding:20px;border-radius:10px;margin-bottom:20px;border:1px dashed #555;"><p style="margin:0 0 10px 0;color:#888;font-size:14px;">DEVICE IDENTIFIER</p><div style="display:flex;align-items:center;justify-content:center;gap:10px;"><code style="font-size:28px;color:#4CAF50;letter-spacing:3px;font-weight:bold;">${id}</code><button onclick="copyToClip('${id}')" style="background:transparent;border:1px solid #555;color:white;cursor:pointer;padding:5px 10px;border-radius:5px;">COPY</button></div></div><div style="display:flex;flex-direction:column;gap:10px;margin-top:20px;"><label style="text-align:left;font-weight:bold;color:#ddd;">Enter Activation Key:</label><div style="display:flex;gap:10px;"><input type="text" id="regKeyInput" placeholder="Paste license key here..." style="width:100%;padding:15px;border-radius:8px;border:none;background:#eee;color:#333;font-size:16px;text-align:center;"></div></div><button onclick="verifyAndSaveKey('${id}')" style="margin-top:25px;width:100%;padding:15px;background:${ac};border:none;border-radius:8px;color:white;font-size:18px;font-weight:bold;cursor:pointer;">ACTIVATE NOW</button></div>`;document.body.appendChild(m);}
function copyToClip(t){if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(t).then(()=>alert("Copied!")).catch(()=>fallbackCopy(t));}else{fallbackCopy(t);}}
function fallbackCopy(t){try{const a=document.createElement("textarea");a.value=t;a.style.position="fixed";a.style.left="-9999px";document.body.appendChild(a);a.focus();a.select();const s=document.execCommand('copy');document.body.removeChild(a);if(s)alert("Copied!");else prompt("Copy ID manually:",t);}catch(e){prompt("Copy ID manually:",t);}}
async function verifyAndSaveKey(id){const i=document.getElementById('regKeyInput').value.trim();if(!i){alert("Please enter a key.");return;}const s=await validateLicenseKey(id,i);if(s.valid){localStorage.setItem('eprashala_license_key',i);alert("Success! "+s.msg+"\nRestarting...");location.reload();}else{alert("Activation Failed:\n"+s.msg);}}
function sha256_js(d){function R(n,x){return(x>>>n)|(x<<(32-n))}function C(x,y,z){return(x&y)^(~x&z)}function M(x,y,z){return(x&y)^(x&z)^(y&z)}function S0(x){return R(2,x)^R(13,x)^R(22,x)}function S1(x){return R(6,x)^R(11,x)^R(25,x)}function G0(x){return R(7,x)^R(18,x)^(x>>>3)}function G1(x){return R(17,x)^R(19,x)^(x>>>10)}const K=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2],H=[0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19];const l=d.length*8,n=((d.length+8)>>6)+1,w=new Int32Array(n*16);for(let i=0;i<d.length;i++)w[i>>2]|=d[i]<<(24-(i%4)*8);w[d.length>>2]|=0x80<<(24-(d.length%4)*8);w[n*16-1]=l;w[n*16-2]=(l/0x100000000)|0;for(let i=0;i<n;i++){const W=new Int32Array(64);for(let t=0;t<16;t++)W[t]=w[i*16+t];for(let t=16;t<64;t++)W[t]=(G1(W[t-2])+W[t-7]+G0(W[t-15])+W[t-16])|0;let a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],f=H[5],g=H[6],h=H[7];for(let t=0;t<64;t++){const T1=(h+S1(e)+C(e,f,g)+K[t]+W[t])|0,T2=(S0(a)+M(a,b,c))|0;h=g;g=f;f=e;e=(d+T1)|0;d=c;c=b;b=a;a=(T1+T2)|0;}H[0]=(H[0]+a)|0;H[1]=(H[1]+b)|0;H[2]=(H[2]+c)|0;H[3]=(H[3]+d)|0;H[4]=(H[4]+e)|0;H[5]=(H[5]+f)|0;H[6]=(H[6]+g)|0;H[7]=(H[7]+h)|0;}const r=new Uint8Array(32);for(let i=0;i<8;i++){r[i*4]=(H[i]>>>24)&0xFF;r[i*4+1]=(H[i]>>>16)&0xFF;r[i*4+2]=(H[i]>>>8)&0xFF;r[i*4+3]=H[i]&0xFF;}return Array.from(r);}

// ==== js/board.js ====
// ==========================================
// Eprashala LMS - Geometric Auto-Draw (CORRECTED)
// ==========================================

let isMagicMode = false;
let magicStroke = []; // Stores points for recognition

function initBoard() {
    updateLeftPanelState(); 
    initResizers(); 
    initCanvas('overlayCanvas','overlay'); 
    initCanvas('boardCanvas','board');
    initCanvas('pdfOverlayCanvas','pdfPanel');
    
    new ResizeObserver(() => resizeCanvas('boardCanvas','board')).observe(document.getElementById('leftPanel'));
    
    if(!window.boardPages || boardPages.length === 0) {
        window.boardPages = [{history:[], step:-1, objects: [], bgColor: '#212121'}];
    }
    
    saveHistory('board','boardCanvas');
    
    window.addEventListener('mouseup', stopObjectManipulation);
    window.addEventListener('touchend', stopObjectManipulation);
    window.addEventListener('mousemove', handleObjectMove);
    window.addEventListener('touchmove', handleObjectMove);
    
    // Global click listener to close ALL popups
    window.addEventListener('click', function(e) {
        const popups = ['geoDropdown', 'sizeDropdown', 'colorDropdown'];
        const triggers = ['bGeo', 'bSize', 'bColor'];
        
        popups.forEach((pid, idx) => {
            const menu = document.getElementById(pid);
            const btn = document.getElementById(triggers[idx]);
            if (menu && menu.classList.contains('show') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('show');
            }
        });
    });
}

function wipeCanvas(id) {
    const c = document.getElementById(id);
    if(!c) return;
    const ctx = c.getContext('2d');
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0); 
    ctx.clearRect(0, 0, c.width, c.height);
    ctx.restore();
}

// --- LEFT PANEL UI ---
function updateLeftPanelState() {
    const p = document.getElementById('leftPanel');
    const c = document.querySelector('.left-toggle-container');
    if(!c) return;
    c.innerHTML = ''; 
    if (leftPanelState === 0) {
        p.style.width = '0'; p.classList.remove('active');
        c.classList.remove('docked-inside');
        c.innerHTML = `<button class="left-toggle-btn" onclick="setLeftPanel(1)">&#10095;</button>`;
    } else if (leftPanelState === 1) {
        p.style.width = '45%'; p.classList.add('active');
        c.classList.remove('docked-inside');
        c.innerHTML = `<button class="left-toggle-btn" onclick="setLeftPanel(2)" title="Full Screen" style="border-bottom:1px solid rgba(255,255,255,0.3)">&#10095;</button><button class="left-toggle-btn" onclick="setLeftPanel(0)" title="Collapse">&#10094;</button>`;
    } else if (leftPanelState === 2) {
        p.style.width = '100%'; p.classList.add('active');
        c.classList.add('docked-inside'); 
        c.innerHTML = `<button class="left-toggle-btn" onclick="setLeftPanel(1)" title="Restore Size">&#10094;</button>`;
    }
    setTimeout(()=>resizeCanvas('boardCanvas','board'), 300);
}
function setLeftPanel(state) { leftPanelState = state; updateLeftPanelState(); }
function changeBoardZoom(delta) { currentBoardScale += delta; if (currentBoardScale < 0.2) currentBoardScale = 0.2; if (currentBoardScale > 5.0) currentBoardScale = 5.0; document.getElementById('boardScaleWrapper').style.transform = `scale(${currentBoardScale})`; }
function initResizers(){ /* ... */ }

// --- CANVAS & TOOL LOGIC (FIXED for Magic Pen) ---
function initCanvas(id,k){ 
    const c=document.getElementById(id); 
    const start=(e)=>{ 
        const r=c.getBoundingClientRect(); 
        const clientX = e.clientX||e.touches[0].clientX; 
        const clientY = e.clientY||e.touches[0].clientY; 
        let scaleFactor = 1.0; 
        if (k === 'board') scaleFactor = currentBoardScale; 
        const x=(clientX-r.left) / scaleFactor, y=(clientY-r.top) / scaleFactor; 
        
        if (k === 'board' && isPlacingImage && pendingResourceImage) { /* ... */ return; } 
        if(k==='board' && activeObject) { 
            const objRect = activeObject.getBoundingClientRect(); 
            if (clientX < objRect.left || clientX > objRect.right || clientY < objRect.top || clientY > objRect.bottom) { 
                deselectObject(); 
            } 
        } 
        
        if(contexts[k].tool==='text'){spawnTextInput(x,y,k);return;} 
        if(contexts[k].tool==='image') return; 
        if(contexts[k].tool.startsWith('geo')) return;
        
        isDrawing=true;
        lastX=x; lastY=y;
        
        // MAGIC: Start recording stroke
        if(isMagicMode && k === 'board') {
            magicStroke = [{x:x, y:y}];
        }
    }; 
    const move=(e)=>{ 
        if(!isDrawing)return;e.preventDefault(); 
        const r=c.getBoundingClientRect(); 
        const clientX = e.clientX||e.touches[0].clientX; 
        const clientY = e.clientY||e.touches[0].clientY; 
        let scaleFactor = 1.0; 
        if (k === 'board') scaleFactor = currentBoardScale; 
        const x=(clientX-r.left)/scaleFactor, y=(clientY-r.top)/scaleFactor; 
        
        // MAGIC: Record Points
        if(isMagicMode && k === 'board') {
            magicStroke.push({x:x, y:y});
        }

        const ctx=c.getContext('2d'),s=contexts[k]; 
        ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.lineCap='round'; ctx.lineJoin='round'; 
        if(s.tool==='eraser'){ctx.globalCompositeOperation='destination-out';ctx.lineWidth=30;} 
        else{ ctx.globalCompositeOperation='source-over'; 
            if(s.tool==='highlighter'){ ctx.strokeStyle='rgba(255, 235, 59, 0.4)'; ctx.lineWidth=20; } 
            else { ctx.strokeStyle=s.color; ctx.lineWidth=s.size; } 
        } 
        ctx.stroke();lastX=x;lastY=y; 
    }; 
    
    // [FIX START] Updated End Handler to prevent double-saving history
    const end=()=>{
        if(isDrawing){
            isDrawing=false;
            let shapeHandled = false;

            // MAGIC: Processing
            if (isMagicMode && k === 'board') {
                // processMagicShape now returns true if it handled the shape
                shapeHandled = processMagicShape();
                magicStroke = [];
            }
            
            // Only save history here if magic shape didn't handle it
            // (If magic shape handled it, it saves its own history after loading the clean BG)
            if (!shapeHandled) {
                saveHistory(k,id);
            }
        }
    }; 
    // [FIX END]
    
    c.addEventListener('mousedown',start); c.addEventListener('mousemove',move); c.addEventListener('mouseup',end); 
    c.addEventListener('touchstart',start); c.addEventListener('touchmove',move); c.addEventListener('touchend',end); 
}

// ==========================================
// MAGIC SHAPE RECOGNITION LOGIC (FIXED)
// ==========================================

function activateMagicPen() {
    isMagicMode = true;
    document.getElementById('geoDropdown').classList.remove('show');
    
    // Set tool to Pen
    setTool('pen', 'board');
    
    // Add visual cue
    document.getElementById('bGeo').classList.add('magic-active');
}

// [FIX START] Updated to return boolean and handle detection logic
function processMagicShape() {
    if (magicStroke.length < 5) return false; // Too small, treat as normal ink

    const points = magicStroke;
    const start = points[0];
    const end = points[points.length - 1];
    
    // 1. Calculate Bounds
    let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
    let pathLen = 0;
    
    for (let i = 0; i < points.length; i++) {
        minX = Math.min(minX, points[i].x);
        maxX = Math.max(maxX, points[i].x);
        minY = Math.min(minY, points[i].y);
        maxY = Math.max(maxY, points[i].y);
        if (i > 0) {
            pathLen += Math.hypot(points[i].x - points[i-1].x, points[i].y - points[i-1].y);
        }
    }
    
    const w = maxX - minX;
    const h = maxY - minY;
    const distanceSE = Math.hypot(end.x - start.x, end.y - start.y);
    const diagonal = Math.hypot(w, h);
    
    // 2. Logic Triggers
    
    // A. LINE DETECTION
    if (distanceSE > 20 && (distanceSE / pathLen) > 0.90) {
        replaceLastStrokeWithShape('line', {x1: start.x, y1: start.y, x2: end.x, y2: end.y});
        return true;
    }
    
    // B. CLOSED SHAPE DETECTION (Start and End are close)
    const isClosed = distanceSE < Math.max(30, diagonal * 0.25);
    
    if (isClosed) {
        // C. CIRCLE / ELLIPSE
        const estimatedCircumference = Math.PI * ((w+h)/2);
        const ratio = pathLen / estimatedCircumference;
        
        if (ratio > 0.8 && ratio < 1.35) {
            const aspectRatio = w > h ? w/h : h/w;
            if (aspectRatio < 1.2) {
                // FORCE CIRCLE
                const size = (w+h)/2;
                replaceLastStrokeWithShape('circle', {cx: minX + w/2, cy: minY + h/2, r: size/2});
            } else {
                // ELLIPSE
                replaceLastStrokeWithShape('ellipse', {cx: minX + w/2, cy: minY + h/2, rx: w/2, ry: h/2});
            }
            return true;
        }
        
        // D. RECTANGLE / SQUARE
        const aspectRatio = w > h ? w/h : h/w;
        if (aspectRatio < 1.2) {
            replaceLastStrokeWithShape('square', {x: minX, y: minY, w: w, h: h}); 
        } else {
            replaceLastStrokeWithShape('rect', {x: minX, y: minY, w: w, h: h});
        }
        return true;
    }
    
    return false; // Not a shape, keep ink
}
// [FIX END]
function toggleDhwaniWidget() {
    const widget = document.getElementById('dhwaniChatWidget');
    
    if (widget.style.display === 'flex') {
        // ‡§ú‡§∞ ‡§µ‡§ø‡§ú‡•á‡§ü ‡§Ü‡§ß‡•Ä‡§ö ‡§â‡§ò‡§°‡•á ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§§‡•á ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§æ
        widget.style.display = 'none';
    } else {
        // ‡§ú‡§∞ ‡§µ‡§ø‡§ú‡•á‡§ü ‡§â‡§ò‡§°‡§§ ‡§Ö‡§∏‡•á‡§≤, ‡§§‡§∞ ‡§Ü‡§ß‡•Ä ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ (Pause Video)
        // ‡§π‡•á ‡§§‡•Å‡§Æ‡§ö‡•á ‡§Ö‡§∏‡•ç‡§§‡§ø‡§§‡•ç‡§µ‡§æ‡§§ ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á function ‡§µ‡§æ‡§™‡§∞‡•Ç‡§® ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§•‡§æ‡§Ç‡§¨‡§µ‡•á‡§≤
        if (typeof controlVideo === "function") {
            controlVideo('pause'); 
        }

        launchDhwaniAI(); // AI ‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ
        widget.style.display = 'flex'; // ‡§µ‡§ø‡§ú‡•á‡§ü ‡§¶‡§æ‡§ñ‡§µ‡§æ
    }

}

function launchDhwaniAI() {
    const widget = document.getElementById('dhwaniChatWidget');
    const iframe = document.getElementById('dhwaniFrame');
    
    // ‡•ß. ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§ó‡•ã‡§≥‡§æ ‡§ï‡§∞‡§æ (Context)
    let contextPath = currentVideoPath || (currentFolder ? currentFolder.path : "Home");
    const encodedContext = encodeURIComponent(contextPath);
    const user = currentUser ? encodeURIComponent(currentUser.name) : "Student";
    
    // ‡•®. ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§∞‡§ö‡•Ä ‡§≤‡§ø‡§Ç‡§ï ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ
    const serverUrl = `https://ai.eprashala.com/Dhwani_LMS.html?context=${encodedContext}&user=${user}`;

    // ‡•©. ‡§µ‡§ø‡§ú‡•á‡§ü‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§≤‡§ø‡§Ç‡§ï ‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ ‡§Ü‡§£‡§ø ‡§§‡•á ‡§¶‡§æ‡§ñ‡§µ‡§æ
    if (iframe.src !== serverUrl) {
        iframe.src = serverUrl;
    }
    widget.style.display = 'flex';
}
// [FIX START] Completely rewritten to handle async image loading
function replaceLastStrokeWithShape(type, data) {
    const t = boardPages[currentPageIndex];
    
    // If no history, we are at step 0 (or -1), clear and draw.
    if (!t || t.step < 0 || !t.history[t.step]) {
        const ctx = document.getElementById('boardCanvas').getContext('2d');
        ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
        drawPerfectShape(ctx, type, data);
        saveHistory('board', 'boardCanvas');
        return;
    }

    // Load the CLEAN background (from history BEFORE we drew the rough stroke)
    // Note: The rough stroke is on the canvas, but NOT in history array yet.
    // So t.history[t.step] is the clean board.
    const img = new Image();
    img.src = t.history[t.step];
    
    img.onload = () => {
        const canvas = document.getElementById('boardCanvas');
        const ctx = canvas.getContext('2d');
        
        // 1. Wipe the rough ink currently on canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 2. Restore the clean background
        ctx.drawImage(img, 0, 0);
        
        // 3. Draw the Perfect Shape on top
        drawPerfectShape(ctx, type, data);
        
        // 4. Save this new state (Background + Perfect Shape) to history
        saveHistory('board', 'boardCanvas');
    };
}

// Helper to draw the actual shapes
function drawPerfectShape(ctx, type, data) {
    const s = contexts.board;
    ctx.beginPath();
    ctx.lineWidth = s.size;
    ctx.strokeStyle = s.color;
    ctx.lineCap = 'round';
    
    if (type === 'line') {
        let x1 = data.x1, y1 = data.y1, x2 = data.x2, y2 = data.y2;
        const diffX = Math.abs(x2 - x1);
        const diffY = Math.abs(y2 - y1);
        if (diffX < 20) x2 = x1; 
        else if (diffY < 20) y2 = y1; 
        
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
    } 
    else if (type === 'circle') {
        ctx.arc(data.cx, data.cy, data.r, 0, Math.PI * 2);
    }
    else if (type === 'ellipse') {
        ctx.ellipse(data.cx, data.cy, data.rx, data.ry, 0, 0, Math.PI*2);
    }
    else if (type === 'rect' || type === 'square') {
        ctx.rect(data.x, data.y, data.w, data.h);
    }
    
    ctx.stroke();
}
// [FIX END]


// ==========================================
// EXISTING GEOMETRY & UTILS
// ==========================================

// Generic Toggle (Used for Geo, Size, Color)
function togglePopup(id) {
    // Close others first
    const others = ['geoDropdown', 'sizeDropdown', 'colorDropdown'];
    others.forEach(oid => {
        if(oid !== id) document.getElementById(oid).classList.remove('show');
    });

    const menu = document.getElementById(id);
    menu.classList.toggle('show');
}

function addGeoTool(type) {
    document.getElementById('geoDropdown').classList.remove('show');
    // Disable magic if selecting a tool
    isMagicMode = false;
    document.getElementById('bGeo').classList.remove('magic-active');
    
    const cx = 100, cy = 100;
    
    if (type === 'ruler') createRuler(cx, cy);
    else if (type === 'protractor') createProtractor(cx, cy);
    else if (type === 'triangle45') createTriangle(cx, cy, 45);
    else if (type === 'triangle60') createTriangle(cx, cy, 60);
    else if (type === 'compass') createCompass(cx, cy);
    else if (type === 'divider') createDivider(cx, cy);
}

// --- STANDARD UNDO/REDO ---
function performUndo(k) {
    let t;
    if (k === 'board') t = boardPages[currentPageIndex];
    else if (k === 'pdfPanel') t = pdfAnnotations[currentPdfPageIndex]; // ‡§µ‡•ç‡§π‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ‡§®‡§æ‡§µ ‡§§‡§™‡§æ‡§∏‡§æ
    // ... ‡§â‡§∞‡•ç‡§µ‡§∞‡§ø‡§§ ‡§ï‡•ã‡§°
}
function performRedo(k){
    let t = null;
    if(k==='board') t=boardPages[currentPageIndex];
    if(t && t.step < t.history.length-1){
        t.step++;
        wipeCanvas(k==='board'?'boardCanvas':'overlayCanvas');
        resH(t, document.getElementById(k==='board'?'boardCanvas':'overlayCanvas'));
    }
}
function saveHistory(k, id) {
    const c = document.getElementById(id);
    let t = null;
    if(k==='board') t = boardPages[currentPageIndex];
    
    if(t) {
        // If we undid and drew new, chop forward history
        if(t.step < t.history.length - 1) {
            t.history = t.history.slice(0, t.step + 1);
        }
        t.history.push(c.toDataURL());
        t.step++;
    }
}

// 1. REALISTIC RULER (Dual Scale)
function createRuler(x, y) {
    const pxPerCm = 30; const pxPerInch = pxPerCm * 2.54; const totalW = (15 * pxPerCm) + 40; const height = 70;
    let cmTicks = ''; for(let i=0; i<=150; i++) { let xPos = 20 + (i * (pxPerCm/10)); let h = (i%10===0) ? 25 : (i%5===0 ? 15 : 8); cmTicks += `<line x1="${xPos}" y1="0" x2="${xPos}" y2="${h}" stroke="#333" stroke-width="${i%10===0?1.5:0.5}"/>`; if(i%10===0) cmTicks += `<text x="${xPos}" y="38" font-size="10" text-anchor="middle" fill="#333">${i/10}</text>`; }
    let inTicks = ''; const totalInches = 6; for(let i=0; i<=totalInches*16; i++) { let xPos = 20 + (i * (pxPerInch/16)); let h = (i%16===0) ? 25 : (i%8===0 ? 15 : (i%4===0 ? 10 : 5)); inTicks += `<line x1="${xPos}" y1="${height}" x2="${xPos}" y2="${height-h}" stroke="#333" stroke-width="${i%16===0?1.5:0.5}"/>`; if(i%16===0) inTicks += `<text x="${xPos}" y="${height-30}" font-size="10" text-anchor="middle" fill="#333">${i/16}</text>`; }
    const svg = `<svg width="100%" height="100%" viewBox="0 0 ${totalW} ${height}" preserveAspectRatio="none" class="geo-tool-svg"><rect x="0" y="0" width="${totalW}" height="${height}" fill="rgba(255, 235, 59, 0.65)" stroke="#FBC02D" rx="4" stroke-width="1"/><text x="${totalW/2}" y="${height/2+4}" font-size="14" fill="rgba(0,0,0,0.2)" text-anchor="middle" font-weight="bold">RULER</text><g>${cmTicks}</g><g>${inTicks}</g><text x="10" y="38" font-size="8" fill="#555">cm</text><text x="10" y="${height-30}" font-size="8" fill="#555">in</text></svg>`;
    createGeoObject(svg, x, y, totalW, height, 'ruler');
}
// 2. REALISTIC PROTRACTOR
function createProtractor(x, y) {
    const r = 160; const w = r*2 + 20; const h = r + 20; const cx = w/2; const cy = h-10;
    let ticks = ''; for(let i=0; i<=180; i++) { const rad = (i * Math.PI) / 180; const isMajor = i%10===0; const isMid = i%5===0; const r1 = r; const r2 = isMajor ? r-15 : (isMid ? r-10 : r-5); const x1 = cx - r1 * Math.cos(rad); const y1 = cy - r1 * Math.sin(rad); const x2 = cx - r2 * Math.cos(rad); const y2 = cy - r2 * Math.sin(rad); ticks += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#1565C0" stroke-width="${isMajor?1.5:0.5}"/>`; if(isMajor) { const rTextOuter = r - 25; const xt = cx - rTextOuter * Math.cos(rad); const yt = cy - rTextOuter * Math.sin(rad); ticks += `<text x="${xt}" y="${yt}" font-size="9" text-anchor="middle" dominant-baseline="middle" fill="#1565C0">${i}</text>`; const rTextInner = r - 45; const xt2 = cx - rTextInner * Math.cos(rad); const yt2 = cy - rTextInner * Math.sin(rad); ticks += `<text x="${xt2}" y="${yt2}" font-size="9" text-anchor="middle" dominant-baseline="middle" fill="#C62828">${180-i}</text>`; } }
    const svg = `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}" class="geo-tool-svg"><path d="M10,${cy} A${r},${r} 0 0,1 ${w-10},${cy} Z" fill="rgba(33, 150, 243, 0.3)" stroke="#1565C0" stroke-width="2"/><line x1="10" y1="${cy}" x2="${w-10}" y2="${cy}" stroke="#1565C0" stroke-width="2"/><line x1="${cx}" y1="${cy}" x2="${cx}" y2="${cy-r}" stroke="#1565C0" stroke-width="0.5"/><path d="M${cx-20},${cy} A20,20 0 0,1 ${cx+20},${cy}" fill="none" stroke="#1565C0"/>${ticks}<circle cx="${cx}" cy="${cy}" r="4" fill="rgba(0,0,0,0.1)" stroke="red" stroke-width="1"/></svg>`;
    createGeoObject(svg, x, y, w*0.8, h*0.8, 'protractor');
}

// --- NEW IMAGE TOOLS ---

function triggerResourcePicker() {
    document.getElementById('imgUpload').click();
}

function handleImageUpload(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                // Default size logic: Scale down if huge, keep aspect ratio
                let w = img.width;
                let h = img.height;
                if(w > 300) { h = (300/w) * h; w = 300; }
                createImageObject(e.target.result, 100, 100, w, h);
            };
            img.src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
    }
    input.value = ''; // Reset for next use
}

function createImageObject(src, x, y, w, h) {
    const layer = document.getElementById('objectLayer');
    const div = document.createElement('div');
    div.className = 'smart-object-wrapper selected';
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    div.style.width = w + 'px';
    div.style.height = h + 'px';
    
    // Structure: Image + Close(Red) + Stick(Green) + Rotate(Top) + Resize(BottomRight)
    div.innerHTML = `
        <img src="${src}" style="width:100%; height:100%; pointer-events:none;">
        <div class="tool-close-btn" onmousedown="removeObject(event, this)" title="Remove">‚úï</div>
        <div class="stick-btn" onmousedown="stickImageToCanvas(event, this.parentNode)" title="Stick to Canvas">‚úì</div>
        <div class="rotate-handle" style="display:flex;" onmousedown="initRotate(event, this)">‚Üª</div>
        <div class="resize-handle-corn" onmousedown="initImageResize(event, this.parentNode)"></div>
    `;
    
    div.onmousedown = (e) => {
        if(e.target.classList.contains('rotate-handle') || 
           e.target.classList.contains('tool-close-btn') || 
           e.target.classList.contains('stick-btn') || 
           e.target.classList.contains('resize-handle-corn')) return;
        selectObject(div);
        initDrag(e, div);
    };
    
    layer.appendChild(div);
    selectObject(div);
}

function initImageResize(e, div) {
    isResizingObj = true;
    initialResize.mode = 'image';
    initialResize.el = div;
    initialResize.mx = e.clientX;
    initialResize.my = e.clientY;
    initialResize.w = parseInt(div.style.width);
    initialResize.h = parseInt(div.style.height);
    // Calculate aspect ratio to maintain it
    initialResize.ratio = initialResize.w / initialResize.h;
    e.stopPropagation();
}

function stickImageToCanvas(e, div) {
    e.stopPropagation();
    const ctx = document.getElementById('boardCanvas').getContext('2d');
    const imgElem = div.querySelector('img');
    
    // 1. Get current DOM properties
    const rect = div.getBoundingClientRect(); // Screen coords
    const wrapperRect = document.getElementById('boardScaleWrapper').getBoundingClientRect(); // Wrapper coords
    
    // 2. Parse Transform (Rotation)
    const st = window.getComputedStyle(div);
    const tr = st.getPropertyValue("-webkit-transform") || st.getPropertyValue("transform");
    let angle = 0;
    if (tr && tr !== 'none') {
        const values = tr.split('(')[1].split(')')[0].split(',');
        const a = values[0];
        const b = values[1];
        angle = Math.atan2(b, a);
    }

    // 3. Calculate Canvas Coordinates (Account for Zoom)
    // Since boardScaleWrapper scales everything, we use relative CSS values directly for best results
    const x = parseFloat(div.style.left);
    const y = parseFloat(div.style.top);
    const w = parseFloat(div.style.width);
    const h = parseFloat(div.style.height);

    // 4. Draw to Canvas
    ctx.save();
    ctx.translate(x + w/2, y + h/2); // Move to center
    ctx.rotate(angle);
    ctx.drawImage(imgElem, -w/2, -h/2, w, h);
    ctx.restore();

    // 5. Cleanup
    div.remove();
    activeObject = null;
    
    // 6. Save History (So you can Undo the "Stick")
    saveHistory('board', 'boardCanvas');
}
// 3. SET SQUARES
function createTriangle(x, y, angle) {
    let svg = ''; let w = 300, h = 300;
    const genTicks = (len, isVert) => { let t = ''; for(let i=0; i<len; i+=10) { if(isVert) t += `<line x1="0" y1="${300-i}" x2="${i%50===0?15:8}" y2="${300-i}" stroke="#333" stroke-width="1"/>`; else t += `<line x1="${i}" y1="300" x2="${i}" y2="${300-(i%50===0?15:8)}" stroke="#333" stroke-width="1"/>`; } return t; };
    if(angle === 45) { svg = `<svg width="100%" height="100%" viewBox="0 0 300 300" class="geo-tool-svg"><path d="M0,300 L300,300 L0,0 Z" fill="rgba(255, 152, 0, 0.4)" stroke="#EF6C00" stroke-width="2"/><path d="M40,260 L40,300 M0,260 L40,260" stroke="#EF6C00" stroke-width="1" fill="none"/><text x="50" y="250" fill="#EF6C00">90¬∞</text><text x="200" y="280" fill="#EF6C00">45¬∞</text><text x="20" y="50" fill="#EF6C00">45¬∞</text><g transform="translate(0,0)">${genTicks(300, false)}</g><g transform="translate(0,0)">${genTicks(300, true)}</g></svg>`; } 
    else { w = 200; h = 346; svg = `<svg width="100%" height="100%" viewBox="0 0 200 346" class="geo-tool-svg"><path d="M0,346 L200,346 L0,0 Z" fill="rgba(76, 175, 80, 0.4)" stroke="#2E7D32" stroke-width="2"/><text x="20" y="320" fill="#2E7D32">90¬∞</text><text x="140" y="330" fill="#2E7D32">60¬∞</text><text x="10" y="40" fill="#2E7D32">30¬∞</text><g transform="translate(0,46)">${genTicks(200, false)}</g><g transform="translate(0,46)">${genTicks(300, true)}</g></svg>`; }
    createGeoObject(svg, x, y, w, h, 'triangle');
}
// 4. COMPASS & DIVIDER
function createCompass(x, y) { 
    const layer = document.getElementById('objectLayer'); 
    const div = document.createElement('div'); 
    div.className = 'smart-object-wrapper selected'; 
    div.style.left = x + 'px'; 
    div.style.top = y + 'px'; 
    div.style.width = '200px'; 
    div.style.height = '200px'; 
    
    // Updated HTML: Added controls for Radius < and >
    div.innerHTML = `
    <div class="tool-close-btn" onmousedown="removeObject(event, this)">‚úï</div>
    
    <div class="compass-nav">
        <button class="compass-btn" onmousedown="adjustCompassRadius(event, this, -1)">&#60;</button>
        <div class="compass-val">3.3 cm</div>
        <button class="compass-btn" onmousedown="adjustCompassRadius(event, this, 1)">&#62;</button>
    </div>
    
    <div style="position:absolute; left:10px; top:10px; width:10px; height:10px; background:#444; border-radius:50%; z-index:10; border:2px solid silver;"></div>
    <div class="compass-arm" style="position:absolute; top:10px; left:10px; width:100px; height:20px; transform-origin: 5px 10px;">
        <div style="width:100%; height:6px; background:linear-gradient(to bottom, #ccc, #999); margin-top:7px; border:1px solid #666; border-radius:2px;"></div>
        <div class="compass-pencil" style="position:absolute; right:0; top:-15px; width:20px; height:50px; cursor:crosshair;">
            <div style="width:6px; height:40px; background:#FFC107; margin:0 auto; border:1px solid #B00020;"></div>
            <div style="width:0; height:0; border-left:3px solid transparent; border-right:3px solid transparent; border-top:10px solid #333; margin:0 auto;"></div>
        </div>
        <div class="resize-handle" style="right:-5px; top:5px; cursor:ew-resize; display:block;" onmousedown="initCompassRadius(event)"></div>
    </div>
    <div class="rotate-handle" style="top:-30px; left:15px; display:flex;" onmousedown="initDrag(event, this.parentNode)">‚Üª</div>`; 
    
    const pencil = div.querySelector('.compass-pencil'); 
    pencil.onmousedown = (e) => { e.stopPropagation(); initCompassDraw(e, div); }; 
    layer.appendChild(div); 
    selectObject(div); 
}

function createDivider(x, y) { const layer = document.getElementById('objectLayer'); const div = document.createElement('div'); div.className = 'smart-object-wrapper selected'; div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.width = '150px'; div.style.height = '200px'; div.innerHTML = `<div class="tool-close-btn" onmousedown="removeObject(event, this)">‚úï</div><div style="position:absolute; top:0; left:50%; transform:translateX(-50%); width:24px; height:24px; background:radial-gradient(circle, #eee 30%, #999 100%); border-radius:50%; border:2px solid #555; z-index:5;"></div><div style="position:absolute; top:10px; left:50%; width:6px; height:180px; background:linear-gradient(90deg, #ccc, #888); transform-origin:top center; transform: rotate(-15deg); border-radius:0 0 50% 50%;"></div><div id="dividerRightLeg" style="position:absolute; top:10px; left:50%; width:6px; height:180px; background:linear-gradient(90deg, #ccc, #888); transform-origin:top center; transform: rotate(15deg); cursor:ew-resize; border-radius:0 0 50% 50%;"><div style="position:absolute; bottom:0; left:0; width:6px; height:10px; background:#333;"></div></div><div class="rotate-handle" style="top:-35px; display:flex;" onmousedown="initDrag(event, this.parentNode)">‚Üª</div>`; const rightLeg = div.querySelector('#dividerRightLeg'); rightLeg.onmousedown = (e) => { e.stopPropagation(); initDividerSpread(e, rightLeg); }; layer.appendChild(div); selectObject(div); }

// --- UTILS (Create, Drag, Rotate, etc.) ---
function createGeoObject(content, x, y, w, h, type) { const layer = document.getElementById('objectLayer'); const div = document.createElement('div'); div.className = 'smart-object-wrapper selected'; div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.width = w + 'px'; div.style.height = h + 'px'; div.innerHTML = `${content}<div class="tool-close-btn" onmousedown="removeObject(event, this)">‚úï</div><div class="rotate-handle" onmousedown="initRotate(event, this)">‚Üª</div>`; div.onmousedown = (e) => { if(e.target.classList.contains('rotate-handle') || e.target.classList.contains('tool-close-btn')) return; selectObject(div); initDrag(e, div); }; layer.appendChild(div); selectObject(div); }
let compassState = { active: false, cx:0, cy:0, r:0, startAngle:0, div:null };
function selectObject(el) { document.querySelectorAll('.smart-object-wrapper').forEach(e => e.classList.remove('selected')); activeObject = el; el.classList.add('selected'); }
function removeObject(e, btn) { e.stopPropagation(); btn.parentNode.remove(); activeObject = null; }
function deselectObject() { if(activeObject) activeObject.classList.remove('selected'); activeObject = null; }
function initDrag(e, el) { isDraggingObj = true; activeObject = el; const r = el.getBoundingClientRect(); const p = document.getElementById('objectLayer').getBoundingClientRect(); dragOffset.x = (e.clientX || e.touches[0].clientX) - r.left; dragOffset.y = (e.clientY || e.touches[0].clientY) - r.top; e.stopPropagation(); }
function initRotate(e, handle) { if(!activeObject) return; isRotatingObj = true; const r = activeObject.getBoundingClientRect(); rotateCenter.x = r.left + r.width/2; rotateCenter.y = r.top + r.height/2; const mx = e.clientX || e.touches[0].clientX; const my = e.clientY || e.touches[0].clientY; const startAngle = Math.atan2(my - rotateCenter.y, mx - rotateCenter.x); const st = window.getComputedStyle(activeObject); const tr = st.getPropertyValue("-webkit-transform") || st.getPropertyValue("transform"); let currentRotation = 0; if(tr !== 'none') { const values = tr.split('(')[1].split(')')[0].split(','); const a = values[0]; const b = values[1]; currentRotation = Math.atan2(b, a); } initialAngle = startAngle - currentRotation; e.stopPropagation(); }
function initCompassDraw(e, div) { isCompassDrawing = true; compassState.div = div; const rect = div.getBoundingClientRect(); const pivotX = rect.left + 15; const pivotY = rect.top + 15; compassState.cx = pivotX; compassState.cy = pivotY; const mx = e.clientX; const my = e.clientY; const dx = mx - pivotX; const dy = my - pivotY; compassState.r = Math.sqrt(dx*dx + dy*dy); compassState.startAngle = Math.atan2(dy, dx); compassState.lastAngle = compassState.startAngle; e.stopPropagation(); }
function initCompassRadius(e) { isResizingObj = true; initialResize.mode = 'compass'; initialResize.mx = e.clientX; e.stopPropagation(); }

// NEW: Function to handle buttons (+/- radius)
function adjustCompassRadius(e, btn, dir) {
    e.stopPropagation();
    const wrapper = btn.closest('.smart-object-wrapper');
    const arm = wrapper.querySelector('.compass-arm');
    const display = wrapper.querySelector('.compass-val');
    
    // Get current width (pixels)
    let w = parseInt(arm.style.width || '100');
    
    // Adjust by 5 pixels (small steps)
    w += (dir * 5);
    
    // Min limit
    if (w < 20) w = 20;
    
    // Apply width
    arm.style.width = w + 'px';
    
    // Update Display (Assuming 30px = 1cm based on ruler logic)
    const cm = (w / 30).toFixed(1);
    display.innerText = cm + ' cm';
}

function initDividerSpread(e, leg) { isResizingObj = true; initialResize.mode = 'divider'; initialResize.el = leg; initialResize.mx = e.clientX; e.stopPropagation(); }
function handleObjectMove(e) {
    const mx = e.clientX || e.touches[0].clientX;
    const my = e.clientY || e.touches[0].clientY;
    const p = document.getElementById('objectLayer').getBoundingClientRect();

    if (isDraggingObj && activeObject) {
        const nx = mx - p.left - dragOffset.x;
        const ny = my - p.top - dragOffset.y;
        activeObject.style.left = nx + 'px';
        activeObject.style.top = ny + 'px';
    } 
    else if (isRotatingObj && activeObject) {
        const mouseAngle = Math.atan2(my - rotateCenter.y, mx - rotateCenter.x);
        const angle = mouseAngle - initialAngle;
        activeObject.style.transform = `rotate(${angle}rad)`;
    } 
    else if (isCompassDrawing) {
        const dx = mx - compassState.cx;
        const dy = my - compassState.cy;
        const angle = Math.atan2(dy, dx);
        const arm = compassState.div.querySelector('.compass-arm');
        arm.style.transform = `rotate(${angle}rad)`;
        arm.style.width = compassState.r + 'px';
        const ctx = document.getElementById('boardCanvas').getContext('2d');
        const pRect = document.getElementById('boardScaleWrapper').getBoundingClientRect();
        const scale = currentBoardScale;
        const boardCX = (compassState.cx - pRect.left) / scale;
        const boardCY = (compassState.cy - pRect.top) / scale;
        const boardR = compassState.r / scale;
        ctx.beginPath();
        ctx.arc(boardCX, boardCY, boardR, compassState.lastAngle, angle, (angle < compassState.lastAngle && Math.abs(angle - compassState.lastAngle) < 3));
        ctx.strokeStyle = contexts.board.color;
        ctx.lineWidth = 2;
        ctx.stroke();
        compassState.lastAngle = angle;
    } 
    else if (isResizingObj && initialResize.mode === 'compass') {
        const delta = mx - initialResize.mx;
        const arm = activeObject.querySelector('.compass-arm');
        const display = activeObject.querySelector('.compass-val');
        
        let w = parseInt(arm.style.width || '100');
        let newW = w + delta;
        if(newW < 20) newW = 20;
        
        arm.style.width = newW + 'px';
        
        // Update CM display while dragging
        if(display) {
            const cm = (newW / 30).toFixed(1);
            display.innerText = cm + ' cm';
        }
        
        initialResize.mx = mx;
    } 
    else if (isResizingObj && initialResize.mode === 'divider') {
        const delta = mx - initialResize.mx;
        const leg = initialResize.el;
        let currentRot = 15;
        let newRot = currentRot + (delta / 2);
        leg.style.transform = `rotate(${newRot}deg)`;
        initialResize.mx = mx;
    }
    // --- NEW IMAGE RESIZE LOGIC ---
    else if (isResizingObj && initialResize.mode === 'image') {
        const deltaX = mx - initialResize.mx;
        // Simple resizing width, calculate height via ratio
        let newW = initialResize.w + deltaX;
        if(newW < 50) newW = 50; // Min width
        let newH = newW / initialResize.ratio;
        
        initialResize.el.style.width = newW + 'px';
        initialResize.el.style.height = newH + 'px';
    }
}
function stopObjectManipulation() { isDraggingObj = false; isResizingObj = false; isRotatingObj = false; isCompassDrawing = false; if(isCompassDrawing) saveHistory('board','boardCanvas'); }
function cycleBoardColor(){ colorIdx = (colorIdx + 1) % BOARD_COLORS.length; const s = BOARD_COLORS[colorIdx]; contexts.board.bg = s.bg; contexts.board.color = s.pen; if(boardPages[currentPageIndex]) boardPages[currentPageIndex].bgColor = s.bg; document.getElementById('boardCanvas').style.background = s.bg; updateBoardColor(s.pen); setTool('pen','board'); wipeCanvas('boardCanvas'); document.getElementById('objectLayer').innerHTML = ''; saveHistory('board', 'boardCanvas'); }
function addNewPage(){ const currentBg = contexts.board.bg || '#212121'; boardPages.push({history:[], step:-1, objects: [], bgColor: currentBg}); currentPageIndex = boardPages.length-1; wipeCanvas('boardCanvas'); document.getElementById('objectLayer').innerHTML = ''; updatePageInd(); saveHistory('board','boardCanvas'); }
function changeBoardPage(d){ const n = currentPageIndex + d; if(n >= 0 && n < boardPages.length){ currentPageIndex = n; const p = boardPages[n]; document.getElementById('boardCanvas').style.background = p.bgColor || '#212121'; contexts.board.bg = p.bgColor || '#212121'; wipeCanvas('boardCanvas'); document.getElementById('objectLayer').innerHTML = ''; if(p.step >= 0) resH(p, document.getElementById('boardCanvas')); updatePageInd(); } }
function resH(t,c){ if(!t.history[t.step]) return; const i = new Image(); i.src = t.history[t.step]; i.onload = () => { const ctx = c.getContext('2d'); ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.clearRect(0, 0, c.width, c.height); ctx.restore(); ctx.drawImage(i, 0, 0); }; }
function clearCanvas(id){ let k = 'overlay'; if(id==='boardCanvas') { k='board'; document.getElementById('objectLayer').innerHTML = ''; boardPages[currentPageIndex].objects = []; } if(id==='pdfOverlayCanvas') k='pdfPanel'; wipeCanvas(id); saveHistory(k,id); }
function updatePageInd(){document.getElementById('pageIndicator').innerText=`${currentPageIndex+1}/${boardPages.length}`;}
// ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§π‡•á ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§æ
function setTool(t, k) {
    contexts[k].tool = t;
    
    // ‡§â‡§ú‡§µ‡•ç‡§Ø‡§æ ‡§™‡•Ö‡§®‡•á‡§≤‡§∏‡§æ‡§†‡•Ä (pdfPanel) ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§¨‡§¶‡§≤
    if (k === 'pdfPanel') {
        const overlay = document.getElementById('pdfOverlayCanvas');
        const scrollContainer = document.getElementById('pdf-scroll-container');
        
        // ‡§∏‡§∞‡•ç‡§µ ‡§¨‡§ü‡§® ‡§Æ‡§ß‡•Ç‡§® 'active' ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ï‡§æ‡§¢‡§æ
        ['pdfHand', 'pdfPen', 'pdfHigh', 'pdfText', 'pdfEraser'].forEach(id => {
            const btn = document.getElementById(id);
            if(btn) btn.classList.remove('active');
        });

        if (t === 'hand') {
            document.getElementById('pdfHand').classList.add('active');
            overlay.style.pointerEvents = 'none'; // ‡§Ü‡§§‡§æ ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§∏‡•ç‡§ï‡•ç‡§∞‡•ã‡§≤ ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§æ‡§≤
            scrollContainer.style.overflow = 'auto'; 
        } else {
            // ‡§™‡•á‡§® ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§á‡§§‡§∞ ‡§ü‡•Ç‡§≤ ‡§®‡§ø‡§µ‡§°‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§°‡•ç‡§∞‡•â‡§à‡§Ç‡§ó ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ
            if(t === 'pen') document.getElementById('pdfPen').classList.add('active');
            if(t === 'highlighter') document.getElementById('pdfHigh').classList.add('active');
            if(t === 'text') document.getElementById('pdfText').classList.add('active');
            if(t === 'eraser') document.getElementById('pdfEraser').classList.add('active');
            
            overlay.style.pointerEvents = 'auto'; // ‡§Ü‡§§‡§æ ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§≤‡§ø‡§π‡•Ç ‡§∂‡§ï‡§æ‡§≤
            scrollContainer.style.overflow = 'hidden'; // ‡§≤‡§ø‡§π‡§ø‡§§‡§æ‡§®‡§æ ‡§™‡§æ‡§® ‡§π‡§≤‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä
        }
    }
    
    // ‡§¨‡•ã‡§∞‡•ç‡§°‡§∏‡§æ‡§†‡•Ä ‡§ú‡•Å‡§®‡•á ‡§≤‡•â‡§ú‡§ø‡§ï (‡§ú‡•á ‡§Ü‡§ß‡•Ä‡§™‡§æ‡§∏‡•Ç‡§® ‡§Ü‡§π‡•á)
    if (k === 'board') {
        // ... ‡§§‡•Å‡§Æ‡§ö‡•á ‡§¨‡•ã‡§∞‡•ç‡§°‡§ö‡•á ‡§Ö‡§∏‡•ç‡§§‡§ø‡§§‡•ç‡§µ‡§æ‡§§ ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§ï‡•ã‡§° ...
    }
}
function updateContextSettings(k,t,v){ if(t==='size') contexts[k].size=parseInt(v); if(t==='color') contexts[k].color=v; }
// ==========================================
// ANNOTATION / OVERLAY LOGIC (Restored from old.html)
// ==========================================

function toggleOverlayMode() {
    const t = document.getElementById('annotationToolbar');
    const canvas = document.getElementById('overlayCanvas');
    
    // If currently visible, hide it (Done)
    if (t.style.display === 'flex') {
        t.style.display = 'none';
        canvas.style.pointerEvents = 'none'; // Pass clicks through to buttons below
    } 
    // If hidden, show it (Start Annotation)
    else {
        t.style.display = 'flex';
        canvas.style.pointerEvents = 'auto'; // Capture clicks for drawing
        
        // Pause video if playing so you can draw on a still frame
        const vid = document.getElementById('mainVideo');
        if(vid && !vid.paused) vid.pause();
        
        // Ensure canvas is sized correctly
        resizeCanvas('overlayCanvas', 'overlay');
        
        // Set default tool
        setTool('pen', 'overlay');
    }
}

function finishAnnotation() {
    // The "Done" button calls this
    toggleOverlayMode();
}
// --- NEW TOOL FUNCTIONS (Replaces Selects) ---
function updateBoardSize(size) {
    updateContextSettings('board', 'size', size);
    document.getElementById('currentSizeIndicator').style.width = size + 'px';
    document.getElementById('currentSizeIndicator').style.height = size + 'px';
    document.getElementById('sizeDropdown').classList.remove('show');
}
function updateBoardColor(color) {
    updateContextSettings('board', 'color', color);
    document.getElementById('currentColorIndicator').style.background = color;
    document.getElementById('colorDropdown').classList.remove('show');
    // Ensure pen tool is active when picking color
    setTool('pen','board');
}

function resizeCanvas(id,k){ const c=document.getElementById(id); c.width=c.clientWidth; c.height=c.clientHeight; if(k==='board') { const p=boardPages[currentPageIndex]; if(p.step>=0) resH(p,c); } }
async function captureZone(id) { finalizeText(); const el = id === 'body' ? document.body : document.getElementById(id); if(!el) return; const selected = document.querySelector('.selected'); if(selected) selected.classList.remove('selected'); setTimeout(async () => { try { const canvas = await html2canvas(el, { allowTaint: true, useCORS: true, scale: 2 }); const link = document.createElement('a'); link.download = `snapshot.jpg`; link.href = canvas.toDataURL('image/jpeg', 0.9); link.click(); if(selected) selected.classList.add('selected'); } catch (e) { alert("Snapshot failed."); } }, 100); }
function spawnTextInput(x,y,k){ if(isTyping)finalizeText(); const i=document.getElementById('tempTextInput'), c=document.getElementById(contexts[k].id); const r=c.getBoundingClientRect(); i.style.left=(r.left+x)+'px'; i.style.top=(r.top+y)+'px'; i.style.color=contexts[k].color; i.value=''; i.style.display='block'; setTimeout(()=>{ i.focus(); i.click(); }, 50); isTyping=true; i.dataset.ctx=k; i.dataset.x=x; i.dataset.y=y; }
function finalizeText(){ if(!isTyping)return; const i=document.getElementById('tempTextInput'),k=i.dataset.ctx,c=document.getElementById(contexts[k].id),ctx=c.getContext('2d'); if(i.value.trim()){ ctx.globalCompositeOperation='source-over';ctx.fillStyle=i.style.color;ctx.font='bold 20px Arial'; ctx.fillText(i.value,parseFloat(i.dataset.x),parseFloat(i.dataset.y)+20); saveHistory(k,c.id); } i.style.display='none';isTyping=false; }
function handleTextEnter(e){if(e.key==='Enter')finalizeText();}

// ==== js/viewer.js ====
// ==========================================
// Eprashala LMS - Viewer Logic (Complete)
// ==========================================

// --- GLOBAL STATE ---
let rightPanelState = 0; // 0=Closed, 1=Half, 2=Full
let currentLoadedPdfPath = null; 
let pdfAnnotations = {}; // Stores drawing history { pageIndex: {history:[], step:-1} }
let DYNAMIC_ROOT = null; // For Admin-loaded folders
let currentRenderTask = null; // To manage PDF rendering cancellations
window.DYNAMIC_LIBRARY_LOADED = false;

// --- INITIALIZATION ---

// Helper to parse local folder selection from Admin Panel
window.processLocalFolder = function(fileList) {
    if(!fileList || fileList.length === 0) return;
    
    const files = Array.from(fileList);
    const tree = { name: "Custom Content", type: "folder", children: [], path: "root" };
    
    files.forEach(file => {
        if(file.name.startsWith('.')) return; // Skip hidden files
        
        const pathParts = (file.webkitRelativePath || file.name).split('/');
        let currentLevel = tree;
        
        pathParts.forEach((part, index) => {
            const isFile = (index === pathParts.length - 1);
            if(isFile) {
                currentLevel.children.push({ 
                    name: part, 
                    type: 'file', 
                    path: file.webkitRelativePath, 
                    fileObj: file 
                });
            } else {
                let folder = currentLevel.children.find(c => c.name === part && c.type === 'folder');
                if(!folder) {
                    folder = { 
                        name: part, 
                        type: 'folder', 
                        path: currentLevel.path + "/" + part, 
                        children: [] 
                    };
                    currentLevel.children.push(folder);
                }
                currentLevel = folder;
            }
        });
    });
    
    // Set root to the inner folder if there's only one top-level folder
    if(tree.children.length === 1 && tree.children[0].type === 'folder') {
        DYNAMIC_ROOT = tree.children[0];
    } else {
        DYNAMIC_ROOT = tree;
    }
    
    window.DYNAMIC_LIBRARY_LOADED = true;
    openFolder(DYNAMIC_ROOT);
};
async function loadPdfLogic(url, pageNum) {
    try {
        // Show loading state if you wish
        const loadingTask = pdfjsLib.getDocument(url);
        pdfDoc = await loadingTask.promise;
        
        currentPdfPageIndex = pageNum - 1;
        
        // Reset annotations for the new document
        pdfAnnotations = {};
        
        updatePdfPageInd();
        renderPdfPage(pageNum);
    } catch (err) {
        console.error("Error loading PDF: ", err);
        alert("Could not load PDF file.");
    }
}

function initViewer() {
    // Reset Filters
    isFavoritesFilterActive = false;
    currentProgressFilter = 0;
    const favBtn = document.getElementById('favFilterBtn');
    if(favBtn) { favBtn.innerHTML = '‚ô°'; favBtn.classList.remove('fav-active'); }
    const progBtn = document.getElementById('progressFilterBtn');
    if(progBtn) { progBtn.className = 'top-btn progress-btn state-0'; }

    // Determine Start Folder
    let startData = null;
    const savedRootPath = localStorage.getItem('eprashala_root_path');
    
    if (DYNAMIC_ROOT) {
        startData = DYNAMIC_ROOT;
    } else if (savedRootPath && typeof LIBRARY_DATA !== 'undefined') {
        startData = findFolderByPath(LIBRARY_DATA, savedRootPath);
        // Fallback if saved path is invalid
        if (!startData || !startData.children || startData.children.length === 0) {
            startData = LIBRARY_DATA;
        }
    }
    
    if (!startData && typeof LIBRARY_DATA !== 'undefined') {
        startData = LIBRARY_DATA;
    }
    
    if (startData) openFolder(startData);
    
    // Listeners
    const vid = document.getElementById('mainVideo');
    if(vid) vid.addEventListener('timeupdate', updateProgressBar);
    
    setupVideoGestures();
    updateRightPanelState(); // Initialize handles
}

function findFolderByPath(node, path) {
    if (node.path === path) return node;
    if (node.children) {
        for (let child of node.children) {
            const found = findFolderByPath(child, path);
            if (found) return found;
        }
    }
    return null;
}

// --- NAVIGATION & FOLDER UI ---

function goHome() {
    historyStack = [];
    forwardStack = [];
    document.getElementById('searchInput').value = '';
    initViewer(); // Re-runs start logic
}

function openFolder(n){
    historyStack.push(currentFolder);
    forwardStack = [];
    loadFolderUI(n);
}

function goBack(){
    if(isFavoritesFilterActive) { toggleFavFilter(); return; }
    if(historyStack.length > 0){
        forwardStack.push(currentFolder);
        loadFolderUI(historyStack.pop());
    }
}

function goForward(){
    if(forwardStack.length > 0){
        historyStack.push(currentFolder);
        loadFolderUI(forwardStack.pop());
    }
}

function loadFolderUI(n) {
    currentFolder = n;
    document.getElementById('folderTitle').innerText = n.name;
    const g = document.getElementById('fileGrid');
    g.innerHTML = '';
    
    // --- NEW: CAPTURE VISIBLE ITEMS ---
    let visibleItems = []; 
    // ----------------------------------

    // 1. Check for Textbook (Same as before)
    const tb = n.children.find(f => f.name === 'textbook.pdf');
    if (tb) {
        const resourcePath = tb.fileObj ? tb.path : tb.path; 
        if (resourcePath !== currentLoadedPdfPath) {
            if(tb.fileObj) {
                const url = URL.createObjectURL(tb.fileObj);
                openInRightPanel('pdf', url, 1);
                currentLoadedPdfPath = tb.path; 
            } else {
                openInRightPanel('pdf', tb.path, 1);
                currentLoadedPdfPath = tb.path;
            }
        }
    } 

    // 2. Loop through children
    n.children.forEach(c => {
        if (c.name === 'textbook.pdf' || c.name === 'page.txt'|| c.name.endsWith('.qa') || c.name.endsWith('.ex')) return;
        
        // Filter Logic
        let shouldRender = true;

        if (isFavoritesFilterActive) {
            if (!currentUser || !currentUser.favorites || !currentUser.favorites.includes(c.path)) shouldRender = false;
        }

        if (shouldRender && (c.name.endsWith('mp4') || c.name.endsWith('enc') || c.name.endsWith('.enc') || c.name.endsWith('.webm'))) {
            const status = getFileStatus(c.path);
            if (currentProgressFilter === 1 && status !== 'red') shouldRender = false;
            if (currentProgressFilter === 2 && status !== 'yellow') shouldRender = false;
            if (currentProgressFilter === 3 && status !== 'green') shouldRender = false;
        }

        // 3. Render & Collect
        if (shouldRender) {
            renderFileCard(c, g);
            
            // Add to our "Local Context" list
            visibleItems.push({
                name: c.name,
                path: c.path,
                type: c.type
            });
        }
    });
    
    g.className = 'grid ' + VIEW_MODES[currentViewModeIndex];

    // --- NEW: SEND CONTEXT TO SEARCH WIDGET ---
    const searchFrame = document.getElementById('searchFrame');
    if (searchFrame && searchFrame.contentWindow) {
        searchFrame.contentWindow.postMessage({
            type: 'UPDATE_CONTEXT',
            items: visibleItems
        }, '*');
    }
}

function renderFileCard(c, container) {
    const d = document.createElement('div');
    d.className = 'card';
    
    let icon = 'üìÑ';
    if(c.type === 'folder') icon = 'üìÅ';
    else if(c.name.endsWith('mp4') || c.name.endsWith('enc') || c.name.endsWith('.enc') || c.name.endsWith('.webm')) icon = 'üé¨';
    
    let favIconHtml = '';
    let statusDotHtml = '';
    
    if(currentUser && c.type !== 'folder') {
        const isFav = (currentUser.favorites || []).includes(c.path);
        favIconHtml = `<div class="card-fav-btn ${isFav ? 'is-fav' : ''}" onclick="toggleFavorite(event, '${c.path}')">${isFav ? '‚ù§Ô∏è' : '‚ô°'}</div>`;
        if(c.name.endsWith('mp4') || c.name.endsWith('enc') || c.name.endsWith('.enc') || c.name.endsWith('.webm')) {
            const status = getFileStatus(c.path);
            statusDotHtml = `<div class="card-status-dot card-status-${status}"></div>`;
        }
    }

    d.innerHTML = `${favIconHtml}${statusDotHtml}<span class="card-icon">${icon}</span><b>${c.name}</b>`;
    
    d.onclick = () => {
        if(c.type === 'folder'){
            if(isFavoritesFilterActive) toggleFavFilter(); 
            openFolder(c);
            document.getElementById('searchInput').value = '';
        } else if(c.name.endsWith('mp4') || c.name.endsWith('enc') || c.name.endsWith('.enc') || c.name.endsWith('.webm')) {
            if(c.fileObj) playSecureVideo(c.fileObj);
            else playSecureVideo(c.path);
        } else {
            // Universal File Opener
            let url = c.path;
            if(c.fileObj) url = URL.createObjectURL(c.fileObj);
            const ext = c.name.split('.').pop().toLowerCase();
            
            // Track this as "Loaded" to prevent auto-textbook overwrite
            currentLoadedPdfPath = c.path;

            if(ext === 'pdf') {
                openInRightPanel('pdf', url, 1);
            } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                openInRightPanel('html', `<img src="${url}" style="max-width:100%;">`);
            } else if (['txt','js','css','html','htm','json','xml'].includes(ext)) {
                if(c.fileObj) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const safeText = e.target.result.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        openInRightPanel('html', `<pre>${safeText}</pre>`);
                    };
                    reader.readAsText(c.fileObj);
                } else {
                    openInRightPanel('html', `<iframe src="${url}" style="width:100%;height:100%;border:none;"></iframe>`);
                }
            } else if (ext === 'docx') {
                alert("For DOCX, please use the 'Open File' button on top toolbar.");
            } else {
                alert("File type not supported for embedded view: " + ext);
            }
        }
    };
    container.appendChild(d);
}

// --- RIGHT PANEL LOGIC ---

function updateRightPanelState() {
    const p = document.getElementById('rightPanel');
    const c = document.querySelector('.right-toggle-container');
    if(!c) return;
    c.innerHTML = '';
    
    if (rightPanelState === 0) {
        p.style.width = '0'; p.classList.remove('active'); c.classList.remove('docked-inside');
        c.innerHTML = `<button class="right-toggle-btn" onclick="setRightPanel(1)">&#10094;</button>`;
    } else if (rightPanelState === 1) {
        p.style.width = '45%'; p.classList.add('active'); c.classList.remove('docked-inside');
        c.innerHTML = `<button class="right-toggle-btn" onclick="setRightPanel(2)" title="Full Screen" style="border-bottom:1px solid rgba(255,255,255,0.3)">&#10094;</button><button class="right-toggle-btn" onclick="setRightPanel(0)" title="Close">&#10095;</button>`;
    } else if (rightPanelState === 2) {
        p.style.width = '100%'; p.classList.add('active'); c.classList.add('docked-inside');
        c.innerHTML = `<button class="right-toggle-btn" onclick="setRightPanel(1)" title="Restore Size">&#10095;</button>`;
    }
    setTimeout(() => { 
        resizeCanvas('pdfOverlayCanvas','pdfPanel'); 
        if(pdfDoc) renderPdfPage(currentPdfPageIndex + 1); 
    }, 300);
}

function setRightPanel(state) {
    rightPanelState = state;
    updateRightPanelState();
}

function openInRightPanel(t, c, pageNum = 1) {
    if (rightPanelState === 0) setRightPanel(1);

    const scrollContainer = document.getElementById('pdf-scroll-container');
    const wrapper = document.getElementById('pdf-wrapper');
    const pdfCanvas = document.getElementById('pdfRenderCanvas');
    const overlayCanvas = document.getElementById('pdfOverlayCanvas');
    
    // Create/Clean HTML Layer
    let htmlLayer = document.getElementById('universal-html-layer');
    if (!htmlLayer) {
        htmlLayer = document.createElement('div');
        htmlLayer.id = 'universal-html-layer';
        wrapper.insertBefore(htmlLayer, overlayCanvas);
    }

    // Reset visibility
    htmlLayer.style.display = 'none';
    pdfCanvas.style.display = 'none';
    htmlLayer.innerHTML = '';

    if (t === 'pdf') {
        pdfCanvas.style.display = 'block';
        loadPdfLogic(c, pageNum); // Encapsulate your existing PDF JS logic here
    } else {
        htmlLayer.style.display = 'block';
        htmlLayer.innerHTML = (t === 'html') ? c : ''; // c is the content
        
        // Let the content load, then sync the overlay canvas size
        setTimeout(() => {
            const h = htmlLayer.scrollHeight;
            const w = htmlLayer.scrollWidth;
            wrapper.style.height = h + "px";
            wrapper.style.width = w + "px";
            overlayCanvas.height = h;
            overlayCanvas.width = w;
        }, 200);
    }
}

function renderDocx(file) {
    openInRightPanel('docx', ''); 
    const container = document.getElementById('universal-html-layer');
    const reader = new FileReader();
    reader.onload = function(e) {
        docx.renderAsync(e.target.result, container, null, {
            className: "docx",
            breakPages: true
        }).then(() => {
            // Re-sync canvas after docx finishes rendering
            const wrapper = document.getElementById('pdf-wrapper');
            const overlay = document.getElementById('pdfOverlayCanvas');
            wrapper.style.height = container.scrollHeight + "px";
            overlay.height = container.scrollHeight;
        });
    };
    reader.readAsArrayBuffer(file);
}

function renderExcel(file) {
    // 1. Show the panel and reset previous content
    openInRightPanel('xlsx', '');
    const container = document.getElementById('universal-html-layer');
    const wrapper = document.getElementById('pdf-wrapper');
    const overlay = document.getElementById('pdfOverlayCanvas');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            
            // Convert to HTML
            const htmlContent = XLSX.utils.sheet_to_html(worksheet);
            
            // Inject into container
            container.innerHTML = `<div class="excel-wrapper">${htmlContent}</div>`;
            
            // Fix formatting
            const table = container.querySelector('table');
            if(table) table.classList.add('excel-table');

            // CRITICAL: Re-calculate heights after content is ready
            setTimeout(() => {
                const newHeight = container.scrollHeight;
                const newWidth = container.scrollWidth;
                
                wrapper.style.height = newHeight + "px";
                wrapper.style.width = (newWidth > 800 ? newWidth : 800) + "px"; // Ensure min width
                overlay.height = newHeight;
                overlay.width = wrapper.clientWidth;
                
                console.log("Excel Rendered. Height:", newHeight);
            }, 150);
        } catch (err) {
            console.error("Excel Error:", err);
            alert("Error reading Excel file.");
        }
    };
    reader.readAsArrayBuffer(file);
}

// --- PDF RENDERING & ANNOTATIONS (Fixed Race Conditions) ---

function renderPdfPage(num) {
    if(!pdfDoc) return;
    if(num > pdfDoc.numPages) num = pdfDoc.numPages;
    if(num < 1) num = 1;
    
    // 1. Cancel any ongoing render to prevent overwriting
    if(currentRenderTask) {
        currentRenderTask.cancel();
        currentRenderTask = null;
    }

    // 2. Capture the requested page index locally to ensure sync
    const renderTargetIndex = num - 1;

    pdfDoc.getPage(num).then(function(page) {
        const canvas = document.getElementById('pdfRenderCanvas');
        const overlay = document.getElementById('pdfOverlayCanvas');
        const wrapper = document.getElementById('pdf-wrapper');
        const ctx = canvas.getContext('2d');
        
        const container = document.getElementById('pdf-scroll-container');
        const containerWidth = container.clientWidth - 40; 
        
        let viewport = page.getViewport({scale: 1.0});
        let scale = containerWidth / viewport.width;
        scale = scale * currentPdfScale;
        viewport = page.getViewport({scale: scale});
        
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        overlay.height = viewport.height;
        overlay.width = viewport.width;
        wrapper.style.width = viewport.width + 'px';
        wrapper.style.height = viewport.height + 'px';
        
        // Reset Transform to prevent inversion bugs
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        
        const renderContext = { canvasContext: ctx, viewport: viewport };
        
        // 3. Render
        const task = page.render(renderContext);
        currentRenderTask = task;
        
        task.promise.then(function() {
            currentRenderTask = null; // Done
            
            // 4. Restore Annotations using the CAPTURED index
            const oCtx = overlay.getContext('2d');
            oCtx.clearRect(0,0,overlay.width,overlay.height);
            
            const p = pdfAnnotations[renderTargetIndex];
            if(p && p.step >= 0) resH(p, overlay);
            
        }).catch(function(err) {
            // Ignore cancellation errors
        });
    });
}

function changePdfPage(delta) {
    if(!pdfDoc) return;
    const newIndex = currentPdfPageIndex + delta;
    
    if (newIndex >= 0 && newIndex < pdfDoc.numPages) {
        // 1. Save CURRENT page annotations
        saveHistory('pdfPanel', 'pdfOverlayCanvas'); 
        
        // 2. Update Index
        currentPdfPageIndex = newIndex;
        
        // 3. Prepare NEW page storage
        if(!pdfAnnotations[currentPdfPageIndex]) {
            pdfAnnotations[currentPdfPageIndex] = {history:[], step:-1};
        }
        
        updatePdfPageInd();
        
        // 4. Wipe Overlay immediately so old drawings don't persist during load
        const c = document.getElementById('pdfOverlayCanvas');
        c.getContext('2d').clearRect(0,0,c.width,c.height);
        
        renderPdfPage(currentPdfPageIndex + 1);
    }
}

function changePdfZoom(delta) {
    currentPdfScale += delta;
    if(currentPdfScale < 0.2) currentPdfScale = 0.2;
    if(currentPdfScale > 5.0) currentPdfScale = 5.0;
    renderPdfPage(currentPdfPageIndex + 1);
}

function updatePdfPageInd(){ 
    if(pdfDoc) document.getElementById('pdfPageIndicator').innerText = `${currentPdfPageIndex + 1}/${pdfDoc.numPages}`;
}

// --- HISTORY & DRAWING HELPERS ---

function saveHistory(k, id) {
    const c = document.getElementById(id);
    let t;
    if (k === 'board') t = boardPages[currentPageIndex];
    else if (k === 'pdfPanel') {
        if(!pdfAnnotations[currentPdfPageIndex]) pdfAnnotations[currentPdfPageIndex] = {history:[], step:-1};
        t = pdfAnnotations[currentPdfPageIndex];
    }
    else t = contexts[k];

    t.step++;
    if (t.step < t.history.length) t.history.length = t.step;
    t.history.push(c.toDataURL());
}

function performUndo(k) {
    let t;
    if (k === 'board') t = boardPages[currentPageIndex];
    else if (k === 'pdfPanel') t = pdfAnnotations[currentPdfPageIndex];
    else t = contexts[k];
    
    const c = document.getElementById(contexts[k].id);
    if (t && t.step > 0) {
        t.step--;
        resH(t, c);
    } else if (t && t.step === 0) {
        t.step = -1;
        c.getContext('2d').clearRect(0, 0, c.width, c.height);
    }
}

function performRedo(k) {
    let t;
    if (k === 'board') t = boardPages[currentPageIndex];
    else if (k === 'pdfPanel') t = pdfAnnotations[currentPdfPageIndex];
    else t = contexts[k];
    
    const c = document.getElementById(contexts[k].id);
    if (t && t.step < t.history.length - 1) {
        t.step++;
        resH(t, c);
    }
}

// --- FILTERS & SEARCH ---

function toggleFavFilter() {
    isFavoritesFilterActive = !isFavoritesFilterActive;
    const btn = document.getElementById('favFilterBtn');
    if (isFavoritesFilterActive) { btn.classList.add('fav-active'); btn.innerHTML = '‚ù§Ô∏è'; } 
    else { btn.classList.remove('fav-active'); btn.innerHTML = '‚ô°'; }
    const q = document.getElementById('searchInput').value;
    if (q) handleSearch(); else loadFolderUI(currentFolder);
}


function toggleFavorite(e, path) {
    e.stopPropagation();
    if(!currentUser) { alert("Please login first"); return; }
    if(!currentUser.favorites) currentUser.favorites = [];
    const idx = currentUser.favorites.indexOf(path);
    if(idx > -1) currentUser.favorites.splice(idx, 1); else currentUser.favorites.push(path);
    const allTeachers = DB.getTeachers();
    const tIndex = allTeachers.findIndex(t => t.id === currentUser.id);
    if(tIndex > -1) { allTeachers[tIndex] = currentUser; DB.saveTeachers(allTeachers); }
    const q = document.getElementById('searchInput').value;
    if(q) handleSearch(); else loadFolderUI(currentFolder);
}

function cycleProgressFilter() {
    currentProgressFilter = (currentProgressFilter + 1) % 4;
    const btn = document.getElementById('progressFilterBtn');
    btn.className = 'top-btn progress-btn state-' + currentProgressFilter;
    loadFolderUI(currentFolder);
}

function cycleViewMode() {
    currentViewModeIndex = (currentViewModeIndex + 1) % VIEW_MODES.length;
    const g = document.getElementById('fileGrid');
    if(g) { VIEW_MODES.forEach(m => g.classList.remove(m)); g.classList.add(VIEW_MODES[currentViewModeIndex]); }
}

function getFileStatus(path) {
    if (!currentUser || !currentUser.progress || !currentUser.progress[path]) return 'red';
    const p = currentUser.progress[path];
    if (p === 'done') return 'green';
    return 'yellow';
}

function updateFileProgress(path, status) {
    if (!currentUser) return;
    if (!currentUser.progress) currentUser.progress = {};
    const current = currentUser.progress[path];
    if (current === 'done') return; 
    currentUser.progress[path] = status;
    const allTeachers = DB.getTeachers();
    const idx = allTeachers.findIndex(t => t.id === currentUser.id);
    if(idx > -1) { allTeachers[idx] = currentUser; DB.saveTeachers(allTeachers); }
}

// --- VIDEO PLAYER (SECURE + NORMAL) ---

function updateProgressBar(){
    const v = document.getElementById('mainVideo');
    if (!v || !currentVideoPath) return;
    if (v.currentTime > 1) updateFileProgress(currentVideoPath, 'started');
    if (v.duration && (v.currentTime / v.duration) > 0.95) updateFileProgress(currentVideoPath, 'done');
}

async function playSecureVideo(fileObjOrUrl) {
    if (!IS_REGISTERED) { alert("License Check Failed. App is locked."); return; }
    
    let blob = null; 
    let path = null;
    let fileName = "";

    // 1. Prepare File Object
    if (fileObjOrUrl instanceof File) { 
        blob = fileObjOrUrl; 
        path = fileObjOrUrl.name;
        fileName = fileObjOrUrl.name;
    } else {
        path = fileObjOrUrl;
        fileName = path.split('/').pop();
        try { 
            const req = await fetch(fileObjOrUrl); 
            if (!req.ok) throw new Error("File missing"); 
            blob = await req.blob(); 
        } catch(e) { alert("Cannot load file: " + fileObjOrUrl); return; }
    }
    
    currentVideoPath = path;

    // 2. Setup Video Player
    const v = document.getElementById('mainVideo');
    let blobUrl = "";

    if (fileName.toLowerCase().endsWith('.enc')) {
        const HEADER_SIZE = 10240;
        const headerSlice = blob.slice(0, HEADER_SIZE);
        const restSlice = blob.slice(HEADER_SIZE);
        const buffer = await headerSlice.arrayBuffer();
        const view = new Uint8Array(buffer);
        const KEY = 0x55; 
        for (let i = 0; i < view.length; i++) { view[i] ^= KEY; }
        const fixedBlob = new Blob([view, restSlice], {type: "video/mp4"});
        blobUrl = URL.createObjectURL(fixedBlob);
    } else {
        blobUrl = URL.createObjectURL(blob);
    }
    
    document.getElementById('videoPlayerArea').style.display = 'flex';
    document.getElementById('videoControlsGroup').style.display = 'flex';
    v.src = blobUrl;
    v.playbackRate = 1.0; 
    document.getElementById('speedSlider').value = 1;
    document.getElementById('speedDisplay').innerText = "1.0x";
    
    // 3. Start Video & Update Progress
    v.play();
    updateFileProgress(currentVideoPath, 'started');

    // --- CRITICAL FIX: CALL LOADFOLDERUI HERE ---
    // We call this NOW to update the yellow 'started' dots in the grid.
    // This will initially load 'textbook.pdf', but we will overwrite it immediately below.
    loadFolderUI(currentFolder);

    // --- 4. OVERRIDE WITH MATCHING PDF ---
    if (currentFolder && currentFolder.children) {
        // Get first 10 chars of video file name (e.g., "3.Maratha ")
        const matchKey = fileName.substring(0, 10).toLowerCase();
        
        // Find a PDF that starts with those 10 chars
        const matchingPdf = currentFolder.children.find(f => 
            f.name.toLowerCase().endsWith('.pdf') && 
            f.name.toLowerCase().startsWith(matchKey)
        );

        if (matchingPdf) {
            // Found a match! Load it into the right panel.
            // This happens AFTER loadFolderUI, so it effectively overwrites the textbook.
            const pdfUrl = matchingPdf.fileObj ? 
                           URL.createObjectURL(matchingPdf.fileObj) : 
                           matchingPdf.path;
            
            // Force open the new PDF
            openInRightPanel('pdf', pdfUrl, 1);
            
            // IMPORTANT: Update this variable so the system knows we intentionally switched
            currentLoadedPdfPath = matchingPdf.path;
        }
    }
}

function closeVideo(){
    const v = document.getElementById('mainVideo');
    v.pause();
    v.playbackRate = 1.0; 
    document.getElementById('videoPlayerArea').style.display = 'none';
    document.getElementById('videoControlsGroup').style.display = 'none';
    document.getElementById('speedSlider').value = 1;
    document.getElementById('speedDisplay').innerText = "1.0x";
    currentVideoPath = null;
    loadFolderUI(currentFolder);
}

function controlVideo(a){
    const v = document.getElementById('mainVideo');
    if(a === 'play') v.play();
    if(a === 'pause') v.pause();
    if(a === 'stop') { v.pause(); closeVideo(); }
    if(a === 'fullscreen') { if(v.requestFullscreen) v.requestFullscreen(); else if(v.webkitRequestFullscreen) v.webkitRequestFullscreen(); }
}

function changeSpeed(val){
    const v = document.getElementById('mainVideo');
    if(v) {
        v.playbackRate = parseFloat(val);
        document.getElementById('speedDisplay').innerText = val + 'x';
    }
}

function adjustVolume(val){ document.getElementById('mainVideo').volume = parseFloat(val); }

function setupVideoGestures(){
    const l = document.getElementById('gestureLayer');
    const v = document.getElementById('mainVideo');
    const f = document.getElementById('vidFeedback');
    let t = 0, tm = null;
    if(!l) return;
    l.addEventListener('click', (e) => {
        t++;
        if(tm) clearTimeout(tm);
        tm = setTimeout(() => {
            if(t === 1){
                v.paused ? v.play() : v.pause();
                f.innerText = v.paused ? "‚è∏" : "‚ñ∂";
                f.style.opacity = '1'; setTimeout(() => f.style.opacity = '0', 600);
            } else {
                const r = l.getBoundingClientRect();
                const x = e.clientX - r.left;
                if(x > r.width / 2){ v.currentTime += 10; f.innerText = "‚è© +10s"; } 
                else { v.currentTime -= 10; f.innerText = "‚è™ -10s"; }
                f.style.opacity = '1'; setTimeout(() => f.style.opacity = '0', 600);
            }
            t = 0;
        }, 250);
    });
}

// --- UNIVERSAL FILE PICKER ---
function triggerFilePicker(){ document.getElementById('localFilePicker').click(); }

function handleLocalFileSelect(input){
    if(input.files && input.files[0]){
        const file = input.files[0];
        const fileName = file.name.toLowerCase();
        
        // 1. VIDEO
        if(fileName.endsWith('.mp4') || fileName.endsWith('.webm') || fileName.endsWith('.ogg') || fileName.endsWith('.enc')) {
            playSecureVideo(file);
        } 
        // 2. PDF
        else if (fileName.endsWith('.pdf')) {
            const url = URL.createObjectURL(file);
            openInRightPanel('pdf', url, 1);
        } 
        // 3. IMAGES
        else if (/\.(jpg|jpeg|png|gif|webp)$/i.test(fileName)) {
            const reader = new FileReader();
            reader.onload = (e) => openInRightPanel('html', `<div style="display:flex;justify-content:center;align-items:center;height:100%"><img src="${e.target.result}" style="max-width:100%;max-height:100%;box-shadow:0 0 10px rgba(0,0,0,0.2);"></div>`);
            reader.readAsDataURL(file);
        } 
        // 4. MODERN WORD (.docx)
        else if (fileName.endsWith('.docx')) {
             renderDocx(file);
        } 
        // 5. LEGACY WORD (.doc) - The "Unsupported" Fix
        else if (fileName.endsWith('.doc')) {
             alert("‚ö†Ô∏è LEGACY FORMAT DETECTED\n\nBrowsers cannot securely render old binary Word (.doc) files.\n\nPlease open this file in Word and 'Save As' -> '.docx' or PDF for best viewing in Eprashala.");
        }
        // 6. EXCEL (.xlsx, .xls, .csv)
        else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileName.endsWith('.csv')) {
             renderExcel(file);
        }
        // 7. POWERPOINT
        else if (fileName.endsWith('.pptx') || fileName.endsWith('.ppt')) {
            alert("‚ö†Ô∏è SLIDE SHOW TIP\n\nFor the best offline experience, please export your PowerPoint slides as a PDF.\n\nFile > Save As > PDF.");
        } 
        // 8. TEXT/CODE
        else if (/\.(txt|html|htm|js|css|json|xml|md)$/i.test(fileName)) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const safeText = e.target.result.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                openInRightPanel('html', `<div style="padding:20px;background:white;"><pre style="white-space:pre-wrap;font-family:consolas;">${safeText}</pre></div>`);
            };
            reader.readAsText(file);
        } 
        else {
            alert("Unsupported file type: " + fileName);
        }
    }
    // Clear input so same file can be selected again if needed
    input.value = ''; 
}

// --- RENDER FUNCTIONS ---




// ==== js/ScreenRecorder.js ====
// js/screen-recorder.js

let mediaRecorder = null;
let recordedChunks = [];
let combinedStream = null;
let isRecording = false;
let isPaused = false;

// -- UI Elements --
const overlay = document.getElementById('recorder-overlay');
const btnToggle = document.getElementById('rec-toggle-btn');
const btnMic = document.getElementById('rec-mic-btn');
const btnClose = document.getElementById('rec-close-btn');
const audioPopup = document.getElementById('audio-settings-popup');

// Icons (Spans inside buttons)
const iconRecord = btnToggle.querySelector('.icon-record');
const iconPause = btnToggle.querySelector('.icon-pause');
const iconPlay = btnToggle.querySelector('.icon-play');
const iconClose = btnClose.querySelector('.icon-close');
const iconTick = btnClose.querySelector('.icon-tick');

// Inputs
const chkSysSound = document.getElementById('chk-sys-sound');
const chkMicSound = document.getElementById('chk-mic-sound');

// 1. Open the Toolbar
function openRecorderToolbar() {
    overlay.style.display = 'flex';
    resetUI();
}

// 2. Close the Toolbar
function closeRecorder() {
    // If recording is active, this button acts as "Finish/Save"
    if (isRecording) {
        stopRecording();
    } else {
        // Just close the UI
        overlay.style.display = 'none';
        resetUI();
    }
}

// 3. Toggle Recording (Start / Pause / Resume)
async function toggleRecordState() {
    if (!isRecording) {
        // START RECORDING
        await startRecording();
    } else {
        // PAUSE / RESUME
        if (isPaused) {
            mediaRecorder.resume();
            isPaused = false;
            updatePlayPauseIcon(false); // Show Pause icon
        } else {
            mediaRecorder.pause();
            isPaused = true;
            updatePlayPauseIcon(true); // Show Play icon
        }
    }
}

// 4. Start Logic
async function startRecording() {
    try {
        const tracks = [];
        
        // 1. SYSTEM AUDIO / SCREEN CHECK
        // If running on file:// protocol, warn the user because it often fails here.
        if (window.location.protocol === 'file:') {
            console.warn("Screen Recording APIs are unstable on file:// protocol. Use a local server (http://localhost) if this fails.");
        }

        let displayStream;
        try {
            // Attempt 1: Try with the user's audio preference
            displayStream = await navigator.mediaDevices.getDisplayMedia({
                video: { mediaSource: 'screen' }, // Explicitly ask for screen/tab
                audio: chkSysSound.checked // Request system audio if checked
            });
        } catch (err) {
            // Attempt 2: If it failed and System Sound was checked, try AGAIN without audio
            // (Fixes 'Permission Denied' on systems that can't share audio for specific screens)
            if (chkSysSound.checked) {
                console.warn("System audio request failed. Retrying with video only...");
                displayStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: false
                });
            } else {
                throw err; // It wasn't the audio, so re-throw the error
            }
        }

        displayStream.getTracks().forEach(track => tracks.push(track));

        // 2. MICROPHONE CHECK
        if (chkMicSound.checked) {
            try {
                const micStream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true }
                });
                micStream.getTracks().forEach(track => tracks.push(track));
            } catch (micErr) {
                alert("Microphone permission denied. Recording will proceed with System Audio/Video only.");
                // We do NOT stop here, we just continue without Mic
            }
        }

        // 3. COMBINE & START
        combinedStream = new MediaStream(tracks);

        mediaRecorder = new MediaRecorder(combinedStream, {
            mimeType: 'video/webm;codecs=vp9'
        });

        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = saveVideoFile;

        // Handle "Stop Sharing" from the browser's native floating bar
        displayStream.getVideoTracks()[0].onended = () => {
            stopRecording();
        };

        mediaRecorder.start();
        isRecording = true;
        
        // Update UI
        iconRecord.style.display = 'none';
        iconPause.style.display = 'inline';
        iconClose.style.display = 'none';
        iconTick.style.display = 'inline';
        btnClose.classList.add('finish');
        btnMic.disabled = true;

    } catch (err) {
        console.error("Recording Error:", err);
        // Alert the EXACT error to help you debug
        alert("Recording Failed: " + err.name + "\n" + err.message + "\n\nTip: If using 'file://', try 'localhost'.");
    }
}

// 5. Stop Logic
function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop(); // Triggers onstop -> saveVideoFile
    }
    
    // Stop all tracks (turns off the red "recording" dot in browser tab)
    if (combinedStream) {
        combinedStream.getTracks().forEach(track => track.stop());
    }

    isRecording = false;
    isPaused = false;
}

// 6. Save File
function saveVideoFile() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    
    // Trigger Download
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    // Naming as MP4 for compatibility (internal stream is WebM)
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    a.download = `Lesson-Recording-${timestamp}.mp4`;
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    window.URL.revokeObjectURL(url);
    recordedChunks = [];
    overlay.style.display = 'none'; // Close toolbar after save
    resetUI();
}

// 7. Toggle Audio Settings
function toggleAudioSettings() {
    if (isRecording) return; // Cannot change during record
    const isVisible = audioPopup.style.display === 'block';
    audioPopup.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) btnMic.classList.add('active');
    else btnMic.classList.remove('active');
}

// Helpers
function updatePlayPauseIcon(paused) {
    if (paused) {
        iconPause.style.display = 'none';
        iconPlay.style.display = 'inline';
    } else {
        iconPause.style.display = 'inline';
        iconPlay.style.display = 'none';
    }
}

function resetUI() {
    isRecording = false;
    isPaused = false;
    recordedChunks = [];
    
    iconRecord.style.display = 'inline';
    iconPause.style.display = 'none';
    iconPlay.style.display = 'none';
    
    iconClose.style.display = 'inline';
    iconTick.style.display = 'none';
    btnClose.classList.remove('finish');
    
    btnMic.disabled = false;
    audioPopup.style.display = 'none';
    btnMic.classList.remove('active');
    
    // Defaults
    chkSysSound.checked = false;
    chkMicSound.checked = false;
}
  </script>

 <script>
    // Replacement for js/app-loader.js: components are already inlined above.
    window.addEventListener('load', () => {
      try {
        if (window.initAuth) window.initAuth();
        if (window.initBoard) window.initBoard();
        if (window.initViewer) window.initViewer();

        // === ADD THIS SECTION FOR ELECTRON MIC/CAM SUPPORT ===
        const webview = document.getElementById('wv');
        if (webview) {
          webview.addEventListener('permissionrequest', (e) => {
            // This handles permissions inside the Eprashala Browser webview
            const allowed = ['media', 'geolocation', 'fullscreen'];
            if (allowed.includes(e.permission)) {
              e.request.allow();
            }
          });
        }
        // =====================================================

      } catch (e) {
        console.error('Initialization Error:', e);
      }
    });
  </script>

<div id="dhwaniChatWidget" style="position: fixed; bottom: 20px; right: 20px; width: 380px; height: 550px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 12000; border: 2px solid #FF9800; overflow: hidden;">
    <div style="background: #FF9800; color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
        <span>ü§ñ ‡§ß‡•ç‡§µ‡§®‡•Ä AI ‡§∏‡§π‡§æ‡§Ø‡•ç‡§Ø‡§ï</span>
        <button onclick="toggleDhwaniWidget()" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer;">‚úñ</button>
    </div>
    <iframe id="dhwaniFrame" src="" allow="microphone" style="width: 100%; flex: 1; border: none;"></iframe>
</div>
<!-- ================= EMBEDDED BROWSER HOST ================= -->
<div id="browserHost" style="position:absolute; top:70px; left:120px; width:900px; height:600px; display:none; z-index:15000; background:#fff; border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #FF9800; flex-direction: column;">

 <div id="browserHeader" style="height:35px; background:#FF9800; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
    <div style="display:flex; align-items:center; gap:10px;">
        <span>üåê Eprashala Browser</span>
        <button id="btnStickyBrowser" onclick="toggleBrowserSticky()" style="background:#fff; color:#FF9800; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
    </div>
    <div style="display:flex; gap:5px; align-items:center;">
        <button onclick="minimiseBrowser()" style="background:#ffa726; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
        
        <button id="btnMaxRestore" onclick="toggleMaximise()" style="background:#42a5f5; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:16px;">üóñ </button>
        
        <button onclick="closeEmbeddedBrowser()" style="background:#d32f2f; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
    </div>
</div>

  <div class="browser-controls" id="browserControls">
      <button class="browser-btn" onclick="document.getElementById('wv').goBack()">‚óÄ</button>
      <button class="browser-btn" onclick="document.getElementById('wv').goForward()">‚ñ∂</button>
      <button class="browser-btn" onclick="document.getElementById('wv').reload()">‚Üª</button>
      <input type="text" id="browserUrlInput" placeholder="https://google.com">
      <button class="browser-btn" onclick="loadBrowserUrl()" style="background:#4CAF50">Go</button>
  </div>

  <div class="browser-shortcuts" id="browserShortcuts">
  <button onclick="quickBrowserLoad('https://www.swayamprabha.gov.in')">Swayam Prabha</button>
    <button onclick="quickBrowserLoad('https://www.google.com')">Google</button>
	<button onclick="quickBrowserLoad('https://www.youtube.com')">Youtube</button>
	<button onclick="quickBrowserLoad('https://www.youtubekids.com')">YoutubeKids</button>
    <button onclick="quickBrowserLoad('https://www.wikipedia.org')">Wikipedia</button>
	<button onclick="quickBrowserLoad('https://meet.google.com')">Google Meet</button>
    <button onclick="quickBrowserLoad('https://web.whatsapp.com')">WhatsApp</button>
    <button onclick="quickBrowserLoad('https://zoom.us/join')">Zoom</button>
  </div>

  <div style="flex:1; position:relative; display:flex; background:white; ">
      <webview 
    id="wv" 
    src="https://www.google.com" 
    style="width:100%; height:100%; display:flex;" 
    partition="persist:eprashala"
    allowpopups
    useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36">
</webview>
      
      
  </div>
<div id="browserResizeHandle" style="position:absolute; bottom:0; right:0; width:20px; height:20px; cursor:nwse-resize; background: linear-gradient(135deg, transparent 50%, #FF9800 50%); z-index: 20;"></div>
</div>

  </div>
<!-- ========================================================= -->
<div id="qaHost" style="position:absolute; top:80px; left:150px; width:1200px; height:600px; display:none; z-index:16000; background:#fff; border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #E91E63; flex-direction: column;">

  <div id="qaHeader" style="height:35px; background:#E91E63; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
      <div style="display:flex; align-items:center; gap:10px;">
          <span>üìù Q&A Engine</span>
          <button id="btnStickyQa" onclick="toggleWindowSticky('qaHost', 'qaFrame', 'btnStickyQa')" style="background:#fff; color:#E91E63; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
		  <span id="qaSubjectDisplay" style="font-size:11px; opacity:0.8; font-weight:normal;">(No Context)</span>
      </div>

      <div style="display:flex; gap:5px; align-items:center;">
          <button onclick="minimiseQa()" style="background:#f06292; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
          <button id="btnQaMaxRestore" onclick="toggleQaMaximise()" style="background:#ec407a; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:16px;">üóñ</button>
          <button onclick="closeQaWindow()" style="background:#b71c1c; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
      </div>
  </div>

  <div class="qa-controls" style="padding: 5px; background: #eee; border-bottom: 1px solid #ccc; display: flex; gap: 5px;">
      <button class="browser-btn" onclick="document.getElementById('qaFrame').contentWindow.history.back()" title="Back">‚óÄ</button>
      <button class="browser-btn" onclick="document.getElementById('qaFrame').contentWindow.history.forward()" title="Forward">‚ñ∂</button>
      <button class="browser-btn" onclick="document.getElementById('qaFrame').contentWindow.location.reload()" title="Refresh">‚Üª</button>
      <input type="text" id="qaUrlDisplay" disabled style="flex:1; border:none; background:transparent; font-size:12px; color:#666; padding-left:10px;" value="QA Engine Ready">
  </div>

  <div style="flex:1; position:relative; display:flex; background:white;">
      <iframe id="qaFrame" style="width:100%; height:100%; border:none;"></iframe>
  </div>

  <div id="qaResizeHandle" style="position:absolute; bottom:0; right:0; width:20px; height:20px; cursor:nwse-resize; background: linear-gradient(135deg, transparent 50%, #E91E63 50%); z-index: 20;"></div>
</div>
<div id="dicHost" style="position:absolute; top:90px; left:180px; width:600px; height:500px; display:none; z-index:17000; background:#fff; border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #4CAF50; flex-direction: column;">

  <div id="dicHeader" style="height:35px; background:#4CAF50; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
      <div style="display:flex; align-items:center; gap:10px;">
          <span>üé§ Voice Dictation</span>
		  <button id="btnStickyDic" onclick="toggleWindowSticky('dicHost', 'dicFrame', 'btnStickyDic')" style="background:#fff; color:#4CAF50; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
      </div>

      <div style="display:flex; gap:5px; align-items:center;">
          <button onclick="minimiseDic()" style="background:#81c784; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
          <button id="btnDicMaxRestore" onclick="toggleDicMaximise()" style="background:#66bb6a; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:16px;">üóñ</button>
          <button onclick="closeDicWindow()" style="background:#2e7d32; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
      </div>
  </div>

  <div class="dic-nav-bar" style="padding: 5px; background: #eee; border-bottom: 1px solid #ccc; display: flex; gap: 5px;">
      <button class="browser-btn" onclick="document.getElementById('dicFrame').contentWindow.history.back()">‚óÄ</button>
      <button class="browser-btn" onclick="document.getElementById('dicFrame').contentWindow.history.forward()">‚ñ∂</button>
      <button class="browser-btn" onclick="document.getElementById('dicFrame').contentWindow.location.reload()">‚Üª</button>
      <div style="flex:1"></div>
  </div>

  <div style="flex:1; position:relative; display:flex; background:white;">
      <iframe id="dicFrame" style="width:100%; height:100%; border:none;"></iframe>
  </div>

  <div id="dicResizeHandle" style="position:absolute; bottom:0; right:0; width:20px; height:20px; cursor:nwse-resize; background: linear-gradient(135deg, transparent 50%, #4CAF50 50%); z-index: 20;"></div>
</div>
<div id="mirrorHost" style="position:absolute; top:100px; left:200px; width:360px; height:640px; display:none; z-index:18000; background:#000; border-radius:30px; box-shadow:0 15px 40px rgba(0,0,0,0.8); overflow:hidden; border: 8px solid #333; flex-direction: column;">
    
    <div id="mirrorHeader" style="height:40px; background:#333; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 15px; cursor:move; font-weight:bold; flex-shrink: 0;">
        <span style="font-size: 12px;">üì± Mobile Mirror</span>
		<button id="btnStickyMirror" onclick="toggleWindowSticky('mirrorHost', 'mirrorWv', 'btnStickyMirror')" style="background:#fff; color:#333; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="minimiseMirror()" style="background:#ffa726; border:none; color:white; width:22px; height:22px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
            <button id="btnMirrorMaxRestore" onclick="toggleMirrorMaximise()" style="background:#42a5f5; border:none; color:white; width:22px; height:22px; border-radius:4px; cursor:pointer; font-size:14px;">üóñ</button>
            <button onclick="closeMirrorBrowser()" style="background:#d32f2f; border:none; color:white; width:22px; height:22px; border-radius:50%; cursor:pointer;">‚úñ</button>
        </div>
    </div>

    <div id="mirrorConnectPanel" style="padding: 15px; background: #222; color: #fff; text-align: center; border-bottom: 1px solid #444;">
        <p style="font-size: 11px; margin: 0 0 10px 0; color: #bbb;">Start <b>ScreenStream</b> app & enter IP:</p>
        <div style="display: flex; align-items: center; background: #fff; border-radius: 5px; padding: 2px 5px;">
            <span style="color: #666; font-size: 12px; font-weight: bold;">http://</span>
            <input type="text" id="mirrorIpInput" placeholder="192.168.1.5" style="flex: 1; border: none; outline: none; padding: 5px; font-size: 14px; font-weight: bold; text-align: center; color: black;">
            <span style="color: #666; font-size: 12px; font-weight: bold;">:8080</span>
        </div>
        <button onclick="loadMirrorUrl()" style="width: 100%; margin-top: 10px; padding: 8px; background: #4CAF50; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold;">Connect Screen</button>
    </div>

    <div id="mirrorActivePanel" style="display: none; padding: 8px; background: #333; text-align: center;">
        <button onclick="endMirrorSession()" style="padding: 5px 20px; background: #f44336; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 12px;">‚èπ End Stream</button>
    </div>

    <div style="flex:1; background:#000; display:flex;">
        <webview id="mirrorWv" src="about:blank" style="width:100%; height:100%;" disablewebsecurity allowpopups></webview>
    </div>

    <div id="mirrorResizeHandle" style="position:absolute; bottom:0; right:0; width:20px; height:20px; cursor:nwse-resize; background: linear-gradient(135deg, transparent 50%, #555 50%);"></div>
</div>
<div id="searchHost" style="position:fixed; top:5px; left:50%; transform:translateX(-50%); width:500px; height:45px; display:none; z-index:20000; transition: height 0.3s ease;">
    <iframe 
    id="searchFrame" 
    src="about:blank"
    allow="microphone *; camera *" 
    style="width:100%; height:100%; border:none; border-radius:25px; overflow:hidden;"
></iframe>
</div>

<div id="calcHost" style="position:absolute; top:120px; left:300px; width:350px; height:480px; display:none; z-index:19000; background:#fff; border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #673AB7; flex-direction: column;">
    
    <div id="calcHeader" style="height:35px; background:#673AB7; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span>üßÆ Calculator</span>
            <button id="btnStickyCalc" onclick="toggleWindowSticky('calcHost', 'calcFrame', 'btnStickyCalc')" style="background:#fff; color:#673AB7; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="minimiseCalc()" style="background:#9575cd; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
            <button id="btnCalcExpand" onclick="toggleCalcScientific()" style="background:#7e57c2; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:16px;">üî¨</button>
            <button onclick="closeCalculator()" style="background:#d32f2f; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
        </div>
    </div>

    <div style="flex:1; background:#f5f5f5;">
        <iframe id="calcFrame" src="calc.html" style="width:100%; height:100%; border:none;"></iframe>
    </div>
</div>
<div id="timerHost" style="position:absolute; top:120px; left:100px; width:300px; height:380px; display:none; z-index:19100; background:#fff; border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #FF5722; flex-direction: column;">
    <div id="timerHeader" style="height:35px; background:#FF5722; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span>‚è±Ô∏è Timer & Stop</span>
            <button id="btnStickyTimer" onclick="toggleWindowSticky('timerHost', 'timerFrame', 'btnStickyTimer')" style="background:#fff; color:#FF5722; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="minimiseWindow('timerHost')" style="background:#ff8a65; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
            <button onclick="closeTimer()" style="background:#d32f2f; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
        </div>
    </div>
    <div style="flex:1; background:#f5f5f5;">
        <iframe id="timerFrame" src="timer.html" style="width:100%; height:100%; border:none;"></iframe>
    </div>
</div>

<div id="prompterHost" style="position:absolute; top:100px; right:50px; width:400px; height:500px; display:none; z-index:19200; background:rgba(0,0,0,0.75); border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #607D8B; flex-direction: column; backdrop-filter: blur(4px);">
    <div id="prompterHeader" style="height:35px; background:rgba(96, 125, 139, 0.9); color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span>üìú Prompter</span>
            <button id="btnStickyPrompter" onclick="toggleWindowSticky('prompterHost', 'prompterFrame', 'btnStickyPrompter')" style="background:#fff; color:#607D8B; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="minimiseWindow('prompterHost')" style="background:#90a4ae; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
            <button onclick="closePrompter()" style="background:#d32f2f; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
        </div>
    </div>
    <div style="flex:1;">
        <iframe id="prompterFrame" src="prompter.html" allowtransparency="true" style="width:100%; height:100%; border:none; background:transparent;"></iframe>
    </div>
    <div id="prompterResizeHandle" style="position:absolute; bottom:0; right:0; width:20px; height:20px; cursor:nwse-resize; background: linear-gradient(135deg, transparent 50%, #607D8B 50%); z-index: 20;"></div>
</div>

<script>
/* === CONTROL LOGIC === */
function openTimer() { document.getElementById('timerHost').style.display = 'flex'; }
function closeTimer() { document.getElementById('timerHost').style.display = 'none'; }
function openPrompter() { document.getElementById('prompterHost').style.display = 'flex'; }
function closePrompter() { document.getElementById('prompterHost').style.display = 'none'; }

function minimiseWindow(hostId) {
    const host = document.getElementById(hostId);
    if (host.style.height === "35px") {
        host.style.height = host.dataset.prevH || "400px";
    } else {
        host.dataset.prevH = host.style.height;
        host.style.height = "35px";
    }
}

/* === UNIVERSAL DRAG & RESIZE === */
function setupDraggableWindow(hostId, headerId, frameId) {
    const host = document.getElementById(hostId);
    const header = document.getElementById(headerId);
    const frame = document.getElementById(frameId);
    let isDragging = false;
    let dragOffsetX = 0, dragOffsetY = 0;

    if (!host || !header) return;

    header.addEventListener('mousedown', (e) => {
        if(e.target.tagName === 'BUTTON' || host.getAttribute('data-sticky') === 'true') return;
        isDragging = true;
        host.style.zIndex = 19999; 
        if(frame) frame.style.pointerEvents = 'none'; 
        const rect = host.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        host.style.left = (e.clientX - dragOffsetX) + 'px';
        host.style.top = (e.clientY - dragOffsetY) + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            if(frame) frame.style.pointerEvents = 'auto'; 
        }
    });
}

// Initialize Dragging
setupDraggableWindow('timerHost', 'timerHeader', 'timerFrame');
setupDraggableWindow('prompterHost', 'prompterHeader', 'prompterFrame');

// Initialize Prompter Resize (Since it needs to adjust to text length)
(function setupPrompterResize() {
    const host = document.getElementById("prompterHost");
    const handle = document.getElementById("prompterResizeHandle");
    const frame = document.getElementById("prompterFrame");
    let isResizing = false;

    if(!handle) return;

    handle.onmousedown = function(e) {
        e.preventDefault(); e.stopPropagation();
        isResizing = true;
        frame.style.pointerEvents = 'none';

        function onMove(e) {
            if (!isResizing) return;
            const newW = e.clientX - host.getBoundingClientRect().left;
            const newH = e.clientY - host.getBoundingClientRect().top;
            if (newW > 250) host.style.width = newW + 'px';
            if (newH > 200) host.style.height = newH + 'px';
        }

        function onUp() {
            isResizing = false;
            frame.style.pointerEvents = 'auto';
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    };
})();
</script>


<div id="timerHost" style="position:absolute; top:120px; left:100px; width:300px; height:380px; display:none; z-index:19100; background:#fff; border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #FF5722; flex-direction: column;">
    <div id="timerHeader" style="height:35px; background:#FF5722; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span>‚è±Ô∏è Timer & Stop</span>
            <button id="btnStickyTimer" onclick="toggleWindowSticky('timerHost', 'timerFrame', 'btnStickyTimer')" style="background:#fff; color:#FF5722; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="minimiseWindow('timerHost')" style="background:#ff8a65; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
            <button onclick="closeTimer()" style="background:#d32f2f; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
        </div>
    </div>
    <div style="flex:1; background:#f5f5f5;">
        <iframe id="timerFrame" src="timer.html" style="width:100%; height:100%; border:none;"></iframe>
    </div>
</div>

<div id="prompterHost" style="position:absolute; top:100px; right:50px; width:400px; height:500px; display:none; z-index:19200; background:rgba(0,0,0,0.75); border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #607D8B; flex-direction: column; backdrop-filter: blur(4px);">
    <div id="prompterHeader" style="height:35px; background:rgba(96, 125, 139, 0.9); color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span>üìú Prompter</span>
            <button id="btnStickyPrompter" onclick="toggleWindowSticky('prompterHost', 'prompterFrame', 'btnStickyPrompter')" style="background:#fff; color:#607D8B; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="minimiseWindow('prompterHost')" style="background:#90a4ae; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
            <button onclick="closePrompter()" style="background:#d32f2f; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
        </div>
    </div>
    <div style="flex:1;">
        <iframe id="prompterFrame" src="prompter.html" allowtransparency="true" style="width:100%; height:100%; border:none; background:transparent;"></iframe>
    </div>
    <div id="prompterResizeHandle" style="position:absolute; bottom:0; right:0; width:20px; height:20px; cursor:nwse-resize; background: linear-gradient(135deg, transparent 50%, #607D8B 50%); z-index: 20;"></div>
</div>

<script>
/* === CONTROL LOGIC === */
function openTimer() { document.getElementById('timerHost').style.display = 'flex'; }
function closeTimer() { document.getElementById('timerHost').style.display = 'none'; }
function openPrompter() { document.getElementById('prompterHost').style.display = 'flex'; }
function closePrompter() { document.getElementById('prompterHost').style.display = 'none'; }

function minimiseWindow(hostId) {
    const host = document.getElementById(hostId);
    if (host.style.height === "35px") {
        host.style.height = host.dataset.prevH || "400px";
    } else {
        host.dataset.prevH = host.style.height;
        host.style.height = "35px";
    }
}

/* === UNIVERSAL DRAG & RESIZE === */
function setupDraggableWindow(hostId, headerId, frameId) {
    const host = document.getElementById(hostId);
    const header = document.getElementById(headerId);
    const frame = document.getElementById(frameId);
    let isDragging = false;
    let dragOffsetX = 0, dragOffsetY = 0;

    if (!host || !header) return;

    header.addEventListener('mousedown', (e) => {
        if(e.target.tagName === 'BUTTON' || host.getAttribute('data-sticky') === 'true') return;
        isDragging = true;
        host.style.zIndex = 19999; 
        if(frame) frame.style.pointerEvents = 'none'; 
        const rect = host.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        host.style.left = (e.clientX - dragOffsetX) + 'px';
        host.style.top = (e.clientY - dragOffsetY) + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            if(frame) frame.style.pointerEvents = 'auto'; 
        }
    });
}

// Initialize Dragging
setupDraggableWindow('timerHost', 'timerHeader', 'timerFrame');
setupDraggableWindow('prompterHost', 'prompterHeader', 'prompterFrame');

// Initialize Prompter Resize (Since it needs to adjust to text length)
(function setupPrompterResize() {
    const host = document.getElementById("prompterHost");
    const handle = document.getElementById("prompterResizeHandle");
    const frame = document.getElementById("prompterFrame");
    let isResizing = false;

    if(!handle) return;

    handle.onmousedown = function(e) {
        e.preventDefault(); e.stopPropagation();
        isResizing = true;
        frame.style.pointerEvents = 'none';

        function onMove(e) {
            if (!isResizing) return;
            const newW = e.clientX - host.getBoundingClientRect().left;
            const newH = e.clientY - host.getBoundingClientRect().top;
            if (newW > 250) host.style.width = newW + 'px';
            if (newH > 200) host.style.height = newH + 'px';
        }

        function onUp() {
            isResizing = false;
            frame.style.pointerEvents = 'auto';
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    };
})();
</script>

<div id="graphHost" style="position:absolute; top:150px; left:400px; width:500px; height:450px; display:none; z-index:19300; background:#fff; border-radius:8px; box-shadow:0 15px 40px rgba(0,0,0,0.6); overflow:hidden; border: 2px solid #00BCD4; flex-direction: column;">
    <div id="graphHeader" style="height:35px; background:#00BCD4; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; cursor:move; font-weight:bold; flex-shrink: 0;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span>üìà 2D Graph Plotter</span>
            <button id="btnStickyGraph" onclick="toggleWindowSticky('graphHost', 'graphFrame', 'btnStickyGraph')" style="background:#fff; color:#00BCD4; border:none; padding:2px 8px; border-radius:4px; font-size:12px; cursor:pointer;">üìå</button>
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <button onclick="minimiseWindow('graphHost')" style="background:#26c6da; border:none; color:white; width:24px; height:24px; border-radius:4px; cursor:pointer; font-weight:bold;">‚Äî</button>
            <button onclick="closeGraph()" style="background:#d32f2f; border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer;">‚úñ</button>
        </div>
    </div>
    <div style="flex:1; background:#fff; position:relative;">
        <iframe id="graphFrame" src="graph.html" style="width:100%; height:100%; border:none;"></iframe>
    </div>
    <div id="graphResizeHandle" style="position:absolute; bottom:0; right:0; width:20px; height:20px; cursor:nwse-resize; background: linear-gradient(135deg, transparent 50%, #00BCD4 50%); z-index: 20;"></div>
</div>

</body>

<script>
      /* ================= BROWSER LOGIC ================= */

// Go Button Logic
function loadBrowserUrl() {
    const vw = document.getElementById('wv');
    let url = document.getElementById('browserUrlInput').value;
    if (!url.trim()) return;
    // Auto-add https if missing
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }
    vw.src = url;
}

// Shortcut Button Logic
function quickBrowserLoad(url) {
    document.getElementById('browserUrlInput').value = url;
    document.getElementById('wv').src = url;
}

// Update URL Bar when browsing
// (‡§π‡•á ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§æ ‡§ï‡•Ä wv ‡§π‡•á ID ‡§¨‡§∞‡•ã‡§¨‡§∞ ‡§Ü‡§π‡•á)
const webviewEl = document.getElementById('wv');
if(webviewEl) {
    webviewEl.addEventListener('did-navigate', (e) => {
        document.getElementById('browserUrlInput').value = e.url;
    });
}
  </script>

<script>
/* ================= EMBEDDED BROWSER CONTROL ================= */
function openWebBrowser() {
  // --- NEW: Pause Video Logic ---
  const vid = document.getElementById('mainVideo');
  if(vid && !vid.paused) {
      vid.pause();
  }
  // -----------------------------

  const host = document.getElementById("browserHost");
  if (!host) {
    alert("Browser container not found");
    return;
  }
  host.style.display = "flex";
  host.style.zIndex = 15000;
}

function closeEmbeddedBrowser() {
  const host = document.getElementById("browserHost");
  if (host) host.style.display = "none";
}

/* ================= DRAG SUPPORT ================= */

let isBrowserDragging = false;
let browserOffsetX = 0;
let browserOffsetY = 0;

document.addEventListener("mousedown", e => {
  if (e.target.classList.contains("browser-drag")) {
    const host = document.getElementById("browserHost");
    isBrowserDragging = true;
    const r = host.getBoundingClientRect();
    browserOffsetX = e.clientX - r.left;
    browserOffsetY = e.clientY - r.top;
  }
});

document.addEventListener("mousemove", e => {
  if (!isBrowserDragging) return;
  const host = document.getElementById("browserHost");
  host.style.left = (e.clientX - browserOffsetX) + "px";
  host.style.top  = (e.clientY - browserOffsetY) + "px";
});

document.addEventListener("mouseup", () => {
  isBrowserDragging = false;
});

/* ================= BROWSER INTERACTIVITY ================= */
let isSticky = false;

// --- 1. Move (Drag) Logic ---
const browserWin = document.getElementById("browserHost");
const browserHeader = document.getElementById("browserHeader");

browserHeader.onmousedown = function(e) {
    if(isSticky) return; // Sticky ‡§Ö‡§∏‡§§‡§æ‡§®‡§æ ‡§π‡§≤‡§µ‡§§‡§æ ‡§Ø‡•á‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä
    let shiftX = e.clientX - browserWin.getBoundingClientRect().left;
    let shiftY = e.clientY - browserWin.getBoundingClientRect().top;

    function moveAt(pageX, pageY) {
        browserWin.style.left = pageX - shiftX + 'px';
        browserWin.style.top = pageY - shiftY + 'px';
    }

    function onMouseMove(e) { moveAt(e.pageX, e.pageY); }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function() {
        document.removeEventListener('mousemove', onMouseMove);
        document.onmouseup = null;
    };
};

// --- 2. Resize Logic ---
const resizeHandle = document.getElementById("browserResizeHandle");
resizeHandle.onmousedown = function(e) {
    e.preventDefault();
    function onMouseMove(e) {
        let newWidth = e.clientX - browserWin.getBoundingClientRect().left;
        let newHeight = e.clientY - browserWin.getBoundingClientRect().top;
        
        if(newWidth > 300) browserWin.style.width = newWidth + 'px';
        if(newHeight > 200) browserWin.style.height = newHeight + 'px';
        
        // ‡§Æ‡§π‡§§‡•ç‡§µ‡§æ‡§ö‡•á: webview ‡§≤‡§æ ‡§§‡§æ‡§£‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä browserHost ‡§≤‡§æ flex ‡§≤‡•á‡§Ü‡§â‡§ü‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§†‡•á‡§µ‡§æ
        browserWin.style.display = "flex"; 
    }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function() {
        document.removeEventListener('mousemove', onMouseMove);
    };
};
function toggleBrowserSticky() {
    const btn = document.getElementById('btnStickyBrowser');
    const overlay = document.getElementById('overlayCanvas'); // ‡§ï‡§ø‡§Ç‡§µ‡§æ boardCanvas
    
    isSticky = !isSticky;

    if (isSticky) {
        // --- STICKY MODE ON ---
        btn.innerText = "üìç";
        btn.style.background = "#4CAF50";
        btn.style.color = "white";
        
        // ‡•ß. ‡§µ‡§ø‡§®‡•ç‡§°‡•ã‡§≤‡§æ ‡§ú‡§æ‡§ó‡•á‡§µ‡§∞ ‡§≤‡•â‡§ï ‡§ï‡§∞‡§æ
        browserHeader.style.cursor = "default";
        
        // ‡•®. ‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•Ö‡§®‡§µ‡•ç‡§π‡§æ‡§∏‡§≤‡§æ ‡§µ‡§∞ ‡§Ü‡§£‡§æ (‡§ù‡•á‡§°-‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏) ‡§ú‡•á‡§£‡•á‡§ï‡§∞‡•Ç‡§® ‡§§‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§≤‡§ø‡§π‡§ø‡§§‡§æ ‡§Ø‡•á‡§à‡§≤
        // ‡§™‡§∞‡§Ç‡§§‡•Å ‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞‡§ö‡•ç‡§Ø‡§æ ‡§ñ‡§æ‡§≤‡•Ä ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§¨‡§ü‡§® ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§π‡•ã‡§ä ‡§®‡§Ø‡•á ‡§Æ‡•ç‡§π‡§£‡•Ç‡§® ‡§Ü‡§™‡§£ 'overlay' ‡§µ‡§æ‡§™‡§∞‡•Ç
        overlay.style.zIndex = "16000"; 
        overlay.style.pointerEvents = "auto";
        
        // ‡•©. ‡§Ø‡•Å‡§ú‡§∞‡§≤‡§æ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§¶‡•ç‡§Ø‡§æ
        document.getElementById('wv').style.pointerEvents = "none"; 
    
    // Controls ‡§Ü‡§£‡§ø Shortcuts ‡§≤‡§æ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä ‡§¶‡•ç‡§Ø‡§æ
    document.getElementById('browserControls').style.pointerEvents = "auto";
    document.getElementById('browserShortcuts').style.pointerEvents = "auto";
    } else {
        // --- STICKY MODE OFF ---
        btn.innerText = "üìå";
        btn.style.background = "#fff";
        btn.style.color = "#FF9800";
        
        browserHeader.style.cursor = "move";
        
        // ‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞‡§§ ‡§ñ‡§æ‡§≤‡•Ä ‡§®‡•ç‡§Ø‡§æ ‡§ú‡•á‡§£‡•á‡§ï‡§∞‡•Ç‡§® ‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞ ‡§µ‡§æ‡§™‡§∞‡§§‡§æ ‡§Ø‡•á‡§à‡§≤
        overlay.style.zIndex = "2000"; 
        overlay.style.pointerEvents = "none";
    }
}
let isMaximised = false;
let lastRect = { top: "70px", left: "120px", width: "900px", height: "600px" };

// ‡•ß. Minimise Function
function minimiseBrowser() {
    const host = document.getElementById("browserHost");
    host.classList.toggle("browser-minimised");
    // ‡§ú‡§∞ ‡§Æ‡§ø‡§®‡•Ä‡§Æ‡§æ‡§à‡§ú ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§Æ‡•Ö‡§ï‡•ç‡§ù‡§ø‡§Æ‡§æ‡§à‡§ú ‡§¨‡§ü‡§® ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§æ
    document.getElementById("btnMaxRestore").disabled = host.classList.contains("browser-minimised");
}

// ‡•®. Maximise/Restore Function
function toggleMaximise() {
    const host = document.getElementById("browserHost");
    const btn = document.getElementById("btnMaxRestore");

    if (!isMaximised) {
        // ‡§∏‡§ß‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§™‡•ã‡§ù‡§ø‡§∂‡§® ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ
        lastRect = {
            top: host.style.top,
            left: host.style.left,
            width: host.style.width,
            height: host.style.height
        };

        // ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡§∞‡§æ
        host.style.top = "48px"; // Top bar ‡§ö‡•ç‡§Ø‡§æ ‡§ñ‡§æ‡§≤‡•Ä
        host.style.left = "0px";
        host.style.width = "100%";
        host.style.height = "calc(100vh - 48px)";
        
        btn.innerText = "‚ùê"; // Restore icon
        isMaximised = true;
    } else {
        // ‡§ú‡•Å‡§®‡•Ä ‡§™‡•ã‡§ù‡§ø‡§∂‡§® ‡§™‡§∞‡§§ ‡§Ü‡§£‡§æ
        host.style.top = lastRect.top;
        host.style.left = lastRect.left;
        host.style.width = lastRect.width;
        host.style.height = lastRect.height;
        
        btn.innerText = "‚¨ú"; // Maximise icon
        isMaximised = false;
    }
}

function syncAnnotationLayer() {
    const wrapper = document.getElementById('pdf-wrapper');
    const overlay = document.getElementById('pdfOverlayCanvas');
    const pdfCanvas = document.getElementById('pdfRenderCanvas');
    const htmlLayer = document.getElementById('universal-html-layer');

    // Determine which layer is currently active/visible
    const activeLayer = (pdfCanvas.style.display !== 'none') ? pdfCanvas : htmlLayer;

    // Match the canvas and wrapper to the content's real-time dimensions
    const newWidth = activeLayer.scrollWidth;
    const newHeight = activeLayer.scrollHeight;

    // Update DOM elements
    wrapper.style.width = newWidth + "px";
    wrapper.style.height = newHeight + "px";
    
    // Update Canvas resolution without clearing context if possible
    // Note: Changing width/height clears the canvas, so we only do it if dimensions changed
    if (overlay.width !== newWidth || overlay.height !== newHeight) {
        overlay.width = newWidth;
        overlay.height = newHeight;
    }
}

/* ================= INDEPENDENT Q&A ENGINE LOGIC ================= */

// 1. OPEN FUNCTION (Replaces your old openQAHandler)
function openQAHandler() {
    // --- NEW: Pause Video Logic ---
    const vid = document.getElementById('mainVideo');
    if(vid && !vid.paused) {
        vid.pause();
    }
    // -----------------------------

    const qaHost = document.getElementById('qaHost');
    const qaFrame = document.getElementById('qaFrame');
    const subjectDisplay = document.getElementById('qaSubjectDisplay');
    const urlDisplay = document.getElementById('qaUrlDisplay');

    let targetUrl = "QA_Engine.html"; // Default: No parameters

    if (currentVideoPath && currentFolder) {
        // 1. Get the video filename (e.g., "4. Shivaji's childhood.enc")
        const videoFileName = currentVideoPath.split('/').pop();
        
        // 2. Get the first 10 characters for matching
        const matchKey = videoFileName.substring(0, 10).toLowerCase();
        
        // 3. Search the current folder for a .qa file that matches the key
        const matchingQAFile = currentFolder.children.find(file => {
            return file.name.toLowerCase().endsWith('.qa') && 
                   file.name.toLowerCase().startsWith(matchKey);
        });

        if (matchingQAFile) {
            // 4. Construct path (using fileObj URL if dynamic, or path string if static)
            const qaPath = matchingQAFile.fileObj ? 
                           URL.createObjectURL(matchingQAFile.fileObj) : 
                           matchingQAFile.path;

            // Pass the parameters to the QA Engine
            // Note: Since we are using an iframe, we pass data via URL hash or query params
            // Ideally, QA_Engine.html should read these. 
            // If you don't have QA_Engine.html ready, this might just open the frame.
            
            // For now, we assume QA_Engine.html can handle query params:
            targetUrl += `?qaFile=${encodeURIComponent(qaPath)}&title=${encodeURIComponent(matchingQAFile.name)}`;
            
            subjectDisplay.innerText = `(${matchingQAFile.name})`;
            urlDisplay.value = "Auto-loaded: " + matchingQAFile.name;
        } else {
            subjectDisplay.innerText = "(Matching .qa not found)";
            urlDisplay.value = "Manual selection required";
        }
    } else {
        subjectDisplay.innerText = "(Manual Mode)";
        urlDisplay.value = "No video active";
    }

    // Load the frame and show window
    qaFrame.src = targetUrl;
    qaHost.style.display = 'flex';
}

// 2. CLOSE FUNCTION
function closeQaWindow() {
    document.getElementById('qaHost').style.display = 'none';
}

// 3. MINIMIZE LOGIC
function minimiseQa() {
    const host = document.getElementById("qaHost");
    // Toggle a class or manually set height
    if (host.style.height === "35px") {
        host.style.height = host.dataset.prevHeight || "600px";
        host.classList.remove("qa-minimised");
    } else {
        host.dataset.prevHeight = host.style.height; // Save height
        host.style.height = "35px";
        host.classList.add("qa-minimised");
    }
}

// 4. MAXIMIZE LOGIC
let isQaMaximised = false;
let lastQaRect = { top: "80px", left: "150px", width: "500px", height: "600px" };

function toggleQaMaximise() {
    const host = document.getElementById("qaHost");
    const btn = document.getElementById("btnQaMaxRestore");

    if (!isQaMaximised) {
        // Save current state
        lastQaRect = {
            top: host.style.top,
            left: host.style.left,
            width: host.style.width,
            height: host.style.height
        };

        // Maximize
        host.style.top = "48px";
        host.style.left = "0px";
        host.style.width = "100%";
        host.style.height = "calc(100vh - 48px)";
        
        btn.innerText = "‚ùê";
        isQaMaximised = true;
    } else {
        // Restore
        host.style.top = lastQaRect.top;
        host.style.left = lastQaRect.left;
        host.style.width = lastQaRect.width;
        host.style.height = lastQaRect.height;
        
        btn.innerText = "üóñ";
        isQaMaximised = false;
    }
}

/* ================= Q&A WINDOW DRAGGING LOGIC ================= */
(function setupQaDrag() {
    const host = document.getElementById("qaHost");
    const header = document.getElementById("qaHeader");
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    header.onmousedown = function(e) {
        if(e.target.tagName === 'BUTTON') return; // Don't drag if clicking buttons
        isDragging = true;
        const rect = host.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
        
        // Bring to front
        host.style.zIndex = 16001; 
    };

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        host.style.left = (e.clientX - dragOffsetX) + 'px';
        host.style.top = (e.clientY - dragOffsetY) + 'px';
    });

    document.addEventListener('mouseup', function() {
        isDragging = false;
    });
})();

/* ================= Q&A WINDOW RESIZING LOGIC ================= */
(function setupQaResize() {
    const host = document.getElementById("qaHost");
    const handle = document.getElementById("qaResizeHandle");
    let isResizing = false;

    handle.onmousedown = function(e) {
        e.preventDefault();
        e.stopPropagation();
        isResizing = true;
        
        // Add overlay to iframe to prevent mouse capture issues while dragging
        document.getElementById('qaFrame').style.pointerEvents = 'none';

        function onMove(e) {
            if (!isResizing) return;
            const newW = e.clientX - host.getBoundingClientRect().left;
            const newH = e.clientY - host.getBoundingClientRect().top;
            
            if (newW > 300) host.style.width = newW + 'px';
            if (newH > 200) host.style.height = newH + 'px';
        }

        function onUp() {
            isResizing = false;
            document.getElementById('qaFrame').style.pointerEvents = 'auto'; // Re-enable iframe
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    };
})();
/* ================= DICTATION TOOL LOGIC ================= */

function openDictationTool() {
    const vid = document.getElementById('mainVideo');
    if(vid && !vid.paused) vid.pause(); // Pause video for better mic performance

    const host = document.getElementById('dicHost');
    const frame = document.getElementById('dicFrame');
    
    if(!frame.src || frame.src === "about:blank") {
        frame.src = "dic.html"; // Load your file
    }
    
    host.style.display = 'flex';
}

function closeDicWindow() {
    document.getElementById('dicHost').style.display = 'none';
}

function minimiseDic() {
    const host = document.getElementById("dicHost");
    if (host.style.height === "35px") {
        host.style.height = host.dataset.prevHeight || "500px";
    } else {
        host.dataset.prevHeight = host.style.height;
        host.style.height = "35px";
    }
}

let isDicMaximised = false;
let lastDicRect = { top: "90px", left: "180px", width: "600px", height: "500px" };

function toggleDicMaximise() {
    const host = document.getElementById("dicHost");
    const btn = document.getElementById("btnDicMaxRestore");

    if (!isDicMaximised) {
        lastDicRect = { top: host.style.top, left: host.style.left, width: host.style.width, height: host.style.height };
        host.style.top = "48px"; host.style.left = "0px"; host.style.width = "100%"; host.style.height = "calc(100vh - 48px)";
        btn.innerText = "‚ùê";
        isDicMaximised = true;
    } else {
        host.style.top = lastDicRect.top; host.style.left = lastDicRect.left; host.style.width = lastDicRect.width; host.style.height = lastDicRect.height;
        btn.innerText = "üóñ";
        isDicMaximised = false;
    }
}

// DRAG & RESIZE INITIALIZATION
(function initDicInteractions() {
    const host = document.getElementById("dicHost");
    const header = document.getElementById("dicHeader");
    const handle = document.getElementById("dicResizeHandle");

    // Dragging
    header.onmousedown = (e) => {
        if(e.target.tagName === 'BUTTON') return;
        let sx = e.clientX - host.offsetLeft;
        let sy = e.clientY - host.offsetTop;
        document.onmousemove = (e) => {
            host.style.left = (e.clientX - sx) + 'px';
            host.style.top = (e.clientY - sy) + 'px';
        };
        document.onmouseup = () => document.onmousemove = null;
    };

    // Resizing
    handle.onmousedown = (e) => {
        e.preventDefault();
        document.getElementById('dicFrame').style.pointerEvents = 'none'; // Prevent iframe blocking
        document.onmousemove = (e) => {
            let w = e.clientX - host.offsetLeft;
            let h = e.clientY - host.offsetTop;
            if(w > 300) host.style.width = w + 'px';
            if(h > 200) host.style.height = h + 'px';
        };
        document.onmouseup = () => {
            document.onmousemove = null;
            document.getElementById('dicFrame').style.pointerEvents = 'auto';
        };
    };
})();


/* ================= MOBILE MIRROR LOGIC ================= */
/* ================= UPDATED MOBILE MIRROR LOGIC ================= */

let isMirrorMaximised = false;
let lastMirrorRect = { top: "100px", left: "200px", width: "360px", height: "640px" };

function openMirrorBrowser() {
    const host = document.getElementById("mirrorHost");
    host.style.display = "flex";
    // Reset panels
    document.getElementById("mirrorConnectPanel").style.display = "block";
    document.getElementById("mirrorActivePanel").style.display = "none";
    
    setTimeout(() => document.getElementById('mirrorIpInput').focus(), 100);
}

function loadMirrorUrl() {
    const ipInput = document.getElementById('mirrorIpInput');
    const ip = ipInput.value.trim();
    if(!ip) return alert("Please enter the IP address");
    
    // Build URL
    const finalUrl = `http://${ip}:8080`;
    document.getElementById('mirrorWv').src = finalUrl;

    // UI SWITCH: Hide input, show "End" button
    document.getElementById("mirrorConnectPanel").style.display = "none";
    document.getElementById("mirrorActivePanel").style.display = "block";
}

function endMirrorSession() {
    // Stop the stream and reset UI
    document.getElementById('mirrorWv').src = "about:blank";
    document.getElementById("mirrorConnectPanel").style.display = "block";
    document.getElementById("mirrorActivePanel").style.display = "none";
    
    // Close window if you want it to shut completely
    closeMirrorBrowser();
}

function closeMirrorBrowser() {
    document.getElementById("mirrorHost").style.display = "none";
    document.getElementById('mirrorWv').src = "about:blank";
}

// --- Minimise/Maximise Logic ---

function minimiseMirror() {
    const host = document.getElementById("mirrorHost");
    if (host.style.height === "40px") {
        host.style.height = host.dataset.prevHeight || "640px";
    } else {
        host.dataset.prevHeight = host.style.height;
        host.style.height = "40px";
    }
}

function toggleMirrorMaximise() {
    const host = document.getElementById("mirrorHost");
    const btn = document.getElementById("btnMirrorMaxRestore");

    if (!isMirrorMaximised) {
        lastMirrorRect = { 
            top: host.style.top, left: host.style.left, 
            width: host.style.width, height: host.style.height 
        };
        host.style.top = "48px"; 
        host.style.left = "0px"; 
        host.style.width = "100%"; 
        host.style.height = "calc(100vh - 48px)";
        btn.innerText = "‚ùê";
        isMirrorMaximised = true;
    } else {
        host.style.top = lastMirrorRect.top; 
        host.style.left = lastMirrorRect.left; 
        host.style.width = lastMirrorRect.width; 
        host.style.height = lastMirrorRect.height;
        btn.innerText = "üóñ";
        isMirrorMaximised = false;
    }
}
/* ================= RE-INITIALIZE MIRROR DRAG & RESIZE ================= */
(function initMirrorInteractions() {
    const host = document.getElementById("mirrorHost");
    const header = document.getElementById("mirrorHeader");
    const handle = document.getElementById("mirrorResizeHandle");

    if (!host || !header || !handle) return; // Safety check

    // 1. Dragging Logic (Header)
    header.onmousedown = (e) => {
        // Don't drag if clicking buttons (Min, Max, Close)
        if (e.target.tagName === 'BUTTON') return;
        
        // Bring to front
        host.style.zIndex = 18001; 

        let sx = e.clientX - host.offsetLeft;
        let sy = e.clientY - host.offsetTop;

        function moveAt(e) {
            host.style.left = (e.clientX - sx) + 'px';
            host.style.top = (e.clientY - sy) + 'px';
        }

        document.addEventListener('mousemove', moveAt);
        document.onmouseup = () => {
            document.removeEventListener('mousemove', moveAt);
            document.onmouseup = null;
        };
    };

    // 2. Resizing Logic (Bottom-Right Handle)
    handle.onmousedown = (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Prevent webview from "stealing" mouse focus during resize
        document.getElementById('mirrorWv').style.pointerEvents = 'none'; 

        function resize(e) {
            let w = e.clientX - host.offsetLeft;
            let h = e.clientY - host.offsetTop;
            
            // Min bounds for mobile shape
            if (w > 200) host.style.width = w + 'px';
            if (h > 300) host.style.height = h + 'px';
        }

        function stopResize() {
            document.getElementById('mirrorWv').style.pointerEvents = 'auto';
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }

        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', stopResize);
    };
})();
function toggleWindowSticky(hostId, frameId, btnId) {
    const host = document.getElementById(hostId);
    const frame = document.getElementById(frameId);
    const btn = document.getElementById(btnId);
    const overlay = document.getElementById('overlayCanvas');
    const header = host.querySelector('[id$="Header"]'); // Finds the header automatically

    // Use a data attribute to track state per window
    const isCurrentlySticky = host.getAttribute('data-sticky') === 'true';

    if (!isCurrentlySticky) {
        // --- ACTIVATE STICKY ---
        host.setAttribute('data-sticky', 'true');
        btn.innerText = "üìç";
        btn.style.background = "#4CAF50";
        btn.style.color = "white";
        
        // 1. Lock movement
        header.style.cursor = "default";
        
        // 2. Move Board Overlay above this specific window
        // Note: browserHost is 15000, qaHost is 16000, etc. 
        // We set overlay to be 1 higher than the current host.
        const currentZ = parseInt(window.getComputedStyle(host).zIndex);
        overlay.style.zIndex = (currentZ + 1).toString();
        overlay.style.pointerEvents = "auto";
        
        // 3. Disable internal clicks so drawing works
        frame.style.pointerEvents = "none";
    } else {
        // --- DEACTIVATE STICKY ---
        host.setAttribute('data-sticky', 'false');
        btn.innerText = "üìå";
        btn.style.background = "#fff";
        btn.style.color = btn.style.color; // Keeps original theme color
        
        header.style.cursor = "move";
        
        // Reset overlay to its default background layer
        overlay.style.zIndex = "2000"; 
        overlay.style.pointerEvents = "none";
        frame.style.pointerEvents = "auto";
    }
}
/* ================= SEARCH WIDGET LOGIC ================= */

/* ================= FLOATING SEARCH BAR LOGIC ================= */

function openSearchWidget() {
    const host = document.getElementById('searchHost');
    const frame = document.getElementById('searchFrame');

    // 1. Toggle Visibility
    if (host.style.display === 'block') {
        // If already open, close it (Toggle behavior)
        closeSearchWidget();
        return;
    }

    // 2. Show the Bar (Small initial size)
    host.style.display = 'block';
    host.style.height = '45px'; // Reset to single bar height
    
    // 3. Load search.html if not ready
    if (!frame.src || frame.src === "about:blank") {
        frame.src = "search.html";
        frame.onload = () => sendDataToSearch();
    } else {
        // If already loaded, just focus it
        sendDataToSearch();
        // Tell search.html to clear previous results and focus input
        frame.contentWindow.postMessage({ action: 'FOCUS_INPUT' }, '*');
    }
}

function closeSearchWidget() {
    const host = document.getElementById('searchHost');
    host.style.display = 'none';
    host.style.height = '45px'; // Reset size
}

function resizeSearchWidget(height) {
    const host = document.getElementById('searchHost');
    const frame = document.getElementById('searchFrame');
    
    // Cap the max height so it doesn't go off-screen
    const maxHeight = window.innerHeight - 20; 
    const finalHeight = Math.min(height, maxHeight);
    
    host.style.height = finalHeight + 'px';
    
    // Optional: Adjust border radius if it expands
    if (finalHeight > 60) {
        frame.style.borderRadius = "20px"; // Box look
    } else {
        frame.style.borderRadius = "25px"; // Pill look
    }
}

// ================= LISTENER FOR SEARCH.HTML =================
window.addEventListener('message', function(event) {
    const data = event.data;
    if (!data || !data.action) return;

    // 1. RESIZE COMMAND (New!)
    if (data.action === 'RESIZE') {
        resizeSearchWidget(data.height);
    }

    // 2. OPEN FILE COMMAND
    if (data.action === 'OPEN_FILE') {
        // Find and open file (Logic from previous step)
        const fileNode = findNodeByPath(LIBRARY_DATA, data.path);
        if (fileNode) {
            // Close search bar to get it out of the way
            //closeSearchWidget();
            
            // Open the file
            if (fileNode.type === 'folder') {
                openFolder(fileNode);
            } else if (fileNode.name.endsWith('.pdf')) {
                openInRightPanel('pdf', fileNode.path, 1);
            } else if (fileNode.name.match(/\.(mp4|webm|enc)$/)) {
                playSecureVideo(fileNode.path);
            } else {
                // Generic open
                 openInRightPanel('html', `<iframe src="${fileNode.path}" style="width:100%;height:100%;border:none;"></iframe>`);
            }
        }
    }

    // 3. CLOSE COMMAND
    if (data.action === 'CLOSE_WIDGET') {
        closeSearchWidget();
    }
	// 4. VIDEO CONTROL COMMANDS (New)
    if (data.action === 'VIDEO_COMMAND') {
        handleVideoVoiceCommand(data.command);
    }
});

function sendDataToSearch() {
    const frame = document.getElementById('searchFrame');
    
    // Determine what is currently visible
    // If currentFolder is null, we assume we are at root or empty
    let currentItems = [];
    if (currentFolder && currentFolder.children) {
        // (Simple fallback: send all children of current folder)
        // ideally loadFolderUI handles the filtering, but for init we send raw children
        currentItems = currentFolder.children.map(c => ({
            name: c.name, path: c.path, type: c.type
        }));
    } else if (typeof LIBRARY_DATA !== 'undefined') {
        currentItems = LIBRARY_DATA.children.map(c => ({
             name: c.name, path: c.path, type: c.type
        }));
    }

    frame.contentWindow.postMessage({
        type: 'INIT_DATA',
        contextItems: currentItems // Send LOCAL items, not global library
    }, '*');
}

// Recursion helper (same as before)
function findNodeByPath(root, path) {
    if (root.path === path) return root;
    if (root.children) {
        for (let child of root.children) {
            const found = findNodeByPath(child, path);
            if (found) return found;
        }
    }
    return null;
}
// ================= DRAG LOGIC FOR SEARCH WIDGET =================
(function initSearchDrag() {
    const host = document.getElementById("searchHost");
    const header = document.getElementById("searchHeader");
    let isDragging = false;
    let dragOffsetX = 0, dragOffsetY = 0;
	if (!host || !header) return;

    header.onmousedown = (e) => {
        if(e.target.tagName === 'BUTTON') return;
        isDragging = true;
        const rect = host.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
        host.style.zIndex = 20000; // Bring to absolute front
    };

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        host.style.left = (e.clientX - dragOffsetX) + 'px';
        host.style.top = (e.clientY - dragOffsetY) + 'px';
    });

    document.addEventListener('mouseup', () => isDragging = false);
})();

function handleVideoVoiceCommand(cmd) {
    const vid = document.getElementById('mainVideo');
    // If no video is active, ignore (or maybe show a message)
    if (!vid || document.getElementById('videoPlayerArea').style.display === 'none') {
        console.log("No video playing to control.");
        return;
    }

    cmd = cmd.toLowerCase();

    // --- PAUSE / PLAY ---
    if (cmd.includes('pause') || cmd.includes('hold') || cmd.includes('wait')) {
        controlVideo('pause');
        showVideoFeedback("‚è∏ Paused");
    }
    else if (cmd.includes('play') || cmd.includes('resume') || cmd.includes('start') || cmd.includes('go')) {
        controlVideo('play');
        showVideoFeedback("‚ñ∂ Resumed");
    }
    
    // --- STOP / CLOSE ---
    else if (cmd.includes('stop') || cmd.includes('close') || cmd.includes('exit')) {
        controlVideo('stop'); // This closes the player
        showVideoFeedback("‚èπ Stopped");
    }

    // --- VOLUME CONTROL ---
    else if (cmd.includes('volume') || cmd.includes('sound')) {
        let currentVol = vid.volume;
        
        if (cmd.includes('up') || cmd.includes('increase') || cmd.includes('high') || cmd.includes('more')) {
            vid.volume = Math.min(1.0, currentVol + 0.2);
            showVideoFeedback("üîä Vol: " + Math.round(vid.volume * 100) + "%");
        } 
        else if (cmd.includes('down') || cmd.includes('decrease') || cmd.includes('low') || cmd.includes('less')) {
            vid.volume = Math.max(0.0, currentVol - 0.2);
            showVideoFeedback("üîâ Vol: " + Math.round(vid.volume * 100) + "%");
        }
        else if (cmd.includes('mute') || cmd.includes('silent')) {
            vid.volume = 0;
            showVideoFeedback("üîá Muted");
        }
        
        // Sync the slider UI
        const slider = document.querySelector('.vol-slider');
        if(slider) slider.value = vid.volume;
    }

    // --- SPEED CONTROL ---
    else if (cmd.includes('speed') || cmd.includes('fast') || cmd.includes('slow')) {
        let currentSpeed = vid.playbackRate;

        if (cmd.includes('increase') || cmd.includes('fast') || cmd.includes('up')) {
            vid.playbackRate = Math.min(2.0, currentSpeed + 0.25);
        } 
        else if (cmd.includes('decrease') || cmd.includes('slow') || cmd.includes('down')) {
            vid.playbackRate = Math.max(0.25, currentSpeed - 0.25);
        }
        else if (cmd.includes('normal') || cmd.includes('reset')) {
            vid.playbackRate = 1.0;
        }

        showVideoFeedback("‚ö° Speed: " + vid.playbackRate + "x");
        
        // Sync UI
        document.getElementById('speedSlider').value = vid.playbackRate;
        document.getElementById('speedDisplay').innerText = vid.playbackRate + "x";
    }
    
    // --- SEEKING ---
    else if (cmd.includes('forward') || cmd.includes('skip')) {
        vid.currentTime += 10;
        showVideoFeedback("‚è© +10s");
    }
    else if (cmd.includes('back') || cmd.includes('rewind')) {
        vid.currentTime -= 10;
        showVideoFeedback("‚è™ -10s");
    }
}

// Helper for Visual Feedback on Video
function showVideoFeedback(text) {
    const f = document.getElementById('vidFeedback');
    if (f) {
        f.innerText = text;
        f.style.opacity = '1';
        setTimeout(() => f.style.opacity = '0', 1000);
    }
}


/* ================= CALCULATOR CONTROL & DRAG LOGIC ================= */
function openCalculator() {
    document.getElementById('calcHost').style.display = 'flex';
}

function closeCalculator() {
    document.getElementById('calcHost').style.display = 'none';
}

function minimiseCalc() {
    const host = document.getElementById('calcHost');
    if (host.style.height === "35px") {
        host.style.height = host.dataset.prevH || "480px";
    } else {
        host.dataset.prevH = host.style.height;
        host.style.height = "35px";
    }
}

function toggleCalcScientific() {
    const host = document.getElementById('calcHost');
    const btn = document.getElementById('btnCalcExpand');
    const frame = document.getElementById('calcFrame');
    
    if (host.style.width === "350px" || host.style.width === "") {
        host.style.width = "650px"; // Expand for scientific
        btn.innerText = "üî¢";
        frame.contentWindow.postMessage('toggle-scientific', '*');
    } else {
        host.style.width = "350px"; // Shrink to normal
        btn.innerText = "üî¨";
        frame.contentWindow.postMessage('toggle-normal', '*');
    }
}

// GUARANTEED DRAG LOGIC
(function initCalcInteractions() {
    const host = document.getElementById("calcHost");
    const header = document.getElementById("calcHeader");
    const frame = document.getElementById("calcFrame");
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    if (!host || !header) return; 

    header.addEventListener('mousedown', (e) => {
        // Stop if clicking a button (like minimize/close) or if pinned (sticky)
        if(e.target.tagName === 'BUTTON' || host.getAttribute('data-sticky') === 'true') return;
        
        isDragging = true;
        
        // Bring to front
        host.style.zIndex = 19001; 
        
        // Prevent iframe from swallowing mouse movements
        if(frame) frame.style.pointerEvents = 'none'; 

        // Calculate offset based on viewport to prevent jumping
        const rect = host.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        host.style.left = (e.clientX - dragOffsetX) + 'px';
        host.style.top = (e.clientY - dragOffsetY) + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            // Re-enable iframe clicks after dropping
            if(frame) frame.style.pointerEvents = 'auto'; 
        }
    });
})();

/* === GRAPH PLOTTER CONTROLS === */
function openGraph() { document.getElementById('graphHost').style.display = 'flex'; }
function closeGraph() { document.getElementById('graphHost').style.display = 'none'; }

// Initialize Dragging (Using the universal function we added earlier)
setupDraggableWindow('graphHost', 'graphHeader', 'graphFrame');

// Initialize Resizing for Graph Window
(function setupGraphResize() {
    const host = document.getElementById("graphHost");
    const handle = document.getElementById("graphResizeHandle");
    const frame = document.getElementById("graphFrame");
    let isResizing = false;

    if(!handle) return;

    handle.onmousedown = function(e) {
        e.preventDefault(); e.stopPropagation();
        isResizing = true;
        frame.style.pointerEvents = 'none'; // Prevent iframe from stealing mouse

        function onMove(e) {
            if (!isResizing) return;
            const newW = e.clientX - host.getBoundingClientRect().left;
            const newH = e.clientY - host.getBoundingClientRect().top;
            if (newW > 300) host.style.width = newW + 'px';
            if (newH > 250) host.style.height = newH + 'px';
        }

        function onUp() {
            isResizing = false;
            frame.style.pointerEvents = 'auto';
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    };
})();

// Add this at the very end of your Index.html script block, 
// ensuring it is NOT inside another function.

async function launchDhwaniSnip() {
    console.log("Dhwani Snip Started...");
    
    // 1. Pause Video
    const vid = document.getElementById('mainVideo');
    if (vid && !vid.paused) vid.pause();

    try {
        // 2. Capture Screen (Native Window Picker)
        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: "never", displaySurface: "browser" },
            audio: false
        });

        const track = stream.getVideoTracks()[0];
        const capture = new ImageCapture(track);
        const bitmap = await capture.grabFrame();
        track.stop(); // Close the "Sharing" bar immediately

        // 3. Create a canvas to process the image
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap, 0, 0);

        // 4. SMART CROP (Optional but recommended)
        // Since you want to ignore toolbars, we can theoretically crop the top 48px
        // But it's safer to send the whole image and use the System Instruction.
        const screenshotData = canvas.toDataURL('image/jpeg', 0.7);

        // 5. PDF Context Extraction
        let pdfText = "";
        try {
            if (window.pdfDoc && window.rightPanelState > 0) {
                const page = await window.pdfDoc.getPage(window.currentPdfPageIndex + 1);
                const textContent = await page.getTextContent();
                pdfText = textContent.items.map(s => s.str).join(' ');
            }
        } catch (e) { console.warn("PDF Context failed", e); }

        // 6. Store and Open
        localStorage.setItem('snip_image', screenshotData);
        localStorage.setItem('snip_text_context', pdfText);
        
        // Trigger the widget UI
        const widget = document.getElementById('dhwaniChatWidget');
        const iframe = document.getElementById('dhwaniFrame');
        
        // Use a timestamp to force the iframe to reload fresh data
        iframe.src = "dhwanisnip.html?v=" + Date.now(); 
        widget.style.display = 'flex';

    } catch (err) {
        console.error("Capture failed:", err);
        alert("Permission denied or capture cancelled.");
    }
}
}

</script>


</html>
