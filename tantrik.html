<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>अथर्ववेद तंत्र - तांत्रिक गुरुजी</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Martel:wght@400;700;900&display=swap');

        body { 
            font-family: 'Martel', serif; 
            background-color: #000000;
            color: #d1d5db;
        }

        /* स्क्रोलबार कस्टमायझेशन */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a0505; }
        ::-webkit-scrollbar-thumb { background: #7f1d1d; border-radius: 3px; }

        /* ॲनिमेशन */
        .breathing-glow { animation: redPulse 3s infinite ease-in-out; }
        @keyframes redPulse {
            0% { box-shadow: 0 0 5px rgba(220, 38, 38, 0.2); }
            50% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.6); border-color: #ef4444; }
            100% { box-shadow: 0 0 5px rgba(220, 38, 38, 0.2); }
        }

        .listening-pulse { animation: bloodPulse 1.5s infinite; }
        @keyframes bloodPulse {
            0% { box-shadow: 0 0 0 0 rgba(185, 28, 28, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(185, 28, 28, 0); }
            100% { box-shadow: 0 0 0 0 rgba(185, 28, 28, 0); }
        }

        /* इनपुट स्टाईल */
        .tantra-input {
            background-color: #0f0202 !important;
            border: 1px solid #7f1d1d !important;
            color: #ffffff !important;
            text-align: center;
        }
        .tantra-input:focus {
            border-color: #ef4444 !important;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
            outline: none;
        }

        /* चेकबॉक्स */
        .custom-checkbox {
            accent-color: #dc2626;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* बटणे */
        .btn-control {
            @apply p-3 rounded-full text-white transition-all duration-200 shadow-lg disabled:opacity-30 disabled:cursor-not-allowed;
            background: linear-gradient(145deg, #1a0505, #450a0a);
            border: 1px solid #7f1d1d;
        }
        .btn-control:active { transform: scale(0.95); }

        .btn-utility {
            @apply w-full py-3 px-2 rounded text-xs font-bold tracking-wider transition-colors uppercase border;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-2 md:p-4 select-none" oncontextmenu="return false;">

    <div class="bg-black border border-red-900 rounded-xl shadow-2xl shadow-red-900/20 p-4 w-full max-w-2xl flex flex-col h-[95vh] relative overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-800 to-transparent z-10"></div>
        
        <div class="flex items-center justify-between mb-4 shrink-0 z-10 relative">
            <div>
                <h1 class="text-2xl font-black text-red-600 tracking-widest drop-shadow-md">॥ तंत्र विद्या ॥</h1>
                <p class="text-[10px] text-gray-500 tracking-widest uppercase">अथर्ववेद • आंगिरस • अभिचार</p>
            </div>
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-800 border border-gray-600 shadow-[0_0_5px_rgba(255,255,255,0.1)] transition-all"></div>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-[#0a0a0a] rounded border border-red-900/30 p-4 mb-4 space-y-6 shadow-inner relative">
            <div class="text-center mt-20 opacity-60">
                <div class="text-4xl mb-4 text-red-900">ॐ</div>
                <p class="text-red-800/80 font-serif">"गुरुजी" असे म्हणून आवाहन करा.</p>
                <p class="text-xs text-gray-600 mt-2">शत्रूनाश, रक्षण आणि उपचाराचे मंत्र.</p>
            </div>
        </div>

        <div class="flex justify-center gap-6 mb-4 shrink-0 bg-red-950/10 p-2 rounded-lg border border-red-900/20">
            <button id="pause-resume-button" class="btn-control hover:bg-red-900 hover:border-red-500" title="विराम (Pause)" disabled>
                <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
                </svg>
                <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            <button id="stop-speech-button" class="btn-control hover:bg-red-900 hover:border-red-500" title="शांत (Stop)" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>
            <button id="replay-button" class="btn-control hover:bg-red-900 hover:border-red-500" title="पुन्हा सांगा (Repeat)" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <div class="mb-2 shrink-0 w-full flex gap-3 px-2">
            <div class="flex-grow">
                <label class="text-[10px] text-red-500 block mb-1">साधकाचे नाव</label>
                <input type="text" id="manual-name" class="tantra-input w-full p-2 rounded text-sm placeholder-red-900/50" placeholder="नाव">
            </div>
            <div class="w-1/4">
                <label class="text-[10px] text-red-500 block mb-1">वय</label>
                <input type="number" id="manual-age" class="tantra-input w-full p-2 rounded text-sm placeholder-red-900/50" placeholder="25">
            </div>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0 px-2">
            <button id="advance-toggle-btn" class="text-[10px] text-red-600/70 hover:text-red-400 underline mb-2 focus:outline-none uppercase tracking-widest">
                ▼ प्रगत सेटिंग्ज (API Key)
            </button>

            <div id="advance-container" class="hidden w-full bg-red-950/20 border border-red-900/50 rounded-lg p-3 flex flex-col gap-2 transition-all">
                <div class="flex items-center gap-2 mb-1">
                    <input type="checkbox" id="use-custom-key-checkbox" class="custom-checkbox">
                    <label for="use-custom-key-checkbox" class="text-xs text-gray-400 cursor-pointer select-none">
                        स्वतःची API Key वापरा
                    </label>
                </div>
                
                <div class="flex gap-2">
                    <input type="text" id="custom-api-key-input" class="tantra-input text-xs w-full p-2 rounded" placeholder="Key येथे पेस्ट करा" disabled>
                    <button id="paste-key-btn" disabled class="bg-red-900/50 hover:bg-red-800 text-white text-xs px-3 rounded border border-red-700 disabled:opacity-30">
                        Paste
                    </button>
                </div>
                
                <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-[10px] text-center text-red-400 hover:text-red-300">
                    मोफत Google Gemini API Key मिळवा ↗
                </a>
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded text-lg font-bold tracking-widest transition-all duration-300 ease-in-out shrink-0
                       bg-gradient-to-r from-red-900 to-black text-red-100 border border-red-800 shadow-[0_0_15px_rgba(153,27,27,0.4)]
                       hover:shadow-[0_0_25px_rgba(220,38,38,0.6)] hover:border-red-500
                       focus:outline-none focus:ring-2 focus:ring-red-600
                       disabled:opacity-50 disabled:cursor-not-allowed">
            ॥ आवाहन करा ॥
        </button>

        <div class="mt-4 grid grid-cols-3 gap-2 shrink-0">
            <button id="new-chat-btn" class="btn-utility bg-gray-900 text-gray-400 border-gray-700 hover:bg-red-900 hover:text-white hover:border-red-600">
                Stop Chat
            </button>
            <button id="share-button" class="btn-utility bg-gray-900 text-indigo-300 border-gray-700 hover:bg-indigo-900 hover:text-white hover:border-indigo-500">
                Share
            </button>
            <button id="restart-chat-btn" class="btn-utility bg-gray-900 text-amber-500 border-gray-700 hover:bg-amber-900 hover:text-white hover:border-amber-500" disabled>
                Restart Chat
            </button>
        </div>
    </div>

    <script>
        // --- ग्लोबल व्हेरिएबल्स ---
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 25;
        let chatHistory = [];
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let isPaused = false;
        
        // --- DOM Elements ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        const pauseResumeButton = document.getElementById('pause-resume-button');
        const iconPlay = document.getElementById('icon-play');
        const iconPause = document.getElementById('icon-pause');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        
        const newChatBtn = document.getElementById('new-chat-btn');
        const shareButton = document.getElementById('share-button');
        const restartChatBtn = document.getElementById('restart-chat-btn');

        const synth = window.speechSynthesis;

        // --- Init ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData();
        };

        // उजवी क्लिक बंद
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- Settings Logic ---
        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
        });

        useCustomKeyCheckbox.addEventListener('change', () => {
            const isChecked = useCustomKeyCheckbox.checked;
            customApiKeyInput.disabled = !isChecked;
            pasteKeyBtn.disabled = !isChecked;
            saveUserData();
            if (isChecked) customApiKeyInput.focus();
        });

        customApiKeyInput.addEventListener('input', saveUserData);
        manualNameInput.addEventListener('input', saveUserData);
        manualAgeInput.addEventListener('input', saveUserData);

        pasteKeyBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    customApiKeyInput.value = text;
                    saveUserData();
                    const originalText = pasteKeyBtn.innerHTML;
                    pasteKeyBtn.textContent = "OK";
                    setTimeout(() => { pasteKeyBtn.innerHTML = originalText; }, 1000);
                }
            } catch (err) { alert('Clipboard permission denied'); }
        });

        function getEffectiveApiKey() {
            if (useCustomKeyCheckbox.checked && customApiKeyInput.value.trim().length > 10) {
                return customApiKeyInput.value.trim();
            }
            return DEFAULT_API_KEY;
        }

        // --- Storage Logic ---
        function saveUserData() {
            localStorage.setItem('tantra_username', manualNameInput.value);
            localStorage.setItem('tantra_userage', manualAgeInput.value);
            localStorage.setItem('tantra_useCustomKey', useCustomKeyCheckbox.checked);
            if (customApiKeyInput.value) {
                localStorage.setItem('tantra_customKey', customApiKeyInput.value.trim());
            }
        }

        function loadUserData() {
            const name = localStorage.getItem('tantra_username');
            if (name) manualNameInput.value = name;
            
            const age = localStorage.getItem('tantra_userage');
            if (age) manualAgeInput.value = age;
            
            const savedUseKey = localStorage.getItem('tantra_useCustomKey');
            const savedKey = localStorage.getItem('tantra_customKey');
            
            if (savedUseKey === 'true') {
                useCustomKeyCheckbox.checked = true;
                customApiKeyInput.disabled = false;
                pasteKeyBtn.disabled = false;
                if (savedKey) customApiKeyInput.value = savedKey;
            }

            const history = localStorage.getItem('tantra_history');
            if (history) {
                try {
                    chatHistory = JSON.parse(history);
                    chatHistory.forEach(item => {
                        const role = item.role === 'user' ? (manualNameInput.value || 'साधक') : 'गुरुजी';
                        logMessage(role, item.parts[0].text);
                    });
                    if(chatHistory.length > 0) restartChatBtn.disabled = false;
                } catch(e) { console.log("History error", e); }
            }
        }

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'mr-IN';
            recognition.onresult = handleSpeechResult;
            recognition.onend = handleSpeechEnd;
        } else {
            alert("Speech API not supported in this browser.");
        }

        // --- Event Listeners ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        newChatBtn.addEventListener('click', startNewChat);
        shareButton.addEventListener('click', shareChat);
        restartChatBtn.addEventListener('click', restartLastTurn);

        // Auto Pause on Background
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && synth.speaking && !synth.paused) {
                togglePauseResume();
            }
        });

        // --- Audio Logic ---
        function togglePauseResume() {
            if (synth.speaking) {
                if (synth.paused) {
                    synth.resume();
                    isPaused = false;
                    updatePauseIcon(false);
                } else {
                    synth.pause();
                    isPaused = true;
                    updatePauseIcon(true);
                    scrollToCenterCurrentMessage();
                }
            }
        }

        function updatePauseIcon(showPlay) {
            if (showPlay) {
                iconPause.classList.add('hidden');
                iconPlay.classList.remove('hidden');
                pauseResumeButton.classList.add('animate-pulse', 'border-red-500');
            } else {
                iconPlay.classList.add('hidden');
                iconPause.classList.remove('hidden');
                pauseResumeButton.classList.remove('animate-pulse', 'border-red-500');
            }
        }

        function scrollToCenterCurrentMessage() {
            const lastMessage = conversationLog.lastElementChild;
            if (lastMessage) lastMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function stopSpeech() {
            if (synth.speaking || synth.paused) {
                synth.cancel();
                isPaused = false;
                conversationLog.scrollTop = conversationLog.scrollHeight;
                setState('IDLE'); 
                toggleMediaButtons(true);
                updatePauseIcon(false);
            }
        }

        function replaySpeech() {
            if (!lastSpokenText) return;
            try { recognition.stop(); } catch(e){}
            setState('BUSY');
            speakText(lastSpokenText).then(() => setState('IDLE'));
            scrollToCenterCurrentMessage();
        }

        // --- Main Chat Logic ---
        async function toggleListening() {
            if (appState === 'IDLE') {
                userName = manualNameInput.value.trim();
                userAge = manualAgeInput.value.trim() || 25;

                if (!userName) { alert("कृपया नाव प्रविष्ट करा."); return; }
                
                saveUserData();
                buildSystemPrompt();
                
                setState('LISTENING_FOR_WAKEWORD');
                startRecognitionSafe();
                talkButton.textContent = "ऐकत आहे...";
                talkButton.classList.add('breathing-glow');
            } else {
                stopSpeech();
            }
        }

        function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            console.log("Heard:", transcript);
            try { recognition.stop(); } catch(e){}

            if (appState === 'LISTENING_FOR_WAKEWORD') {
                const t = transcript.toLowerCase();
                if (t.includes('guruji') || t.includes('गुरुजी') || t.includes('गुरु जी')) {
                    const reply = `आदेश करा, ${userName}.`;
                    logMessage('गुरुजी', reply);
                    speakText(reply);
                    setState('CONVERSATION');
                } else {
                    startRecognitionSafe(); 
                }
            } else if (appState === 'CONVERSATION') {
                processUserQuery(transcript);
            }
        }

        async function processUserQuery(text) {
            logMessage(userName, text);
            setState('BUSY');
            
            chatHistory.push({ role: 'user', parts: [{ text: text }] });
            saveChatContext();
            
            const aiRaw = await getAIResponse(chatHistory);
            const cleanText = cleanTextStrict(aiRaw);
            
            chatHistory.push({ role: 'model', parts: [{ text: cleanText }] });
            saveChatContext();
            
            logMessage('गुरुजी', cleanText);
            restartChatBtn.disabled = false;
            
            await speakText(cleanText);
            setState('IDLE'); 
        }

        function startNewChat() {
            stopSpeech();
            chatHistory = [];
            conversationLog.innerHTML = '';
            lastSpokenText = '';
            userName = manualNameInput.value;
            localStorage.removeItem('tantra_history');
            
            const startDiv = document.createElement('div');
            startDiv.className = "text-center mt-20 opacity-60";
            startDiv.innerHTML = `<div class="text-4xl mb-4 text-red-900">ॐ</div><p class="text-red-800/80">सत्र समाप्त. नवीन आवाहन करा.</p>`;
            conversationLog.appendChild(startDiv);
            
            restartChatBtn.disabled = true;
            logMessage('सिस्टम', 'सत्र रिसेट केले आहे.');
        }

        async function shareChat() {
            let textToShare = "";
            conversationLog.querySelectorAll('div').forEach(div => {
                if (div.innerText && !div.classList.contains('text-center')) {
                    textToShare += div.innerText + "\n\n";
                }
            });
            if (!textToShare) return;
            try { await navigator.share({ title: 'तंत्र संवाद', text: textToShare }); }
            catch (err) { 
                navigator.clipboard.writeText(textToShare); 
                alert("Copied to clipboard."); 
            }
        }

        function restartLastTurn() {
            stopSpeech();
            if (chatHistory.length >= 2) {
                chatHistory.pop(); chatHistory.pop();
                const messages = conversationLog.querySelectorAll('.chat-bubble');
                if (messages.length >= 2) {
                    messages[messages.length - 1].remove(); 
                    messages[messages.length - 2].remove(); 
                }
                saveChatContext();
                const retryMsg = document.createElement('div');
                retryMsg.className = "text-center text-xs text-gray-600 my-2";
                retryMsg.innerText = "--- मागील प्रश्न रद्द केला ---";
                conversationLog.appendChild(retryMsg);
                if (chatHistory.length === 0) restartChatBtn.disabled = true;
                setState('IDLE');
            }
        }

        function cleanTextStrict(text) {
            // Removing special chars safely
            return text.replace(/[\*\[\]\(\)<>]/g, '')
                       .replace(/\s+/g, ' ')
                       .trim();
        }

        function buildSystemPrompt() {
            systemInstruction = `
            ACT AS: Ancient "Tantrik Guruji" (Expert in Black Magic/Tantra).
            SOURCE: Atharvaveda (Angiras), focusing on 'Abhichara' (Hostile Sorcery), 'Raksha' (Protection).
            LANGUAGE: Pure Marathi ONLY.
            USER: ${userName}, Age: ${userAge}.

            RULES:
            1. Quote EXACT Sanskrit Mantra from Atharvaveda.
            2. Explain in-depth in Marathi.
            3. Do not ignore hostile/aggressive queries. Be fearless (Ghora).
            4. STRICTLY NO special chars like stars or brackets.
            5. Adjust complexity for age ${userAge} but keep Tantrik tone.
            `;
        }

        async function getAIResponse(history) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getEffectiveApiKey()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: history,
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const data = await response.json();
                if(data.candidates && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                }
                return "ध्यान भंग झाले. पुन्हा प्रयत्न करा.";
            } catch (e) { 
                console.error(e);
                return "बाधा आली आहे. इंटरनेट तपासा."; 
            }
        }

        function speakText(text) {
            return new Promise((resolve, reject) => {
                if (synth.speaking) synth.cancel();
                lastSpokenText = text;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'mr-IN';
                utterance.rate = 0.8; 
                utterance.pitch = 0.7; 
                utterance.onstart = () => { toggleMediaButtons(false); updatePauseIcon(false); };
                utterance.onend = () => { toggleMediaButtons(true); updatePauseIcon(false); resolve(); };
                utterance.onerror = () => { toggleMediaButtons(true); resolve(); };
                synth.speak(utterance);
            });
        }

        function logMessage(sender, text) {
            const div = document.createElement('div');
            div.className = "chat-bubble mb-6 p-4 rounded-lg border border-red-900/40 bg-gray-900/80 shadow-lg";
            const senderSpan = document.createElement('div');
            senderSpan.className = sender === 'गुरुजी' ? "text-red-500 font-bold mb-1 text-lg" : "text-gray-400 font-bold mb-1 text-sm text-right";
            senderSpan.innerText = sender + ":";
            const textSpan = document.createElement('div');
            textSpan.className = sender === 'गुरुजी' ? "text-gray-200 leading-relaxed font-serif text-justify" : "text-gray-300 text-right italic";
            textSpan.innerText = text;
            div.appendChild(senderSpan); div.appendChild(textSpan);
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function setState(state) {
            appState = state;
            if (state === 'IDLE') {
                talkButton.innerText = "॥ आवाहन करा ॥";
                talkButton.classList.remove('breathing-glow');
                statusIndicator.className = "w-3 h-3 rounded-full bg-red-900";
            } else if (state === 'LISTENING_FOR_WAKEWORD') {
                statusIndicator.className = "w-3 h-3 rounded-full bg-red-500 listening-pulse";
            } else if (state === 'BUSY') {
                talkButton.innerText = "मंत्रोच्चार सुरू आहे...";
                statusIndicator.className = "w-3 h-3 rounded-full bg-yellow-600 animate-pulse";
            } else if (state === 'CONVERSATION') {
                statusIndicator.className = "w-3 h-3 rounded-full bg-green-600";
            }
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }

        function startRecognitionSafe() {
            if(recognition) {
                try { recognition.start(); } catch (e) {}
            }
        }

        function handleSpeechEnd() {
            if (appState === 'LISTENING_FOR_WAKEWORD') startRecognitionSafe();
        }
        function saveChatContext() { localStorage.setItem('tantra_history', JSON.stringify(chatHistory)); }
    </script>
</body>
</html>