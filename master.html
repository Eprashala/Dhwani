<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani - Comprehensive Aptitude Center</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; max-width: 1000px; width: 100%; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Layouts */
        .screen { display: none; flex-direction: column; height: 90vh; }
        .active-screen { display: flex; }
        
        /* Setup Screen */
        #setup-screen { padding: 40px; text-align: center; justify-content: center; }
        .input-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px; }
        #setup-screen input { width: 45%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        #setup-screen input[type="password"] { width: 93%; }
        button { background: #2980b9; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background: #1c5980; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        
        /* Test Screen */
        .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        #stage-indicator { background: #f39c12; padding: 5px 10px; border-radius: 4px; font-size: 14px; font-weight: bold; }
        
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .video-panel { width: 30%; background: #000; position: relative; display: flex; flex-direction: column; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        .recording-badge { position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.8); color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .interaction-panel { width: 70%; display: flex; flex-direction: column; border-left: 1px solid #eee; position: relative; }
        #chat-history, #consult-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 85%; padding: 12px 18px; border-radius: 8px; line-height: 1.5; font-size: 15px; }
        .bot-msg { background: #e3f2fd; color: #0d47a1; align-self: flex-start; border-bottom-left-radius: 0; }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; }
        .system-msg { background: #fff3cd; color: #856404; font-size: 13px; text-align: center; margin: 10px auto; border-radius: 4px; padding: 8px; width: 80%; }
        
        .controls-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .controls-area input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        
        #loading { display: none; position: absolute; bottom: 80px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        
        /* Final Report Screen */
        #report-screen { padding: 40px; overflow-y: auto; background: white; }
        .report-header { text-align: center; border-bottom: 2px solid #2980b9; padding-bottom: 20px; margin-bottom: 30px; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .consultation-box { margin-top: 30px; border: 2px dashed #2980b9; border-radius: 8px; display: flex; flex-direction: column; height: 400px; }
        .consultation-header { background: #2980b9; color: white; padding: 10px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen" class="screen active-screen">
        <h2>Dhwani Comprehensive Aptitude Center</h2>
        <p>Expert career mapping for the youth of India.</p>
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key" required>
            <input type="text" id="childName" placeholder="Student's Name" required>
            <input type="number" id="childAge" placeholder="Age" required>
            <input type="text" id="childCity" placeholder="City/Town (e.g., Mumbai, Delhi)" required>
            <input type="text" id="childLanguage" placeholder="Preferred Language Context" value="English">
        </div>
        <button onclick="startTest()">Initialize Session</button>
    </div>

    <div id="test-screen" class="screen">
        <div class="header">
            <span id="test-header">Active Session</span>
            <span id="stage-indicator">Stage 1: Icebreaker</span>
        </div>
        <div class="main-content">
            <div class="video-panel">
                <div class="recording-badge">REC (Auto-Saving)</div>
                <video id="webcam" autoplay muted playsinline></video>
                <button style="border-radius: 0; background: #e74c3c; width: 100%; margin-top: auto;" onclick="generateReportEarly()">Generate Report Early</button>
            </div>
            <div class="interaction-panel">
                <div id="chat-history"></div>
                <div id="loading">Dhwani is analyzing...</div>
                <div class="controls-area">
                    <input type="text" id="userInput" placeholder="Type your answer..." onkeypress="handleEnter(event, submitAnswer)">
                    <button id="sendBtn" onclick="submitAnswer()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div id="report-screen" class="screen">
        <div class="report-header">
            <h1 style="color: #2980b9;">Comprehensive Career Map</h1>
            <h3 id="report-name-age"></h3>
        </div>
        <div id="report-body"></div>
        
        <div class="consultation-box">
            <div class="consultation-header">Ask Dhwani: Carrier & Course Consultation</div>
            <div id="consult-history">
                <div class="message bot-msg">The test is complete. You can now ask me about specific universities, required percentages, or ask for YouTube/Udemy course recommendations to build your skills!</div>
            </div>
            <div class="controls-area" style="border-top: none;">
                <input type="text" id="consultInput" placeholder="Ask about colleges, streams, or courses..." onkeypress="handleEnter(event, submitConsult)">
                <button id="consultBtn" onclick="submitConsult()">Ask AI</button>
            </div>
        </div>
        <center><button onclick="location.reload()" style="margin-top: 30px; background: #e74c3c;">Close Session & Clear Data</button></center>
    </div>
</div>

<script>
    // System State
    let mediaRecorder;
    let streamReference;
    let videoChunkTimer;
    let chunkCounter = 1;
    
    let childData = { name: "", age: 0, city: "" };
    let apiKey = "";
    
    // Stages Progression
    const stages = [
        "Icebreaker & Local Context",
        "Logical Reasoning (Thinking Power)",
        "Numerical Ability (Number Intelligence)",
        "Verbal Ability (Language Skills)",
        "Spatial Ability (Visual Thinking)",
        "Mechanical / Technical Aptitude",
        "Abstract Reasoning",
        "Personality & Interests",
        "Situational Judgment",
        "Final Career Mapping"
    ];
    let currentStageIndex = 0;
    let maxQuestionsPerStage = 2; // Adjust for test length
    let questionCountInStage = 0;
    
    let conversationHistory = []; // Main test history
    let consultHistory = [];      // Post-test chat history

    // Auto-load API key if previously saved
    window.onload = () => {
        if(localStorage.getItem('gemini_api_key')) {
            document.getElementById('apiKey').value = localStorage.getItem('gemini_api_key');
        }
    };

    async function startTest() {
        apiKey = document.getElementById('apiKey').value.trim();
        childData.name = document.getElementById('childName').value.trim();
        childData.age = parseInt(document.getElementById('childAge').value);
        childData.city = document.getElementById('childCity').value.trim();

        if(!apiKey || !childData.name || !childData.age) return alert("Fill all fields.");
        
        localStorage.setItem('gemini_api_key', apiKey); // Persist Key

        document.getElementById('setup-screen').classList.remove('active-screen');
        document.getElementById('test-screen').classList.add('active-screen');
        document.getElementById('test-header').innerText = `Proctoring: ${childData.name}`;

        await initRollingCamera();
        
        conversationHistory.push({ role: "user", parts: [{ text: "Initialize the psychometric assessment. Start with the Icebreaker." }] });
        
        document.getElementById('loading').style.display = 'block';
        callGeminiAPI(getTestSystemInstruction(), processTestResponse);
    }

    // --- VIDEO CHUNKING LOGIC ---
    async function initRollingCamera() {
        try {
            streamReference = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('webcam').srcObject = streamReference;
            startNewRecordingChunk();
            
            // Auto-save video every 5 minutes (300000 ms)
            videoChunkTimer = setInterval(() => {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop(); // Triggers download
                    startNewRecordingChunk(); // Instantly restart
                }
            }, 300000); 
        } catch (err) { alert("Camera access required."); }
    }

    function startNewRecordingChunk() {
        let localChunks = [];
        mediaRecorder = new MediaRecorder(streamReference);
        
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) localChunks.push(e.data); };
        
        mediaRecorder.onstop = () => {
            const blob = new Blob(localChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${childData.name}_Session_Part${chunkCounter}.webm`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            chunkCounter++;
        };
        mediaRecorder.start();
    }
    // ----------------------------

    function getTestSystemInstruction() {
        const ageContext = childData.age >= 18 
            ? "The student is 18+. They have likely already chosen a stream. Focus questions on evaluating their current choice, uncovering hidden frustrations, and mapping towards higher education specialization or validating a stream change."
            : "The student is under 18. They are preparing for their 10th standard choice. Slowly map their innate abilities to Indian streams: Science (PCM/PCB), Commerce, Arts, Sports, Music, or IT.";

        return `You are Dhwani, a world-class Indian AI career counselor and aptitude expert. 
        Student: ${childData.name}, Age: ${childData.age}, City: ${childData.city}.
        
        ${ageContext}

        CURRENT STAGE: ${stages[currentStageIndex]}. (Question ${questionCountInStage + 1} of ${maxQuestionsPerStage})
        
        RULES FOR PACING & TONE:
        1. Never rush. The test must slowly dig into the user's nerves. 
        2. If Stage 1 (Icebreaker), start casually. Mention something local about ${childData.city} (e.g., a local sports match, weather, or news) to ease them in. Do not ask academic questions yet.
        3. Challenge them. If they give a short answer, probe deeper. Find out what frustrates them and what they hate.
        4. Do NOT mention streams explicitly until the final stages. You are testing innate aptitude covertly.

        OUTPUT STRICTLY AS JSON:
        {
            "bot_reply": "Your engaging, conversational next question.",
            "internal_analysis": "Hidden notes. What did you learn about their likes, dislikes, or cognitive speed?",
            "is_test_complete": boolean (True ONLY if you have completed the 'Final Career Mapping' stage),
            "final_report_html": "If is_test_complete is true, generate a highly detailed HTML report using <h3>, <p>, and <ul>. MUST include sections: 1. Likes Most 2. Likes Somewhat 3. Dislikes 4. Hates 5. Will NEVER Do 6. Final Stream/Career Recommendations."
        }`;
    }

    function submitAnswer() {
        const inputField = document.getElementById('userInput');
        const answerText = inputField.value.trim();
        if (!answerText) return;

        addMessage(answerText, 'user', 'chat-history');
        inputField.value = '';
        toggleInput(true, 'userInput', 'sendBtn');
        document.getElementById('loading').style.display = 'block';

        conversationHistory.push({ role: "user", parts: [{ text: answerText }] });
        
        questionCountInStage++;
        if (questionCountInStage >= maxQuestionsPerStage && currentStageIndex < stages.length - 1) {
            currentStageIndex++;
            questionCountInStage = 0;
            document.getElementById('stage-indicator').innerText = `Stage ${currentStageIndex + 1}: ${stages[currentStageIndex]}`;
            addSystemMessage(`Entering: ${stages[currentStageIndex]}`);
        }

        callGeminiAPI(getTestSystemInstruction(), processTestResponse);
    }

    function processTestResponse(aiData, rawText) {
        conversationHistory.push({ role: "model", parts: [{ text: rawText }] });

        if (aiData.is_test_complete) {
            transitionToReport(aiData.final_report_html);
        } else {
            addMessage(aiData.bot_reply, 'bot', 'chat-history');
            console.log(`[Stage ${currentStageIndex + 1}] Notes:`, aiData.internal_analysis);
        }
        toggleInput(false, 'userInput', 'sendBtn');
    }

    function generateReportEarly() {
        if(!confirm("End the test early and generate the report based on current data?")) return;
        toggleInput(true, 'userInput', 'sendBtn');
        document.getElementById('loading').style.display = 'block';
        
        // Force the AI to conclude and write the report
        conversationHistory.push({ role: "user", parts: [{ text: "SYSTEM OVERRIDE: End the test immediately and generate the final_report_html based on the data gathered so far." }] });
        callGeminiAPI(getTestSystemInstruction(), processTestResponse);
    }

    function transitionToReport(htmlReport) {
        // Stop Video & Timers
        clearInterval(videoChunkTimer);
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        if (streamReference) streamReference.getTracks().forEach(track => track.stop());
        
        document.getElementById('test-screen').classList.remove('active-screen');
        document.getElementById('report-screen').classList.add('active-screen');
        document.getElementById('report-name-age').innerText = `${childData.name} | Age: ${childData.age}`;
        document.getElementById('report-body').innerHTML = htmlReport;

        // Initialize Consult History with context of the report
        consultHistory.push({ role: "user", parts: [{ text: `Here is my assessment report: ${htmlReport}. I will now ask follow up questions.` }] });
        consultHistory.push({ role: "model", parts: [{ text: "Understood. I am ready to provide university guidance, course links, and actionable next steps based on your report." }] });
    }

    // --- POST-TEST CONSULTATION LOGIC ---
    function submitConsult() {
        const inputField = document.getElementById('consultInput');
        const text = inputField.value.trim();
        if (!text) return;

        addMessage(text, 'user', 'consult-history');
        inputField.value = '';
        toggleInput(true, 'consultInput', 'consultBtn');

        consultHistory.push({ role: "user", parts: [{ text: text }] });
        
        const consultSystemInstruction = `You are Dhwani, an educational consultant in India. You just finished an aptitude test for ${childData.name}. Answer their follow-up questions regarding universities, exam cut-offs (e.g., JEE, NEET, CUET, CAT), or recommend specific online courses (YouTube channels, Udemy topics). Be direct, factual, and helpful. OUTPUT AS PLAIN TEXT OR HTML ONLY (No JSON required for this phase).`;

        fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                system_instruction: { parts: [{ text: consultSystemInstruction }] },
                contents: consultHistory
            })
        })
        .then(res => res.json())
        .then(data => {
            const aiText = data.candidates[0].content.parts[0].text;
            consultHistory.push({ role: "model", parts: [{ text: aiText }] });
            addMessage(aiText, 'bot', 'consult-history');
        })
        .finally(() => toggleInput(false, 'consultInput', 'consultBtn'));
    }

    // --- UTILITIES ---
    async function callGeminiAPI(systemInstruction, successCallback) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: systemInstruction }] },
                    contents: conversationHistory,
                    generationConfig: { response_mime_type: "application/json" }
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            const rawText = data.candidates[0].content.parts[0].text;
            successCallback(JSON.parse(rawText), rawText);
        } catch (error) {
            console.error(error);
            addSystemMessage("Network error communicating with Dhwani AI.");
            toggleInput(false, 'userInput', 'sendBtn');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function addMessage(text, sender, containerId) {
        const container = document.getElementById(containerId);
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}-msg`;
        msgDiv.innerHTML = text; // Allow HTML rendering in chat
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }
    
    function addSystemMessage(text) {
        const container = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `system-msg`;
        msgDiv.innerText = text;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }

    function toggleInput(disable, inputId, btnId) {
        document.getElementById(inputId).disabled = disable;
        document.getElementById(btnId).disabled = disable;
        if(!disable) document.getElementById(inputId).focus();
    }

    function handleEnter(event, callback) { if (event.key === 'Enter') callback(); }
</script>
</body>
</html>