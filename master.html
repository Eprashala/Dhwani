<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani - Comprehensive Aptitude Center</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; max-width: 1000px; width: 100%; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Layouts */
        .screen { display: none; flex-direction: column; height: 90vh; }
        .active-screen { display: flex; }
        
        /* Setup Screen */
        #setup-screen { padding: 40px; text-align: center; justify-content: center; }
        .input-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px; }
        #setup-screen input { width: 45%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        #setup-screen input[type="password"] { width: 93%; }
        button { background: #2980b9; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #1c5980; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        
        /* Test Screen */
        .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        #stage-indicator { background: #f39c12; padding: 5px 10px; border-radius: 4px; font-size: 14px; font-weight: bold; }
        
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .video-panel { width: 30%; background: #000; position: relative; display: flex; flex-direction: column; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        .recording-badge { position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.8); color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .interaction-panel { width: 70%; display: flex; flex-direction: column; border-left: 1px solid #eee; position: relative; }
        #chat-history, #consult-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 85%; padding: 12px 18px; border-radius: 8px; line-height: 1.5; font-size: 15px; }
        .bot-msg { background: #e3f2fd; color: #0d47a1; align-self: flex-start; border-bottom-left-radius: 0; }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; }
        .system-msg { background: #fff3cd; color: #856404; font-size: 13px; text-align: center; margin: 10px auto; border-radius: 4px; padding: 8px; width: 80%; }
        
        .controls-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
        .controls-area input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        #micBtn { background: #e67e22; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; padding: 0; }
        #micBtn.listening { background: #c0392b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        #loading { display: none; position: absolute; bottom: 90px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        
        /* Final Report Screen */
        #report-screen { padding: 40px; overflow-y: auto; background: white; }
        .report-header { text-align: center; border-bottom: 2px solid #2980b9; padding-bottom: 20px; margin-bottom: 30px; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .consultation-box { margin-top: 30px; border: 2px dashed #2980b9; border-radius: 8px; display: flex; flex-direction: column; height: 400px; }
        .consultation-header { background: #2980b9; color: white; padding: 10px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen" class="screen active-screen">
        <h2>Dhwani Interactive Aptitude Center</h2>
        <p>Voice-enabled psychometric assessment.</p>
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key" required>
            <input type="text" id="childName" placeholder="Student's Name" required>
            <input type="number" id="childAge" placeholder="Age" required>
            <input type="text" id="childCity" placeholder="City/Town (e.g., Pune, Delhi)" required>
            <input type="text" id="childLanguage" placeholder="Language Context (e.g., English, Hindi)" value="English">
        </div>
        <button onclick="startTest()">Initialize Session</button>
    </div>

    <div id="test-screen" class="screen">
        <div class="header">
            <span id="test-header">Active Session</span>
            <span id="stage-indicator">Stage 1: Icebreaker</span>
        </div>
        <div class="main-content">
            <div class="video-panel">
                <div class="recording-badge">REC (Auto-Saving)</div>
                <video id="webcam" autoplay muted playsinline></video>
                <button style="border-radius: 0; background: #e74c3c; width: 100%; margin-top: auto;" onclick="generateReportEarly()">End Test & Generate Report</button>
            </div>
            <div class="interaction-panel">
                <div id="chat-history"></div>
                <div id="loading">Dhwani is analyzing...</div>
                <div class="controls-area">
                    <button id="micBtn" onclick="toggleSpeechRecognition()" title="Click to Speak">ðŸŽ¤</button>
                    <input type="text" id="userInput" placeholder="Speak or type your answer..." onkeypress="handleEnter(event, submitAnswer)">
                    <button id="sendBtn" onclick="submitAnswer()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div id="report-screen" class="screen">
        <div class="report-header">
            <h1 style="color: #2980b9;">Comprehensive Career Map</h1>
            <h3 id="report-name-age"></h3>
        </div>
        <div id="report-body"></div>
        
        <div class="consultation-box">
            <div class="consultation-header">Ask Dhwani: Career & Course Consultation</div>
            <div id="consult-history">
                <div class="message bot-msg">The test is complete. You can now ask me about universities, cut-offs, or request YouTube/Udemy courses!</div>
            </div>
            <div class="controls-area" style="border-top: none;">
                <input type="text" id="consultInput" placeholder="Ask about colleges or courses..." onkeypress="handleEnter(event, submitConsult)">
                <button id="consultBtn" onclick="submitConsult()">Ask AI</button>
            </div>
        </div>
        <center><button onclick="location.reload()" style="margin-top: 30px; background: #e74c3c;">Close Session & Clear Data</button></center>
    </div>
</div>

<script>
    // System State
    let mediaRecorder;
    let streamReference;
    let videoChunkTimer;
    let chunkCounter = 1;
    let questionAskedTime = 0;
    
    let childData = { name: "", age: 0, city: "", language: "" };
    let apiKey = "";
    
    // Stages Progression
    const stages = [
        "Icebreaker", "Logical Reasoning", "Numerical Ability", "Verbal Ability", 
        "Spatial Ability", "Mechanical Aptitude", "Abstract Reasoning", 
        "Personality & Interests", "Situational Judgment", "Final Career Mapping"
    ];
    let currentStageIndex = 0;
    let maxQuestionsPerStage = 2; 
    let questionCountInStage = 0;
    
    let conversationHistory = []; 
    let consultHistory = [];      

    // Speech Recognition Setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;
    
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = () => {
            isListening = true;
            document.getElementById('micBtn').classList.add('listening');
            document.getElementById('userInput').placeholder = "Listening...";
        };
        
        recognition.onresult = (event) => {
            document.getElementById('userInput').value = event.results[0][0].transcript;
        };
        
        recognition.onend = () => {
            isListening = false;
            document.getElementById('micBtn').classList.remove('listening');
            document.getElementById('userInput').placeholder = "Speak or type your answer...";
        };
    }

    window.onload = () => {
        if(localStorage.getItem('gemini_api_key')) document.getElementById('apiKey').value = localStorage.getItem('gemini_api_key');
    };

    async function startTest() {
        apiKey = document.getElementById('apiKey').value.trim();
        childData.name = document.getElementById('childName').value.trim();
        childData.age = parseInt(document.getElementById('childAge').value);
        childData.city = document.getElementById('childCity').value.trim();
        childData.language = document.getElementById('childLanguage').value.trim();

        if(!apiKey || !childData.name || !childData.age) return alert("Fill all fields.");
        
        localStorage.setItem('gemini_api_key', apiKey); 

        document.getElementById('setup-screen').classList.remove('active-screen');
        document.getElementById('test-screen').classList.add('active-screen');
        document.getElementById('test-header').innerText = `Proctoring: ${childData.name}`;

        await initRollingCamera();
        
        conversationHistory.push({ role: "user", parts: [{ text: "Initialize the test. Start with the Icebreaker." }] });
        
        document.getElementById('loading').style.display = 'block';
        callGeminiAPI(getTestSystemInstruction(), processTestResponse);
    }

    // --- VIDEO CHUNKING ---
    async function initRollingCamera() {
        try {
            streamReference = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('webcam').srcObject = streamReference;
            startNewRecordingChunk();
            
            videoChunkTimer = setInterval(() => {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop(); 
                    startNewRecordingChunk(); 
                }
            }, 300000); // 5 minutes
        } catch (err) { alert("Camera/Mic access required."); }
    }

    function startNewRecordingChunk() {
        let localChunks = [];
        mediaRecorder = new MediaRecorder(streamReference);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) localChunks.push(e.data); };
        mediaRecorder.onstop = () => {
            const blob = new Blob(localChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${childData.name}_Session_Part${chunkCounter}.webm`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            chunkCounter++;
        };
        mediaRecorder.start();
    }

    // --- VOICE OUTPUT (TTS) ---
    function speakText(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            
            // Prioritize an Indian voice to match context
            const indianVoice = voices.find(v => v.lang.includes('IN') || v.lang.includes('hi'));
            if(indianVoice) utterance.voice = indianVoice;
            
            utterance.rate = 0.7; // Keep Dhwani's deliberate, clear teaching pace
            
            utterance.onend = () => { questionAskedTime = Date.now(); };
            window.speechSynthesis.speak(utterance);
        } else {
            questionAskedTime = Date.now(); 
        }
    }

    function toggleSpeechRecognition() {
        if (!recognition) return alert("Speech recognition not supported here. Please type.");
        if (isListening) recognition.stop();
        else {
            recognition.lang = childData.language.toLowerCase().includes('hindi') ? 'hi-IN' : 'en-IN';
            recognition.start();
        }
    }

    // --- PROMPT ENGINEERING ---
    function getTestSystemInstruction() {
        return `You are Dhwani, a strict but empathetic Indian psychometric evaluator. 
        Student: ${childData.name}, Age: ${childData.age}, City: ${childData.city}.
        
        CURRENT STAGE: ${stages[currentStageIndex]}. 

        LATENCY METADATA: 
        You will receive a timestamp [Answer Latency: X seconds] with every user answer. Fast latency means high intuition. Slow latency means struggle or deep calculation. Track this in your internal_analysis.

        RULES FOR PACING & TONE (CRITICAL):
        1. Keep questions EXTREMELY SHORT. Maximum 15 words per question. 
        2. Do NOT use conversational filler like "Great job!" or "That's interesting." Just fire the next question immediately. Real aptitude tests are rapid and punchy.
        3. Do NOT combine questions. Ask exactly ONE direct question.
        4. If Stage 1, ask a 10-word question about ${childData.city}.
        5. You are probing for streams: Science, Commerce, Arts, IT.

        OUTPUT STRICTLY AS JSON:
        {
            "bot_reply": "Your 10-15 word question.",
            "internal_analysis": "Hidden notes. Note their latency and cognitive capability.",
            "is_test_complete": boolean,
            "final_report_html": "If is_test_complete is true, generate an HTML report including: 1. Likes Most 2. Likes Somewhat 3. Dislikes 4. Hates 5. Will NEVER Do 6. Final Stream Recommendations."
        }`;
    }

    function submitAnswer() {
        const inputField = document.getElementById('userInput');
        const answerText = inputField.value.trim();
        if (!answerText) return;

        let timeTakenSecs = questionAskedTime > 0 ? ((Date.now() - questionAskedTime) / 1000).toFixed(1) : 0;

        addMessage(answerText, 'user', 'chat-history');
        inputField.value = '';
        toggleInput(true, 'userInput', 'sendBtn', 'micBtn');
        document.getElementById('loading').style.display = 'block';

        const enrichedAnswer = `[Answer Latency: ${timeTakenSecs} seconds] ${answerText}`;
        conversationHistory.push({ role: "user", parts: [{ text: enrichedAnswer }] });
        
        questionCountInStage++;
        if (questionCountInStage >= maxQuestionsPerStage && currentStageIndex < stages.length - 1) {
            currentStageIndex++;
            questionCountInStage = 0;
            document.getElementById('stage-indicator').innerText = `Stage ${currentStageIndex + 1}: ${stages[currentStageIndex]}`;
            addSystemMessage(`Entering: ${stages[currentStageIndex]}`);
        }

        callGeminiAPI(getTestSystemInstruction(), processTestResponse);
    }

    function processTestResponse(aiData, rawText) {
        conversationHistory.push({ role: "model", parts: [{ text: rawText }] });

        if (aiData.is_test_complete) {
            transitionToReport(aiData.final_report_html);
        } else {
            addMessage(aiData.bot_reply, 'bot', 'chat-history');
            speakText(aiData.bot_reply); // Speak the AI's response aloud
        }
        toggleInput(false, 'userInput', 'sendBtn', 'micBtn');
    }

    function generateReportEarly() {
        if(!confirm("End the test early?")) return;
        toggleInput(true, 'userInput', 'sendBtn', 'micBtn');
        document.getElementById('loading').style.display = 'block';
        
        conversationHistory.push({ role: "user", parts: [{ text: "SYSTEM OVERRIDE: End the test immediately and generate the final_report_html." }] });
        callGeminiAPI(getTestSystemInstruction(), processTestResponse);
    }

    function transitionToReport(htmlReport) {
        clearInterval(videoChunkTimer);
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        if (streamReference) streamReference.getTracks().forEach(track => track.stop());
        
        document.getElementById('test-screen').classList.remove('active-screen');
        document.getElementById('report-screen').classList.add('active-screen');
        document.getElementById('report-name-age').innerText = `${childData.name} | Age: ${childData.age}`;
        document.getElementById('report-body').innerHTML = htmlReport;

        consultHistory.push({ role: "user", parts: [{ text: `Here is my assessment report: ${htmlReport}. I will now ask follow up questions.` }] });
        consultHistory.push({ role: "model", parts: [{ text: "I am ready to provide university guidance and course links based on your report." }] });
    }

    function submitConsult() {
        const inputField = document.getElementById('consultInput');
        const text = inputField.value.trim();
        if (!text) return;

        addMessage(text, 'user', 'consult-history');
        inputField.value = '';
        toggleInput(true, 'consultInput', 'consultBtn');

        consultHistory.push({ role: "user", parts: [{ text: text }] });
        
        const consultInstruction = `You are Dhwani, an educational consultant in India. You just finished an aptitude test for ${childData.name}. Answer follow-up questions regarding universities, cut-offs, or recommend online courses. OUTPUT AS PLAIN TEXT OR HTML ONLY.`;

        fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ system_instruction: { parts: [{ text: consultInstruction }] }, contents: consultHistory })
        })
        .then(res => res.json())
        .then(data => {
            const aiText = data.candidates[0].content.parts[0].text;
            consultHistory.push({ role: "model", parts: [{ text: aiText }] });
            addMessage(aiText, 'bot', 'consult-history');
        })
        .finally(() => toggleInput(false, 'consultInput', 'consultBtn'));
    }

    async function callGeminiAPI(systemInstruction, successCallback) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: systemInstruction }] },
                    contents: conversationHistory,
                    generationConfig: { response_mime_type: "application/json" }
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            const rawText = data.candidates[0].content.parts[0].text;
            successCallback(JSON.parse(rawText), rawText);
        } catch (error) {
            console.error(error);
            addSystemMessage("Network error communicating with Dhwani AI.");
            toggleInput(false, 'userInput', 'sendBtn', 'micBtn');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function addMessage(text, sender, containerId) {
        const container = document.getElementById(containerId);
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}-msg`;
        msgDiv.innerHTML = text; 
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }
    
    function addSystemMessage(text) {
        const container = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `system-msg`;
        msgDiv.innerText = text;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }

    function toggleInput(disable, inputId, btnId, micId = null) {
        document.getElementById(inputId).disabled = disable;
        document.getElementById(btnId).disabled = disable;
        if(micId) document.getElementById(micId).disabled = disable;
        if(!disable) document.getElementById(inputId).focus();
    }

    function handleEnter(event, callback) { if (event.key === 'Enter') callback(); }
</script>
</body>
</html>