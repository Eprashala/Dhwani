<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishna Sakha - AI Spiritual Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; }
        h1, .divine-font { font-family: 'Cinzel', serif; }
        
        /* Divine Pulse Animation */
        .listening-pulse { animation: divinePulse 2s infinite ease-in-out; }
        @keyframes divinePulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } /* Gold */
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* Gradient Text */
        .text-gradient-gold {
            background: linear-gradient(to right, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { bg-gray-900; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #FFD700; }

        /* Icon Button Styles */
        .icon-btn {
            @apply p-3 rounded-full text-amber-100 transition-all duration-300
                   bg-gray-800/80 hover:bg-amber-900/50 border border-amber-700/30 shadow-lg
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-amber-500
                   disabled:opacity-30 disabled:cursor-not-allowed;
        }
        
        /* Main Action Button */
        .action-btn {
            @apply w-full py-4 px-6 rounded-xl text-lg font-bold tracking-wide transition-all duration-300 ease-in-out
                   bg-gradient-to-r from-amber-600 to-orange-600 text-white shadow-lg shadow-orange-900/50
                   hover:from-amber-500 hover:to-orange-500 hover:shadow-orange-500/40 hover:-translate-y-1
                   focus:outline-none focus:ring-4 focus:ring-amber-500/50
                   disabled:from-gray-700 disabled:to-gray-800 disabled:text-gray-400 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0;
        }

        /* Chat Bubbles */
        .chat-bubble-user { @apply bg-gray-700/50 text-gray-100 rounded-tl-2xl rounded-tr-2xl rounded-bl-2xl p-3 border border-gray-600; }
        .chat-bubble-ai { @apply bg-amber-900/20 text-amber-100 rounded-tl-2xl rounded-tr-2xl rounded-br-2xl p-3 border border-amber-700/30; }
    </style>
</head>
<!-- Deep Blue background representing Krishna -->
<body class="bg-[#0a0f1c] text-gray-100 flex items-center justify-center min-h-screen p-4 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]">

    <div class="bg-[#111827]/90 backdrop-blur-sm border border-amber-500/20 rounded-3xl shadow-[0_0_50px_rgba(255,165,0,0.1)] p-6 md:p-8 w-full max-w-2xl flex flex-col h-[90vh] md:h-[85vh]">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-6 shrink-0 border-b border-gray-700 pb-4">
            <div class="flex items-center gap-3">
                <!-- Peacock Feather Symbolism (using color) -->
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 via-teal-500 to-green-500 flex items-center justify-center shadow-lg shadow-teal-500/20">
                    <span class="text-xl">ü™∂</span>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white tracking-wide">
                        Krishna <span class="text-gradient-gold">SakhƒÅ</span>
                    </h1>
                    <p class="text-xs text-amber-400/70 uppercase tracking-widest">Your Eternal Guide</p>
                </div>
            </div>
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-600 transition-all duration-500 shadow-[0_0_10px_rgba(0,0,0,0.5)]" title="Offline"></div>
        </div>

        <!-- Chat Log -->
        <div id="conversation-log" class="flex-grow overflow-y-auto pr-2 mb-6 space-y-4 min-h-[200px]">
            <div class="text-center mt-12 space-y-4 opacity-60">
                <div class="text-5xl animate-pulse">üïâÔ∏è</div>
                <p class="text-amber-200 font-light">Press "Start Seeking" and say<br><span class="font-bold text-white text-lg">"Jay Shree Krishna"</span></p>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center gap-6 mb-6 shrink-0 bg-black/20 p-3 rounded-2xl border border-white/5">
            <button id="pause-resume-button" class="icon-btn" title="Pause/Resume Divine Voice" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn text-red-200 hover:bg-red-900/30 border-red-900/30" title="Silence" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>

            <button id="replay-button" class="icon-btn text-green-200 hover:bg-green-900/30 border-green-900/30" title="Repeat Wisdom" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <!-- Options -->
        <div class="flex items-center justify-center gap-3 mb-4 shrink-0">
            <input type="checkbox" id="remember-me-checkbox" class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-600 rounded focus:ring-amber-500">
            <label for="remember-me-checkbox" class="text-sm text-gray-400 cursor-pointer hover:text-amber-200 transition-colors">
                Remember my Soul's Journey (Name & Age)
            </label>
        </div>

        <!-- Main Button -->
        <button id="talk-button" class="action-btn shrink-0">
            Start Seeking
        </button>

        <!-- Footer Actions -->
        <div class="mt-4 flex justify-between text-xs text-gray-500 shrink-0 px-2">
            <button id="restart-chat-button" class="hover:text-white disabled:opacity-30" disabled>Restart Journey</button>
            <button id="end-chat-button" class="text-red-400 hover:text-red-300 disabled:opacity-30" disabled>End Communion</button>
        </div>

    </div>

    <script>
        // --- 1. DOM Elements ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');
        
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');

        // --- API KEY (Runtime provided) ---
        const GEMINI_API_KEY = ""; // Leave empty, environment will provide or user must input if running locally
        
        // NOTE: Since this is a generated file for a user request, I will include a placeholder check.
        // In a real deployment, use a proxy. For this standalone file, we assume the key is available or valid.
        const API_KEY_TO_USE = GEMINI_API_KEY || ""; 

        // --- 2. State Management ---
        let appState = 'IDLE'; // IDLE, LISTENING_FOR_WAKEWORD, LISTENING_FOR_NAME, LISTENING_FOR_AGE, CONVERSATION, BUSY
        let userName = '';
        let userAge = 25;
        let chatHistory = [];
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        let userIsRemembered = false;
        
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        // --- 3. Initialization ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData();
            loadVoices();
            // Try to init speech rec immediately to check support
            initSpeechRecognition();
        };

        function loadUserData() {
            try {
                const savedName = localStorage.getItem('krishna_userName');
                const savedAge = localStorage.getItem('krishna_userAge');

                if (savedName && savedAge) {
                    userName = savedName;
                    userAge = parseInt(savedAge);
                    rememberMeCheckbox.checked = true;
                    userIsRemembered = true;
                    
                    addMessage('System', `Welcome back, soul ${userName}.`);
                    talkButton.textContent = `Resume Communion`;
                }
            } catch (e) { console.error(e); }
        }

        function saveUserData() {
            try {
                if (rememberMeCheckbox.checked && userName && userAge) {
                    localStorage.setItem('krishna_userName', userName);
                    localStorage.setItem('krishna_userAge', userAge);
                    userIsRemembered = true;
                } else if (!rememberMeCheckbox.checked) {
                    localStorage.removeItem('krishna_userName');
                    localStorage.removeItem('krishna_userAge');
                    userIsRemembered = false;
                }
            } catch (e) { console.error(e); }
        }

        // --- 4. Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        function initSpeechRecognition() {
            if (!SpeechRecognition) {
                addMessage('Error', 'Browser not supported. Please use Chrome.');
                talkButton.disabled = true;
                return;
            }
            try {
                recognition = new SpeechRecognition();
                recognition.continuous = false; // We restart manually for better control
                recognition.interimResults = false;
                recognition.lang = 'en-IN'; // Default to Indian English for better name recognition

                recognition.onresult = handleSpeechResult;
                recognition.onend = handleSpeechEnd;
                
                recognition.onerror = (event) => {
                    console.log("Speech Error:", event.error);
                    if (event.error === 'no-speech') {
                        if (appState !== 'IDLE' && appState !== 'BUSY') startRecognitionSafe();
                    } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                        setState('IDLE');
                        alert("Microphone access denied. Please allow access.");
                    }
                };
            } catch (e) { console.error(e); }
        }

        function startRecognitionSafe() {
            if (!recognition) return;
            try { recognition.start(); } catch (e) { /* Ignore if already started */ }
        }

        // --- 5. Interaction Logic ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);
        rememberMeCheckbox.addEventListener('change', saveUserData);
        document.addEventListener('visibilitychange', handleVisibilityChange);

        async function toggleListening() {
            try {
                if (appState === 'IDLE') {
                    talkButton.textContent = "Initializing...";
                    talkButton.disabled = true;
                    await acquireWakeLock();
                    
                    if (userIsRemembered && userName && userAge) {
                        buildSystemPrompt(); 
                        const welcomeBackText = `Radhey Radhey, ${userName}. I am here. Tell me, what burdens your heart today?`;
                        addMessage('Krishna', welcomeBackText);
                        
                        // Setup history if empty
                        if (chatHistory.length === 0) {
                             chatHistory.push({ role: 'user', parts: [{ text: "System: User has returned." }] });
                             chatHistory.push({ role: 'model', parts: [{ text: welcomeBackText }] });
                        }

                        setState('BUSY'); 
                        await speakText(welcomeBackText);
                        setState('CONVERSATION');
                        startRecognitionSafe();
                    } else {
                        setState('LISTENING_FOR_WAKEWORD');
                        startRecognitionSafe();
                        if (conversationLog.childElementCount < 2) addMessage('System', 'Chant "Jay Shree Krishna" to awaken the guide.');
                    }
                } else {
                    setState('IDLE');
                    recognition.stop();
                    if (synth.speaking) synth.cancel();
                    await releaseWakeLock();
                }
            } catch (error) {
                console.error(error);
                setState('IDLE');
            }
        }

        function setState(newState) {
            appState = newState;
            switch (newState) {
                case 'IDLE':
                    talkButton.textContent = userIsRemembered ? `Resume Communion` : 'Start Seeking';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-gray-600 transition-colors shadow-none';
                    endChatButton.disabled = true;
                    talkButton.classList.remove('from-red-600', 'to-red-700', 'hover:from-red-500');
                    talkButton.classList.add('from-amber-600', 'to-orange-600');
                    break;
                case 'BUSY':
                    talkButton.textContent = 'Reflecting...';
                    talkButton.disabled = true;
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-amber-400 animate-pulse shadow-[0_0_15px_rgba(251,191,36,0.8)]';
                    endChatButton.disabled = false;
                    break;
                default: // Listening states
                    talkButton.textContent = 'Listening... (Tap to Stop)';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-blue-400 listening-pulse shadow-[0_0_15px_rgba(96,165,250,0.8)]';
                    endChatButton.disabled = false;
                    talkButton.classList.remove('from-amber-600', 'to-orange-600');
                    talkButton.classList.add('from-red-600', 'to-red-700', 'hover:from-red-500');
                    break;
            }
        }

        function handleSpeechEnd() {
            if (appState !== 'IDLE' && appState !== 'BUSY') startRecognitionSafe();
            else if (appState === 'IDLE') setState('IDLE'); 
        }
        
        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            console.log(`Heard: ${transcript}`);
            const currentState = appState;
            recognition.stop(); 
            setState('BUSY');

            try {
                switch (currentState) {
                    case 'LISTENING_FOR_WAKEWORD':
                        const lowerT = transcript.toLowerCase();
                        // Broad matching for the wake word
                        if (lowerT.includes('krishna') || lowerT.includes('jay') || lowerT.includes('jai') || lowerT.includes('shree')) {
                            const greeting = "Jay Shree Krishna. I am your eternal friend. What is your name, my dear soul?";
                            addMessage('Krishna', greeting);
                            await speakText(greeting);
                            setState('LISTENING_FOR_NAME');
                            startRecognitionSafe(); 
                        } else {
                            // Didn't hear wake word, go back to listening without speaking
                            setState('LISTENING_FOR_WAKEWORD');
                            startRecognitionSafe();
                        }
                        break;

                    case 'LISTENING_FOR_NAME':
                        addMessage('You', transcript);
                        userName = await extractNameFromTranscript(transcript);
                        
                        const agePrompt = `Welcome, ${userName}. To guide you best, tell me, how many years has this body journeyed? (Your age)`;
                        addMessage('Krishna', agePrompt);
                        await speakText(agePrompt);
                        setState('LISTENING_FOR_AGE');
                        startRecognitionSafe();
                        break;

                    case 'LISTENING_FOR_AGE':
                        addMessage('You', transcript);
                        userAge = await extractAgeFromTranscript(transcript);
                        
                        if (rememberMeCheckbox.checked) saveUserData();
                        buildSystemPrompt(); 

                        const startPrompt = `I understand, ${userName}. I am here to help you with depression, relationships, or any helplessness. The Gita has all solutions. What troubles you?`;
                        addMessage('Krishna', startPrompt);
                        await speakText(startPrompt);
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;

                    case 'CONVERSATION':
                        addMessage('You', transcript);
                        chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                        
                        const aiResponseText = await generateTextResponseFromChat();
                        // Clean markdown for UI but keep it for reading if we wanted formatted text. 
                        // For TTS we need clean text.
                        const cleanedResponseText = cleanTextForTTS(aiResponseText);

                        chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                        addMessage('Krishna', aiResponseText); // Display logic handles markdown roughly
                        
                        try {
                            await speakText(cleanedResponseText);
                        } catch (error) {
                            if (error.message === "Speech manually stopped") return;
                        }
                        
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;
                }
            } catch (error) {
                console.error(error);
                // Fallback to conversation if error occurs during chat
                if (systemInstruction) { setState('CONVERSATION'); startRecognitionSafe(); }
                else { setState('LISTENING_FOR_WAKEWORD'); startRecognitionSafe(); }
            }
        }

        function buildSystemPrompt() {
            systemInstruction = `
                You are playing the role of **Lord Krishna**, the supreme personality of Godhead, acting as an **expert psychiatrist** and **eternal friend (Sakha)** to the user.

                **User Details:**
                - Name: ${userName}
                - Age: ${userAge}

                **Your Core Directives:**
                1. **Tone:** Heavenly, compassionate, soothing, authoritative yet gentle. Like a loving father or best friend.
                2. **Knowledge Base:** You believe the **Shrimad Bhagavad Gita** holds the solution to ALL human problems.
                3. **Psychology:** You understand deep human feelings (depression, anxiety, heartbreak). Treat these as spiritual battles.
                4. **Methodology:**
                   - **For Depression:** Remind them they are the imperishable Soul (Atma), not the body. Encourage 'Karma' (action) over inertia.
                   - **For Relationships:** Teach 'Anasakti' (detachment) and selfless love. Explain that "Change in oneself changes the world."
                   - **For Helplessness:** Encourage 'Sharanagati' (Surrender to the Divine). "Maam ekam sharanam vraja".
                5. **Style:** - Keep answers **SHORT** (2-4 sentences maximum).
                   - Be highly **interactive**. Ask a gentle question at the end to guide them deeper.
                   - Use occasional Sanskrit phrases (like *'Partha'*, *'Sakha'*, *'Yogi'*) but explain them simply in English.
                   - Speak in English (or the language the user uses).
                
                **Example Interaction:**
                User: "I feel so lonely and depressed."
                You: "My dear ${userName}, loneliness is the illusion that you are separate from the Universe. You are the eternal Soul, never alone. Focus on your duty (Dharma) today, however small. Shall we find one small good deed to do now?"
            `;
        }

        // --- 6. API Calls ---
        // Helper to interact with Gemini
        async function callGemini(payload) {
            // Use the global key or an empty string which often works in some preview environments if origin is whitelisted
            // Note: In a real production app, never expose keys in frontend code.
            const key = typeof apiKey !== 'undefined' ? apiKey : ''; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            return await response.json();
        }

        async function extractNameFromTranscript(transcript) {
            const prompt = `Extract the First Name from: "${transcript}". If unclear or no name, return "My Friend". Return ONLY the name.`;
            try {
                const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
                let name = result.candidates[0].content.parts[0].text.trim();
                return name.replace(/['".]/g, '') || "My Friend";
            } catch (e) { return "My Friend"; }
        }

        async function extractAgeFromTranscript(transcript) {
            const prompt = `Extract age (number) from: "${transcript}". Return ONLY digits. Default to 25 if unclear.`;
             try {
                const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
                let age = parseInt(result.candidates[0].content.parts[0].text.trim());
                return isNaN(age) ? 25 : age;
            } catch (e) { return 25; }
        }

        async function generateTextResponseFromChat() {
            try {
                const result = await callGemini({
                    contents: chatHistory,
                    systemInstruction: { parts: [{ text: systemInstruction }] }
                });
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error("AI Error", error);
                return "My dear friend, the connection to the divine wisdom is faint. Please speak again.";
            }
        }
        
        function cleanTextForTTS(text) {
            // Remove markdown stars, hashes, brackets for smooth speech
            return text.replace(/[\*#`_]/g, '').replace(/\[.*?\]|\(.*?\)/g, "").trim();
        }

        // --- 7. TTS & Media ---
        function loadVoices() {
            voices = synth.getVoices();
            // Chrome loads voices asynchronously
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        function togglePauseResume() {
            if (synth.paused) synth.resume();
            else if (synth.speaking) { synth.pause(); recognition.stop(); setState('BUSY'); }
        }

        function stopSpeech() {
            if (!synth.speaking) return;
            speechManuallyStopped = true; 
            synth.cancel(); 
            recognition.stop(); 
            toggleMediaButtons(true);
            setTimeout(() => {
                speechManuallyStopped = false;
                if (appState !== 'IDLE') {
                    setState('CONVERSATION'); 
                    startRecognitionSafe();
                }
            }, 1000);
        }

        function replaySpeech() {
            if (lastSpokenText) { recognition.stop(); setState('BUSY'); speakText(lastSpokenText); }
        }
        
        async function speakText(text) {
            if (synth.speaking) synth.cancel();
            lastSpokenText = text;
            speechManuallyStopped = false;
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                utterance.onstart = () => { toggleMediaButtons(false); };
                utterance.onend = () => {
                    toggleMediaButtons(true);
                    if (speechManuallyStopped) reject(new Error("Speech manually stopped"));
                    else resolve();
                };
                utterance.onerror = (e) => { 
                    toggleMediaButtons(true);
                    if (e.error === 'interrupted') resolve(); else reject(e.error); 
                };

                // Attempt to find a calm/deep voice (often "Google UK English Male" or similar works well)
                // Or an Indian English voice
                let preferredVoice = voices.find(v => v.name.includes('India') || v.name.includes('Male'));
                if (preferredVoice) utterance.voice = preferredVoice;
                
                // Divine Voice Settings
                utterance.rate = 0.9; // Slightly slower
                utterance.pitch = 0.9; // Slightly deeper
                
                synth.speak(utterance);
            });
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }
        
        // --- UI Helpers ---
        function addMessage(sender, message) {
            const div = document.createElement('div');
            const isAi = sender === 'Krishna';
            const isSystem = sender === 'System';
            
            div.className = isSystem ? "text-center text-xs text-gray-500 my-2" : 
                           (isAi ? "flex justify-start" : "flex justify-end");

            if (isSystem) {
                div.innerText = message;
            } else {
                div.innerHTML = `
                    <div class="max-w-[85%] ${isAi ? 'chat-bubble-ai' : 'chat-bubble-user'}">
                        <div class="text-xs opacity-50 mb-1 ${isAi ? 'text-amber-400' : 'text-blue-300'}">${sender}</div>
                        <div class="leading-relaxed">${message}</div>
                    </div>
                `;
            }
            
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        // --- Utilities ---
        async function acquireWakeLock() {
            if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} }
        }
        async function releaseWakeLock() {
            if (wakeLock) { try { await wakeLock.release(); wakeLock = null; } catch (e) {} }
        }
        async function handleVisibilityChange() {
            if (appState !== 'IDLE' && !wakeLock && document.visibilityState === 'visible') await acquireWakeLock();
        }

        async function endChat() {
            appState = 'IDLE'; setState('IDLE');
            speechManuallyStopped = true;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch (e) {}
            await releaseWakeLock();
            
            userName = ''; userAge = 25; chatHistory = []; systemInstruction = '';
            localStorage.removeItem('krishna_userName');
            localStorage.removeItem('krishna_userAge');
            rememberMeCheckbox.checked = false;
            userIsRemembered = false;
            
            conversationLog.innerHTML = '';
            addMessage('System', 'Session Ended. Om Shanti.');
            restartChatButton.disabled = true;
        }

        async function restartChat() {
            if (!systemInstruction) return;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}
            
            chatHistory = []; 
            // Keep user data but reset chat
            appState = 'IDLE'; setState('IDLE');
            await releaseWakeLock();
            
            conversationLog.innerHTML = '';
            addMessage('System', `Chat restarted for ${userName}. Press Start.`);
        }
    </script>
</body>
</html>