<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarthi: Krishna AI Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Mukta:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Mukta', sans-serif; 
            background: linear-gradient(135deg, #ff9933 0%, #ffe5b4 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #fb923c;
            box-shadow: 0 10px 30px rgba(234, 88, 12, 0.3);
        }
        .krishna-title { font-family: 'Cinzel', serif; }
        
        /* Animation for Listening State */
        .mic-active { animation: glow 1.5s infinite ease-in-out; border-color: #ea580c; }
        @keyframes glow {
            0% { box-shadow: 0 0 5px #ea580c; }
            50% { box-shadow: 0 0 20px #ea580c; }
            100% { box-shadow: 0 0 5px #ea580c; }
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center">

    <div class="glass-card rounded-2xl p-6 w-full max-w-lg flex flex-col relative overflow-hidden">
        
        <div class="text-center mb-6">
            <h1 class="krishna-title text-4xl text-orange-800 font-bold mb-1">SARTHI</h1>
            <p class="text-orange-600 text-sm font-bold uppercase tracking-widest">Your Divine Psychiatrist</p>
        </div>

        <div class="mb-4">
            <label class="text-xs font-bold text-orange-800 uppercase ml-1">Select Communication Language:</label>
            <select id="language-select" class="w-full p-3 rounded-lg border-2 border-orange-200 bg-orange-50 text-orange-900 font-bold focus:border-orange-500 outline-none transition-all">
                <option value="hi-IN">हिंदी (Hindi)</option>
                <option value="mr-IN">मराठी (Marathi)</option>
                <option value="en-IN">English (India)</option>
            </select>
        </div>

        <div id="chat-box" class="h-64 overflow-y-auto bg-orange-50/50 rounded-xl p-4 border border-orange-100 mb-4 space-y-3 scroll-smooth">
            <div class="text-center text-orange-400 text-sm mt-10">
                Select language, Click Start, and say:<br>
                <span class="text-xl font-bold text-orange-700">"Jay Shree Krishna"</span>
            </div>
        </div>

        <div class="mb-2 text-xs text-center text-gray-500 h-4" id="live-transcript">...</div>

        <div class="flex flex-col gap-3">
            <button id="start-btn" class="w-full py-4 rounded-xl bg-gradient-to-r from-orange-600 to-red-600 text-white font-bold text-lg shadow-lg hover:shadow-orange-500/50 hover:-translate-y-1 transition-all">
                Start Spiritual Connection
            </button>
            
            <div class="flex gap-2">
                <button id="stop-btn" class="flex-1 py-3 rounded-lg bg-gray-200 text-gray-700 font-bold hover:bg-gray-300 transition-colors" disabled>
                    Stop / Pause
                </button>
                <button id="reset-btn" class="flex-1 py-3 rounded-lg border border-orange-300 text-orange-700 font-bold hover:bg-orange-50 transition-colors">
                    Reset Session
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        // PLEASE REPLACE WITH YOUR OWN KEY IF THIS ONE EXPIRES
        const API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        
        // --- VARIABLES ---
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        const chatBox = document.getElementById('chat-box');
        const liveTranscript = document.getElementById('live-transcript');
        const langSelect = document.getElementById('language-select');

        let recognition;
        let isListening = false;
        let isSpeaking = false;
        let appState = "IDLE"; // IDLE, WAITING_WAKE, WAITING_NAME, WAITING_AGE, CHAT
        
        let userData = { name: "", age: "" };
        let chatHistory = [];
        let silenceTimer;

        // --- SPEECH RECOGNITION SETUP ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            alert("Your browser does not support Speech Recognition. Please use Google Chrome.");
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // CRITICAL: False prevents the 'toggle loop' bug
            recognition.interimResults = true; // See results as you speak
        }

        // --- EVENT LISTENERS ---
        startBtn.addEventListener('click', () => {
            if (!API_KEY) { alert("No API Key found in code."); return; }
            startSession();
        });
        
        stopBtn.addEventListener('click', stopSession);
        
        resetBtn.addEventListener('click', () => {
            stopSession();
            chatBox.innerHTML = '<div class="text-center text-orange-400 text-sm mt-10">Session Reset. Say "Jay Shree Krishna"</div>';
            userData = { name: "", age: "" };
            chatHistory = [];
            appState = "IDLE";
        });

        // --- CORE FUNCTIONS ---

        function startSession() {
            appState = "WAITING_WAKE";
            addMessage("System", "Listening for 'Jay Shree Krishna'...");
            startListening();
            startBtn.style.display = 'none';
            stopBtn.disabled = false;
        }

        function stopSession() {
            isListening = false;
            if (recognition) recognition.stop();
            window.speechSynthesis.cancel();
            startBtn.style.display = 'block';
            startBtn.innerText = "Resume Connection";
            stopBtn.disabled = true;
            liveTranscript.innerText = "Stopped.";
        }

        function startListening() {
            if (isSpeaking) return; // Don't listen while speaking
            
            try {
                recognition.lang = langSelect.value; // Update language based on selection
                recognition.start();
                isListening = true;
                liveTranscript.innerText = "Listening...";
                document.querySelector('.glass-card').classList.add('mic-active');
            } catch (e) {
                console.log("Mic already active or error:", e);
            }
        }

        // --- RECOGNITION HANDLERS ---

        recognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            
            liveTranscript.innerText = `Hearing: "${transcript}"`;

            // Only process if final result
            if (event.results[0].isFinal) {
                handleInput(transcript);
            }
        };

        recognition.onend = () => {
            document.querySelector('.glass-card').classList.remove('mic-active');
            isListening = false;
            
            // AUTO-RESTART LOGIC (The fix for toggling)
            // Only restart if we are NOT speaking and the user hasn't clicked stop
            if (!isSpeaking && stopBtn.disabled === false) {
                setTimeout(() => {
                    startListening();
                }, 500); // 500ms delay prevents CPU crash/toggling sound
            }
        };

        recognition.onerror = (event) => {
            console.error("Speech Error:", event.error);
            liveTranscript.innerText = "Error: " + event.error;
            if (event.error === 'not-allowed') {
                addMessage("System", "Please allow Microphone access.");
                stopSession();
            }
        };

        // --- INTELLIGENCE FLOW ---

        async function handleInput(text) {
            const lowerText = text.toLowerCase();
            const currentLang = langSelect.value;

            // 1. WAKE WORD DETECTION
            if (appState === "WAITING_WAKE") {
                // Broad check for variations of Jay Shree Krishna
                if (lowerText.includes('krishna') || lowerText.includes('krsna') || lowerText.includes('jay') || lowerText.includes('jai')) {
                    appState = "WAITING_NAME";
                    let msg = currentLang.includes('en') ? "Radhe Radhe. I am here. What is your name?" 
                            : (currentLang.includes('hi') ? "राधे राधे। मैं आपका सारथी हूँ। आपका नाम क्या है?" 
                            : "राधे राधे. मी तुमचा सारथी आहे. तुझे नाव काय आहे?");
                    
                    addMessage("Krishna", msg);
                    await speak(msg);
                }
                return;
            }

            // 2. CAPTURE NAME
            if (appState === "WAITING_NAME") {
                userData.name = text;
                appState = "WAITING_AGE";
                let msg = currentLang.includes('en') ? `Welcome ${text}. How old are you?` 
                        : (currentLang.includes('hi') ? `स्वागत है ${text}। आपकी आयु (Age) क्या है?` 
                        : `स्वागत आहे ${text}. तुमचे वय काय आहे?`);
                
                addMessage("Krishna", msg);
                await speak(msg);
                return;
            }

            // 3. CAPTURE AGE
            if (appState === "WAITING_AGE") {
                userData.age = text.replace(/\D/g,'') || "18"; // Extract number
                appState = "CHAT";
                let msg = currentLang.includes('en') ? "I understand. Tell me your worries, and I shall guide you with the Gita." 
                        : (currentLang.includes('hi') ? "मैं समझ गया। अपनी चिंताएं बताओ, मैं गीता के ज्ञान से मार्गदर्शन करूँगा।" 
                        : "मी समजलो. तुमची चिंता सांगा, मी गीतेच्या माध्यमातून मार्गदर्शन करेन.");
                
                addMessage("Krishna", msg);
                await speak(msg);
                return;
            }

            // 4. MAIN CHAT (Gita/Psychiatrist)
            if (appState === "CHAT") {
                addMessage("You", text);
                
                // Show loading state
                liveTranscript.innerText = "Krishna is contemplating...";
                
                const aiResponse = await getGeminiResponse(text);
                addMessage("Krishna", aiResponse);
                await speak(aiResponse);
            }
        }

        // --- GEMINI API CALL ---
        async function getGeminiResponse(userText) {
            const lang = langSelect.value;
            const prompt = `
                Role: Act as Lord Krishna, the Supreme Psychiatrist.
                User: Name is ${userData.name}, Age is ${userData.age}.
                Language Code: ${lang}
                
                Directives:
                1. Answer in the language: ${lang === 'en-IN' ? 'English' : (lang === 'hi-IN' ? 'Hindi' : 'Marathi')}.
                2. Use references from Shrimad Bhagavad Gita to solve the problem.
                3. Act as a compassionate therapist (CBT + Spirituality).
                4. Tone: Calm, Divine, Authoritative but loving.
                5. KEEP IT SHORT. Maximum 3 sentences.
                
                User Problem: ${userText}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: 'user', parts: [{ text: prompt }] }
                        ]
                    })
                });
                
                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                return rawText.replace(/\*/g, ''); // Remove markdown stars for cleaner speech
            } catch (error) {
                console.error("API Error:", error);
                return "My connection to the cosmos is fluctuating. Please ask again.";
            }
        }

        // --- TEXT TO SPEECH (TTS) ---
        function speak(text) {
            return new Promise((resolve) => {
                isSpeaking = true;
                recognition.stop(); // Stop mic so it doesn't hear the AI speaking

                const utterance = new SpeechSynthesisUtterance(text);
                
                // Voice Selection Logic
                const voices = window.speechSynthesis.getVoices();
                const lang = langSelect.value;
                
                // Try to find a matching voice, prioritize Google/Microsoft native ones
                let voice = voices.find(v => v.lang === lang) || voices.find(v => v.lang.includes(lang.split('-')[0]));
                if (voice) utterance.voice = voice;

                utterance.lang = lang;
                utterance.rate = 0.9; // Slightly slower for divine effect
                utterance.pitch = 0.9; // Slightly deeper

                utterance.onend = () => {
                    isSpeaking = false;
                    resolve(); // Promise done
                    // Mic will auto-restart via recognition.onend logic
                };

                utterance.onerror = (e) => {
                    console.error("TTS Error", e);
                    isSpeaking = false;
                    resolve();
                };

                window.speechSynthesis.speak(utterance);
            });
        }

        function addMessage(sender, text) {
            const div = document.createElement('div');
            const isMe = sender === "You";
            div.className = isMe 
                ? "bg-white p-3 rounded-lg rounded-tr-none shadow-sm ml-8 text-right border-l-4 border-gray-300"
                : "bg-orange-100 p-3 rounded-lg rounded-tl-none shadow-sm mr-8 border-l-4 border-orange-500";
            
            div.innerHTML = `<strong class="block text-xs uppercase mb-1 ${isMe ? 'text-gray-500' : 'text-orange-700'}">${sender}</strong>${text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // Preload voices
        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

    </script>
</body>
</html>