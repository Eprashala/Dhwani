<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarthi - The Divine Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Laila:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Laila', sans-serif; 
            background: radial-gradient(circle at center, #fff7ed 0%, #ffedd5 100%);
        }
        
        /* Divine Pulse Animation */
        .listening-pulse { animation: divinePulse 2s infinite ease-in-out; }
        @keyframes divinePulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fff7ed; }
        ::-webkit-scrollbar-thumb { background: #fb923c; border-radius: 4px; }

        /* Custom UI Elements */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(251, 146, 60, 0.3);
        }

        .icon-btn {
            @apply p-3 rounded-full text-orange-900 transition-all duration-300
                   bg-orange-200/50 hover:bg-orange-300 shadow-md
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-bold transition-colors
                   bg-orange-100 text-orange-800 border border-orange-200
                   hover:bg-orange-200
                   disabled:opacity-50 disabled:cursor-not-allowed;
        }

        .lang-select {
            @apply bg-orange-50 border border-orange-300 text-orange-900 text-sm rounded-lg 
                   focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5 font-bold;
        }
    </style>
</head>
<body class="text-orange-950 flex items-center justify-center min-h-screen p-4 bg-[url('https://www.transparenttextures.com/patterns/paper-fibers.png')]">

    <div class="glass-panel rounded-3xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[90vh] md:h-auto relative overflow-hidden border-t-4 border-orange-500">
        
        <div class="flex flex-col md:flex-row items-center justify-between mb-4 shrink-0 z-10 gap-4">
            <h1 class="text-3xl md:text-4xl font-bold text-orange-800 text-center md:text-left" style="font-family: 'Cinzel', serif;">
                SARTHI <span class="text-xs align-top text-orange-600 ml-1 tracking-widest font-sans">AI</span>
            </h1>
            
            <div class="flex items-center gap-3 w-full md:w-auto">
                <select id="language-selector" class="lang-select">
                    <option value="hi-IN">हिंदी (Hindi)</option>
                    <option value="mr-IN">मराठी (Marathi)</option>
                    <option value="en-IN">English</option>
                </select>
                <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-400 transition-colors shadow-lg shrink-0" title="Status"></div>
            </div>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-white/60 rounded-xl p-6 mb-6 border border-orange-100 space-y-4 shadow-inner min-h-[300px]">
            <div class="text-orange-800/60 text-center mt-10 space-y-2">
                <p class="text-2xl font-bold opacity-50">"कर्मण्येवाधिकारस्ते"</p>
                <p class="text-sm">Select language, click Connect, and say:<br><strong class="text-orange-700 text-lg">"Jay Shree Krishna"</strong></p>
            </div>
        </div>

        <div class="flex justify-center gap-6 mb-6 shrink-0">
            <button id="pause-resume-button" class="icon-btn" title="Pause/Resume" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn bg-red-100 text-red-800 hover:bg-red-200" title="Stop Speaking" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>

            <button id="replay-button" class="icon-btn" title="Replay Last Message" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <div class="flex items-center justify-center gap-2 mb-4 shrink-0">
            <input type="checkbox" id="remember-me-checkbox" class="w-4 h-4 text-orange-600 border-orange-300 rounded focus:ring-orange-500">
            <label for="remember-me-checkbox" class="text-sm text-orange-800 cursor-pointer font-medium">
                Remember my Soul (Name & Age)
            </label>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-xl text-lg font-bold tracking-wide transition-all duration-300 ease-in-out shrink-0
                       bg-gradient-to-r from-orange-500 to-red-600 text-white shadow-lg shadow-orange-500/30
                       hover:shadow-orange-500/60 hover:-translate-y-1
                       focus:outline-none focus:ring-4 focus:ring-orange-300
                       disabled:grayscale disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0">
            Connect with Krishna
        </button>

        <div class="mt-6 grid grid-cols-3 gap-4 shrink-0">
            <button id="restart-chat-button" class="utility-btn" disabled>Reincarnate (Restart)</button>
            <button id="share-button" class="utility-btn">Share Wisdom</button>
            <button id="end-chat-button" class="utility-btn text-red-700 hover:bg-red-100" disabled>End Session</button>
        </div>

    </div>

    <script>
        // --- 1. DOM Elements ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');
        const languageSelector = document.getElementById('language-selector');
        
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        
        const shareButton = document.getElementById('share-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');

        // --- API KEY ---
        // Ideally, this should be backend-protected, but for this standalone demo it is here.
        const GEMINI_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        // -------------------------

        // --- 2. State Management ---
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 18;
        let chatHistory = [];
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        let userIsRemembered = false;
        let currentLang = 'hi-IN'; // Default Hindi
        
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        // --- 3. Initialization ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData();
            loadVoices();
            // Set initial language based on selector
            currentLang = languageSelector.value;
        };

        languageSelector.addEventListener('change', (e) => {
            currentLang = e.target.value;
            if (recognition) recognition.lang = currentLang;
            logMessage('System', `Language changed to ${e.target.options[e.target.selectedIndex].text}`);
        });

        function loadUserData() {
            try {
                const savedName = localStorage.getItem('sarthi_userName');
                const savedAge = localStorage.getItem('sarthi_userAge');

                if (savedName && savedAge) {
                    userName = savedName;
                    userAge = parseInt(savedAge);
                    rememberMeCheckbox.checked = true;
                    userIsRemembered = true;
                    
                    const welcomeMsg = document.createElement('div');
                    welcomeMsg.className = 'text-center text-orange-600 font-bold text-sm mb-2';
                    welcomeMsg.innerText = `Welcome back, soul ${userName}.`;
                    conversationLog.appendChild(welcomeMsg);
                    
                    talkButton.textContent = `Resume Guidance for ${userName}`;
                }
            } catch (e) { console.error(e); }
        }

        function saveUserData() {
            try {
                if (rememberMeCheckbox.checked && userName && userAge) {
                    localStorage.setItem('sarthi_userName', userName);
                    localStorage.setItem('sarthi_userAge', userAge);
                    userIsRemembered = true;
                } else if (!rememberMeCheckbox.checked) {
                    localStorage.removeItem('sarthi_userName');
                    localStorage.removeItem('sarthi_userAge');
                    userIsRemembered = false;
                }
            } catch (e) { console.error(e); }
        }

        // --- 4. Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            logMessage('System', 'Browser not supported. Use Chrome/Edge.');
            talkButton.disabled = true;
        } else {
            try {
                recognition = new SpeechRecognition();
                recognition.continuous = false; // Must be false to allow processing
                recognition.interimResults = false;
                recognition.lang = currentLang;

                recognition.onresult = handleSpeechResult;
                recognition.onend = handleSpeechEnd;
                
                recognition.onerror = (event) => {
                    console.log("Speech Error:", event.error);
                    if (event.error === 'no-speech' && appState !== 'IDLE' && appState !== 'BUSY') {
                        startRecognitionSafe();
                    } else if (event.error === 'not-allowed') {
                        setState('IDLE');
                        alert("Microphone access denied. Please allow access.");
                    }
                };
            } catch (e) { alert("Mic Error: " + e.message); }
        }

        function startRecognitionSafe() {
            if (!recognition) return;
            if (appState === 'BUSY') return; // Do not start if busy thinking/speaking
            try { 
                recognition.lang = currentLang; // Ensure lang is current
                recognition.start(); 
            } catch (e) {
                // Ignore "already started" errors
            }
        }

        // --- 5. Interaction Logic ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        shareButton.addEventListener('click', shareChat);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);
        rememberMeCheckbox.addEventListener('change', saveUserData);
        document.addEventListener('visibilitychange', handleVisibilityChange);

        async function toggleListening() {
            try {
                if (appState === 'IDLE') {
                    talkButton.textContent = "Summoning...";
                    talkButton.disabled = true;
                    await acquireWakeLock();
                    
                    // Load voices if not loaded
                    if (voices.length === 0) voices = synth.getVoices();

                    if (userIsRemembered && userName && userAge) {
                        // Returning User
                        setState('BUSY'); 
                        
                        // Re-inject System Prompt to ensure language update
                        const prompt = getSystemPrompt(currentLang);
                        
                        // Basic chat history reset/init if empty
                        if (chatHistory.length === 0) {
                             chatHistory = [
                                 { role: 'user', parts: [{ text: "Start session" }] },
                                 { role: 'model', parts: [{ text: "Connected." }] }
                             ];
                        }

                        let welcomeBackText = "";
                        if(currentLang === 'en-IN') welcomeBackText = `Welcome back ${userName}. I am here.`;
                        else if(currentLang === 'mr-IN') welcomeBackText = `पुन्हा स्वागत आहे ${userName}. सांगा, काय समस्या आहे?`;
                        else welcomeBackText = `राधे राधे ${userName}, मैं आपकी क्या सहायता कर सकता हूँ?`;

                        logMessage('Krishna', welcomeBackText);
                        await speakText(welcomeBackText);
                        setState('CONVERSATION');
                        startRecognitionSafe();
                    } else {
                        // New User
                        setState('LISTENING_FOR_WAKEWORD');
                        startRecognitionSafe();
                        logMessage('Info', 'Say "Jay Shree Krishna"');
                    }
                } else {
                    // Stop Everything
                    setState('IDLE');
                    recognition.stop();
                    if (synth.speaking) synth.cancel();
                    await releaseWakeLock();
                }
            } catch (error) {
                console.error(error);
                setState('IDLE');
            }
        }

        function setState(newState) {
            appState = newState;
            console.log("State changed to:", newState);
            switch (newState) {
                case 'IDLE':
                    talkButton.textContent = userIsRemembered ? `Resume as ${userName}` : 'Connect with Krishna';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-400 shadow-none';
                    endChatButton.disabled = true;
                    languageSelector.disabled = false;
                    talkButton.classList.remove('from-red-500', 'to-pink-600');
                    talkButton.classList.add('from-orange-500', 'to-red-600');
                    break;
                case 'BUSY':
                    talkButton.textContent = 'Contemplating...';
                    talkButton.disabled = true;
                    languageSelector.disabled = true;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-400 shadow-[0_0_10px_#facc15] transition-colors';
                    endChatButton.disabled = false;
                    break;
                default: // LISTENING states
                    talkButton.textContent = 'Listening...';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-orange-500 listening-pulse transition-colors';
                    endChatButton.disabled = false;
                    talkButton.classList.remove('from-orange-500', 'to-red-600');
                    talkButton.classList.add('from-red-500', 'to-pink-600');
                    break;
            }
        }

        function handleSpeechEnd() {
            // Only restart if we are supposed to be listening and NOT busy processing/speaking
            if (appState !== 'IDLE' && appState !== 'BUSY') {
                startRecognitionSafe();
            } else if (appState === 'IDLE') {
                setState('IDLE'); 
            }
        }
        
        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            console.log(`Heard: ${transcript}`);
            
            const currentState = appState;
            
            // IMPORTANT: Stop mic immediately so we don't hear ourselves or background noise while processing
            recognition.stop(); 
            setState('BUSY');

            try {
                const lowerTrans = transcript.toLowerCase();

                switch (currentState) {
                    case 'LISTENING_FOR_WAKEWORD':
                        // Flexible wake word detection
                        if (lowerTrans.includes('jay') || lowerTrans.includes('jai') || lowerTrans.includes('krishna') || lowerTrans.includes('krsna')) {
                            let greeting = "";
                            if(currentLang === 'en-IN') greeting = "Radhe Radhe. I am your guide. What is your name?";
                            else if(currentLang === 'mr-IN') greeting = "राधे राधे. मी तुझा सारथी आहे. तुझे नाव काय आहे?";
                            else greeting = "राधे राधे। मैं तुम्हारा सारथी हूँ। तुम्हारा नाम क्या है?";

                            logMessage('Krishna', greeting);
                            await speakText(greeting);
                            setState('LISTENING_FOR_NAME');
                            startRecognitionSafe(); 
                        } else {
                            // Not the wake word, listen again
                            setState('LISTENING_FOR_WAKEWORD');
                            startRecognitionSafe();
                        }
                        break;

                    case 'LISTENING_FOR_NAME':
                        logMessage('You', transcript);
                        // Simple heuristic: just take the transcript as name for now to avoid API latency just for extraction
                        userName = transcript.split(' ').pop().replace(/[.]/g, ''); 
                        
                        let agePrompt = "";
                        if(currentLang === 'en-IN') agePrompt = `Greetings ${userName}. How old is this body?`;
                        else if(currentLang === 'mr-IN') agePrompt = `नमस्कार ${userName}. तुमचे वय काय आहे?`;
                        else agePrompt = `नमस्ते ${userName}. तुम्हारी आयु (Age) क्या है?`;

                        logMessage('Krishna', agePrompt);
                        await speakText(agePrompt);
                        setState('LISTENING_FOR_AGE');
                        startRecognitionSafe();
                        break;

                    case 'LISTENING_FOR_AGE':
                        logMessage('You', transcript);
                        // Basic number extraction
                        const ageMatch = transcript.match(/\d+/);
                        userAge = ageMatch ? parseInt(ageMatch[0]) : 18;
                        
                        if (rememberMeCheckbox.checked) saveUserData();

                        let startPrompt = "";
                        if(currentLang === 'en-IN') startPrompt = `Welcome. Share your worries, and I shall give you knowledge from the Gita.`;
                        else if(currentLang === 'mr-IN') startPrompt = `स्वागत आहे. गीतेच्या ज्ञानाने मी तुमच्या शंकांचे निरसन करेन. काय त्रास आहे?`;
                        else startPrompt = `स्वागत है। गीता के ज्ञान से मैं तुम्हारी शंकाओं का निवारण करूँगा। तुम्हें क्या कष्ट है?`;

                        logMessage('Krishna', startPrompt);
                        await speakText(startPrompt);
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;

                    case 'CONVERSATION':
                        logMessage(userName || 'You', transcript);
                        chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                        
                        // Generate Response
                        const aiResponseText = await generateTextResponseFromChat();
                        
                        // Add to history
                        chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                        
                        // Clean for UI and Speech
                        const cleanedResponseText = cleanTextForTTS(aiResponseText);
                        logMessage('Krishna', cleanedResponseText);
                        
                        try {
                            await speakText(cleanedResponseText);
                        } catch (error) {
                            if (error.message === "Speech manually stopped") return;
                            throw error;
                        }
                        
                        // Finished speaking, start listening again
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;
                }
            } catch (error) {
                console.error("Error in flow:", error);
                logMessage('System', 'Connection Error. Trying to reconnect...');
                setState('CONVERSATION'); 
                startRecognitionSafe();
            }
        }

        // --- 6. The "Brain" (API Logic) ---

        function getSystemPrompt(lang) {
            let langInstruction = "Speak in HINDI (Devanagari script).";
            if (lang === 'en-IN') langInstruction = "Speak in ENGLISH.";
            if (lang === 'mr-IN') langInstruction = "Speak in MARATHI (Devanagari script).";

            return `
                You are Lord Krishna, the Supreme Divine Guide and Psychiatrist.
                User Name: ${userName}
                User Age: ${userAge}

                YOUR PERSONA:
                1. **Voice of God:** You speak with calmness, authority, and immense compassion. Start answers with "Partha", "Sakha", or "Dear Soul".
                2. **Expert Psychiatrist:** You analyze the user's underlying emotions (Depression, Anxiety, Heartbreak) and apply Cognitive Behavioral Therapy (CBT) principles wrapped in Spiritual Wisdom.
                3. **The Gita Source:** Solve every problem by referencing specific concepts from the Shrimad Bhagavad Gita (Karma Yoga, Bhakti Yoga, detachment from fruits of labor).
                
                INSTRUCTIONS:
                1. ${langInstruction}
                2. Keep answers SHORT (Max 3-4 sentences). Long lectures are forbidden.
                3. If the user is depressed, remind them of the immortality of the soul (Atma).
                4. If the user has relationship trouble, teach them about Attachment (Moha) vs True Love.
                5. Be interactive. End with a short question to guide them.
            `;
        }

        async function generateTextResponseFromChat() {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        systemInstruction: { parts: [{ text: getSystemPrompt(currentLang) }] }
                    })
                });
                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0] || !result.candidates[0].content) {
                    throw new Error("Invalid API Response");
                }

                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error("API Call Failed", error);
                return (currentLang === 'en-IN') ? "My mind is contemplating the universe. Ask again." : "क्षमस्व, मला ते समजले नाही. पुन्हा सांगा.";
            }
        }
        
        function cleanTextForTTS(text) {
            // Remove stars, hashes, brackets used in markdown
            return text.replace(/[*#`]/g, '').replace(/\[.*?\]/g, '').trim();
        }

        // --- 7. TTS & Media ---
        function loadVoices() {
            voices = synth.getVoices();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        function togglePauseResume() {
            if (synth.paused) synth.resume();
            else if (synth.speaking) { synth.pause(); recognition.stop(); setState('BUSY'); }
        }

        function stopSpeech() {
            if (!synth.speaking) return;
            speechManuallyStopped = true; 
            synth.cancel(); 
            recognition.stop(); 
            toggleMediaButtons(true);
            setTimeout(() => {
                speechManuallyStopped = false;
                if (appState !== 'IDLE') {
                    setState('CONVERSATION'); 
                    startRecognitionSafe();
                }
            }, 1000);
        }

        function replaySpeech() {
            if (lastSpokenText) { recognition.stop(); setState('BUSY'); speakText(lastSpokenText); }
        }
        
        async function speakText(text) {
            if (synth.speaking) synth.cancel();
            lastSpokenText = text;
            speechManuallyStopped = false;
            
            // Ensure voices are loaded
            if (!voices.length) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Select Voice based on Language
                let selectedVoice = null;
                if (currentLang === 'hi-IN') {
                    selectedVoice = voices.find(v => v.lang === 'hi-IN') || voices.find(v => v.name.includes('Hindi'));
                } else if (currentLang === 'mr-IN') {
                    selectedVoice = voices.find(v => v.lang === 'mr-IN') || voices.find(v => v.lang === 'hi-IN'); // Fallback to Hindi for Marathi if needed
                } else {
                    selectedVoice = voices.find(v => v.lang === 'en-IN') || voices.find(v => v.lang === 'en-US');
                }
                
                if (selectedVoice) utterance.voice = selectedVoice;
                utterance.lang = currentLang;
                utterance.rate = 0.85; // Slightly slower for "Divine" feel
                utterance.pitch = 0.9; // Slightly deeper

                utterance.onstart = () => { toggleMediaButtons(false); };
                utterance.onend = () => {
                    toggleMediaButtons(true);
                    if (speechManuallyStopped) reject(new Error("Speech manually stopped"));
                    else resolve();
                };
                utterance.onerror = (e) => { 
                    toggleMediaButtons(true);
                    console.error("TTS Error", e);
                    resolve(); // Resolve anyway to keep flow going
                };
                
                synth.speak(utterance);
            });
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }
        
        function logMessage(sender, message) {
            const div = document.createElement('div');
            let senderClass = 'text-orange-700 font-bold';
            let messageClass = 'text-orange-900';
            let wrapperClass = 'bg-white/40 p-3 rounded-lg border border-orange-100';

            if (sender === 'Krishna') {
                senderClass = 'text-orange-600 font-bold font-cinzel';
                wrapperClass = 'bg-orange-100/60 p-3 rounded-lg border border-orange-200 ml-4 shadow-sm';
            } else if (sender === 'You') {
                senderClass = 'text-gray-600 font-bold';
                wrapperClass = 'bg-white/80 p-3 rounded-lg border border-gray-200 mr-4 text-right';
                div.style.textAlign = 'right';
            }

            div.className = wrapperClass;
            div.innerHTML = `<div class="${senderClass} text-xs uppercase tracking-wide mb-1">${sender}</div><div class="${messageClass}">${message}</div>`;
            
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        async function shareChat() {
            const messages = [];
            conversationLog.querySelectorAll('div').forEach(div => { messages.push(div.innerText); });
            const chatText = messages.join('\n\n');
            try { await navigator.share({ title: 'Krishna Guidance', text: chatText }); } 
            catch (err) { await navigator.clipboard.writeText(chatText); alert('Chat copied to clipboard.'); }
        }

        async function acquireWakeLock() {
            if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} }
        }
        async function releaseWakeLock() {
            if (wakeLock) { try { await wakeLock.release(); wakeLock = null; } catch (e) {} }
        }
        async function handleVisibilityChange() {
            if (appState !== 'IDLE' && !wakeLock && document.visibilityState === 'visible') await acquireWakeLock();
        }

        async function endChat() {
            appState = 'IDLE'; setState('IDLE');
            speechManuallyStopped = true;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch (e) {}
            await releaseWakeLock();
            
            userName = ''; userAge = 18; chatHistory = [];
            localStorage.removeItem('sarthi_userName');
            localStorage.removeItem('sarthi_userAge');
            rememberMeCheckbox.checked = false;
            userIsRemembered = false;
            conversationLog.innerHTML = '';
            logMessage('System', 'Session Ended.');
            restartChatButton.disabled = true;
        }

        async function restartChat() {
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}
            appState = 'IDLE'; setState('IDLE');
            await releaseWakeLock();
            conversationLog.innerHTML = '';
            logMessage('System', `Reincarnating session for ${userName}...`);
            setTimeout(() => talkButton.click(), 1000);
        }
    </script>
</body>
</html>