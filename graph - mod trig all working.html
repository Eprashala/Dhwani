<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #fff; overflow: hidden; }
        
        /* Top Input Bar */
        .toolbar { background: #f5f5f5; padding: 10px; display: flex; gap: 8px; align-items: center; border-bottom: 1px solid #ddd; z-index: 10; }
        .equation-input { display: flex; align-items: center; flex: 1; background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 0 10px; }
        .equation-input span { font-weight: bold; color: #00BCD4; font-size: 16px; margin-right: 5px; font-style: italic; }
        .equation-input input { border: none; outline: none; padding: 8px 0; font-size: 16px; flex: 1; font-family: monospace; color: #333;}
        
        button.action-btn { background: #00BCD4; border: none; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.1s; font-size: 13px;}
        button.action-btn:hover { background: #00ACC1; }
        button.btn-icon { background: #00BCD4; border: none; color: white; border-radius: 4px; padding: 6px 10px; font-size: 14px; cursor: pointer;}
        button.btn-icon:hover { background: #00ACC1; }

        /* Tabbed Math Palette */
        .palette-container { background: #eeeeee; border-bottom: 2px solid #00BCD4; display: flex; flex-direction: column; }
        
        /* Tab Headers */
        .tab-bar { display: flex; background: #e0e0e0; border-bottom: 1px solid #ccc; }
        .tab-btn { flex: 1; padding: 6px 0; border: none; background: transparent; cursor: pointer; font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; transition: 0.2s; border-right: 1px solid #ccc; }
        .tab-btn:hover { background: #d5d5d5; }
        .tab-btn.active { background: #eeeeee; color: #00BCD4; border-bottom: 2px solid #00BCD4; }
        
        /* Persistent Controls in Tab Bar */
        .persistent-controls { display: flex; background: #e0e0e0; }
        .persistent-controls button { border: none; background: transparent; cursor: pointer; font-weight: bold; padding: 0 12px; border-left: 1px solid #ccc; transition: 0.2s; }
        .persistent-controls button.btn-backspace { color: #E65100; font-size: 14px; }
        .persistent-controls button.btn-backspace:hover { background: #ffe0b2; }
        .persistent-controls button.btn-clear { color: #d32f2f; font-size: 12px; }
        .persistent-controls button.btn-clear:hover { background: #ffcdd2; }

        /* Tab Content Panels */
        .tab-pane { display: none; padding: 8px 10px; gap: 4px; flex-wrap: wrap; }
        .tab-pane.active { display: flex; }
        
        button.sc-btn { background: #fff; border: 1px solid #ddd; color: #333; padding: 4px 6px; border-radius: 3px; cursor: pointer; font-family: 'Segoe UI', sans-serif; font-weight: bold; font-size: 12px; transition: 0.1s; flex-grow: 1; text-align: center; min-width: 35px;}
        button.sc-btn:hover { background: #e0f7fa; border-color: #00BCD4; color: #00838F; }
        button.sc-btn.func { color: #E91E63; }
        button.sc-btn.var { color: #00BCD4; font-style: italic;}

        /* Canvas Area */
        .canvas-container { flex: 1; position: relative; overflow: hidden; cursor: grab; background: #fafafa; }
        .canvas-container:active { cursor: grabbing; }
        canvas { display: block; width: 100%; height: 100%; }

        .tooltip { position: absolute; bottom: 10px; left: 10px; font-size: 11px; color: #777; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; pointer-events: none; border: 1px solid #ddd;}
    </style>
</head>
<body>

<div class="toolbar">
    <div class="equation-input">
        <span>y =</span>
        <input type="text" id="eqInput" value="sin(x)" placeholder="e.g. x^2 * sin(x)" oninput="draw()" onkeydown="if(event.key === 'Enter') draw()">
    </div>
    <button class="action-btn" onclick="draw()">Plot</button>
    <button class="btn-icon" onclick="zoom(1.2)" title="Zoom In">‚ûï</button>
    <button class="btn-icon" onclick="zoom(0.8)" title="Zoom Out">‚ûñ</button>
    <button class="btn-icon" onclick="resetView()" title="Center Graph">üéØ</button>
</div>

<div class="palette-container">
    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab(event, 'pane-base')">Base</button>
        <button class="tab-btn" onclick="switchTab(event, 'pane-exps')">Mods</button>
        <button class="tab-btn" onclick="switchTab(event, 'pane-trig')">Trig</button>
        <button class="tab-btn" onclick="switchTab(event, 'pane-hyp')">Hyp</button>
        
        <div class="persistent-controls">
            <button class="btn-backspace" onclick="backspace()" title="Backspace">‚å´</button>
            <button class="btn-clear" onclick="clearInput()" title="All Clear">AC</button>
        </div>
    </div>

    <div id="pane-base" class="tab-pane active">
        <button class="sc-btn var" onclick="insertSymbol('x')">x</button>
        <button class="sc-btn var" onclick="insertSymbol('a')">a</button>
        <button class="sc-btn var" onclick="insertSymbol('b')">b</button>
        <button class="sc-btn var" onclick="insertSymbol('c')">c</button>
        <button class="sc-btn" onclick="insertSymbol('œÄ')">œÄ</button>
        <button class="sc-btn" onclick="insertSymbol('e')">e</button>
        <button class="sc-btn" onclick="insertSymbol('+')">+</button>
        <button class="sc-btn" onclick="insertSymbol('-')">‚àí</button>
        <button class="sc-btn" onclick="insertSymbol('*')">√ó</button>
        <button class="sc-btn" onclick="insertSymbol('/')">√∑</button>
        <button class="sc-btn" onclick="insertSymbol('(', 0)">(</button>
        <button class="sc-btn" onclick="insertSymbol(')', 0)">)</button>
    </div>

    <div id="pane-exps" class="tab-pane">
        <button class="sc-btn" onclick="insertSymbol('¬≤')">x¬≤</button>
        <button class="sc-btn" onclick="insertSymbol('¬≥')">x¬≥</button>
        <button class="sc-btn" onclick="insertSymbol('^')">x^y</button>
        <button class="sc-btn" onclick="insertSymbol('‚àö(', -1)">‚àöx</button>
        <button class="sc-btn" onclick="insertSymbol('cbrt(', -1)">‚àõx</button>
        <button class="sc-btn func" onclick="insertSymbol('| |', -2)">|x|</button>
        <button class="sc-btn func" onclick="insertSymbol('log(', -1)">log‚ÇÅ‚ÇÄ</button>
        <button class="sc-btn func" onclick="insertSymbol('ln(', -1)">ln</button>
        <button class="sc-btn func" onclick="insertSymbol('log2(', -1)">log‚ÇÇ</button>
        <button class="sc-btn func" onclick="insertSymbol('sign(', -1)">sgn</button>
        <button class="sc-btn func" onclick="insertSymbol('floor(', -1)">floor</button>
        <button class="sc-btn func" onclick="insertSymbol('ceil(', -1)">ceil</button>
    </div>

    <div id="pane-trig" class="tab-pane">
        <button class="sc-btn func" onclick="insertSymbol('sin(', -1)">sin</button>
        <button class="sc-btn func" onclick="insertSymbol('cos(', -1)">cos</button>
        <button class="sc-btn func" onclick="insertSymbol('tan(', -1)">tan</button>
        <button class="sc-btn func" onclick="insertSymbol('sec(', -1)">sec</button>
        <button class="sc-btn func" onclick="insertSymbol('csc(', -1)">csc</button>
        <button class="sc-btn func" onclick="insertSymbol('cot(', -1)">cot</button>
        <button class="sc-btn func" onclick="insertSymbol('asin(', -1)">sin‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('acos(', -1)">cos‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('atan(', -1)">tan‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('asec(', -1)">sec‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('acsc(', -1)">csc‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('acot(', -1)">cot‚Åª¬π</button>
    </div>

    <div id="pane-hyp" class="tab-pane">
        <button class="sc-btn func" onclick="insertSymbol('sinh(', -1)">sinh</button>
        <button class="sc-btn func" onclick="insertSymbol('cosh(', -1)">cosh</button>
        <button class="sc-btn func" onclick="insertSymbol('tanh(', -1)">tanh</button>
        <button class="sc-btn func" onclick="insertSymbol('sech(', -1)">sech</button>
        <button class="sc-btn func" onclick="insertSymbol('csch(', -1)">csch</button>
        <button class="sc-btn func" onclick="insertSymbol('coth(', -1)">coth</button>
        <button class="sc-btn func" onclick="insertSymbol('asinh(', -1)">sinh‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('acosh(', -1)">cosh‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('atanh(', -1)">tanh‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('asech(', -1)">sech‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('acsch(', -1)">csch‚Åª¬π</button>
        <button class="sc-btn func" onclick="insertSymbol('acoth(', -1)">coth‚Åª¬π</button>
    </div>
</div>

<div class="canvas-container" id="canvasContainer">
    <canvas id="graphCanvas"></canvas>
    <div class="tooltip">Scroll to Zoom | Drag to Pan</div>
</div>

<script>
    const canvas = document.getElementById('graphCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvasContainer');
    const inputField = document.getElementById('eqInput');

    let scale = 40; 
    let offsetX = 0; 
    let offsetY = 0; 

    // UNIVERSAL RESIZE FALLBACK (Works on all EXE Wrappers)
    function resizeCanvas() {
        if (container.clientWidth > 0 && container.clientHeight > 0) {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }
    }
    window.addEventListener('resize', resizeCanvas);
    
    // Polling interval ensures the graph draws the moment the window becomes visible
    let renderCheck = setInterval(() => {
        if (canvas.width !== container.clientWidth && container.clientWidth > 0) {
            resizeCanvas();
            clearInterval(renderCheck); // Stop checking once successfully rendered
        }
    }, 200);

    // --- TAB LOGIC ---
    function switchTab(evt, paneId) {
        const panes = document.getElementsByClassName("tab-pane");
        for (let i = 0; i < panes.length; i++) panes[i].classList.remove("active");
        
        const tabBtns = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < tabBtns.length; i++) tabBtns[i].classList.remove("active");
        
        document.getElementById(paneId).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    // --- SMART CURSOR CONTROLS ---
    function insertSymbol(val, cursorOffset = 0) {
        const start = inputField.selectionStart;
        const end = inputField.selectionEnd;
        const text = inputField.value;
        inputField.value = text.slice(0, start) + val + text.slice(end);
        
        const newPos = start + val.length + cursorOffset;
        inputField.focus();
        inputField.setSelectionRange(newPos, newPos);
        draw(); 
    }

    function backspace() {
        const start = inputField.selectionStart;
        const end = inputField.selectionEnd;
        const text = inputField.value;

        if (start === end && start > 0) {
            inputField.value = text.slice(0, start - 1) + text.slice(end);
            inputField.focus();
            inputField.setSelectionRange(start - 1, start - 1);
        } else if (start !== end) {
            inputField.value = text.slice(0, start) + text.slice(end);
            inputField.focus();
            inputField.setSelectionRange(start, start);
        }
        draw();
    }

    function clearInput() {
        inputField.value = '';
        inputField.focus();
        draw();
    }

    // --- BULLETPROOF MATH PARSER ---
    function compileMathExpression(expr) {
        if (!expr.trim()) return null;
        
        let parsed = expr.toLowerCase().replace(/\s+/g, '');
        
        // 1. Convert absolute value |x| to abs(x)
        parsed = parsed.replace(/\|([^\|]+)\|/g, 'abs($1)');
        
        // 2. Protect log2 so implicit multiplication doesn't break it
        parsed = parsed.replace(/log2/g, 'LOGTWO');
        
        // 3. Convert math symbols
        parsed = parsed
            .replace(/œÄ/g, 'pi')
            .replace(/œÜ/g, 'phi')
            .replace(/¬≤/g, '**2')
            .replace(/¬≥/g, '**3')
            .replace(/\^/g, '**')
            .replace(/‚àö\(/g, 'sqrt(');
            
        // 4. Safe Implicit multiplication (e.g., 2x -> 2*x, xsin -> x*sin)
        parsed = parsed.replace(/(\d)([a-z\(])/gi, '$1*$2');
        parsed = parsed.replace(/([x])([a-z\(])/gi, '$1*$2');
        parsed = parsed.replace(/\)([\dxa-z\(])/gi, ')*$1');
        
        // 5. Restore log2
        parsed = parsed.replace(/LOGTWO/g, 'log2');
        
        try {
            // Evaluated using pure, isolated scoping to prevent outer clashes
            return new Function('x', `
                const a = 1, b = 2, c = 3, y = 1, z = 1;
                const pi = Math.PI, e = Math.E, phi = 1.6180339887;
                const sin = Math.sin, cos = Math.cos, tan = Math.tan;
                const sec = function(v) { return 1/Math.cos(v); };
                const csc = function(v) { return 1/Math.sin(v); };
                const cot = function(v) { return 1/Math.tan(v); };
                const asin = Math.asin, acos = Math.acos, atan = Math.atan;
                const asec = function(v) { return Math.acos(1/v); };
                const acsc = function(v) { return Math.asin(1/v); };
                const acot = function(v) { return Math.PI/2 - Math.atan(v); };
                const sinh = Math.sinh, cosh = Math.cosh, tanh = Math.tanh;
                const sech = function(v) { return 1/Math.cosh(v); };
                const csch = function(v) { return 1/Math.sinh(v); };
                const coth = function(v) { return 1/Math.tanh(v); };
                const asinh = Math.asinh, acosh = Math.acosh, atanh = Math.atanh;
                const asech = function(v) { return Math.acosh(1/v); };
                const acsch = function(v) { return Math.asinh(1/v); };
                const acoth = function(v) { return 0.5 * Math.log((v+1)/(v-1)); };
                const log = Math.log10, ln = Math.log, log2 = Math.log2;
                const abs = Math.abs, sqrt = Math.sqrt, cbrt = Math.cbrt;
                const sign = Math.sign, floor = Math.floor, ceil = Math.ceil, round = Math.round;
                
                return ${parsed};
            `);
        } catch (err) {
            return null;
        }
    }

    // --- HIGH-PERFORMANCE RENDERING ---
    function draw() {
        if (canvas.width === 0 || canvas.height === 0) return; // Prevent 0x0 loop

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const centerX = (canvas.width / 2) + offsetX;
        const centerY = (canvas.height / 2) + offsetY;

        // Grid
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#e0e0e0';
        ctx.beginPath();
        const startCol = Math.floor(-centerX / scale);
        const endCol = Math.ceil((canvas.width - centerX) / scale);
        for(let i = startCol; i <= endCol; i++) {
            let x = centerX + i * scale;
            ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height);
        }
        const startRow = Math.floor(-centerY / scale);
        const endRow = Math.ceil((canvas.height - centerY) / scale);
        for(let i = startRow; i <= endRow; i++) {
            let y = centerY + i * scale;
            ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
        }
        ctx.stroke();

        // Axes
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#333';
        ctx.beginPath();
        ctx.moveTo(0, centerY); ctx.lineTo(canvas.width, centerY);
        ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvas.height);
        ctx.stroke();

        // Labels
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.fillText("0", centerX + 5, centerY + 15);
        if (scale > 15) { 
            ctx.fillText("1", centerX + scale + 5, centerY + 15);
            ctx.fillText("1", centerX + 5, centerY - scale + 15);
        }

        // Plot Function
        const expr = inputField.value;
        const func = compileMathExpression(expr);
        
        if (func) {
            ctx.beginPath();
            ctx.lineWidth = 2.5;
            ctx.strokeStyle = '#E91E63'; 
            
            let firstPoint = true;
            
            for(let px = 0; px <= canvas.width; px += 2) {
                let mathX = (px - centerX) / scale;
                try {
                    let mathY = func(mathX);
                    
                    if(!isFinite(mathY) || isNaN(mathY)) {
                        firstPoint = true;
                        continue;
                    }
                    let py = centerY - (mathY * scale);
                    if(py < -5000 || py > canvas.height + 5000) {
                        firstPoint = true;
                        continue;
                    }
                    if (firstPoint) {
                        ctx.moveTo(px, py);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(px, py);
                    }
                } catch(e) {
                    break;
                }
            }
            ctx.stroke();
        }
    }

    // --- INTERACTIVITY ---
    function zoom(factor) {
        scale *= factor;
        if(scale < 2) scale = 2;
        if(scale > 500) scale = 500;
        draw();
    }
    
    function resetView() {
        scale = 40; offsetX = 0; offsetY = 0;
        draw();
    }

    let isDragging = false;
    let lastX = 0, lastY = 0;

    canvas.addEventListener('mousedown', (e) => {
        isDragging = true; lastX = e.clientX; lastY = e.clientY;
    });
    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        offsetX += (e.clientX - lastX); offsetY += (e.clientY - lastY);
        lastX = e.clientX; lastY = e.clientY;
        draw();
    });
    window.addEventListener('mouseup', () => { isDragging = false; });
    window.addEventListener('mouseleave', () => { isDragging = false; });
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        zoom(e.deltaY > 0 ? 0.9 : 1.1);
    });
</script>
</body>
</html>