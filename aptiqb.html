<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhwani AI - Eprashala Local Assessment</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; display: flex; justify-content: center; height: 100dvh; box-sizing: border-box; }
        .container { background: white; max-width: 800px; width: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        button { background: #2980b9; color: white; border: none; padding: 14px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        button:disabled { background: #bdc3c7; }
        input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        
        #setup-screen { padding: 40px 20px; text-align: center; overflow-y: auto; height: 100%; }
        #test-screen { display: none; flex-direction: column; height: 100%; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 15px; }
        #stage-indicator { background: #e67e22; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; display: inline-block; margin-top: 5px; }
        
        #chat-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 90%; padding: 14px; border-radius: 10px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; }
        .bot-msg { background: #e3f2fd; color: #0b3c7c; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #bbdefb; }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .controls-area { padding: 15px; background: white; border-top: 1px solid #eee; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .input-row { display: flex; gap: 10px; align-items: center; }
        
        /* PTT Mic Button Styling */
        #micBtn { 
            background: #e67e22; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; flex-shrink: 0; border: none; padding: 0; transition: 0.2s;
            -webkit-user-select: none; -webkit-touch-callout: none; user-select: none; touch-action: none;
        }
        #micBtn.listening { background: #e74c3c; box-shadow: 0 0 15px rgba(231, 76, 60, 0.6); transform: scale(1.08); }
        
        #full-loader { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box;}
        #report-screen { display: none; flex-direction: column; height: 100%; }
        #report-content { flex: 1; overflow-y: auto; padding: 20px; background: white; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 20px; border-radius: 0 8px 8px 0; }
        #consult-area { background: #eef2f5; padding: 20px; border-top: 2px solid #ddd; }
        #consult-history { max-height: 250px; overflow-y: auto; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd;}
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen">
        <h2>Dhwani AI - Offline Evaluator</h2>
        <p style="color: #666; font-size: 14px;">Eprashala Hybrid Architecture</p>
        <input type="password" id="apiKey" placeholder="Gemini API Key (For Final Report)" required>
        <input type="text" id="childName" placeholder="Student's Name" required>
        <input type="number" id="childAge" placeholder="Age (e.g., 14)" required>
        <input type="text" id="childCity" placeholder="City/Town (e.g., Pune)" required>
        <button onclick="startTest()">Begin Assessment</button>
    </div>

    <div id="test-screen">
        <div class="header">
            <div id="test-header">Dhwani Session</div>
            <div id="stage-indicator">Stage 0: Basics</div>
        </div>
        <div id="chat-history"></div>
        
        <div class="controls-area">
            <p id="mic-status" style="font-size: 11px; color: #7f8c8d; margin: 0 0 5px 0; text-align: center;">Hold mic to speak. Auto-sends on release.</p>
            <div class="input-row">
                <button id="micBtn">ðŸŽ¤</button>
                <input type="text" id="userInput" placeholder="Type or hold mic..." onkeypress="handleEnter(event)">
                <button id="sendBtn" onclick="submitAnswer()" style="display: none;">Send</button>
            </div>
        </div>
    </div>

    <div id="report-screen">
        <div id="report-content"></div>
        <div id="consult-area">
            <h3 style="margin-top:0; color:#2c3e50;">Consult Dhwani</h3>
            <div id="consult-history"></div>
            <div class="input-row">
                <input type="text" id="consultInput" placeholder="Ask about colleges, streams..." onkeypress="if(event.key === 'Enter') sendConsult()">
                <button onclick="sendConsult()" style="width: auto; margin:0;">Ask</button>
            </div>
            <button onclick="downloadChatAsText()" style="background: #27ae60;">Download Full Report (.txt)</button>
        </div>
    </div>

    <div id="full-loader">
        <h2 id="loader-text">Dhwani is analyzing...</h2>
    </div>
</div>

<script>
    let childData = { name: "", age: 0, city: "" };
    let apiKey = "";
    
    // OFFLINE TEST LOGIC
    let currentStage = 0;
    let questionCount = 0;
    const questionsPerStage = 5; 
    let fullTranscript = ""; 
    let lastBotQuestion = ""; 
    let consultHistory = [];
    
    // THE OFFLINE QUESTION BANK (Add your 500 questions here)
    const QUESTION_BANK = {
        0: [
            "Do you prefer solving math puzzles, writing stories, playing sports, or drawing?",
            "If you had a free hour, would you rather read a book, build something, or talk to friends?",
            "Which subject do you score the highest marks in: Science, English, or History?",
            "Do you like working on computers, or do you prefer being outdoors?"
        ],
        1: [
            "Are you comfortable speaking in front of a large group of people? Answer yes or no.",
            "Do you easily get bored when doing repetitive tasks? Yes or no.",
            "Do you prefer working alone rather than in a team? Yes or no.",
            "Are you good at keeping a strict daily timetable? Yes or no."
        ],
        2: [
            "Describe a time when you helped a friend solve a difficult problem.",
            "What is the most interesting project you have made for a school exhibition?",
            "If you could invent one thing to help people in your city, what would it be?",
            "Tell me about a hobby you have that takes a lot of patience."
        ],
        3: [
            "You mentioned you like science. Why does studying how things work interest you so much?",
            "What kind of career do you see yourself having 10 years from now, and why?",
            "If you had to start a small business tomorrow, what product or service would you sell?",
            "How do you usually handle a situation where you completely disagree with your teacher or parents?"
        ],
        4: [
            "Imagine you are given a massive project but your team abandons you on the final day. How exactly do you handle the stress and complete it?",
            "AI is rapidly replacing many traditional jobs. What is your backup plan if your dream career becomes fully automated?",
            "If you fail your most important entrance exam next year, what is your immediate next step?",
            "Some people say pursuing your passion doesn't pay the bills. How would you balance making money with doing what you love?"
        ]
    };

    const STAGE_NAMES = ["Stage 0: Basics", "Stage 1: Quick Fire", "Stage 2: Short Thoughts", "Stage 3: Exploration", "Stage 4: Stress Test"];

    // --- PUSH-TO-TALK LOGIC ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isButtonHeld = false; 
    let committedText = ""; 

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false; 
        recognition.interimResults = true; 
        recognition.lang = 'en-IN'; 
        
        recognition.onstart = () => { 
            document.getElementById('micBtn').classList.add('listening'); 
            document.getElementById('mic-status').innerText = "Listening... Release to send.";
            document.getElementById('userInput').placeholder = "Listening...";
        };
        
        recognition.onresult = (e) => { 
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = e.resultIndex; i < e.results.length; ++i) {
                if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
                else interimTranscript += e.results[i][0].transcript;
            }
            
            if (finalTranscript) {
                if (committedText.length > 0 && !committedText.endsWith(' ') && !finalTranscript.startsWith(' ')) committedText += ' ';
                committedText += finalTranscript;
            }
            document.getElementById('userInput').value = committedText + interimTranscript;
        };

        recognition.onend = () => { 
            if (isButtonHeld) {
                try { recognition.start(); } catch(err) {}
            } else {
                stopListeningUI();
                setTimeout(() => {
                    const inputVal = document.getElementById('userInput').value.trim();
                    if (inputVal.length > 0) submitAnswer();
                }, 500);
            }
        };

        recognition.onerror = (e) => { if (e.error !== 'no-speech') stopListeningUI(); };
    }

    const micBtn = document.getElementById('micBtn');

    function startListening(e) {
        if (e) e.preventDefault();
        if (isButtonHeld || !recognition) return;
        isButtonHeld = true;
        committedText = document.getElementById('userInput').value;
        if (committedText.length > 0 && !committedText.endsWith(' ')) committedText += ' ';
        try { recognition.start(); } catch(err) {}
    }

    function stopListening(e) {
        if (e) e.preventDefault();
        if (!isButtonHeld) return;
        isButtonHeld = false; 
        try { recognition.stop(); } catch(err) {} 
    }

    micBtn.addEventListener('touchstart', startListening, { passive: false });
    micBtn.addEventListener('touchend', stopListening);
    micBtn.addEventListener('touchcancel', stopListening);
    micBtn.addEventListener('mousedown', startListening);
    micBtn.addEventListener('mouseup', stopListening);
    micBtn.addEventListener('mouseleave', stopListening);

    function stopListeningUI() {
        document.getElementById('micBtn').classList.remove('listening'); 
        document.getElementById('mic-status').innerText = "Hold mic to speak. Auto-sends on release.";
        document.getElementById('userInput').placeholder = "Type or hold mic...";
    }

    // --- TTS SETUP ---
    function unlockAndroidAudio() {
        const silentUtterance = new SpeechSynthesisUtterance('');
        silentUtterance.volume = 0;
        window.speechSynthesis.speak(silentUtterance);
    }

    function speakDhwaniResponse(text) {
        if (!('speechSynthesis' in window)) return;
        window.speechSynthesis.cancel(); 
        const utterance = new SpeechSynthesisUtterance(text);
        
        let voices = window.speechSynthesis.getVoices();
        let targetVoice = voices.find(v => 
            (v.lang.includes('en-IN') || v.lang.includes('hi-IN') || v.lang.includes('mr-IN')) && 
            (v.name.toLowerCase().includes('female') || v.name.includes('Google'))
        ) || voices.find(v => v.lang === 'en-IN');
        
        if (targetVoice) utterance.voice = targetVoice;
        utterance.rate = 0.90; 
        utterance.pitch = 1.1; 
        window.speechSynthesis.speak(utterance);
    }

    // --- CORE LOCAL LOGIC ---
    function startTest() {
        apiKey = document.getElementById('apiKey').value.trim();
        childData.name = document.getElementById('childName').value.trim();
        childData.age = parseInt(document.getElementById('childAge').value);
        childData.city = document.getElementById('childCity').value.trim();

        if(!apiKey || !childData.name || !childData.age || !childData.city) { alert("Fill all fields."); return; }

        unlockAndroidAudio(); 
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('test-screen').style.display = 'flex';
        
        // Start the offline loop
        askNextLocalQuestion(true);
    }

    function askNextLocalQuestion(isFirst = false) {
        document.getElementById('stage-indicator').innerText = STAGE_NAMES[currentStage];
        
        // Pick a random question from the current stage bank
        const bank = QUESTION_BANK[currentStage];
        const randomInt = Math.floor(Math.random() * bank.length);
        let nextQuestion = bank[randomInt];

        // Slight personalization trick offline
        if (isFirst) {
            nextQuestion = `Namaste ${childData.name}. Let's begin. ` + nextQuestion;
        }

        lastBotQuestion = nextQuestion;
        addMessage(nextQuestion, 'bot', 'chat-history');
        speakDhwaniResponse(nextQuestion);
    }

    function submitAnswer() {
        if (isButtonHeld) { isButtonHeld = false; try { recognition.stop(); } catch(e){} }

        const input = document.getElementById('userInput');
        const answerTxt = input.value.trim();
        if (!answerTxt) return;
        
        addMessage(answerTxt, 'user', 'chat-history');
        fullTranscript += `Stage ${currentStage} - Q: ${lastBotQuestion}\nUser (${childData.name}): ${answerTxt}\n\n`;

        input.value = '';
        committedText = ''; 
        questionCount++;
        
        if (questionCount >= questionsPerStage) {
            currentStage++;
            questionCount = 0;
            
            const chat = document.getElementById('chat-history');
            const divider = document.createElement('div');
            divider.innerHTML = `<hr style="border:0; border-top:1px dashed #ccc; margin: 20px 0;">`;
            chat.appendChild(divider);
        }

        if (currentStage > 4) {
            // Trigger the SINGLE Gemini API call
            generateFinalReport();
        } else {
            // Instantly ask next local question
            setTimeout(() => askNextLocalQuestion(), 500);
        }
    }

    function handleEnter(e) { if (e.key === 'Enter') submitAnswer(); }

    function cleanText(text) { return text.replace(/\*\*(.*?)\*\*/g, '$1').replace(/\*/g, ''); }

    // --- THE SINGLE GEMINI API CALL FOR REPORT ---
    async function generateFinalReport() {
        setLoading(true, "Test complete. Sending transcript to Dhwani Server for deep analysis...");
        
        const reportPrompt = `You are Dhwani, the career consultant AI. The user (${childData.name}, Age ${childData.age}, from ${childData.city}) just completed their aptitude test.
        Here is the full flat-text transcript of their answers across 5 stages:
        
        ${fullTranscript}
        
        Analyze this entire transcript holistically to determine their inclinations. Output ONLY raw HTML. 
        Format strictly:
        <h2 style='color:#2980b9'>Dhwani AI Executive Summary</h2>
        <div class='report-card'><b>Personality Traits:</b> Honest psychological assessment based on their text.</div>
        <div class='report-card'><b>Strengths & Areas of Improvement:</b> Highlight specific answers they gave.</div>
        <div class='report-card'><b>Recommended Indian Career Streams:</b> Top 3 paths (e.g. Commerce, IT, Arts) suitable for them.</div>`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ role: "user", parts: [{ text: reportPrompt }] }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" }
                    ]
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || "Report Generation Failed");

            let rawHtml = data.candidates[0].content.parts[0].text;
            rawHtml = rawHtml.replace(/^```html\n|```\n?$/gm, '').trim();

            document.getElementById('test-screen').style.display = 'none';
            document.getElementById('report-screen').style.display = 'flex';
            document.getElementById('report-content').innerHTML = rawHtml;
            
            consultHistory.push({ role: "user", parts: [{ text: "I have read my report. Let's start the post-test consultation." }] });
            speakDhwaniResponse("Assessment complete. Your final report is ready. You can now consult me below for further guidance.");
        } catch (e) { 
            console.error("Report Error:", e);
            alert(`Error generating report: ${e.message}`); 
        } finally {
            setLoading(false);
        }
    }

    // --- POST-TEST CONSULTATION (API REMAINS ACTIVE HERE) ---
    async function sendConsult() {
        const input = document.getElementById('consultInput');
        const text = input.value.trim();
        if (!text) return;
        addMessage(text, 'user', 'consult-history');
        consultHistory.push({ role: "user", parts: [{ text: text }] });
        input.value = '';
        
        // Pass the transcript context silently so the AI remembers their test
        let contextBlock = [{ role: "user", parts: [{ text: "Context Transcript:\n" + fullTranscript }] }];
        let activeHistory = contextBlock.concat(consultHistory);

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: "You are Dhwani, an Indian career consultant. Give advice on Indian colleges, coaching, Udemy, and entrance exams. Reply in plain text. DO NOT USE MARKDOWN." }] },
                    contents: activeHistory
                })
            });
            const data = await response.json();
            const reply = cleanText(data.candidates[0].content.parts[0].text);
            
            consultHistory.push({ role: "model", parts: [{ text: reply }] });
            addMessage(reply, 'bot', 'consult-history');
            speakDhwaniResponse(reply); 
        } catch(e) { alert("Error connecting."); }
    }

    function downloadChatAsText() {
        let textToSave = `--- Eprashala Dhwani Report for ${childData.name} ---\n\n`;
        textToSave += `Test Transcript:\n${fullTranscript}\n\n`;
        textToSave += `--- Consultation Log ---\n`;
        consultHistory.forEach(msg => { if (!msg.parts[0].text.includes("I have read my report")) textToSave += `${msg.role}: ${msg.parts[0].text}\n\n`; });
        
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([textToSave], { type: "text/plain" }));
        link.download = `Eprashala_Dhwani_${childData.name}.txt`;
        link.click();
    }

    function addMessage(text, sender, containerId) {
        const chat = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = `message ${sender}-msg`;
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function setLoading(show, text="") {
        document.getElementById('full-loader').style.display = show ? 'flex' : 'none';
        document.getElementById('loader-text').innerText = text;
    }
</script>
</body>
</html>