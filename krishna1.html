<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Krishna Sarthi - AI Gita Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Holy Font */
        @import url('https://fonts.googleapis.com/css2?family=Martel:wght@300;400;700&family=Yatra+One&display=swap');
        
        body { 
            font-family: 'Martel', serif; 
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
        }
        h1, button { font-family: 'Yatra One', serif; }
        
        /* ANIMATION: Divine Pulse */
        .listening-pulse { animation: divinePulse 2s infinite ease-in-out; }
        @keyframes divinePulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7); } 
            70% { box-shadow: 0 0 0 15px rgba(255, 165, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0); }
        }

        /* UI: Peacock Feather Effect (CSS Art) - Positioned for Mobile */
        .peacock-feather {
            position: absolute;
            top: -30px;
            right: -30px;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle at center, #1e3a8a 0%, #06b6d4 30%, #10b981 50%, #d97706 70%);
            border-radius: 50% 0 50% 50%;
            transform: rotate(45deg);
            opacity: 0.6;
            filter: blur(12px);
            z-index: 0;
            pointer-events: none;
        }

        /* UI: Buttons - Mobile Touch Targets */
        .icon-btn {
            @apply p-4 rounded-full text-white transition-all duration-200
                   bg-orange-800 hover:bg-orange-700 shadow-lg border border-yellow-600/50
                   active:scale-95 focus:outline-none
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors
                   bg-orange-900/80 text-yellow-100 border border-orange-800
                   active:bg-orange-800
                   focus:outline-none
                   disabled:opacity-50 disabled:cursor-not-allowed;
        }

        /* UI: Inputs - Compact Row */
        .custom-input {
            @apply block w-full text-center border border-yellow-700/50 rounded-lg p-2 outline-none transition-all text-sm;
            background-color: rgba(42, 10, 10, 0.8) !important; 
            color: #fcd34d !important;             
        }
        .custom-input::placeholder { color: #b45309 !important; }

        /* Scrollbar styling */
        #conversation-log {
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            scrollbar-width: thin;
            scrollbar-color: #d97706 #1a0505;
        }
        #conversation-log::-webkit-scrollbar { width: 4px; }
        #conversation-log::-webkit-scrollbar-track { background: transparent; }
        #conversation-log::-webkit-scrollbar-thumb { background: #d97706; border-radius: 10px; }
        
        .live-transcript {
            @apply text-yellow-200 text-xs italic opacity-80 min-h-[1.5em] truncate px-4;
        }
    </style>
</head>

<body class="bg-orange-950 h-[100dvh] w-full flex items-center justify-center overflow-hidden relative" oncontextmenu="return false;">

    <div class="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none" 
         style="background-image: radial-gradient(#f59e0b 1px, transparent 1px); background-size: 20px 20px;">
    </div>

    <div class="relative w-full h-full md:h-[90vh] md:max-w-md md:rounded-3xl bg-[#1a0505] shadow-2xl flex flex-col overflow-hidden border-x-0 md:border-4 border-orange-800/50">
        
        <div class="peacock-feather"></div>

        <div class="flex items-center justify-between p-4 shrink-0 z-20 bg-gradient-to-b from-orange-900 to-[#1a0505] border-b border-orange-800/30">
            <div>
                <h1 class="text-2xl text-yellow-400 drop-shadow-md tracking-wide leading-none">
                    ‡§ï‡•É‡§∑‡•ç‡§£ <span class="text-white text-xl">‡§∏‡§æ‡§∞‡§•‡•Ä</span>
                </h1>
                <p class="text-[10px] text-orange-300/80 font-sans">AI Gita Guide</p>
            </div>
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-600 border border-white/20 shadow-[0_0_10px_rgba(255,255,255,0.2)]" title="Status"></div>
        </div>

        <div id="conversation-log" class="flex-1 overflow-y-auto p-4 space-y-4 relative scroll-smooth">
            <div class="text-yellow-200/40 text-center mt-20 font-serif italic text-sm px-6">
                <p class="mb-4 text-2xl opacity-50">üïâÔ∏è</p>
                "Arjuna, I am the beginning, the middle, and the end of all beings."
                <br><br>
                <div class="text-xs text-orange-400/60 border border-orange-900/50 rounded-lg p-2 inline-block bg-black/20">
                    Tap <strong>Start</strong> or say <br>
                    <span class="text-yellow-300 font-bold">"Hare Krishna"</span>
                </div>
            </div>
        </div>
        
        <div class="shrink-0 bg-[#120303] border-t border-orange-800/30 p-4 pb-6 z-30 flex flex-col gap-3">
            
            <div id="live-text-container" class="text-center hidden">
                <span class="text-orange-400 text-[10px] uppercase tracking-[0.2em] animate-pulse">Listening...</span>
                <div id="live-transcript" class="live-transcript"></div>
            </div>

            <div class="flex justify-center gap-6">
                <button id="pause-resume-button" class="icon-btn bg-gray-800" disabled>
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>
                </button>
                
                <button id="stop-speech-button" class="icon-btn bg-red-900/80 text-red-100" disabled>
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>
                </button>

                <button id="replay-button" class="icon-btn bg-emerald-900/80 text-emerald-100" disabled>
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                </button>
            </div>

            <div class="flex gap-2 w-full">
                <input type="text" id="manual-name" class="custom-input flex-[2]" placeholder="Name (‡§®‡§æ‡§µ)">
                <input type="number" id="manual-age" class="custom-input flex-[1]" placeholder="Age">
            </div>

            <div class="flex flex-col items-center">
                <button id="advance-toggle-btn" class="text-[10px] text-orange-500/70 uppercase tracking-wider mb-2">
                    ‚ñº API Key Settings
                </button>
                <div id="advance-container" class="hidden w-full bg-orange-950/50 rounded-lg p-2 flex-col gap-2 mb-2">
                    <div class="flex items-center gap-2 justify-center">
                        <input type="checkbox" id="use-custom-key-checkbox" class="accent-orange-600">
                        <label for="use-custom-key-checkbox" class="text-xs text-yellow-200/80">Use Custom Key</label>
                    </div>
                    <input type="text" id="custom-api-key-input" class="custom-input text-[10px] !p-1" placeholder="Paste Key Here" disabled>
                    <button id="paste-key-btn" disabled class="w-full py-1 bg-orange-800 text-[10px] text-white rounded opacity-50 disabled:opacity-20">Paste</button>
                </div>
            </div>

            <button id="talk-button" class="w-full py-4 rounded-xl text-lg font-bold tracking-widest text-white shadow-lg
                       bg-gradient-to-r from-orange-700 via-red-600 to-orange-700 border-t border-orange-400/30
                       active:scale-[0.98] transition-transform duration-150
                       disabled:from-gray-800 disabled:to-gray-700 disabled:text-gray-500">
                START
            </button>

            <div class="grid grid-cols-2 gap-2 mt-1">
                <button id="restart-chat-button" class="utility-btn" disabled>New Session</button>
                <button id="end-chat-button" class="utility-btn text-red-300 border-red-900/50 bg-red-900/20" disabled>End</button>
            </div>
        </div>

    </div>

    <script>
        /* ==========================================================================
           KRISHNA SARTHI LOGIC v3.0 (Mobile Optimized)
           ========================================================================== */

        document.addEventListener('contextmenu', event => event.preventDefault());
        
        // Mobile helper: Fix 100vh issue on mobile browsers
        function setAppHeight() {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', setAppHeight);
        setAppHeight();

        function enterFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen(); } 
        }

        // --- DOM ELEMENTS ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');
        const liveTextContainer = document.getElementById('live-text-container');
        const liveTranscript = document.getElementById('live-transcript');
        
        // Advance Settings
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        // --- CONFIGURATION ---
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 0;
        let chatHistory = []; 
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;
        
        // Patience Logic
        let silenceTimer = null;
        let finalTranscriptAccumulator = '';
        const SILENCE_DELAY_MS = 2500; // 2.5 seconds patience

        // --- INITIALIZATION ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData(); 
            loadVoices();   
        };

        // --- SETTINGS UI ---
        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
        });

        useCustomKeyCheckbox.addEventListener('change', () => {
            const isChecked = useCustomKeyCheckbox.checked;
            customApiKeyInput.disabled = !isChecked;
            pasteKeyBtn.disabled = !isChecked;
            pasteKeyBtn.style.opacity = isChecked ? "1" : "0.5";
            saveUserData(); 
        });

        customApiKeyInput.addEventListener('input', saveUserData);

        pasteKeyBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    customApiKeyInput.value = text;
                    saveUserData();
                    pasteKeyBtn.textContent = "OK";
                    setTimeout(() => { pasteKeyBtn.textContent = "Paste"; }, 1000);
                }
            } catch (err) { alert('Manual Paste Required'); }
        });

        function getEffectiveApiKey() {
            if (useCustomKeyCheckbox.checked && customApiKeyInput.value.trim().length > 10) {
                return customApiKeyInput.value.trim();
            }
            return DEFAULT_API_KEY;
        }

        // --- MEMORY ---
        function loadUserData() {
            try {
                const savedName = localStorage.getItem('krishna_userName');
                const savedAge = localStorage.getItem('krishna_userAge');
                if (savedName) manualNameInput.value = savedName;
                if (savedAge) manualAgeInput.value = savedAge;

                const savedUseKey = localStorage.getItem('krishna_useCustomKey');
                const savedKey = localStorage.getItem('krishna_customKey');
                if (savedUseKey === 'true') {
                    useCustomKeyCheckbox.checked = true;
                    customApiKeyInput.disabled = false;
                    pasteKeyBtn.disabled = false;
                    pasteKeyBtn.style.opacity = "1";
                    if (savedKey) customApiKeyInput.value = savedKey;
                }
            } catch (e) {}
        }

        function saveUserData() {
            try {
                localStorage.setItem('krishna_userName', manualNameInput.value.trim());
                localStorage.setItem('krishna_userAge', manualAgeInput.value.trim());
                localStorage.setItem('krishna_useCustomKey', useCustomKeyCheckbox.checked);
                if (customApiKeyInput.value) {
                    localStorage.setItem('krishna_customKey', customApiKeyInput.value.trim());
                }
            } catch (e) {}
        }

        function loadChatContext(name) {
            const key = `krishna_history_${name.toLowerCase()}`;
            const savedHistory = localStorage.getItem(key);
            try { return savedHistory ? JSON.parse(savedHistory) : []; } catch (e) { return []; }
        }

        function saveChatContext() {
            if (!userName) return;
            const key = `krishna_history_${userName.toLowerCase()}`;
            const limitedHistory = chatHistory.slice(-20); 
            localStorage.setItem(key, JSON.stringify(limitedHistory));
        }

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            logMessage('System', 'Browser not supported. Please use Chrome.');
            talkButton.disabled = true;
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = true; 
            recognition.interimResults = true; 
            recognition.lang = 'mr-IN'; 

            recognition.onresult = handleSpeechResultStream;
            recognition.onend = handleSpeechEnd;
            recognition.onerror = (event) => {
                if (event.error === 'not-allowed') setState('IDLE');
            };
        }

        function startRecognitionSafe() {
            if (!recognition) return;
            try { 
                finalTranscriptAccumulator = ''; 
                recognition.start(); 
                liveTextContainer.classList.remove('hidden');
            } catch (e) {}
        }

        function stopRecognitionSafe() {
             if (!recognition) return;
             try { recognition.stop(); } catch(e) {}
             liveTextContainer.classList.add('hidden');
        }

        // --- MAIN FLOW ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);

        async function toggleListening() {
            if (appState === 'IDLE') {
                try { enterFullScreen(); } catch(e) {}
                
                const inputName = manualNameInput.value.trim();
                const inputAge = manualAgeInput.value.trim();
                
                talkButton.textContent = "Connecting...";
                talkButton.disabled = true;
                await acquireWakeLock();

                if (inputName && inputAge) {
                    // PATH A: Known User
                    userName = inputName;
                    userAge = parseInt(inputAge) || 20;
                    saveUserData(); 
                    buildSystemPrompt(); 

                    const previousHistory = loadChatContext(userName);
                    if (previousHistory.length > 0) {
                        chatHistory = previousHistory;
                        logMessage('Krishna', `Radhe Radhe ${userName}.`);
                        await speakText(`‡§∞‡§æ‡§ß‡•á ‡§∞‡§æ‡§ß‡•á ${userName}, ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§Ü‡§π‡•á.`, 'mr-IN');
                    } else {
                         if (chatHistory.length === 0) {
                            chatHistory.push({ role: 'user', parts: [{ text: "Start." }] });
                            chatHistory.push({ role: 'model', parts: [{ text: `Radhe Radhe ${userName}.` }] });
                        }
                        const welcomeText = `‡§∞‡§æ‡§ß‡•á ‡§∞‡§æ‡§ß‡•á ${userName}. ‡§Æ‡•Ä ‡§ï‡•É‡§∑‡•ç‡§£, ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∏‡§æ‡§∞‡§•‡•Ä.`;
                        logMessage('Krishna', welcomeText);
                        setState('BUSY'); 
                        await speakText(welcomeText, 'mr-IN');
                    }
                    setState('CONVERSATION');
                    startRecognitionSafe();

                } else {
                    // PATH B: Unknown User
                    setState('LISTENING_FOR_WAKEWORD');
                    startRecognitionSafe();
                    if (conversationLog.childElementCount < 3) logMessage('System', 'Say "Hare Krishna"');
                }
            } else {
                // STOP
                setState('IDLE');
                stopRecognitionSafe();
                if (synth.speaking) synth.cancel();
                await releaseWakeLock();
            }
        }

        function setState(newState) {
            appState = newState;
            switch (newState) {
                case 'IDLE':
                    talkButton.textContent = 'START';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-gray-600 border border-white/20';
                    endChatButton.disabled = true;
                    talkButton.classList.remove('from-red-600', 'to-red-800');
                    talkButton.classList.add('from-orange-700', 'to-orange-700');
                    manualNameInput.disabled = false;
                    manualAgeInput.disabled = false;
                    liveTextContainer.classList.add('hidden');
                    break;
                case 'BUSY':
                    talkButton.textContent = 'THINKING...';
                    talkButton.disabled = true;
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-400 border border-white shadow-[0_0_10px_rgba(250,204,21,0.5)]';
                    endChatButton.disabled = false;
                    liveTextContainer.classList.add('hidden');
                    break;
                default: // LISTENING
                    talkButton.textContent = 'LISTENING...';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-3 h-3 rounded-full bg-orange-500 listening-pulse border border-white';
                    endChatButton.disabled = false;
                    talkButton.classList.remove('from-orange-700', 'to-orange-700');
                    talkButton.classList.add('from-red-600', 'to-red-800');
                    manualNameInput.disabled = true;
                    manualAgeInput.disabled = true;
                    liveTextContainer.classList.remove('hidden');
                    break;
            }
        }

        function handleSpeechEnd() {
            if (appState !== 'IDLE' && appState !== 'BUSY') {
                startRecognitionSafe();
            } else if (appState === 'IDLE') {
                setState('IDLE'); 
            }
        }

        function handleSpeechResultStream(event) {
            clearTimeout(silenceTimer);

            let interimTranscript = '';
            let finalChunk = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalChunk += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            finalTranscriptAccumulator += finalChunk;
            liveTranscript.textContent = finalTranscriptAccumulator + " " + interimTranscript;
            
            // Scroll transcript to see new words
            liveTranscript.scrollLeft = liveTranscript.scrollWidth;

            silenceTimer = setTimeout(() => {
                if (finalTranscriptAccumulator.trim().length > 0 || interimTranscript.trim().length > 0) {
                    const fullText = (finalTranscriptAccumulator + " " + interimTranscript).trim();
                    processFinalInput(fullText);
                }
            }, SILENCE_DELAY_MS);
        }

        async function processFinalInput(transcript) {
            if (!transcript) return;
            stopRecognitionSafe();
            
            const currentState = appState;
            setState('BUSY');

            try {
                switch (currentState) {
                    case 'LISTENING_FOR_WAKEWORD':
                        const lower = transcript.toLowerCase();
                        const wakeWords = ['krishna', 'kru', 'hare', 'jai', 'jay', 'shree', 'shri', '‡§π‡§∞‡•á', '‡§ï‡•É‡§∑‡•ç‡§£', '‡§ú‡§Ø', '‡§∂‡•ç‡§∞‡•Ä', '‡§∞‡§æ‡§ß‡•á'];
                        
                        if (wakeWords.some(word => lower.includes(word))) {
                            const greeting = "‡§∞‡§æ‡§ß‡•á ‡§∞‡§æ‡§ß‡•á! ‡§Æ‡•Ä ‡§ï‡•É‡§∑‡•ç‡§£. ‡§§‡•Å‡§Æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§ï‡§æ‡§Ø ‡§Ü‡§π‡•á?";
                            logMessage('Krishna', greeting);
                            await speakText(greeting, 'mr-IN');
                            setState('LISTENING_FOR_NAME');
                            startRecognitionSafe(); 
                        } else {
                            setState('LISTENING_FOR_WAKEWORD');
                            startRecognitionSafe();
                        }
                        break;

                    case 'LISTENING_FOR_NAME':
                        logMessage('You', transcript);
                        userName = transcript.split(' ').slice(0,2).join(' '); 
                        manualNameInput.value = userName; 
                        const agePrompt = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${userName}, ‡§µ‡§Ø ‡§∏‡§æ‡§Ç‡§ó‡§æ?`;
                        logMessage('Krishna', agePrompt);
                        await speakText(agePrompt, 'mr-IN');
                        setState('LISTENING_FOR_AGE');
                        startRecognitionSafe();
                        break;

                    case 'LISTENING_FOR_AGE':
                        logMessage('You', transcript);
                        userAge = parseInt(transcript.replace(/\D/g,'')) || 25;
                        manualAgeInput.value = userAge; 
                        saveUserData();
                        buildSystemPrompt(); 

                        const startPrompt = `‡§Ö‡§∞‡•ç‡§ú‡•Å‡§®‡§æ, ‡§Æ‡•Ä ‡§§‡§Ø‡§æ‡§∞ ‡§Ü‡§π‡•á.`;
                        logMessage('Krishna', startPrompt);
                        await speakText(startPrompt, 'mr-IN');
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;

                    case 'CONVERSATION':
                        logMessage(userName || 'You', transcript);
                        chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                        saveChatContext();

                        const aiResponseText = await getAIResponse(chatHistory);
                        const cleanedResponseText = cleanTextForTTS(aiResponseText);

                        chatHistory.push({ role: 'model', parts: [{ text: cleanedResponseText }] });
                        saveChatContext();

                        logMessage('Krishna', cleanedResponseText);
                        
                        try { await speakText(cleanedResponseText, 'mr-IN'); } 
                        catch (error) { if (error.message === "Speech manually stopped") return; }
                        
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;
                }
            } catch (error) {
                console.error(error);
                setState('CONVERSATION'); 
                startRecognitionSafe();
            }
        }

        function buildSystemPrompt() {
            let toneInstruction = "";
            if (userAge <= 12) {
                toneInstruction = "User is a child (Bal Gopal). Keep answers very short (2 sentences).";
            } else {
                toneInstruction = "User is adult. Answer deeply with Bhagavad Gita Chapter/Verse (Adhyay X, Shloka Y).";
            }

            systemInstruction = `
                You are Lord Krishna. User is Arjuna.
                Language: Marathi.
                1. ${toneInstruction}
                2. Give HOPE and strength.
                3. End with "Radhe Radhe".
                4. Be polite and soft.
                5. Answer in Marathi Script.
            `;
            restartChatButton.disabled = false;
        }

        async function getAIResponse(historyData) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: historyData,
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) { return "‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‡§Ü‡§¢‡§≥‡§≤‡•Ä. ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ."; }
        }

        function cleanTextForTTS(text) {
            let cleaned = text.replace(/\[.*?\]|\(.*?\)|{.*?}/g, ""); 
            return cleaned.replace(/[\*#`]/g, ' ').replace(/\s+/g, ' ').trim();
        }

        function loadVoices() {
            voices = synth.getVoices();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        function togglePauseResume() {
            if (synth.paused) synth.resume();
            else if (synth.speaking) { synth.pause(); stopRecognitionSafe(); setState('BUSY'); }
        }

        function stopSpeech() {
            if (!synth.speaking) return;
            speechManuallyStopped = true; 
            synth.cancel(); 
            stopRecognitionSafe();
            toggleMediaButtons(true);
            setTimeout(() => {
                speechManuallyStopped = false;
                if (appState !== 'IDLE') { setState('CONVERSATION'); startRecognitionSafe(); }
            }, 1500);
        }

        function replaySpeech() {
            if (lastSpokenText) { stopRecognitionSafe(); setState('BUSY'); speakText(lastSpokenText); }
        }
        
        async function speakText(text, lang = 'mr-IN') {
            if (synth.speaking) synth.cancel();
            lastSpokenText = text;
            speechManuallyStopped = false;
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.onstart = () => { toggleMediaButtons(false); };
                utterance.onend = () => {
                    toggleMediaButtons(true);
                    if (speechManuallyStopped) reject(new Error("Speech manually stopped"));
                    else resolve();
                };
                utterance.onerror = (e) => { 
                    toggleMediaButtons(true);
                    if (e.error === 'interrupted') resolve(); else reject(e.error); 
                };

                const marathiVoices = voices.filter(voice => voice.lang === 'mr-IN' || voice.lang === 'hi-IN');
                if (marathiVoices.length > 1) utterance.voice = marathiVoices[1]; 
                else if (marathiVoices.length === 1) utterance.voice = marathiVoices[0];
                
                utterance.lang = 'mr-IN';
                utterance.rate = 0.9; 
                utterance.pitch = 0.8; 
                
                synth.speak(utterance);
            });
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }
        
        function logMessage(sender, message) {
            const div = document.createElement('div');
            // Simpler logic for mobile readability
            if (sender === 'Krishna') {
                div.innerHTML = `<div class="bg-orange-900/40 border-l-2 border-orange-500 p-2 rounded-r-lg rounded-bl-lg text-yellow-50 text-sm"><span class="text-orange-400 font-bold block text-xs mb-1">KRISHNA</span>${message}</div>`;
            } else if (sender === 'You') {
                div.innerHTML = `<div class="bg-gray-800/40 p-2 rounded-l-lg rounded-br-lg text-right text-white text-sm ml-auto max-w-[85%]"><span class="text-green-400 font-bold block text-xs mb-1">YOU</span>${message}</div>`;
            } else {
                div.innerHTML = `<div class="text-center text-xs text-gray-500 my-2">${message}</div>`;
            }
            conversationLog.appendChild(div);
            // Force scroll to bottom
            setTimeout(() => { conversationLog.scrollTop = conversationLog.scrollHeight; }, 100);
        }

        async function acquireWakeLock() {
            if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} }
        }
        async function releaseWakeLock() {
            if (wakeLock) { try { await wakeLock.release(); wakeLock = null; } catch (e) {} }
        }

        async function endChat() {
            appState = 'IDLE'; setState('IDLE');
            speechManuallyStopped = true;
            if (synth.speaking) synth.cancel();
            stopRecognitionSafe();
            await releaseWakeLock();
            userName = ''; userAge = 0; chatHistory = []; 
            conversationLog.innerHTML = '<div class="text-yellow-500/50 text-center text-sm mt-10">Ended.</div>';
            restartChatButton.disabled = true;
        }

        async function restartChat() {
            if (synth.speaking) synth.cancel();
            stopRecognitionSafe();
            appState = 'IDLE'; setState('IDLE');
            await releaseWakeLock();
            conversationLog.innerHTML = '';
            if(userName) {
                localStorage.removeItem(`krishna_history_${userName.toLowerCase()}`);
                chatHistory = [];
            }
        }
    </script>
</body>
</html>