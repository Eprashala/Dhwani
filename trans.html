<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani AI - Pro Question Bank Translator (Auto-Resume)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; max-width: 800px; width: 100%; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 8px; }
        h2 { color: #2c3e50; margin-top: 0; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 14px; font-weight: bold; color: #555; margin-bottom: 5px; }
        input[type="file"] { width: 100%; padding: 10px; border: 1px dashed #2980b9; border-radius: 4px; background: #f9fbfc; cursor: pointer; box-sizing: border-box; }
        input[type="password"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 15px; transition: border 0.3s; }
        .quota-error { border: 2px solid #e74c3c !important; background: #fdf2f2; }
        .button-row { display: flex; gap: 10px; margin-top: 10px; }
        button { background: #2980b9; color: white; border: none; padding: 14px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; flex: 1; transition: 0.2s; }
        button:hover { background: #1c5980; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        #resumeBtn { background: #e67e22; display: none; }
        #downloadBtn { background: #27ae60; display: none; }
        #status { margin-top: 15px; font-weight: bold; color: #e67e22; text-align: center; font-size: 15px; }
        textarea { width: 100%; height: 350px; margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 13px; box-sizing: border-box; white-space: pre; background: #fafafa; resize: vertical; }
    </style>
</head>
<body>

<div class="container">
    <h2>Dhwani Eprashala - Translation Engine (Pro)</h2>
    <p style="font-size: 14px; color: #666; margin-bottom: 25px;">Upload <code>qa.js</code>. If your quota is exceeded, enter a new key and click <b>Resume</b>.</p>
    
    <div class="input-group">
        <label>1. Upload English Question Bank (qa.js)</label>
        <input type="file" id="fileInput" accept=".js,.txt" onchange="handleFileUpload(event)">
    </div>

    <div class="input-group">
        <label>2. Gemini API Key</label>
        <input type="password" id="apiKey" placeholder="Enter Gemini API Key" oninput="this.classList.remove('quota-error')">
    </div>
    
    <div class="button-row">
        <button id="translateBtn" onclick="startTranslation(true)" disabled>⚙️ Start Translation</button>
        <button id="resumeBtn" onclick="startTranslation(false)">⏯️ Resume Translation</button>
        <button id="downloadBtn" onclick="downloadFile()">⬇️ Download qm.js</button>
    </div>
    
    <div id="status">Waiting for file upload...</div>
    <textarea id="outputArea" placeholder="Translations will appear here..." readonly></textarea>
</div>

<script>
    // State tracking to allow resuming
    let currentStageKey = null;
    let currentChunkIndex = 0;
    let translatedData = {}; 

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            let text = e.target.result;
            text = text.replace(/(const|let|var)\s+QUESTION_BANK\s*=/g, 'window.sourceBank =');
            try {
                const script = document.createElement('script');
                script.textContent = text;
                document.body.appendChild(script);
                if (window.sourceBank) {
                    document.getElementById('status').innerText = "✅ qa.js loaded!";
                    document.getElementById('translateBtn').disabled = false;
                    // Reset state for new file
                    currentStageKey = Object.keys(window.sourceBank)[0];
                    currentChunkIndex = 0;
                    translatedData = {};
                }
            } catch (err) { alert("File read error."); }
        };
        reader.readAsText(file);
    }

    async function startTranslation(isNewStart) {
        const apiKeyField = document.getElementById('apiKey');
        const apiKey = apiKeyField.value.trim();
        if (!apiKey) { alert("Enter an API Key."); return; }

        if (isNewStart) {
            translatedData = {};
            currentStageKey = Object.keys(window.sourceBank)[0];
            currentChunkIndex = 0;
        }

        const btn = document.getElementById('translateBtn');
        const resBtn = document.getElementById('resumeBtn');
        const status = document.getElementById('status');
        const output = document.getElementById('outputArea');
        
        btn.disabled = true;
        resBtn.style.display = 'none';
        apiKeyField.classList.remove('quota-error');

        const CHUNK_SIZE = 40; 
        const stages = Object.keys(window.sourceBank);
        let currentStageIdx = stages.indexOf(currentStageKey);

        for (let s = currentStageIdx; s < stages.length; s++) {
            let stage = stages[s];
            currentStageKey = stage;
            const englishArray = window.sourceBank[stage];
            
            if (!translatedData[stage]) translatedData[stage] = [];

            for (let i = currentChunkIndex; i < englishArray.length; i += CHUNK_SIZE) {
                const chunk = englishArray.slice(i, i + CHUNK_SIZE);
                status.innerText = `⏳ Translating Stage ${stage} (${i+1}-${Math.min(i+CHUNK_SIZE, englishArray.length)})...`;
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ role: "user", parts: [{ text: `Translate this JSON array to natural Marathi. Return ONLY the JSON array: ${JSON.stringify(chunk)}` }] }],
                            generationConfig: { temperature: 0.1 } 
                        })
                    });

                    if (response.status === 429) throw new Error("QUOTA_EXCEEDED");
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || "API Error");

                    let rawText = data.candidates[0].content.parts[0].text.replace(/```json\n|```/g, '').trim();
                    const parsedArray = JSON.parse(rawText);
                    
                    translatedData[stage].push(...parsedArray);
                    currentChunkIndex = i + CHUNK_SIZE; // Update progress

                    // Update UI preview
                    updatePreview();

                } catch (error) {
                    if (error.message === "QUOTA_EXCEEDED") {
                        status.innerText = "❌ Quota Exceeded! Enter a new API Key and click Resume.";
                        apiKeyField.classList.add('quota-error');
                        resBtn.style.display = 'block';
                    } else {
                        status.innerText = "❌ Error: " + error.message;
                    }
                    btn.disabled = false;
                    return; 
                }
            }
            currentChunkIndex = 0; // Reset chunk for next stage
        }

        status.innerText = "✅ Complete!";
        document.getElementById('downloadBtn').style.display = 'block';
        btn.disabled = false;
    }

    function updatePreview() {
        let finalJS = "const QUESTION_BANK_MR = {\n";
        for (let stage in translatedData) {
            finalJS += `    ${stage}: [\n`;
            translatedData[stage].forEach((q, idx) => {
                finalJS += `        "${q.replace(/"/g, '\\"')}"${idx < translatedData[stage].length - 1 ? ',' : ''}\n`;
            });
            finalJS += `    ],\n`;
        }
        finalJS += "};\n";
        document.getElementById('outputArea').value = finalJS;
    }

    function downloadFile() {
        const blob = new Blob([document.getElementById('outputArea').value], { type: "text/javascript" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "qm.js";
        a.click();
    }
</script>
</body>
</html>