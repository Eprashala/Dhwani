<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhwani - Interactive Behavioral Assessment</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; max-width: 950px; width: 100%; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Setup Screen */
        #setup-screen { padding: 40px; text-align: center; }
        .input-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        #setup-screen input { width: 45%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        #setup-screen input[type="password"] { width: 92%; }
        .api-note { font-size: 12px; color: #666; margin-bottom: 20px; }
        button { background: #2980b9; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        button:hover { background: #1c5980; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        
        /* Test Screen */
        #test-screen { display: none; flex-direction: column; height: 90vh; }
        .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        #stage-indicator { background: #f39c12; padding: 5px 10px; border-radius: 4px; font-size: 14px; font-weight: bold; }
        
        .main-content { display: flex; flex: 1; overflow: hidden; }
        
        /* Video Panel */
        .video-panel { width: 30%; background: #000; position: relative; display: flex; flex-direction: column; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        .recording-badge { position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.8); color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* Chat Panel */
        .interaction-panel { width: 70%; display: flex; flex-direction: column; border-left: 1px solid #eee; position: relative; }
        #chat-history { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 15px; max-width: 85%; padding: 12px 18px; border-radius: 8px; line-height: 1.5; font-size: 15px; }
        .bot-msg { background: #e3f2fd; color: #0d47a1; align-self: flex-start; border-bottom-left-radius: 0; }
        .user-msg { background: #27ae60; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 0; }
        .system-msg { background: #fff3cd; color: #856404; font-size: 13px; text-align: center; margin: 10px auto; border-radius: 4px; padding: 8px; width: 80%; }
        
        /* Controls */
        .controls-area { padding: 15px; background: white; border-top: 1px solid #eee; }
        .input-row { display: flex; gap: 10px; }
        .input-row input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        #micBtn { background: #e67e22; width: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        #micBtn.listening { background: #c0392b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        #loading { display: none; position: absolute; bottom: 80px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        
        /* Final Report Screen */
        #report-screen { display: none; padding: 40px; overflow-y: auto; height: 90vh; background: white; }
        .report-header { text-align: center; border-bottom: 2px solid #2980b9; padding-bottom: 20px; margin-bottom: 30px; }
        .report-card { background: #f8f9fa; border-left: 4px solid #2980b9; padding: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-screen">
        <h2>Dhwani Interactive Aptitude Center</h2>
        <p>Enter details to initialize the voice-enabled AI assessment.</p>
        <input type="password" id="apiKey" placeholder="Gemini API Key" required>
        <p class="api-note">Key is stored locally. Requires Gemini 1.5 Flash or higher.</p>
        
        <div class="input-group">
            <input type="text" id="childName" placeholder="Student's Name" required>
            <input type="number" id="childAge" placeholder="Age" required>
            <input type="text" id="childCity" placeholder="City/Town (e.g., Delhi, Pune)" required>
            <input type="text" id="childLanguage" placeholder="Preferred Language Context (e.g., English/Hindi mix)" value="English">
        </div>
        
        <button onclick="startTest()">Initialize Camera & Audio</button>
    </div>

    <div id="test-screen">
        <div class="header">
            <span id="test-header">Dhwani Active Session</span>
            <span id="stage-indicator">Stage 1: Exploration</span>
        </div>
        <div class="main-content">
            <div class="video-panel">
                <div class="recording-badge">REC</div>
                <video id="webcam" autoplay muted playsinline></video>
                <button style="border-radius: 0; background: #e74c3c; width: 100%; margin-top: auto;" onclick="forceEndTest()">Abort Test</button>
            </div>
            <div class="interaction-panel">
                <div id="chat-history"></div>
                <div id="loading">Dhwani is thinking...</div>
                <div class="controls-area">
                    <p style="margin: 0 0 10px 0; font-size: 12px; color: #666; text-align: center;">Click the microphone to speak, or type your answer below.</p>
                    <div class="input-row">
                        <button id="micBtn" onclick="toggleSpeechRecognition()">ðŸŽ¤</button>
                        <input type="text" id="userInput" placeholder="Listening/Typing..." onkeypress="handleEnter(event)">
                        <button id="sendBtn" onclick="submitAnswer()">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="report-screen">
        <div class="report-header">
            <h1 style="color: #2980b9;">Psychometric & Behavioral Report</h1>
            <h3 id="report-name-age"></h3>
        </div>
        <div id="report-body"></div>
        <center><button onclick="location.reload()" style="margin-top: 30px;">Close Session</button></center>
    </div>
</div>

<script>
    let mediaRecorder;
    let recordedChunks = [];
    let childData = { name: "", age: 0, city: "", language: "" };
    let apiKey = "";
    
    // State & Timing Logic
    let currentStage = 1;
    let questionCount = 0;
    let maxQuestionsPerStage = 4; 
    let conversationHistory = [];
    
    let questionAskedTime = 0;
    
    // Speech Recognition Setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;
    
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = () => {
            isListening = true;
            document.getElementById('micBtn').classList.add('listening');
            document.getElementById('userInput').placeholder = "Listening... Speak now.";
        };
        
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('userInput').value = transcript;
            // Optionally auto-submit here, but letting them review is safer for kids
        };
        
        recognition.onend = () => {
            isListening = false;
            document.getElementById('micBtn').classList.remove('listening');
            document.getElementById('userInput').placeholder = "Review text and submit...";
        };
    }

    async function startTest() {
        apiKey = document.getElementById('apiKey').value.trim();
        childData.name = document.getElementById('childName').value.trim();
        childData.age = parseInt(document.getElementById('childAge').value);
        childData.city = document.getElementById('childCity').value.trim();
        childData.language = document.getElementById('childLanguage').value.trim();

        if(!apiKey || !childData.name || !childData.age || !childData.city) {
            alert("Please fill all fields."); return;
        }

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('test-screen').style.display = 'flex';
        document.getElementById('test-header').innerText = `Proctoring: ${childData.name} from ${childData.city}`;

        await initCamera();
        
        const systemPrompt = getSystemInstruction();
        conversationHistory.push({ role: "user", parts: [{ text: "Initialize test." }] });
        
        // Trigger the first API call to get the greeting and first question
        document.getElementById('loading').style.display = 'block';
        callGeminiAPI(systemPrompt);
    }

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('webcam').srcObject = stream;
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.start();
        } catch (err) { alert("Camera/Mic access required."); }
    }

    function toggleSpeechRecognition() {
        if (!recognition) { alert("Speech recognition not supported in this browser. Please type."); return; }
        if (isListening) recognition.stop();
        else {
            recognition.lang = childData.language.toLowerCase().includes('hindi') ? 'hi-IN' : 'en-IN';
            recognition.start();
        }
    }

    function speakText(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); // Stop any current speech
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Try to find an Indian English voice for better context
            const voices = window.speechSynthesis.getVoices();
            const indianVoice = voices.find(v => v.lang.includes('en-IN') || v.lang.includes('hi-IN'));
            if(indianVoice) utterance.voice = indianVoice;
            
            utterance.rate = 0.95; // Slightly slower for kids
            
            utterance.onend = () => {
                // Start the timer the moment Dhwani finishes asking the question
                questionAskedTime = Date.now();
            };
            
            window.speechSynthesis.speak(utterance);
        } else {
            // Fallback if TTS not supported: start timer immediately
            questionAskedTime = Date.now(); 
        }
    }

    function getSystemInstruction() {
        return `You are Dhwani, an empathetic but highly analytical AI career counselor and psychometric evaluator in India. 
        Student Profile: ${childData.name}, Age: ${childData.age}, Location: ${childData.city}.
        
        You are currently in STAGE ${currentStage} of 4. Question ${questionCount + 1} of ${maxQuestionsPerStage}.

        VITAL METADATA CONTEXT: 
        With the student's answer, you will receive a timestamp [Answer Latency: X seconds]. 
        - Fast latency (< 5 secs) implies high confidence, quick recall, or natural intuition.
        - Slow latency (> 15 secs) implies hesitation, deep thinking, or struggling. 
        Use this data in your 'internal_analysis' to judge their TRUE aptitude, not just if the answer is right.

        GEOGRAPHIC CONTEXT:
        In Stages 3 and 4, you MUST weave their city (${childData.city}) into the scenario to test their situational awareness. For example, if they like engineering and live in Mumbai, ask how they would solve local flooding or traffic using tech. 

        RULES:
        1. Ask ONE question at a time. Keep it conversational.
        2. Encourage them to speak their thoughts aloud. 
        3. Do NOT mention the latency timer to the child.
        4. ALWAYS output STRICTLY in this JSON format.

        {
            "bot_reply": "Text to be spoken to the child.",
            "internal_analysis": "Your hidden notes on their aptitude and what their response latency indicates.",
            "stage_summary": "If stage changes, summarize findings. Else empty.",
            "is_test_complete": boolean,
            "final_report_html": "If complete, generate a detailed HTML report including an analysis of their confidence/response times, Recommended Streams, and Career Paths."
        }`;
    }

    function submitAnswer() {
        const inputField = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const answerText = inputField.value.trim();
        if (!answerText) return;

        // Calculate how long it took them to answer
        let timeTakenSecs = 0;
        if (questionAskedTime > 0) {
            timeTakenSecs = ((Date.now() - questionAskedTime) / 1000).toFixed(1);
        }

        addMessage(answerText, 'user');
        inputField.value = '';
        inputField.disabled = true;
        sendBtn.disabled = true;
        document.getElementById('micBtn').disabled = true;
        document.getElementById('loading').style.display = 'block';

        // Append latency metadata invisibly to the AI
        const enrichedAnswer = `[Answer Latency: ${timeTakenSecs} seconds] ${answerText}`;
        conversationHistory.push({ role: "user", parts: [{ text: enrichedAnswer }] });
        
        questionCount++;
        if (questionCount >= maxQuestionsPerStage && currentStage < 4) {
            currentStage++;
            questionCount = 0;
            document.getElementById('stage-indicator').innerText = `Stage ${currentStage}: progressing...`;
        }

        callGeminiAPI(getSystemInstruction());
    }

    function handleEnter(event) { if (event.key === 'Enter') submitAnswer(); }

    async function callGeminiAPI(systemInstruction) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: systemInstruction }] },
                    contents: conversationHistory,
                    generationConfig: { response_mime_type: "application/json" }
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const aiResponseText = data.candidates[0].content.parts[0].text;
            const aiData = JSON.parse(aiResponseText);

            conversationHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

            if (aiData.stage_summary) addSystemMessage(`Stage Update: ${aiData.stage_summary}`);

            if (aiData.is_test_complete) {
                endTestAndShowReport(aiData.final_report_html);
            } else {
                addMessage(aiData.bot_reply, 'bot');
                console.log("Behavioral Analysis:", aiData.internal_analysis);
                
                // Speak the reply aloud!
                speakText(aiData.bot_reply);
            }

        } catch (error) {
            console.error("API Error:", error);
            addSystemMessage("AI Connection Error. Try again.");
        } finally {
            document.getElementById('userInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('micBtn').disabled = false;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('userInput').focus();
        }
    }

    function addMessage(text, sender) {
        const chatHistory = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}-msg`;
        msgDiv.innerText = text;
        chatHistory.appendChild(msgDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    function addSystemMessage(text) {
        const chatHistory = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `system-msg`;
        msgDiv.innerText = text;
        chatHistory.appendChild(msgDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function forceEndTest() {
        if (confirm("End test early?")) { stopCamera(); location.reload(); }
    }

    function stopCamera() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById('webcam').srcObject.getTracks().forEach(track => track.stop());
        }
    }

    function endTestAndShowReport(htmlReport) {
        stopCamera();
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${childData.name}_Assessment.webm`;
        a.click();
        
        document.getElementById('test-screen').style.display = 'none';
        document.getElementById('report-screen').style.display = 'block';
        document.getElementById('report-name-age').innerText = `${childData.name} | ${childData.city} | Age: ${childData.age}`;
        document.getElementById('report-body').innerHTML = htmlReport;
    }
</script>
</body>
</html>