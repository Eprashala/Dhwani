<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhwani Smart AI Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Smooth scrolling for chat */
        .chat-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .chat-scroll::-webkit-scrollbar { display: none; }

        /* Animations */
        .pulse-ring { animation: pulse-purple 2s infinite; }
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); }
        }

        /* Glassmorphism */
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.15);
        }
        .glass-footer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(139, 92, 246, 0.15);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .chat-bubble-u1 {
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
            color: white;
            border-bottom-left-radius: 2px;
        }
        .chat-bubble-u2 {
            background: linear-gradient(135deg, #db2777 0%, #ec4899 100%);
            color: white;
            border-bottom-right-radius: 2px;
        }
        
        button { user-select: none; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-purple-50 h-[100dvh] w-full flex flex-col overflow-hidden">

    <header class="glass-header z-50 shrink-0 px-4 py-3 flex justify-between items-center relative">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center text-white font-bold text-lg shadow-sm">D</div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 leading-tight">Dhwani</h1>
                <p class="text-[10px] text-purple-600 font-medium tracking-wide">AI TRANSLATOR</p>
            </div>
        </div>
        <button id="api-settings-btn" class="p-2 text-gray-500 hover:text-purple-600 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.157.92c.447.1.879.255 1.288.452l.85-.386c.52-.236 1.137-.089 1.48.358l.775 1.127c.36.523.275 1.197-.184 1.54l-.768.56c.06.33.097.67.097 1.01 0 .34-.037.68-.097 1.01l.768.56c.459.343.544 1.017.184 1.54l-.775 1.127c-.343.447-.96.594-1.48.358l-.85-.386c-.409.197-.841.352-1.288.452l-.157.92z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
        
        <div id="api-panel" class="hidden absolute top-full right-0 mt-2 w-64 bg-white shadow-xl rounded-xl border border-gray-100 p-3 mr-2 z-50">
            <p class="text-xs text-gray-500 mb-2">Translation API Email (Optional):</p>
            <input type="email" id="user-email-input" placeholder="email@example.com" class="w-full text-xs p-2 rounded bg-gray-50 border mb-2 focus:ring-2 focus:ring-purple-500 outline-none">
            <button id="save-api-btn" class="w-full bg-purple-600 text-white text-xs py-2 rounded font-bold">Save & Close</button>
        </div>
    </header>

    <div class="bg-white/50 shrink-0 px-4 py-2 border-b border-purple-100 flex gap-3">
        <div class="flex-1">
            <label class="text-[10px] font-bold text-purple-800 uppercase block mb-1">User 1 (Me)</label>
            <select id="lang-u1" class="w-full text-sm p-2 rounded-lg border border-purple-200 bg-white focus:border-purple-500 outline-none shadow-sm"></select>
        </div>
        <div class="flex-1 text-right">
            <label class="text-[10px] font-bold text-pink-700 uppercase block mb-1">User 2 (Guest)</label>
            <select id="lang-u2" class="w-full text-sm p-2 rounded-lg border border-pink-200 bg-white focus:border-pink-500 outline-none shadow-sm text-right" dir="rtl"></select>
        </div>
    </div>

    <main id="chat-container" class="flex-grow chat-scroll overflow-y-auto px-4 py-4 space-y-4 bg-gradient-to-b from-transparent to-white/30">
        <div id="intro-msg" class="text-center mt-12 opacity-50">
            <div class="w-16 h-16 bg-gray-200 rounded-full mx-auto flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
            </div>
            <p class="text-sm text-gray-500 font-medium">Ready to translate</p>
            <p class="text-xs text-gray-400 mt-1">Tap 'Start' below</p>
        </div>
        <div class="h-32 w-full shrink-0"></div>
    </main>

    <div id="status-bar" class="fixed top-24 left-1/2 -translate-x-1/2 z-40 px-4 py-1.5 bg-gray-900/80 backdrop-blur text-white text-xs font-medium rounded-full hidden pointer-events-none">
        Listening...
    </div>

    <div class="z-50 shrink-0 w-full glass-footer">
        <div class="px-4 pt-3 pb-2 flex items-center gap-3">
             <div class="flex-grow h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div id="silence-progress" class="bg-gradient-to-r from-purple-500 to-pink-500 h-full w-0 transition-all duration-100 ease-linear"></div>
             </div>
             <button id="manual-send-btn" disabled class="shrink-0 px-3 py-1 bg-gray-100 text-gray-400 text-[10px] font-bold uppercase rounded-md transition-colors border border-gray-200">
                Send ↵
             </button>
        </div>

        <footer class="px-4 pb-4 grid grid-cols-4 gap-3 items-center">
            <button id="repeat-btn" class="col-span-1 h-12 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 active:scale-95 transition-all border border-gray-200 disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
            <button id="main-action-btn" class="col-span-2 h-14 -mt-2 rounded-2xl bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 font-bold text-lg active:scale-95 transition-all transform">
                <span id="btn-text">Start Chat</span>
            </button>
            <button id="share-btn" class="col-span-1 h-12 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 active:scale-95 transition-all border border-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
            </button>
        </footer>
    </div>

    <script>
        // --- CONFIG ---
        const LANGUAGES = [
            { code: 'en-IN', name: 'English (IN)' },
            { code: 'hi-IN', name: 'Hindi (हिंदी)' },
            { code: 'mr-IN', name: 'Marathi (मराठी)' },
            { code: 'gu-IN', name: 'Gujarati' },
            { code: 'ta-IN', name: 'Tamil' },
            { code: 'te-IN', name: 'Telugu' },
            { code: 'bn-IN', name: 'Bengali' },
            { code: 'kn-IN', name: 'Kannada' },
            { code: 'ml-IN', name: 'Malayalam' },
            { code: 'en-US', name: 'English (US)' },
            { code: 'es-ES', name: 'Spanish' },
            { code: 'fr-FR', name: 'French' },
            { code: 'de-DE', name: 'German' },
            { code: 'ja-JP', name: 'Japanese' },
            { code: 'zh-CN', name: 'Chinese' },
            { code: 'ru-RU', name: 'Russian' },
            { code: 'ar-SA', name: 'Arabic' }
        ];

        let USER_EMAIL = ""; 
        let lastTranslatedText = "";
        let lastTranslatedLang = "";

        // --- ELEMENTS ---
        const mainBtn = document.getElementById('main-action-btn');
        const btnText = document.getElementById('btn-text');
        const manualSendBtn = document.getElementById('manual-send-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const shareBtn = document.getElementById('share-btn');
        const chatContainer = document.getElementById('chat-container');
        const introMsg = document.getElementById('intro-msg');
        const statusBar = document.getElementById('status-bar');
        const silenceProgress = document.getElementById('silence-progress');
        const langU1Select = document.getElementById('lang-u1');
        const langU2Select = document.getElementById('lang-u2');
        const apiPanel = document.getElementById('api-panel');
        const apiSettingsBtn = document.getElementById('api-settings-btn');
        const userEmailInput = document.getElementById('user-email-input');
        const saveApiBtn = document.getElementById('save-api-btn');

        // --- STATE ---
        let state = 'IDLE'; 
        let recognition;
        let synth = window.speechSynthesis;
        let finalTranscript = '';
        let silenceTimer = null;
        let silenceInterval = null;
        const SILENCE_TIMEOUT_MS = 5000;
        let silenceTimeElapsed = 0;
        let isProcessing = false; // Flag to prevent overlaps during API calls

        // --- INIT ---
        function init() {
            LANGUAGES.forEach(l => {
                langU1Select.add(new Option(l.name, l.code));
                langU2Select.add(new Option(l.name, l.code));
            });
            langU1Select.value = 'en-IN';
            langU2Select.value = 'hi-IN';

            const savedEmail = localStorage.getItem('dhwani_email');
            if(savedEmail) {
                USER_EMAIL = savedEmail;
                userEmailInput.value = savedEmail;
            }
        }

        // --- RECOGNITION SETUP (FIXED FOR ANDROID) ---
        function setupRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return null;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            
            // CRITICAL FIX: Set continuous to false.
            // This forces Android to clear the buffer after every pause.
            rec.continuous = false; 
            rec.interimResults = true; // We still want to see what we say while speaking

            rec.onstart = () => {
                if(state.includes('LISTENING')) {
                    updateStatus(state === 'LISTENING_U1' ? "User 1 Listening..." : "User 2 Listening...");
                    startSilenceTimer();
                }
            };

            rec.onresult = (event) => {
                // Because continuous = false, we don't need to loop. 
                // We just grab the latest result in the array.
                const result = event.results[event.results.length - 1];
                const transcript = result[0].transcript;

                if (result.isFinal) {
                    finalTranscript += transcript + " ";
                    updateStatus("Heard: " + transcript.slice(-15) + "...");
                    resetSilenceTimer();
                    // Don't auto-send here yet, wait for silence or manual send
                    // OR if you want it super fast, you could trigger here.
                    // For now, we let the silence timer or manual button handle 'finishTurn'.
                } else {
                    updateStatus("Hearing: " + transcript.slice(-15) + "...");
                    resetSilenceTimer();
                }
            };

            rec.onend = () => {
                // AUTO-RESTART LOGIC (The Yogi Method)
                // If we are still supposed to be listening, and not processing, start again immediately.
                if (state.includes('LISTENING') && !isProcessing) {
                    try {
                        rec.start();
                    } catch(e) {
                        // Sometimes it complains if started too fast
                        setTimeout(() => { if(state.includes('LISTENING')) rec.start(); }, 100);
                    }
                }
            };

            rec.onerror = (e) => {
                if (e.error === 'no-speech') {
                    // Ignore, let onend restart it
                } else if (e.error === 'not-allowed') {
                    stopAll();
                    alert("Microphone permission denied.");
                } else {
                    console.log("Mic Error: ", e.error);
                }
            };
            return rec;
        }
        
        recognition = setupRecognition();

        // --- CONTROLLER ---
        mainBtn.addEventListener('click', toggleConversation);
        manualSendBtn.addEventListener('click', () => { 
            if(state.includes('LISTENING')) finishTurn(); 
        });
        
        repeatBtn.addEventListener('click', () => {
            if(lastTranslatedText && lastTranslatedLang) speak(lastTranslatedText, lastTranslatedLang, () => {});
        });

        shareBtn.addEventListener('click', async () => {
            let fullText = "--- Dhwani Translation Chat ---\n\n";
            chatContainer.querySelectorAll('.chat-bubble-u1, .chat-bubble-u2').forEach(b => {
                const user = b.classList.contains('chat-bubble-u1') ? "User 1" : "User 2";
                const original = b.querySelector('.font-medium').innerText;
                const translated = b.querySelector('.translation-text').innerText;
                fullText += `${user}: ${original}\n[Trans]: ${translated}\n\n`;
            });
            if (navigator.share) {
                try { await navigator.share({ title: 'Dhwani Chat', text: fullText }); } catch (err) {}
            } else {
                navigator.clipboard.writeText(fullText);
                updateStatus("Copied to Clipboard!", true);
            }
        });

        function toggleConversation() {
            if (state === 'IDLE') {
                if(synth.speaking) synth.cancel();
                introMsg.classList.add('hidden');
                chatContainer.innerHTML = '<div class="h-4"></div>'; 
                startTurn('U1');
                updateUIState('STARTED');
            } else {
                stopAll();
            }
        }

        function stopAll() {
            state = 'IDLE';
            isProcessing = false;
            if (recognition) recognition.stop();
            if (synth) synth.cancel();
            stopSilenceTimer();
            updateUIState('STOPPED');
            updateStatus("Session Ended", true);
        }

        function startTurn(user) {
            state = user === 'U1' ? 'LISTENING_U1' : 'LISTENING_U2';
            finalTranscript = ''; // Clear buffer
            isProcessing = false;
            
            const langCode = user === 'U1' ? langU1Select.value : langU2Select.value;
            recognition.lang = langCode;

            try { recognition.start(); } 
            catch (e) { 
                // If already started, onend logic handles it, or we retry
            }
            
            highlightUser(user);
            updateStatus(user === 'U1' ? "User 1 Speaking..." : "User 2 Speaking...", false, true);
        }

        function finishTurn() {
            // We set processing to true so onend doesn't restart listening immediately
            isProcessing = true; 
            if (recognition) recognition.stop();
            stopSilenceTimer();

            if (!finalTranscript.trim()) {
                updateStatus("No speech detected", true);
                setTimeout(() => startTurn(state === 'LISTENING_U1' ? 'U1' : 'U2'), 1000);
                return;
            }
            processTranslation(finalTranscript);
        }

        async function processTranslation(text) {
            const currentUser = state === 'LISTENING_U1' ? 'U1' : 'U2';
            state = 'PROCESSING';
            updateStatus("Translating...", false, true);
            manualSendBtn.disabled = true;

            addMessage(currentUser, text, "...");

            const sCode = currentUser === 'U1' ? langU1Select.value : langU2Select.value;
            const tCode = currentUser === 'U1' ? langU2Select.value : langU1Select.value;

            try {
                const transText = await fetchMyMemory(text, sCode, tCode);
                updateLastMessage(transText);
                
                lastTranslatedText = transText;
                lastTranslatedLang = tCode;
                repeatBtn.disabled = false;

                speak(transText, tCode, () => {
                    const nextUser = currentUser === 'U1' ? 'U2' : 'U1';
                    setTimeout(() => startTurn(nextUser), 500);
                });
            } catch (err) {
                updateLastMessage("[Error] " + err.message);
                setTimeout(() => startTurn(currentUser === 'U1' ? 'U2' : 'U1'), 2000);
            }
        }

        // --- API & TTS ---
        async function fetchMyMemory(text, s, t) {
            const pair = `${s}|${t}`;
            let url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${pair}`;
            if (USER_EMAIL) url += `&de=${USER_EMAIL}`;
            
            const res = await fetch(url);
            const data = await res.json();
            if (data.responseStatus === 200 || data.responseStatus === '200') return data.responseData.translatedText;
            throw new Error(data.responseDetails || "Trans Error");
        }

        function speak(text, lang, cb) {
            state = 'SPEAKING';
            updateStatus("Speaking...");
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = lang;
            ut.rate = 0.9;
            
            // Smart voice matching
            const v = synth.getVoices().find(v => v.lang === lang) || 
                      synth.getVoices().find(v => v.lang.startsWith(lang.split('-')[0]));
            if(v) ut.voice = v;

            ut.onend = cb;
            ut.onerror = cb;
            synth.speak(ut);
        }

        // --- UI UPDATERS ---
        function addMessage(user, text, trans) {
            const isU1 = user === 'U1';
            const div = document.createElement('div');
            div.className = `flex flex-col max-w-[85%] ${isU1 ? 'mr-auto items-start' : 'ml-auto items-end'} animate-fade-in-up`;
            div.innerHTML = `
                <div class="p-3 shadow-sm relative ${isU1 ? 'chat-bubble-u1' : 'chat-bubble-u2'}">
                    <div class="font-medium text-[15px] leading-snug">${text}</div>
                    <div class="translation-text text-sm opacity-90 italic mt-1 pt-1 border-t border-white/20">${trans}</div>
                </div>
                <span class="text-[10px] text-gray-400 mt-1 px-1 font-bold tracking-wide">${isU1 ? 'USER 1' : 'USER 2'}</span>
            `;
            chatContainer.insertBefore(div, chatContainer.lastElementChild);
            window.lastTransNode = div.querySelector('.translation-text');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateLastMessage(text) {
            if (window.lastTransNode) window.lastTransNode.innerText = text;
        }

        function startSilenceTimer() {
            silenceTimeElapsed = 0;
            silenceProgress.style.width = '0%';
            manualSendBtn.disabled = false;
            manualSendBtn.classList.remove('text-gray-400', 'bg-gray-100');
            manualSendBtn.classList.add('text-purple-700', 'bg-purple-100');
            manualSendBtn.innerHTML = "Send Now";

            clearInterval(silenceInterval);
            silenceInterval = setInterval(() => {
                silenceTimeElapsed += 100;
                silenceProgress.style.width = (silenceTimeElapsed / SILENCE_TIMEOUT_MS * 100) + '%';
                if (silenceTimeElapsed >= SILENCE_TIMEOUT_MS) finishTurn();
            }, 100);
        }

        function resetSilenceTimer() {
            silenceTimeElapsed = 0;
            silenceProgress.style.width = '0%';
        }

        function stopSilenceTimer() {
            clearInterval(silenceInterval);
            silenceProgress.style.width = '0%';
            manualSendBtn.disabled = true;
            manualSendBtn.classList.add('text-gray-400', 'bg-gray-100');
            manualSendBtn.classList.remove('text-purple-700', 'bg-purple-100');
        }

        function updateStatus(msg, hide = false, pulse = false) {
            statusBar.innerText = msg;
            statusBar.classList.remove('hidden');
            if(hide) setTimeout(() => statusBar.classList.add('hidden'), 2000);
        }

        function highlightUser(user) {
            if(user === 'U1') {
                langU1Select.parentElement.classList.add('pulse-ring');
                langU2Select.parentElement.classList.remove('pulse-ring');
            } else {
                langU1Select.parentElement.classList.remove('pulse-ring');
                langU2Select.parentElement.classList.add('pulse-ring');
            }
        }

        function updateUIState(s) {
            if(s === 'STARTED') {
                mainBtn.classList.remove('from-purple-600', 'to-pink-600');
                mainBtn.classList.add('bg-gray-800');
                btnText.innerText = "Stop Chat";
                repeatBtn.disabled = true;
            } else {
                mainBtn.classList.add('from-purple-600', 'to-pink-600');
                mainBtn.classList.remove('bg-gray-800');
                btnText.innerText = "Start Chat";
                langU1Select.parentElement.classList.remove('pulse-ring');
                langU2Select.parentElement.classList.remove('pulse-ring');
            }
        }

        apiSettingsBtn.onclick = () => apiPanel.classList.toggle('hidden');
        saveApiBtn.onclick = () => {
            const val = userEmailInput.value.trim();
            if(val) {
                USER_EMAIL = val;
                localStorage.setItem('dhwani_email', val);
                alert("Email Saved!");
            }
            apiPanel.classList.add('hidden');
        };

        init();
    </script>
</body>
</html>