<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§à-‡§™‡•ç‡§∞‡§∂‡§æ‡§≥‡§æ: ‡§ó‡•Ä‡§§‡§æ ‡§∏‡§æ‡§∞‡§•‡•Ä (AI ‡§ï‡•É‡§∑‡•ç‡§£)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* ANIMATION: Golden Divine Pulse */
        .listening-pulse { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* UI: Icon Button Styles */
        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-gray-700 hover:bg-yellow-600 shadow-lg
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-yellow-500
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        /* UI: General Buttons */
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-gray-700 text-white
                   hover:bg-gray-600
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-yellow-500
                   disabled:bg-gray-800 disabled:text-gray-600 disabled:cursor-not-allowed;
        }

        /* UI: Custom Checkbox */
        .custom-checkbox {
            @apply w-4 h-4 text-yellow-500 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500 focus:ring-2 ring-offset-gray-800;
        }
        
        /* UI: High Contrast Inputs */
        .custom-input {
            @apply block w-3/4 mx-auto text-center border border-gray-500 rounded-lg p-3 outline-none transition-all;
            background-color: #000000 !important; 
            color: #ffffff !important;             
            caret-color: #ffd700 !important;       
        }
        .custom-input::placeholder { color: #9ca3af !important; opacity: 1 !important; }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div id="api-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center hidden backdrop-blur-sm p-4">
        <div class="bg-gray-800 border-2 border-yellow-500 rounded-2xl p-6 max-w-sm w-full text-center shadow-2xl">
            <div class="text-4xl mb-4">üîë</div>
            <h2 class="text-xl font-bold text-yellow-400 mb-2">API Key ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á</h2>
            <p class="text-gray-300 text-sm mb-6">
                ‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü ‡§Ü‡§£‡§ø ‡§ú‡§≤‡§¶ ‡§®‡§ø‡§ï‡§æ‡§≤‡§æ‡§Ç‡§∏‡§æ‡§†‡•Ä ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§∏‡•ç‡§µ‡§§‡§É‡§ö‡•Ä Google Gemini API Key ‡§µ‡§æ‡§™‡§∞‡§æ. ‡§π‡•á ‡§Æ‡•ã‡§´‡§§ ‡§Ü‡§π‡•á.
                <br><span class="text-xs text-gray-500">(For best results, use your own API Key)</span>
            </p>
            
            <div class="flex flex-col gap-3">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                   class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold transition-colors">
                   ‡§Æ‡•ã‡§´‡§§ ‡§Æ‡§ø‡§≥‡§µ‡§æ (Get Free Here) ‚Üó
                </a>
                <button id="modal-continue-btn" 
                        class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors border border-gray-600">
                    ‡§Ü‡§§‡•ç‡§§‡§æ ‡§™‡•Å‡§¢‡•á ‡§ö‡§≤‡§æ (Continue)
                </button>
            </div>
        </div>
    </div>

    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto border-t-4 border-yellow-500 border-b-4 border-cyan-600">
        
        <div class="flex items-center justify-between mb-4 shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                <span class="text-yellow-500">‡§à-‡§™‡•ç‡§∞‡§∂‡§æ‡§≥‡§æ</span> "‡§ó‡•Ä‡§§‡§æ <span class="text-cyan-400">‡§∏‡§æ‡§∞‡§•‡•Ä</span>"
            </h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-500 transition-colors" title="Offline"></div>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-gray-900 rounded-lg p-4 mb-4 border border-gray-700 space-y-4 shadow-inner min-h-[200px]">
            <div class="text-gray-400 text-center mt-10">
                ‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä <strong>"‡§π‡§∞‡•á ‡§ï‡•É‡§∑‡•ç‡§£"</strong> ‡§ï‡§ø‡§Ç‡§µ‡§æ <strong>"‡§ú‡§Ø ‡§∂‡•ç‡§∞‡•Ä ‡§ï‡•É‡§∑‡•ç‡§£"</strong> ‡§Æ‡•ç‡§π‡§£‡§æ.<br>
                <span class="text-xs text-yellow-600 mt-2 block">"‡§Æ‡•Ä ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∏‡§ñ‡§æ, ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§™‡§æ‡§†‡•Ä‡§∂‡•Ä ‡§Ü‡§π‡•á."</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-gray-800/50 p-2 rounded-xl">
            <button id="pause-resume-button" class="icon-btn bg-blue-900/30 hover:bg-blue-800" title="‡§µ‡§ø‡§∂‡•ç‡§∞‡§æ‡§Ç‡§§‡•Ä / ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn bg-red-900/30 hover:bg-red-800" title="‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>

            <button id="replay-button" class="icon-btn bg-green-900/30 hover:bg-green-800" title="‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§ê‡§ï‡§æ" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <div class="flex flex-col gap-4 mb-4 shrink-0 w-full text-center">
            <div class="w-full">
                <label class="text-xs text-gray-400 mb-1 block">‡§§‡•Å‡§Æ‡§ö‡•á ‡§®‡§æ‡§µ</label>
                <input type="text" id="manual-name" class="custom-input" placeholder="‡§Ö‡§∞‡•ç‡§ú‡•Å‡§® (‡§§‡•Å‡§Æ‡§ö‡•á ‡§®‡§æ‡§µ)">
            </div>
            <div class="w-full">
                <label class="text-xs text-gray-400 mb-1 block">‡§§‡•Å‡§Æ‡§ö‡•á ‡§µ‡§Ø</label>
                <input type="number" id="manual-age" class="custom-input" placeholder="25">
            </div>
        </div>

        <div class="flex items-center justify-center gap-2 mb-2 shrink-0">
            <input type="checkbox" id="remember-me-checkbox" class="custom-checkbox">
            <label for="remember-me-checkbox" class="text-sm text-gray-300 cursor-pointer select-none">
                ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≤‡§ï‡•ç‡§∑‡§æ‡§§ ‡§†‡•á‡§µ‡§æ
            </label>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0">
            <button id="advance-toggle-btn" class="text-xs text-yellow-500 hover:text-yellow-400 underline mb-2 focus:outline-none">
                ‚ñº ‡§™‡•ç‡§∞‡§ó‡§§ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§ú (API Key)
            </button>

            <div id="advance-container" class="hidden w-full bg-gray-800/80 border border-gray-700 rounded-lg p-4 flex flex-col gap-3 transition-all">
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="use-custom-key-checkbox" class="custom-checkbox">
                    <label for="use-custom-key-checkbox" class="text-sm text-gray-300 cursor-pointer select-none">
                        ‡§∏‡•ç‡§µ‡§§‡§É‡§ö‡•Ä API Key ‡§µ‡§æ‡§™‡§∞‡§æ (‡§∂‡§ø‡§´‡§æ‡§∞‡§∏)
                    </label>
                </div>

                <input type="text" id="custom-api-key-input" class="custom-input text-xs w-full !w-full" placeholder="Paste API Key here (AIza...)" disabled>
                
                <button id="paste-key-btn" type="button" disabled class="w-full py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white text-xs rounded transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    API Key ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ
                </button>
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all duration-300 ease-in-out shrink-0
                       bg-yellow-600 text-white shadow-lg shadow-yellow-900/50
                       hover:bg-yellow-500 hover:shadow-yellow-500/50 hover:-translate-y-0.5
                       focus:outline-none focus:ring-4 focus:ring-yellow-500 focus:ring-opacity-50
                       disabled:bg-gray-600 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0">
            ‡§∏‡§Ç‡§µ‡§æ‡§¶ ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ
        </button>

        <div class="mt-4 grid grid-cols-3 gap-3 shrink-0">
            <button id="restart-chat-button" class="utility-btn" disabled>‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ</button>
            <button id="share-button" class="utility-btn bg-cyan-700 hover:bg-cyan-600">‡§∂‡•á‡§Ö‡§∞ ‡§ï‡§∞‡§æ</button>
            <button id="end-chat-button" class="utility-btn text-red-200 hover:bg-red-900/40" disabled>‡§∏‡§Ç‡§µ‡§æ‡§¶ ‡§∏‡§Ç‡§™‡§µ‡§æ</button>
        </div>

    </div>

    <script>
        /* ==========================================================================
           GEETA SARATHI: CORE LOGIC
           ==========================================================================
        */

        // --- UTILITY: PREVENT RIGHT CLICK ---
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- DOM ELEMENTS ---
        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const shareButton = document.getElementById('share-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');
        
        // Modal & Advance Settings
        const apiModal = document.getElementById('api-modal');
        const modalContinueBtn = document.getElementById('modal-continue-btn');
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        // --- CONFIGURATION & STATE ---
        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 18;
        let chatHistory = []; 
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        let isAiSpeaking = false; // Flag to prevent self-hearing
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        // --- INITIALIZATION ---
        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData();
            loadVoices();
            checkAndShowModal();
        };

        // --- MODAL LOGIC ---
        function checkAndShowModal() {
            const hasCustomKey = localStorage.getItem('krishna_mr_useCustomKey') === 'true';
            if (!hasCustomKey) {
                apiModal.classList.remove('hidden');
            }
        }
        
        modalContinueBtn.addEventListener('click', () => {
            apiModal.classList.add('hidden');
        });

        // --- UI HANDLERS ---
        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
        });

        useCustomKeyCheckbox.addEventListener('change', () => {
            const isChecked = useCustomKeyCheckbox.checked;
            customApiKeyInput.disabled = !isChecked;
            pasteKeyBtn.disabled = !isChecked;
            saveUserData(); 
            if (isChecked) {
                customApiKeyInput.focus();
                apiModal.classList.add('hidden'); // Hide modal if they enable this manually
            }
        });

        customApiKeyInput.addEventListener('input', saveUserData);

        pasteKeyBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    customApiKeyInput.value = text;
                    saveUserData();
                }
            } catch (err) { alert('‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡§§‡§æ ‡§Ü‡§≤‡•á ‡§®‡§æ‡§π‡•Ä.'); }
        });

        function getEffectiveApiKey() {
            if (useCustomKeyCheckbox.checked && customApiKeyInput.value.trim().length > 10) {
                return customApiKeyInput.value.trim();
            }
            return DEFAULT_API_KEY;
        }

        // --- MEMORY LOGIC ---
        function loadUserData() {
            const savedRemember = localStorage.getItem('krishna_mr_remember');
            if (savedRemember === 'true') {
                rememberMeCheckbox.checked = true;
                manualNameInput.value = localStorage.getItem('krishna_mr_userName') || '';
                manualAgeInput.value = localStorage.getItem('krishna_mr_userAge') || '';
            }
            const savedUseKey = localStorage.getItem('krishna_mr_useCustomKey');
            const savedKey = localStorage.getItem('krishna_mr_customKey');
            if (savedUseKey === 'true') {
                useCustomKeyCheckbox.checked = true;
                customApiKeyInput.disabled = false;
                pasteKeyBtn.disabled = false;
                if (savedKey) customApiKeyInput.value = savedKey;
            }
        }

        function saveUserData() {
            if (rememberMeCheckbox.checked) {
                localStorage.setItem('krishna_mr_remember', 'true');
                localStorage.setItem('krishna_mr_userName', manualNameInput.value.trim());
                localStorage.setItem('krishna_mr_userAge', manualAgeInput.value.trim());
            } else {
                localStorage.removeItem('krishna_mr_remember');
                localStorage.removeItem('krishna_mr_userName');
                localStorage.removeItem('krishna_mr_userAge');
            }
            localStorage.setItem('krishna_mr_useCustomKey', useCustomKeyCheckbox.checked);
            if (customApiKeyInput.value) localStorage.setItem('krishna_mr_customKey', customApiKeyInput.value.trim());
        }

        function loadChatContext(name) {
            const key = `krishna_mr_history_${name.toLowerCase()}`;
            try { return JSON.parse(localStorage.getItem(key)) || []; } catch (e) { return []; }
        }

        function saveChatContext() {
            if (!userName) return;
            const key = `krishna_mr_history_${userName.toLowerCase()}`;
            const limitedHistory = chatHistory.slice(-20); 
            localStorage.setItem(key, JSON.stringify(limitedHistory));
        }

        manualNameInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });
        manualAgeInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });


        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            logMessage('Error', '‡§π‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞ ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§§ ‡§®‡§æ‡§π‡•Ä. Chrome ‡§µ‡§æ‡§™‡§∞‡§æ.');
            talkButton.disabled = true;
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = false;
            recognition.lang = 'mr-IN'; 

            recognition.onresult = handleSpeechResult;
            recognition.onend = handleSpeechEnd;
            recognition.onerror = (event) => {
                if (event.error === 'no-speech' && appState !== 'IDLE' && appState !== 'BUSY' && !isAiSpeaking) {
                    startRecognitionSafe();
                } else if (event.error === 'not-allowed') {
                    setState('IDLE');
                }
            };
        }

        function startRecognitionSafe() {
            if (!recognition || isAiSpeaking) return; // STRICT CHECK: Don't listen if speaking
            try { recognition.start(); } catch (e) {}
        }

        // --- MAIN FLOW ---
        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        shareButton.addEventListener('click', shareChat);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);

        function enterFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen(); } 
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } 
        }

        async function toggleListening() {
            if (appState === 'IDLE') {
                try { enterFullScreen(); } catch(e) {} 
                
                talkButton.textContent = "‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...";
                talkButton.disabled = true;
                await acquireWakeLock();
                
                const inputName = manualNameInput.value.trim();
                const inputAge = manualAgeInput.value.trim();

                if (inputName && inputAge) {
                    userName = inputName;
                    userAge = parseInt(inputAge) || 18;
                    saveUserData(); 
                    buildSystemPrompt(); 

                    const previousHistory = loadChatContext(userName);
                    if (previousHistory.length > 0) {
                        chatHistory = previousHistory;
                        logMessage('System', '‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§∏‡§Ç‡§µ‡§æ‡§¶ ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...');
                        setState('CONVERSATION');
                        startRecognitionSafe();
                    } else {
                        // Fresh Start
                        chatHistory.push({ role: 'user', parts: [{ text: "Start." }] });
                        chatHistory.push({ role: 'model', parts: [{ text: `Partha, I am ready.` }] });
                        
                        const welcomeText = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${userName}, ‡§Æ‡•Ä ‡§ï‡•É‡§∑‡•ç‡§£. ‡§Æ‡•Ä ‡§§‡•Å‡§ù‡•ç‡§Ø‡§æ ‡§™‡§æ‡§†‡•Ä‡§∂‡•Ä ‡§Ü‡§π‡•á.`;
                        logMessage('Krishna', welcomeText);
                        setState('BUSY'); 
                        await speakText(welcomeText, 'mr-IN');
                        setState('CONVERSATION');
                        // Recognition starts in speakText onend
                    }

                } else {
                    // Waiting for Wake Word
                    setState('LISTENING_FOR_WAKEWORD');
                    startRecognitionSafe();
                    if (conversationLog.childElementCount < 3) logMessage('Info', '"‡§π‡§∞‡•á ‡§ï‡•É‡§∑‡•ç‡§£" ‡§Æ‡•ç‡§π‡§£‡§æ');
                }
            } else {
                setState('IDLE');
                recognition.stop();
                if (synth.speaking) synth.cancel();
                await releaseWakeLock();
            }
        }

        function setState(newState) {
            appState = newState;
            switch (newState) {
                case 'IDLE':
                    talkButton.textContent = '‡§∏‡§Ç‡§µ‡§æ‡§¶ ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-500 transition-colors';
                    endChatButton.disabled = true;
                    talkButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    talkButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                    manualNameInput.disabled = false;
                    manualAgeInput.disabled = false;
                    break;
                case 'BUSY':
                    talkButton.textContent = '‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...';
                    talkButton.disabled = true;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-400 transition-colors';
                    endChatButton.disabled = false;
                    break;
                default: // LISTENING STATES
                    talkButton.textContent = '‡§ê‡§ï‡§£‡•á ‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-cyan-400 listening-pulse transition-colors';
                    endChatButton.disabled = false;
                    talkButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                    talkButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    manualNameInput.disabled = true;
                    manualAgeInput.disabled = true;
                    break;
            }
        }

        function handleSpeechEnd() {
            // CRITICAL FIX: Do NOT restart listening if AI is currently speaking
            if (isAiSpeaking) return;

            if (appState !== 'IDLE' && appState !== 'BUSY') startRecognitionSafe();
            else if (appState === 'IDLE') setState('IDLE'); 
        }
        
        // --- LOGIC: PROCESSING SPEECH ---
        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            console.log(`Heard: ${transcript}`);
            
            const currentState = appState;
            recognition.stop(); 
            setState('BUSY');

            const lowerTranscript = transcript.toLowerCase();

            try {
                switch (currentState) {
                    case 'LISTENING_FOR_WAKEWORD':
                        if (lowerTranscript.includes('krishna') || lowerTranscript.includes('hare') || lowerTranscript.includes('jai') || lowerTranscript.includes('‡§ï‡•É‡§∑‡•ç‡§£')) {
                            const greeting = "‡§∞‡§æ‡§ß‡•á ‡§∞‡§æ‡§ß‡•á! ‡§∏‡§ñ‡§æ, ‡§§‡•Å‡§ù‡•á ‡§®‡§æ‡§µ ‡§ï‡§æ‡§Ø ‡§Ü‡§π‡•á?";
                            logMessage('Krishna', greeting);
                            await speakText(greeting, 'mr-IN');
                            setState('LISTENING_FOR_NAME');
                            // startRecognitionSafe happens in speakText onend
                        } else {
                            setState('LISTENING_FOR_WAKEWORD');
                            startRecognitionSafe();
                        }
                        break;

                    case 'LISTENING_FOR_NAME':
                        logMessage('You', transcript);
                        userName = await extractNameFromTranscript(transcript);
                        manualNameInput.value = userName; 
                        
                        const agePrompt = `‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§Ü‡§π‡•á ${userName}. ‡§§‡•Å‡§Æ‡§ö‡•á ‡§µ‡§Ø ‡§ï‡§æ‡§Ø ‡§Ü‡§π‡•á?`;
                        logMessage('Krishna', agePrompt);
                        await speakText(agePrompt, 'mr-IN');
                        setState('LISTENING_FOR_AGE');
                        break;

                    case 'LISTENING_FOR_AGE':
                        logMessage('You', transcript);
                        userAge = await extractAgeFromTranscript(transcript);
                        manualAgeInput.value = userAge; 
                        saveUserData();
                        buildSystemPrompt(); 

                        const startPrompt = `‡§â‡§§‡•ç‡§§‡§Æ. ‡§™‡§æ‡§∞‡•ç‡§•, ‡§§‡•Å‡§ù‡•ç‡§Ø‡§æ ‡§Æ‡§®‡§æ‡§§ ‡§ï‡§æ‡§Ø ‡§ö‡§ø‡§Ç‡§§‡§æ ‡§Ü‡§π‡•á? ‡§Æ‡§≤‡§æ ‡§∏‡§æ‡§Ç‡§ó.`;
                        logMessage('Krishna', startPrompt);
                        await speakText(startPrompt, 'mr-IN');
                        setState('CONVERSATION');
                        break;

                    case 'CONVERSATION':
                        logMessage(userName || 'You', transcript);
                        chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                        saveChatContext();

                        const aiResponseText = await generateTextResponseFromChat();
                        
                        // Clean Text
                        const cleanedResponseText = cleanTextForTTS(aiResponseText);

                        chatHistory.push({ role: 'model', parts: [{ text: cleanedResponseText }] });
                        saveChatContext();

                        logMessage('Krishna', cleanedResponseText);
                        
                        try { await speakText(cleanedResponseText, 'mr-IN'); } 
                        catch (error) { if (error.message === "Speech manually stopped") return; }
                        
                        setState('CONVERSATION');
                        break;
                }
            } catch (error) {
                if (systemInstruction) { setState('CONVERSATION'); startRecognitionSafe(); }
                else { setState('LISTENING_FOR_WAKEWORD'); startRecognitionSafe(); }
            }
        }

        // --- BRAIN ---
        function buildSystemPrompt() {
            let complexityInstruction = "";
            if (userAge <= 12) {
                complexityInstruction = "User is a child. Use very simple Marathi words. Tell stories of Bal Krishna.";
            } else {
                complexityInstruction = "User is mature. Provide deep philosophical insights but in clear, conversational Marathi.";
            }

            systemInstruction = `
                You are Lord Krishna (God). You are the supreme guide.
                You are speaking to ${userName}, age ${userAge}.
                
                CRITICAL RULES:
                1. **LANGUAGE:** YOU MUST SPEAK ONLY IN MARATHI (Devanagari script). NEVER use English sentences.
                2. **FORMATTING:** Do NOT use Markdown. Do NOT use asterisks (*), hashes (#), or brackets ([]). Write plain text only.
                3. **TONE:** Compassionate, Soft, Divine, like a Best Friend (Sakha).
                4. **CONTENT:**
                   - Reference the Bhagavad Gita (Adhyay and Shlok) to solve problems.
                   - Act as an expert Psychologist. Give hope even in darkness.
                   - Encourage Dharma and Good Karma.
                5. **STYLE:** - Start answers with "‡§™‡§æ‡§∞‡•ç‡§•", "‡§∏‡§ñ‡§æ", or "${userName}".
                   - ${complexityInstruction}
                   - Keep answers concise but impactful.
            `;
            restartChatButton.disabled = false;
        }

        async function getAIResponse(historyData) {
            return await fetchGemini(historyData);
        }

        async function generateTextResponseFromChat() {
            return await fetchGemini(chatHistory);
        }

        async function fetchGemini(contents) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                return "‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ ‡§∏‡§ñ‡§æ, ‡§Æ‡§≤‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§∏‡§æ‡§Ç‡§ó‡§æ.";
            }
        }

        async function extractNameFromTranscript(transcript) {
            try {
                const prompt = { contents: [{ parts: [{ text: `Extract Name from: "${transcript}". Return ONLY the name text in Marathi script if possible.` }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getEffectiveApiKey()}`;
                const res = await fetch(apiUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(prompt)});
                const data = await res.json();
                let name = data.candidates[0].content.parts[0].text.trim().replace(/['".]/g, '');
                return (name.length < 2) ? "‡§™‡§æ‡§∞‡•ç‡§•" : name;
            } catch (e) { return "‡§™‡§æ‡§∞‡•ç‡§•"; }
        }

        async function extractAgeFromTranscript(transcript) {
            try {
                const prompt = { contents: [{ parts: [{ text: `Extract age number from: "${transcript}". Return ONLY digits.` }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getEffectiveApiKey()}`;
                const res = await fetch(apiUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(prompt)});
                const data = await res.json();
                let age = parseInt(data.candidates[0].content.parts[0].text.trim());
                return isNaN(age) ? 18 : age;
            } catch (e) { return 18; }
        }

        // --- CLEANER ENGINE: FIXED SPACING ISSUE ---
        function cleanTextForTTS(text) {
            // FIXED REGEX: removed space from character class so spaces are PRESERVED
            // Removed: space inside []
            let cleaned = text.replace(/[<>[\]{}\^]/g, ""); 
            
            // Remove Markdown symbols
            cleaned = cleaned.replace(/[\*#`]/g, '');
            
            // Clean extra spaces (normalize)
            return cleaned.replace(/\s+/g, ' ').trim();
        }

        // --- VOICE & MIC CONTROL ---
        function loadVoices() {
            voices = synth.getVoices();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        function togglePauseResume() {
            if (synth.paused) synth.resume();
            else if (synth.speaking) { synth.pause(); recognition.stop(); setState('BUSY'); }
        }

        function stopSpeech() {
            if (!synth.speaking) return;
            speechManuallyStopped = true; 
            synth.cancel(); 
            // Reset Mic State
            isAiSpeaking = false;
            recognition.stop(); 
            
            toggleMediaButtons(true);
            setTimeout(() => {
                speechManuallyStopped = false;
                if (appState !== 'IDLE') { setState('CONVERSATION'); startRecognitionSafe(); }
            }, 1500);
        }

        function replaySpeech() {
            if (lastSpokenText) { recognition.stop(); setState('BUSY'); speakText(lastSpokenText); }
        }
        
        async function speakText(text, lang = 'mr-IN') {
            if (synth.speaking) synth.cancel();
            
            // CRITICAL: STOP LISTENING IMMEDIATELY
            if (recognition) recognition.stop();
            isAiSpeaking = true; // Set flag to lock mic

            lastSpokenText = text;
            speechManuallyStopped = false;
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                utterance.onstart = () => { toggleMediaButtons(false); };
                
                // CRITICAL: RESTART LISTENING ONLY AFTER SPEAKING ENDS
                utterance.onend = () => {
                    toggleMediaButtons(true);
                    isAiSpeaking = false; // Unlock mic
                    
                    if (speechManuallyStopped) {
                        reject(new Error("Speech manually stopped"));
                    } else {
                        // Only auto-restart mic if we are in active mode
                        if (appState === 'CONVERSATION' || appState === 'LISTENING_FOR_NAME' || appState === 'LISTENING_FOR_AGE') {
                            startRecognitionSafe();
                        }
                        resolve();
                    }
                };
                
                utterance.onerror = (e) => { 
                    toggleMediaButtons(true); 
                    isAiSpeaking = false; // Unlock mic on error
                    resolve(); 
                };

                let preferredVoice = voices.find(v => v.lang === 'mr-IN' && (v.name.toLowerCase().includes('male') || v.name.includes('Voice 2')));
                if (!preferredVoice) preferredVoice = voices.find(v => v.lang === 'mr-IN');
                if (!preferredVoice) preferredVoice = voices.find(v => v.lang === 'hi-IN' && v.name.toLowerCase().includes('male'));
                if (!preferredVoice) preferredVoice = voices.find(v => v.lang === 'hi-IN');

                if (preferredVoice) utterance.voice = preferredVoice;
                utterance.lang = 'mr-IN';
                utterance.rate = 0.9; 
                utterance.pitch = 0.7; 
                
                synth.speak(utterance);
            });
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }
        
        // --- LOGGING ---
        function logMessage(sender, message) {
            const div = document.createElement('div');
            let senderClass = 'text-cyan-300 font-semibold';
            if (sender === 'Krishna') senderClass = 'text-yellow-400 font-bold';
            else if (sender === 'You') senderClass = 'text-green-300 font-semibold';

            div.innerHTML = `<strong class="${senderClass}">${sender}:</strong> <span class="text-white">${message}</span>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function getChatLogAsText() {
            const messages = [];
            conversationLog.querySelectorAll('div').forEach(div => { if (div.textContent) messages.push(div.textContent); });
            return messages.join('\n');
        }

        async function shareChat() {
            const chatText = getChatLogAsText();
            if (!chatText.trim()) return;
            try { await navigator.share({ title: 'Divine Guidance', text: chatText }); } 
            catch (err) { try { await navigator.clipboard.writeText(chatText); logMessage('Info', 'Copied'); } catch (e) {} }
        }

        // --- WAKE LOCK ---
        async function acquireWakeLock() {
            if ('wakeLock' in navigator) { 
                try { wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        if (appState !== 'IDLE' && document.visibilityState === 'visible') acquireWakeLock();
                    });
                } catch (e) {} 
            }
        }
        async function releaseWakeLock() {
            if (wakeLock) { try { await wakeLock.release(); wakeLock = null; } catch (e) {} }
        }

        async function endChat() {
            appState = 'IDLE'; setState('IDLE');
            speechManuallyStopped = true;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch (e) {}
            isAiSpeaking = false;
            await releaseWakeLock();
            
            userName = ''; userAge = 18; chatHistory = [];
            conversationLog.innerHTML = '<div class="text-gray-400 text-center">‡§∏‡§Ç‡§µ‡§æ‡§¶ ‡§•‡§æ‡§Ç‡§¨‡§µ‡§≤‡§æ ‡§Ü‡§π‡•á.</div>';
            restartChatButton.disabled = true;
        }

        async function restartChat() {
            if (!systemInstruction) return;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}
            appState = 'IDLE'; setState('IDLE');
            isAiSpeaking = false;
            await releaseWakeLock();
            conversationLog.innerHTML = '';
            if(userName) {
                localStorage.removeItem(`krishna_mr_history_${userName.toLowerCase()}`);
                chatHistory = [];
            }
            logMessage('Info', `‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡•á‡§≤‡•á.`);
        }
    </script>
</body>
</html>