<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>डॉ. बाबासाहेब आंबेडकर - प्रेरणा AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* ॲनिमेशन - निळा प्रकाश (Blue Glow) */
        .listening-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } /* blue-600 */
            70% { box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }

        .icon-btn {
            @apply p-3 rounded-full text-white transition-all duration-200
                   bg-blue-700 hover:bg-blue-600 shadow-lg
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-blue-900 focus:ring-blue-500
                   disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none;
        }
        
        .utility-btn {
            @apply w-full py-3 px-2 rounded-lg text-sm font-semibold transition-colors
                   bg-blue-800 text-blue-100
                   hover:bg-blue-700
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-blue-900 focus:ring-blue-500
                   disabled:bg-blue-900 disabled:text-blue-300 disabled:cursor-not-allowed;
        }

        .custom-checkbox {
            @apply w-4 h-4 text-blue-600 bg-blue-900 border-blue-700 rounded focus:ring-blue-500 focus:ring-2 ring-offset-blue-800;
        }
        
        .custom-input {
            @apply block w-3/4 mx-auto text-center border border-blue-700 rounded-lg p-3 outline-none transition-all;
            background-color: #172554 !important; /* blue-950 */
            color: #dbeafe !important;             /* blue-100 */
            caret-color: #60a5fa !important;       /* blue-400 */
        }
        .custom-input::placeholder {
            color: #93c5fd !important;
            opacity: 0.8 !important;
        }

        /* स्क्रोलबार कस्टमायझेशन */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020617; } /* slate-950 */
        ::-webkit-scrollbar-thumb { background: #1d4ed8; border-radius: 4px; } /* blue-700 */
        ::-webkit-scrollbar-thumb:hover { background: #2563eb; } /* blue-600 */
    </style>
</head>

<body class="bg-[#020617] text-blue-50 flex items-center justify-center min-h-screen p-4" oncontextmenu="return false;">

    <div class="bg-[#0f172a] rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl flex flex-col h-[95vh] md:h-auto border-t-4 border-blue-500 border-b-4 border-blue-900">
        
        <div class="flex items-center justify-between mb-4 shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                <span class="text-blue-400">डॉ. बाबासाहेब</span> <span class="text-blue-200">आंबेडकर</span> <span class="text-blue-500">विचार</span>
            </h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-600 transition-colors" title="बंद आहे"></div>
        </div>
        <div class="text-center mb-2">
             <span class="text-xs text-blue-300 uppercase tracking-widest">|| शिका, संघटित व्हा, संघर्ष करा ||</span>
        </div>

        <div id="conversation-log" class="flex-grow overflow-y-auto bg-[#020617] rounded-lg p-4 mb-4 border border-blue-900 space-y-4 shadow-inner min-h-[200px]">
            <div class="text-blue-300/60 text-center mt-10">
                सुरू करण्यासाठी "जय भीम" म्हणा.<br>
                <span class="text-sm opacity-70 text-blue-400">शहाणपण आणि स्वाभिमान हेच मानवाचे खरे बळ आहे.</span>
            </div>
        </div>

        <div class="flex justify-center gap-8 mb-4 shrink-0 bg-blue-900/30 p-2 rounded-xl">
            <button id="pause-resume-button" class="icon-btn bg-blue-700 hover:bg-blue-600" title="थांबवा/पुन्हा सुरू करा" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
            </button>
            
            <button id="stop-speech-button" class="icon-btn bg-red-900/50 hover:bg-red-800" title="बोलणे थांबवा" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
            </button>

            <button id="replay-button" class="icon-btn bg-green-900/50 hover:bg-green-800" title="पुन्हा ऐका" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>

        <div class="flex flex-col gap-4 mb-4 shrink-0 w-full text-center">
            <div class="w-full">
                <label class="text-xs text-blue-400 mb-1 block">युवकाचे नाव</label>
                <input type="text" id="manual-name" class="custom-input" placeholder="तुमचे नाव">
            </div>
            <div class="w-full">
                <label class="text-xs text-blue-400 mb-1 block">वय (वर्षे)</label>
                <input type="number" id="manual-age" class="custom-input" placeholder="उदा. २५">
            </div>
        </div>

        <div class="flex items-center justify-center gap-2 mb-2 shrink-0">
            <input type="checkbox" id="remember-me-checkbox" class="custom-checkbox">
            <label for="remember-me-checkbox" class="text-sm text-blue-200 cursor-pointer select-none">
                माहिती लक्षात ठेवा
            </label>
        </div>

        <div class="w-full flex flex-col items-center justify-center mb-4 shrink-0">
            <button id="advance-toggle-btn" class="text-xs text-blue-500 hover:text-blue-400 underline mb-2 focus:outline-none">
                ▼ प्रगत सेटिंग्ज (API Key)
            </button>

            <div id="advance-container" class="hidden w-full bg-[#020617] border border-blue-800 rounded-lg p-4 flex flex-col gap-3 transition-all">
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="use-custom-key-checkbox" class="custom-checkbox">
                    <label for="use-custom-key-checkbox" class="text-sm text-blue-200 cursor-pointer select-none">
                        तुमची स्वतःची API Key वापरा
                    </label>
                </div>

                <input type="text" id="custom-api-key-input" class="custom-input text-xs w-full !w-full" placeholder="API Key येथे पेस्ट करा" disabled>
                
                <button id="paste-key-btn" type="button" disabled class="w-full py-2 px-4 bg-blue-900 hover:bg-blue-800 text-white text-xs rounded transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                    </svg>
                    पेस्ट करा
                </button>

                <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-center w-full py-2 bg-[#020617] hover:bg-[#1e3a8a] text-xs text-blue-400 rounded transition-colors border border-blue-800">
                    मोफत Google Gemini API Key मिळवा ↗
                </a>
            </div>
        </div>

        <button id="talk-button" class="w-full py-4 px-6 rounded-lg text-lg font-semibold transition-all duration-300 ease-in-out shrink-0
                       bg-blue-600 text-white shadow-lg shadow-blue-900/50
                       hover:bg-blue-500 hover:shadow-blue-500/50 hover:-translate-y-0.5
                       focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50
                       disabled:bg-gray-700 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0">
            संवाद सुरू करा
        </button>

        <div class="mt-4 grid grid-cols-3 gap-3 shrink-0">
            <button id="restart-chat-button" class="utility-btn" disabled>पुन्हा सुरू करा</button>
            <button id="share-button" class="utility-btn bg-cyan-900/50 hover:bg-cyan-800">शेअर करा</button>
            <button id="end-chat-button" class="utility-btn text-red-200 hover:bg-red-900/40" disabled>थांबवा</button>
        </div>

    </div>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());

        function enterFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen(); } 
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } 
            else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
        }

        const talkButton = document.getElementById('talk-button');
        const statusIndicator = document.getElementById('status-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const rememberMeCheckbox = document.getElementById('remember-me-checkbox');
        const manualNameInput = document.getElementById('manual-name');
        const manualAgeInput = document.getElementById('manual-age');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopSpeechButton = document.getElementById('stop-speech-button');
        const replayButton = document.getElementById('replay-button');
        const shareButton = document.getElementById('share-button');
        const endChatButton = document.getElementById('end-chat-button');
        const restartChatButton = document.getElementById('restart-chat-button');
        
        const advanceToggleBtn = document.getElementById('advance-toggle-btn');
        const advanceContainer = document.getElementById('advance-container');
        const useCustomKeyCheckbox = document.getElementById('use-custom-key-checkbox');
        const customApiKeyInput = document.getElementById('custom-api-key-input');
        const pasteKeyBtn = document.getElementById('paste-key-btn');

        const DEFAULT_API_KEY = "AIzaSyB41xzsLyqQizurma_sHuBPd18wpJvoJro"; 
        let appState = 'IDLE'; 
        let userName = '';
        let userAge = 30; 
        let chatHistory = [];
        let systemInstruction = '';
        let recognition;
        let lastSpokenText = ''; 
        let speechManuallyStopped = false; 
        const synth = window.speechSynthesis;
        let voices = [];
        let wakeLock = null;

        window.onload = () => {
            if (synth.speaking) synth.cancel();
            loadUserData(); 
            loadVoices();   
        };

        advanceToggleBtn.addEventListener('click', () => {
            advanceContainer.classList.toggle('hidden');
            advanceContainer.classList.toggle('flex');
        });

        useCustomKeyCheckbox.addEventListener('change', () => {
            const isChecked = useCustomKeyCheckbox.checked;
            customApiKeyInput.disabled = !isChecked;
            pasteKeyBtn.disabled = !isChecked;
            saveUserData(); 
            if (isChecked) customApiKeyInput.focus();
        });

        customApiKeyInput.addEventListener('input', saveUserData);

        pasteKeyBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    customApiKeyInput.value = text;
                    saveUserData();
                    const originalText = pasteKeyBtn.innerHTML;
                    pasteKeyBtn.textContent = "पेस्ट झाले!";
                    setTimeout(() => { pasteKeyBtn.innerHTML = originalText; }, 1000);
                }
            } catch (err) { alert('पेस्ट करता आले नाही. कृपया टाईप करा.'); }
        });

        function getEffectiveApiKey() {
            if (useCustomKeyCheckbox.checked && customApiKeyInput.value.trim().length > 10) {
                return customApiKeyInput.value.trim();
            }
            return DEFAULT_API_KEY;
        }

        function loadUserData() {
            try {
                const savedName = localStorage.getItem('bhim_userName');
                const savedAge = localStorage.getItem('bhim_userAge');
                const savedRemember = localStorage.getItem('bhim_remember');

                if (savedRemember === 'true') {
                    rememberMeCheckbox.checked = true;
                    if (savedName) manualNameInput.value = savedName;
                    if (savedAge) manualAgeInput.value = savedAge;
                    if (savedName) talkButton.textContent = `जय भीम ${savedName}`;
                }

                const savedUseKey = localStorage.getItem('bhim_useCustomKey');
                const savedKey = localStorage.getItem('bhim_customKey');

                if (savedUseKey === 'true') {
                    useCustomKeyCheckbox.checked = true;
                    customApiKeyInput.disabled = false;
                    pasteKeyBtn.disabled = false;
                    if (savedKey) customApiKeyInput.value = savedKey;
                }
            } catch (e) { console.error(e); }
        }

        function saveUserData() {
            try {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('bhim_remember', 'true');
                    localStorage.setItem('bhim_userName', manualNameInput.value.trim());
                    localStorage.setItem('bhim_userAge', manualAgeInput.value.trim());
                } else {
                    localStorage.removeItem('bhim_remember');
                    localStorage.removeItem('bhim_userName');
                    localStorage.removeItem('bhim_userAge');
                }
                localStorage.setItem('bhim_useCustomKey', useCustomKeyCheckbox.checked);
                if (customApiKeyInput.value) {
                    localStorage.setItem('bhim_customKey', customApiKeyInput.value.trim());
                }
            } catch (e) { console.error(e); }
        }

        function loadChatContext(name) {
            const key = `bhim_history_${name.toLowerCase()}`;
            const savedHistory = localStorage.getItem(key);
            try { return savedHistory ? JSON.parse(savedHistory) : []; } catch (e) { return []; }
        }

        function saveChatContext() {
            if (!userName) return;
            const key = `bhim_history_${userName.toLowerCase()}`;
            const limitedHistory = chatHistory.slice(-20); 
            localStorage.setItem(key, JSON.stringify(limitedHistory));
        }

        manualNameInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });
        manualAgeInput.addEventListener('input', () => { if(rememberMeCheckbox.checked) saveUserData(); });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            logMessage('त्रुटी', 'हा ब्राउझर सपोर्ट करत नाही. कृपया Google Chrome वापरा.');
            talkButton.disabled = true;
        } else {
            try {
                recognition = new SpeechRecognition();
                recognition.continuous = false; 
                recognition.interimResults = false;
                recognition.lang = 'mr-IN'; 

                recognition.onresult = handleSpeechResult;
                recognition.onend = handleSpeechEnd;
                
                recognition.onerror = (event) => {
                    if (event.error === 'no-speech' && appState !== 'IDLE' && appState !== 'BUSY') {
                        startRecognitionSafe();
                    } else if (event.error === 'not-allowed') {
                        setState('IDLE');
                    }
                };
            } catch (e) { alert("माईक त्रुटी: " + e.message); }
        }

        function startRecognitionSafe() {
            if (!recognition) return;
            try { recognition.start(); } catch (e) {}
        }

        talkButton.addEventListener('click', toggleListening);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopSpeechButton.addEventListener('click', stopSpeech);
        replayButton.addEventListener('click', replaySpeech);
        shareButton.addEventListener('click', shareChat);
        endChatButton.addEventListener('click', endChat);
        restartChatButton.addEventListener('click', restartChat);
        document.addEventListener('visibilitychange', handleVisibilityChange);

        async function toggleListening() {
            if (appState === 'IDLE') {
                try { enterFullScreen(); } catch(e) {}
            }

            try {
                if (appState === 'IDLE') {
                    talkButton.textContent = "ऐकत आहे...";
                    talkButton.disabled = true;
                    await acquireWakeLock(); 
                    
                    const inputName = manualNameInput.value.trim();
                    const inputAge = manualAgeInput.value.trim();

                    if (inputName && inputAge) {
                        userName = inputName;
                        userAge = parseInt(inputAge);
                        saveUserData(); 
                        buildSystemPrompt(); 

                        // जुना इतिहास तपासणे
                        const previousHistory = loadChatContext(userName);
                        
                        if (previousHistory.length > 0) {
                            chatHistory = previousHistory;
                            logMessage('सिस्टम', 'बाबासाहेब आपले स्मरण करत आहेत...');
                            
                            setState('BUSY');
                            const welcomeBackPrompt = "User परत आला आहे. म्हणा 'जय भीम'.";
                            
                            const tempHistory = [...chatHistory, { role: 'user', parts: [{ text: welcomeBackPrompt }] }];
                            const welcomeText = await getAIResponse(tempHistory);
                            
                            logMessage('डॉ. बाबासाहेब', welcomeText);
                            await speakText(welcomeText, 'mr-IN');
                            setState('CONVERSATION');
                            startRecognitionSafe();

                        } else {
                            if (chatHistory.length === 0) {
                                chatHistory.push({ role: 'user', parts: [{ text: "Start session." }] });
                                chatHistory.push({ role: 'model', parts: [{ text: `जय भीम.` }] });
                            }
                            
                            const welcomeText = `जय भीम ${userName}. तुझ्या ${userAge} वर्षांच्या आयुष्यात तुला शिक्षणाबद्दल किंवा संविधानाबद्दल काही मार्गदर्शन हवे आहे का? बोल, मी ऐकतोय.`;
                            logMessage('डॉ. बाबासाहेब', welcomeText);
                            
                            setState('BUSY'); 
                            await speakText(welcomeText, 'mr-IN');
                            setState('CONVERSATION');
                            startRecognitionSafe();
                        }

                    } else {
                        setState('LISTENING_FOR_WAKEWORD');
                        startRecognitionSafe();
                        if (conversationLog.childElementCount < 3) logMessage('माहिती', '"जय भीम" म्हणा.');
                    }

                } else {
                    setState('IDLE');
                    recognition.stop();
                    if (synth.speaking) synth.cancel();
                    await releaseWakeLock();
                }
            } catch (error) {
                setState('IDLE');
            }
        }

        function setState(newState) {
            appState = newState;
            switch (newState) {
                case 'IDLE':
                    talkButton.textContent = 'संवाद सुरू करा';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-gray-600 transition-colors';
                    endChatButton.disabled = true;
                    talkButton.classList.remove('bg-blue-700', 'hover:bg-blue-600');
                    talkButton.classList.add('bg-blue-600', 'hover:bg-blue-500');
                    manualNameInput.disabled = false;
                    manualAgeInput.disabled = false;
                    break;
                case 'BUSY':
                    talkButton.textContent = 'विचार करत आहे...';
                    talkButton.disabled = true;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500 transition-colors';
                    endChatButton.disabled = false;
                    break;
                default:
                    talkButton.textContent = 'ऐकणे थांबवा';
                    talkButton.disabled = false;
                    statusIndicator.className = 'w-4 h-4 rounded-full bg-blue-500 listening-pulse transition-colors';
                    endChatButton.disabled = false;
                    talkButton.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                    talkButton.classList.add('bg-blue-700', 'hover:bg-blue-600');
                    manualNameInput.disabled = true;
                    manualAgeInput.disabled = true;
                    break;
            }
        }

        function handleSpeechEnd() {
            if (appState !== 'IDLE' && appState !== 'BUSY') startRecognitionSafe();
            else if (appState === 'IDLE') setState('IDLE'); 
        }
        
        async function handleSpeechResult(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (!transcript) return;
            console.log(`Heard: ${transcript}`);
            
            const currentState = appState;
            recognition.stop();
            setState('BUSY');

            try {
                switch (currentState) {
                    case 'LISTENING_FOR_WAKEWORD':
                        const t = transcript.toLowerCase();
                        if (t.includes('baba') || t.includes('bhim') || t.includes('ambedkar') || t.includes('बाबा') || t.includes('भीम') || t.includes('आंबेडकर') || t.includes('जय भीम')) {
                            const greeting = "जय भीम. मी डॉ. बाबासाहेब आंबेडकर आहे. तुमचे नाव काय आहे?";
                            logMessage('डॉ. बाबासाहेब', greeting);
                            await speakText(greeting, 'mr-IN');
                            setState('LISTENING_FOR_NAME');
                            startRecognitionSafe(); 
                        } else {
                            setState('LISTENING_FOR_WAKEWORD');
                            startRecognitionSafe();
                        }
                        break;

                    case 'LISTENING_FOR_NAME':
                        logMessage('तुम्ही', transcript);
                        userName = await extractNameFromTranscript(transcript);
                        manualNameInput.value = userName; 
                        
                        const agePrompt = `स्वागत आहे ${userName}. तुमचे वय काय आहे?`;
                        logMessage('डॉ. बाबासाहेब', agePrompt);
                        await speakText(agePrompt, 'mr-IN');
                        setState('LISTENING_FOR_AGE');
                        startRecognitionSafe();
                        break;
                    
                    case 'LISTENING_FOR_AGE':
                        logMessage('तुम्ही', transcript);
                        userAge = await extractAgeFromTranscript(transcript);
                        manualAgeInput.value = userAge; 
                        
                        saveUserData();
                        buildSystemPrompt(); 

                        const history = loadChatContext(userName);
                        if(history.length > 0) chatHistory = history;

                        const startPrompt = `उत्तम. ${userAge} वर्षांच्या वयात शिक्षणाचे आणि स्वाभिमानाचे महत्त्व तुला कळले पाहिजे. तुझ्या मनात कोणता प्रश्न आहे?`;
                        logMessage('डॉ. बाबासाहेब', startPrompt);
                        await speakText(startPrompt, 'mr-IN');
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;

                    case 'CONVERSATION':
                        logMessage(userName || 'तुम्ही', transcript);
                        chatHistory.push({ role: 'user', parts: [{ text: transcript }] });
                        saveChatContext();

                        const aiResponseText = await generateTextResponseFromChat();
                        
                        // फिल्टर
                        const noBracketText = cleanBrackets(aiResponseText);
                        const cleanedResponseText = cleanTextForTTS(noBracketText);

                        chatHistory.push({ role: 'model', parts: [{ text: cleanedResponseText }] });
                        saveChatContext();

                        logMessage('डॉ. बाबासाहेब', cleanedResponseText);
                        
                        try {
                            await speakText(cleanedResponseText, 'mr-IN');
                        } catch (error) {
                            if (error.message === "Speech manually stopped") return;
                            throw error;
                        }
                        
                        setState('CONVERSATION');
                        startRecognitionSafe();
                        break;
                }
            } catch (error) {
                if (systemInstruction) { setState('CONVERSATION'); startRecognitionSafe(); }
                else { setState('LISTENING_FOR_WAKEWORD'); startRecognitionSafe(); }
            }
        }

        // --- मुख्य लॉजिक (Brain) - डॉ. आंबेडकर सिस्टम प्रॉम्प्ट ---
        function buildSystemPrompt() {
            
            // वयानुसार सूचना
            let ageToneInstruction = "";
            let conceptsToFocus = "";

            if (userAge < 15) {
                ageToneInstruction = `User is a CHILD (${userAge} years old). Speak like a wise grandfather. Focus on the importance of SCHOOL and STUDY.`;
                conceptsToFocus = "Focus on: 'Shika' (Educate), Discipline, cleanliness, and respecting teachers. Tell them books are their best friends.";
            } else if (userAge >= 15 && userAge < 25) {
                ageToneInstruction = `User is a STUDENT/YOUTH (${userAge} years old). Speak with intensity about SELF-RESPECT and AMBITION.`;
                conceptsToFocus = "Focus on: 'Shika, Sanghatit Vha, Sangharsh Kara' (Educate, Agitate, Organize). Logic, Science, and questioning superstition. Career and excellence.";
            } else if (userAge >= 25 && userAge < 60) {
                ageToneInstruction = `User is a CITIZEN (${userAge} years old). Speak about RIGHTS, DUTIES, and SOCIAL REFORM.`;
                conceptsToFocus = "Focus on: Liberty, Equality, Fraternity. The Constitution. Economic independence. Fighting against caste discrimination in daily life.";
            } else {
                ageToneInstruction = `User is an ELDER (${userAge} years old). Speak about SOCIETY and LEGACY.`;
                conceptsToFocus = "Focus on: Passing wisdom to next generation, Social Democracy, Peace, and Dhamma (if relevant to peace).";
            }

            systemInstruction = `
                You are "Dr. Babasaheb Ambedkar" (डॉ. बाबासाहेब आंबेडकर), the Father of the Indian Constitution.
                User: ${userName}, Age: ${userAge}.
                
                AGE CONTEXT: ${ageToneInstruction}
                THEMES TO EMPHASIZE: ${conceptsToFocus}

                YOUR CORE PHILOSOPHY & SOURCE MATERIAL:
                1. **Source:** Base your answers on thoughts found in "Dr. Babasaheb Ambedkar Writings and Speeches Vol 1" and the reference PDF: https://sahitya.marathi.gov.in/wp-content/uploads/2023/05/Dr.-Ambedlar-1.pdf
                2. **Core Teachings:**
                   - **Liberty, Equality, Fraternity** (स्वातंत्र्य, समता, बंधुता) are my religion.
                   - **Social Democracy:** Democracy is not just a form of government, it is a mode of associated living.
                   - **Education:** Education is the milk of a tigress; one who drinks it will not fail to roar.
                   - **Caste:** Caste is a state of mind, it must be destroyed to build a nation.
                3. **Tone:** Rational, Logical, Fearless, Intellectual, and Compassionate towards the oppressed.
                4. **Greeting:** Use "Jai Bhim" (जय भीम) or "Namaskar". DO NOT use religious greetings like "Allah Malik" or "Swami".

                STRICT RULES:
                1. OUTPUT MUST BE IN PURE, INTELLECTUAL MARATHI.
                2. **STRICTLY FORBIDDEN: Do NOT use parentheses ( ), brackets [ ], angle brackets < >, or asterisks *.**
                3. Do NOT use shortforms (e.g., say 'Dr. Ambedkar' not 'Dr. B.R.').
                4. **NO HATE SPEECH:** While criticizing bad traditions is allowed, do not spread hatred against any specific community. Focus on *systemic* reform.
                5. Provide **EXACT VERSES/QUOTES** from my writings where possible, then explain them deeply.

                RESPONSE STRUCTURE:
                1. Acknowledge the question with dignity.
                2. **Quote a specific thought** (e.g., "मी संविधानात मांडले आहे...", "माझ्या भाषणात मी म्हटले होते...").
                3. Explain the deep social or legal meaning.
                4. Give a practical call to action (Education/Rights).

                EXAMPLE FORMAT (Do not copy text, use structure):
                बाळा, तुझे प्रश्न महत्त्वाचे आहेत.
                मी नेहमी सांगतो की शिक्षण हे वाघिणीचे दूध आहे आणि जो ते पिईल तो गुरगुरल्याशिवाय राहणार नाही.
                याचा अर्थ असा की केवळ पुस्तकी ज्ञान नव्हे, तर अन्यायाविरुद्ध लढण्याची ताकद शिक्षण देते.
                म्हणून तू आधी तुझे शिक्षण पूर्ण कर आणि मग समाजासाठी कार्य कर. जय भीम.
            `;
            restartChatButton.disabled = false;
        }

        // --- API कॉल्स ---
        async function getAIResponse(historyData) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: historyData,
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) { return "संपर्क तुटला आहे. पुन्हा प्रयत्न करा."; }
        }

        async function generateTextResponseFromChat() { return await getAIResponse(chatHistory); }

        async function extractNameFromTranscript(transcript) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${getEffectiveApiKey()}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Extract First Name from audio: "${transcript}". Return ONLY the name in Marathi script. If unclear return "मित्र".` }] }] })
                });
                const result = await response.json();
                let name = result.candidates[0].content.parts[0].text.trim();
                return (name.length < 2) ? "मित्र" : name.replace(/['".]/g, '');
            } catch (error) { return "मित्र"; }
        }

        async function extractAgeFromTranscript(transcript) {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${getEffectiveApiKey()}`;
             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Extract age number from: "${transcript}". Return ONLY digits. Default 25.` }] }] })
                });
                const result = await response.json();
                let age = parseInt(result.candidates[0].content.parts[0].text.trim());
                return isNaN(age) ? 25 : age;
            } catch (e) { return 25; }
        }

        function cleanBrackets(text) {
             return text.replace(/[\*\[\]\(\)<>`]/g, '')
                        .replace(/\(.*?\)/g, '')
                        .replace(/\[.*?\]/g, '')
                        .replace(/<.*?>/g, '');
        }

        function cleanTextForTTS(text) {
            let cleaned = text.replace(/[\*#`<>]/g, '').trim();
            return cleaned;
        }

        function loadVoices() {
            voices = synth.getVoices();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }

        function togglePauseResume() {
            if (synth.paused) synth.resume();
            else if (synth.speaking) { synth.pause(); recognition.stop(); setState('BUSY'); }
        }

        function stopSpeech() {
            if (!synth.speaking) return;
            speechManuallyStopped = true; 
            synth.cancel(); 
            recognition.stop(); 
            toggleMediaButtons(true);
            logMessage('माहिती', 'थांबले.');
            setTimeout(() => {
                speechManuallyStopped = false;
                if (appState !== 'IDLE') {
                    if (systemInstruction) { setState('CONVERSATION'); startRecognitionSafe(); }
                    else { setState('LISTENING_FOR_WAKEWORD'); startRecognitionSafe(); }
                }
            }, 1500);
        }

        function replaySpeech() {
            if (lastSpokenText) { recognition.stop(); setState('BUSY'); speakText(lastSpokenText); }
        }
        
        async function speakText(text, lang = 'mr-IN') {
            if (synth.speaking) synth.cancel();
            lastSpokenText = text;
            speechManuallyStopped = false;
            if (voices.length === 0) voices = synth.getVoices();

            return new Promise((resolve, reject) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.onstart = () => { toggleMediaButtons(false); };
                utterance.onend = () => {
                    toggleMediaButtons(true);
                    if (speechManuallyStopped) reject(new Error("Speech manually stopped"));
                    else resolve();
                };
                utterance.onerror = (e) => { 
                    toggleMediaButtons(true);
                    if (e.error === 'interrupted') resolve(); else reject(e.error); 
                };

                // मराठी किंवा हिंदी आवाज निवडणे
                let vedicVoice = voices.find(voice => voice.lang === 'mr-IN') || 
                                 voices.find(voice => voice.lang === 'hi-IN');
                                 
                if (vedicVoice) utterance.voice = vedicVoice;
                utterance.lang = 'mr-IN'; 
                utterance.rate = 0.95; // थोडा वेगवान, बुद्धीवादी टोन
                utterance.pitch = 0.9; // गंभीर आवाज
                
                synth.speak(utterance);
            });
        }

        function toggleMediaButtons(disabled) {
            pauseResumeButton.disabled = disabled;
            stopSpeechButton.disabled = disabled;
            replayButton.disabled = disabled;
        }
        
        function logMessage(sender, message) {
            const div = document.createElement('div');
            let senderClass = 'text-blue-300 font-semibold';
            let messageClass = 'text-white';

            if (sender === 'डॉ. बाबासाहेब') { senderClass = 'text-blue-500 font-bold'; messageClass = 'text-blue-50'; }
            else if (sender === 'तुम्ही') { senderClass = 'text-green-300 font-semibold'; }

            let formattedMessage = message.replace(/\n/g, '<br>');
            
            div.innerHTML = `<strong class="${senderClass}">${sender}:</strong> <span class="${messageClass}">${formattedMessage}</span>`;
            conversationLog.appendChild(div);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function getChatLogAsText() {
            const messages = [];
            conversationLog.querySelectorAll('div').forEach(div => { if (div.textContent) messages.push(div.textContent); });
            return messages.join('\n');
        }

        async function shareChat() {
            const chatText = getChatLogAsText();
            if (!chatText.trim()) return;
            try { await navigator.share({ title: 'डॉ. आंबेडकर विचार', text: chatText }); } 
            catch (err) { try { await navigator.clipboard.writeText(chatText); logMessage('माहिती', 'कॉपी केले'); } catch (e) {} }
        }

        async function acquireWakeLock() {
            if ('wakeLock' in navigator) { 
                try { 
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        if (appState !== 'IDLE' && document.visibilityState === 'visible') acquireWakeLock();
                    });
                } catch (e) {} 
            }
        }

        async function releaseWakeLock() {
            if (wakeLock) { try { await wakeLock.release(); wakeLock = null; } catch (e) {} }
        }

        async function handleVisibilityChange() {
            if (appState !== 'IDLE' && document.visibilityState === 'visible') await acquireWakeLock();
        }

        async function endChat() {
            appState = 'IDLE'; setState('IDLE');
            speechManuallyStopped = true;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch (e) {}
            await releaseWakeLock();
            userName = ''; userAge = 30; chatHistory = []; systemInstruction = '';
            conversationLog.innerHTML = '<div class="text-gray-400 text-center">जय भीम.</div>';
            restartChatButton.disabled = true;
        }

        async function restartChat() {
            if (!systemInstruction) return;
            if (synth.speaking) synth.cancel();
            if (recognition) try { recognition.stop(); } catch(e){}
            appState = 'IDLE'; setState('IDLE');
            await releaseWakeLock();
            conversationLog.innerHTML = '';
            if(userName) {
                localStorage.removeItem(`bhim_history_${userName.toLowerCase()}`);
                chatHistory = [];
            }
            logMessage('माहिती', `सत्र पुन्हा सुरू झाले.`);
        }
    </script>
</body>
</html>